<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="RVDSD的个人笔记本">
<meta property="og:url" content="http://rvdsd.top/index.html">
<meta property="og:site_name" content="RVDSD的个人笔记本">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="RVDSD的个人笔记本">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://rvdsd.top/"/>





  <title>RVDSD的个人笔记本</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">RVDSD的个人笔记本</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-tags" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rvdsd.top/2019/08/22/DAL/DALS017_InferenceForHighDimensionalData2_/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="RVDSD">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RVDSD的个人笔记本">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/22/DAL/DALS017_InferenceForHighDimensionalData2_/" itemprop="url">DALS016-高维数据推断2-统计原理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-22T12:00:00+08:00">
                2019-08-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/生物统计/" itemprop="url" rel="index">
                    <span itemprop="name">生物统计</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  8,658
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  36
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言">前言</h2>
<p>这一部分是《Data Analysis for the life sciences》的第6章线性模型的第2小节，这一部分的主要内容涉及高维数据统计的一些原理，相应的R markdown文档可以参考作者的<a href="https://github.com/genomicsclass/labs/blob/master/advinference/multiple_testing.Rmd" target="_blank" rel="external">Github</a>。</p>
<h2 id="高维数据的p值">高维数据的p值</h2>
<p>在前面我们了解了，当我们在分析高维数据时，p值就不再是一个很好的统计指标了。这是因为，我们同一次检测了许多特征值(feature)。这种检测手段被称为多重比较( multiple comparison)，或多重检测(multiple testing)，或多重性问题(multiplicity)。在此情况下，p值就不再适用。另外，当我们同时检测多个假设问题时，仅仅基于一个小p值的阈值，例如0.01，这就很容易导假阳性。针对这种情况，我们需要定义一个新的术语来研究高通量数据。</p>
<p>为了处理多重比较的问题，我们广泛使用的方法就是定义一个程序(procedure，也可以说是一种算法，也可以翻译为<code>校正</code>等等，总之，表达的是一个意思)，然后用它来估计或控制(control)计算过程中的错误率(rate error)。我们这里所说的<code>控制(control)</code>的意思是说，我们会采用这个程序来保证错误率(error rate)低于某个提前设定的值。通过参数或截止值(cutoff)来进行设定的这个程序通常比较灵活，它会让我们能够控制特异性(specificity)和灵敏度(sensitivity)，这种程序的一个典型功能如下所示：</p>
<ul>
<li>计算每个基因的p值；</li>
<li>计算出p值小于<span class="math inline">\(\alpha\)</span>的所有显著性基因。</li>
</ul>
<p>这里需要注意的是，当我们改变<span class="math inline">\(\alpha\)</span>值时，会调整相应的特异性(specificity)和灵敏度(sensitivity)。</p>
<p>接着我们来定义错误率(error rate)，它会让我们对统计过程进行估计和控制。</p>
<h2 id="错误率">错误率</h2>
<p>在这一部分中，我们会了解到I类错误与II类错误，这两类错误分别代表假阳性(false positives)与假阴性(false negatives)。通常，特异性(specificity)与I类错误有关，灵敏性(sensitivity)与II类错误有关。</p>
<p>在一次高通量实验里，我们会犯第I类错误和第II类错误。我们参考了Benjamini-Hochberg的论文，做了以下表格，总结了这些错误，如下所示：</p>
<table>
<thead>
<tr class="header">
<th></th>
<th>Called significant（真）</th>
<th>Not called significant（假）</th>
<th>Total</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Null True</td>
<td><span class="math inline">\(V\)</span></td>
<td><span class="math inline">\(m_0-V\)</span></td>
<td><span class="math inline">\(m_0\)</span></td>
</tr>
<tr class="even">
<td>Alternative True</td>
<td><span class="math inline">\(S\)</span></td>
<td><span class="math inline">\(m_1-S\)</span></td>
<td><span class="math inline">\(m_1\)</span></td>
</tr>
<tr class="odd">
<td>True</td>
<td><span class="math inline">\(R\)</span></td>
<td><span class="math inline">\(m-R\)</span></td>
<td><span class="math inline">\(m\)</span></td>
</tr>
</tbody>
</table>
<p>为了说明这个表格中的内容，我们来打个比方，假设我们检测了10000个基因，这就意味着我们需要做检测的次数为<span class="math inline">\(m=10000\)</span>。</p>
<p>那些零假设是真的基因数目（多数是我们不感兴趣的基因，零假设为真，也就是说这些基因在对照和实验组中都没有显著性差异）为<span class="math inline">\(m_{0}\)</span>，那些零假设为假的基因数目为<span class="math inline">\(m_{1}\)</span>，零假设为假，也就是说，替代假设(alternative hypothesis)为真（不一定严谨，反正就是说零假设为假）。通常来说，我们感兴趣的是尽可能地检测到那些替代假设为真的基因（真阳性），避免检测到那些零假设为真的基因（假阳性）。对于多数高通量实验来说，我们会假设<span class="math inline">\(m_{0}\)</span>远大于<span class="math inline">\(m_{1}\)</span>（这句话我的理解就是，在一次高通量实验中，没差异基因的数目<span class="math inline">\(m_{0}\)</span>要大于有差异基因的数目<span class="math inline">\(m_{1}\)</span>）。</p>
<p>例如我们检测了10000个基因，对其中约有100个基因感兴趣。这也就是说，<span class="math inline">\(m_1 \leq 100\)</span> 并且 <span class="math inline">\(m_0 \geq 19,900\)</span>。</p>
<p>在这一章中，我们指的特征值(feature)就是我们的检测值。在遗传学中，这些特征值可以是基因(genes)，转录本(transcripts)，结合位点(binding sites)，CpG岛和SNPs。</p>
<p>在上面的那个表格中，<span class="math inline">\(R\)</span>表示的是经过检测后，有显著性差异的特征值的数目总和，而<span class="math inline">\(m-R\)</span>则表示不显著的基因数目。表格中剩下的部分表示的是一些实际上未知的重要的量。</p>
<ul>
<li><span class="math inline">\(V\)</span>表示I类错误或假阳性。更具体地来说就是，<span class="math inline">\(V\)</span>表示了那些零假设为真的特征值的数目。</li>
<li><span class="math inline">\(S\)</span>表示的是真阳性的数目。具体地来说就是，<span class="math inline">\(S\)</span>表示替代假设为真的特征值的数目。</li>
</ul>
<p><span class="math inline">\(m_{1}-S\)</span>表示了II类错误或假阴性，<span class="math inline">\(m_{0}-V\)</span>表示真阴性。</p>
<p>这里需要牢记的是，当我们只做一次检测时，p就仅仅是当<span class="math inline">\(V=1\)</span>，<span class="math inline">\(m=m_{0}=1\)</span>时的概率。功效(power)就是当<span class="math inline">\(S=1\)</span>，<span class="math inline">\(m=m_{1}=1\)</span>时的概率。在这种非常简单的案例里，我们并不制作上面类似的表格，但是我们会说明一下，如何定义表格中的术语，从而帮助我们处理高维数据。</p>
<h2 id="数据案例">数据案例</h2>
<p>现在看一个案例。在这个案例中我们会使用小鼠数据进行Monte Carlo模拟，从而模拟一种情况，在这种情况里，我们会检测10000种对小鼠体重无影响的减肥饲料(fad diets)。这就是说，在零假设下，这些饲料对小鼠体重没影响为真，也就是说<span class="math inline">\(m=m_{0}=10000\)</span>，并且<span class="math inline">\(m_{1}=0\)</span>，现在我们先进行一个样本数目为12的计算，并且我们认为p值小于<span class="math inline">\(\alpha=0.05\)</span>显著，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">set.seed(<span class="number">1</span>)</div><div class="line">population = unlist( read.csv(<span class="string">"femaleControlsPopulation.csv"</span>) )</div><div class="line">alpha &lt;- <span class="number">0.05</span></div><div class="line">N &lt;- <span class="number">12</span></div><div class="line">m &lt;- <span class="number">10000</span></div><div class="line">pvals &lt;- replicate(m,&#123;</div><div class="line">  control = sample(population,N)</div><div class="line">  treatment = sample(population,N)</div><div class="line">  t.test(treatment,control)$p.value</div><div class="line">&#125;)</div><div class="line">sum(pvals &lt; <span class="number">0.05</span>) <span class="comment">##This is R</span></div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; sum(pvals &lt; <span class="number">0.05</span>) <span class="comment">##This is R</span></div><div class="line">[<span class="number">1</span>] <span class="number">462</span></div></pre></td></tr></table></figure>
<p>从结果我们可以看出，这个假阳性（462个）还是比较高的，这是要在多数分析中是要避免的。</p>
<p>下面我们来看一个更加复杂的代码，这段代码会进行人为设定10%的饮食有效，平均效应(average effect size)为<span class="math inline">\(\Delta=3\)</span>盎司（约85克）。仔细研究这段代码可以帮助我们理解上面的那个表格，现在我们先来定义这样的数据，其中10%有效：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">alpha &lt;- <span class="number">0.05</span></div><div class="line">N &lt;- <span class="number">12</span></div><div class="line">m &lt;- <span class="number">10000</span></div><div class="line">p0 &lt;- <span class="number">0.90</span> <span class="comment">##10% of diets work, 90% don't</span></div><div class="line">m0 &lt;- m*p0</div><div class="line">m1 &lt;- m-m0</div><div class="line">nullHypothesis &lt;- c( rep(<span class="literal">TRUE</span>,m0), rep(<span class="literal">FALSE</span>,m1))</div><div class="line">delta &lt;- <span class="number">3</span></div></pre></td></tr></table></figure>
<p>现在我们做10000次模拟统计，每次都采用t检验，并记录下来：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">set.seed(<span class="number">1</span>)</div><div class="line">calls &lt;- sapply(<span class="number">1</span>:m, <span class="keyword">function</span>(i)&#123;</div><div class="line">  control &lt;- sample(population,N)</div><div class="line">  treatment &lt;- sample(population,N)</div><div class="line">  <span class="keyword">if</span>(!nullHypothesis[i]) treatment &lt;- treatment + delta</div><div class="line">  ifelse( t.test(treatment,control)$p.value &lt; alpha,</div><div class="line">          <span class="string">"Called Significant"</span>,</div><div class="line">          <span class="string">"Not Called Significant"</span>)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>由于我们知道哪些是数据是有差异的（毕竟是自己人为生成的，保存在了<code>nullHypothesis</code>中)，我们现在计算一下上面的表格，代码如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">null_hypothesis &lt;- factor( nullHypothesis, levels=c(<span class="string">"TRUE"</span>,<span class="string">"FALSE"</span>))</div><div class="line">table(null_hypothesis,calls)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&gt; null_hypothesis &lt;- factor( nullHypothesis, levels=c(<span class="string">"TRUE"</span>,<span class="string">"FALSE"</span>))</div><div class="line">&gt; table(null_hypothesis,calls)</div><div class="line">               calls</div><div class="line">null_hypothesis Called Significant Not Called Significant</div><div class="line">          <span class="literal">TRUE</span>                 <span class="number">421</span>                   <span class="number">8579</span></div><div class="line">          <span class="literal">FALSE</span>                <span class="number">520</span>                    <span class="number">480</span></div></pre></td></tr></table></figure>
<p>结果中的第1列就是<span class="math inline">\(V\)</span>与<span class="math inline">\(S\)</span>，需要注意的是，<span class="math inline">\(V\)</span>与<span class="math inline">\(S\)</span>是随机变量，如果我们再次运行这段代码以，这些值就会改变，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">B &lt;- <span class="number">10</span> <span class="comment">##number of simulations</span></div><div class="line">VandS &lt;- replicate(B,&#123;</div><div class="line">  calls &lt;- sapply(<span class="number">1</span>:m, <span class="keyword">function</span>(i)&#123;</div><div class="line">    control &lt;- sample(population,N)</div><div class="line">    treatment &lt;- sample(population,N)</div><div class="line">    <span class="keyword">if</span>(!nullHypothesis[i]) treatment &lt;- treatment + delta</div><div class="line">    t.test(treatment,control)$p.val &lt; alpha</div><div class="line">  &#125;)</div><div class="line">  cat(<span class="string">"V ="</span>,sum(nullHypothesis &amp; calls), <span class="string">"S ="</span>,sum(!nullHypothesis &amp; calls),<span class="string">"\n"</span>)</div><div class="line">  c(sum(nullHypothesis &amp; calls),sum(!nullHypothesis &amp; calls))</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">V = <span class="number">410</span> S = <span class="number">564</span> </div><div class="line">V = <span class="number">400</span> S = <span class="number">552</span> </div><div class="line">V = <span class="number">366</span> S = <span class="number">546</span> </div><div class="line">V = <span class="number">382</span> S = <span class="number">553</span> </div><div class="line">V = <span class="number">372</span> S = <span class="number">505</span> </div><div class="line">V = <span class="number">382</span> S = <span class="number">530</span> </div><div class="line">V = <span class="number">381</span> S = <span class="number">539</span> </div><div class="line">V = <span class="number">396</span> S = <span class="number">554</span> </div><div class="line">V = <span class="number">380</span> S = <span class="number">550</span> </div><div class="line">V = <span class="number">405</span> S = <span class="number">569</span></div></pre></td></tr></table></figure>
<p>针对这种情况，我们就定义了错误率(error rate)。例如，我们可以估计<span class="math inline">\(V\)</span>大于0的概率。它可以解释为，在10000次检验中，我们出现I类错误的概率。在上述模拟数据中，<span class="math inline">\(V\)</span>在每次模拟中都大于1，因此我们怀疑这个概率实际上就是1（这里的1就是“V大于0”这个事件的概率，换句话讲，就是，在这个检验中，必然会出现假阳性）。</p>
<p>当<span class="math inline">\(m=1\)</span>时，这个概率就等于p值。当我们进行多重检验模拟时，我们称之为多重比较谬误(Family Wide Error Rate,FWER)，它与我们广泛使用的一个检验方法有关，即Bonferroni校正( Bonferroni Correction)。</p>
<h2 id="bonferroni校正">Bonferroni校正</h2>
<p>现在我们了解一下FWER是如何运用的，在实际的分析中，我们会选择一个程序(procedure)来保证FWER小于某个提前设定好的阈值，例如0.05，通常情况下，就使用<span class="math inline">\(\alpha\)</span>来表示。</p>
<p>现在我们来描述一个这样的程序：拒绝所有p值小于0.01的假设。</p>
<p>为了说明这个目的，我们假设所有的检验都是独立的（在10000个饲料检验的实验里，这个假设是成立的；但是在一些遗传学实验里，这个假设有可能不成立，因为某些基因会共同发挥作用）。每次检验得到的p值我们用<span class="math inline">\(p_1,\dots,p_{10000}\)</span>表示。这些独立的随机变量如下所示： <span class="math display">\[
\begin{align*}
\mbox{Pr}(\mbox{at least one rejection}) &amp;= 1 -\mbox{Pr}(\mbox{no rejections}) \\
&amp;= 1 - \prod_{i=1}^{10000} \mbox{Pr}(p_i&gt;0.01) \\
&amp;= 1-0.99^{10000} \approx 1
\end{align*}
\]</span> 如果我们要模拟这个过程，代码如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">B&lt;-<span class="number">10000</span></div><div class="line">minpval &lt;- replicate(B, min(runif(<span class="number">10000</span>,<span class="number">0</span>,<span class="number">1</span>))&lt;<span class="number">0.01</span>)</div><div class="line">mean(minpval&gt;=<span class="number">1</span>)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; mean(minpval&gt;=<span class="number">1</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">1</span></div></pre></td></tr></table></figure>
<p>因此，我们计算出来的FWER是1，这并非我们想要的结果。如果我们想要它低于<span class="math inline">\(\alpha=0.05\)</span>，那么我们的统计就是失败的。</p>
<p>我们如何做才能使得一个错误出现的概率低于<span class="math inline">\(\alpha\)</span>呢，我们可以使用上面的公式推导一下，通过选择更严格的截止值(cutoff），之前的是0.01，从而将我们的错误降低至至少5%的水平，如下所示： <span class="math display">\[
\mbox{Pr}(\mbox{at least one rejection}) =  1-(1-k)^{10000}
\]</span> 解这个方程，我们就得到了 <span class="math inline">\(1-(1-k)^{10000}=0.01 \implies k = 1-0.99^{1/10000} \approx 1e-6\)</span></p>
<p>这就是我们给出的一个程序案例。这实际上就是Sikdak过程。尤其是，当我们定义一个说明，例如<code>拒绝所有p值小于 0.000005的零假设</code>。然后，我们知道了p值是一个随机变量，我们会使用统计理论来计算，如果我们遵循这个程序，平均会犯多少错误。更确切地讲就是，我们可以计算出这些错误的边界，也就是说，这些错误小于某些预定值的比例。</p>
<p>Sidak校正的一个问题是，这个校正假设所有的检验都是独立的。因此当这个假设时成立的，它只能控制FWER。百Bonferroini校正则更为通用，因为即使每个检测不独立，它也能控制FWER。。与Sidak校正一样，我们首先来看一下： <span class="math display">\[
FWER = \mbox{Pr}(V&gt;0) \leq \mbox{Pr}(V&gt;0 \mid \mbox{all nulls are true})
\]</span></p>
<p>现在使用前面表格的那种表示方法为： <span class="math display">\[
\mbox{Pr}(V&gt;0) \leq \mbox{Pr}(V&gt;0 \mid m_1=0)
\]</span> Bonferoni校正会设定<span class="math inline">\(k=\alpha/m\)</span>，因此可以写为如下形式： <span class="math display">\[
\begin{align*}
\mbox{Pr}(V&gt;0 \,\mid \, m_1=0) &amp;= \mbox{Pr}\left( \min_i \{p_i\} \leq \frac{\alpha}{m} \mid m_1=0 \right)\\
 &amp;\leq \sum_{i=1}^m \mbox{Pr}\left(p_i \leq \frac{\alpha}{m} \right)\\
 &amp;= m \frac{\alpha}{m}=\alpha
\end{align*}
\]</span> 将FWER控制在0.05水平是一种非常保守的方法，现在我们使用前面计算的p值来计算一下：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">set.seed(<span class="number">1</span>)</div><div class="line">pvals &lt;- sapply(<span class="number">1</span>:m, <span class="keyword">function</span>(i)&#123;</div><div class="line">  control &lt;- sample(population,N)</div><div class="line">  treatment &lt;- sample(population,N)</div><div class="line">  <span class="keyword">if</span>(!nullHypothesis[i]) treatment &lt;- treatment + delta</div><div class="line">  t.test(treatment,control)$p.value</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>只需要关于p值是否小于0.05/10000即可，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sum(pvals &lt; <span class="number">0.05</span>/<span class="number">10000</span>)</div></pre></td></tr></table></figure>
<p>结果为：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; sum(pvals &lt; <span class="number">0.05</span>/<span class="number">10000</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">2</span></div></pre></td></tr></table></figure>
<p>当使用了Bonferroni校正后，即使我们进行了10000次饮食实验，却只有发现2个假阳性的结果，Bonferroni是一种非常严格的校正。</p>
<h2 id="错误发现率fdr">错误发现率(FDR)</h2>
<p>在许多情况下，要求FWER是0.05没多大意义，因为它太严格了。例如，我们常见的做法就是先进行初步的小型实验来确定小数候选基因。这种做法被称为之发现驱动的实验或项目。我们也许会寻找一个未知的致病基因，而不仅仅是对候选基因进行采用更多的样本进行后续研究。如果我们开发一个程序，例如一个10个基因列表，从中发现1到2个为重要的基因，这个实验就算非常成功。小样本实验，实现<span class="math inline">\(FWER\leq0.05\)</span>的唯一途径就是使用一个空的基因列表。在前面我们已经看到，虽然只有1000种包含有效，但是最终我们只得到2个饮食有效这样一个结果，如果把样本数目降低到6，这个结果有可能就是0，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">set.seed(<span class="number">1</span>)</div><div class="line">pvals &lt;- sapply(<span class="number">1</span>:m, <span class="keyword">function</span>(i)&#123;</div><div class="line">  control &lt;- sample(population,<span class="number">6</span>)</div><div class="line">  treatment &lt;- sample(population,<span class="number">6</span>)</div><div class="line">  <span class="keyword">if</span>(!nullHypothesis[i]) treatment &lt;- treatment + delta</div><div class="line">  t.test(treatment,control)$p.value</div><div class="line">&#125;)</div><div class="line">sum(pvals &lt; <span class="number">0.05</span>/<span class="number">10000</span>)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; sum(pvals &lt; <span class="number">0.05</span>/<span class="number">10000</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0</span></div></pre></td></tr></table></figure>
<p>由于我们要求<span class="math inline">\(FWER\leq 0.05\)</span>，因此我们实际上就是0功效（灵敏度）。在许多方法中，这种情况称为特异性(specificity)过强(over-kill)。替代FWER的另外一种方法就是FDR，即错误发现率(false discover rate)。FDR背后的思想就是集中关注Q值，即 <span class="math inline">\(Q \equiv V/R\)</span>，当<span class="math inline">\(R=0,V=0\)</span>时，<span class="math inline">\(Q=0\)</span>。其中，当<span class="math inline">\(R=0\)</span>（没有显著性）就表明，<span class="math inline">\(V=0\)</span>（没有假阳性）。因此<span class="math inline">\(Q\)</span>是一个随机变量，它的范围是0到1，通过计算Q的平均值，我们可以定义一个比值(rate)，它所表示的是意思是，在显著的基因里，假阳性的基因占的比例。为了更好地理解这个概含，我们计算Q的程序要求调用所有的p值都小于0.05。</p>
<h2 id="向量化代码">向量化代码</h2>
<p>在R中可以使用<code>sapply()</code>系列函数来加快运行速度，前面已经看到了这个函数的使用方法，现在使用传统的代码来看一下Q值的计算方法，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(genefilter) <span class="comment">##rowttests is here</span></div><div class="line">set.seed(<span class="number">1</span>)</div><div class="line"><span class="comment">##Define groups to be used with rowttests</span></div><div class="line">g &lt;- factor( c(rep(<span class="number">0</span>,N),rep(<span class="number">1</span>,N)) )</div><div class="line">B &lt;- <span class="number">1000</span> <span class="comment">##number of simulations</span></div><div class="line">Qs &lt;- replicate(B,&#123;</div><div class="line">  <span class="comment">##matrix with control data (rows are tests, columns are mice)</span></div><div class="line">  controls &lt;- matrix(sample(population, N*m, replace=<span class="literal">TRUE</span>),nrow=m)</div><div class="line">  <span class="comment">##matrix with control data (rows are tests, columns are mice)</span></div><div class="line">  treatments &lt;- matrix(sample(population, N*m, replace=<span class="literal">TRUE</span>),nrow=m)</div><div class="line">  <span class="comment">##add effect to 10% of them</span></div><div class="line">  treatments[which(!nullHypothesis),]&lt;-treatments[which(!nullHypothesis),]+delta</div><div class="line">  <span class="comment">##combine to form one matrix</span></div><div class="line">  dat &lt;- cbind(controls,treatments)</div><div class="line">  calls &lt;- rowttests(dat,g)$p.value &lt; alpha</div><div class="line">  R=sum(calls)</div><div class="line">  Q=ifelse(R&gt;<span class="number">0</span>,sum(nullHypothesis &amp; calls)/R,<span class="number">0</span>)</div><div class="line">  <span class="keyword">return</span>(Q)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt; head(Qs)</div><div class="line">[<span class="number">1</span>] <span class="number">0.4513274</span> <span class="number">0.4063786</span> <span class="number">0.4568627</span> <span class="number">0.4490414</span> <span class="number">0.4468314</span> <span class="number">0.4315569</span></div><div class="line">&gt; tail(Qs)</div><div class="line">[<span class="number">1</span>] <span class="number">0.4390756</span> <span class="number">0.4718657</span> <span class="number">0.4395373</span> <span class="number">0.4425711</span> <span class="number">0.4536391</span> <span class="number">0.4284284</span></div></pre></td></tr></table></figure>
<h2 id="控制fdr">控制FDR</h2>
<p>上述代码使用Monte Carlo模拟计算了1000次10000个样本的实验，并保存了Q值，现在看一下Q值的直方图，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(rafalib)</div><div class="line">mypar(<span class="number">1</span>,<span class="number">1</span>)</div><div class="line">hist(Qs) <span class="comment">##Q is a random variable, this is its distribution</span></div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190831135218.jpeg">

</div>
<p>FDR就是Q值的平均值，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">FDR=mean(Qs)</div><div class="line">print(FDR)</div></pre></td></tr></table></figure>
<p>如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; print(FDR)</div><div class="line">[<span class="number">1</span>] <span class="number">0.4463354</span></div></pre></td></tr></table></figure>
<p>这里的计算结果表明，FDR值比较高。这是因为对于90%的统计检验而言，零假设是真。这就暗示了，由于p值是cutoff值为0.05，100个检验中，大概有4到5个是假阳性。再加上我们没有考虑到替代所设为真时的所有情况，因此FDR值就比较高。那么我们如何控制它呢，如果我们想要更低的FDR值，比如5%怎么办？</p>
<p>为了用图形说明FDR为什么这么高，我们来绘制p值的直方图。我们使用一个较大的<code>m</code>值从直方图中获取更多的数据。再绘制一条水平线，表示当NULL为真时，从<span class="math inline">\(m_{0}\)</span>个案例（指的基因或其它检测值，<span class="math inline">\(m_{0}\)</span>就是没有统计学差异的基因）中到的阳性结果的均匀分布，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">set.seed(<span class="number">1</span>)</div><div class="line">controls &lt;- matrix(sample(population, N*m, replace=<span class="literal">TRUE</span>),nrow=m)</div><div class="line">treatments &lt;- matrix(sample(population, N*m, replace=<span class="literal">TRUE</span>),nrow=m)</div><div class="line">treatments[which(!nullHypothesis),]&lt;-treatments[which(!nullHypothesis),]+delta</div><div class="line">dat &lt;- cbind(controls,treatments)</div><div class="line">pvals &lt;- rowttests(dat,g)$p.value</div><div class="line">h &lt;- hist(pvals,breaks=seq(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0.05</span>))</div><div class="line">polygon(c(<span class="number">0</span>,<span class="number">0.05</span>,<span class="number">0.05</span>,<span class="number">0</span>),c(<span class="number">0</span>,<span class="number">0</span>,h$counts[<span class="number">1</span>],h$counts[<span class="number">1</span>]),col=<span class="string">"grey"</span>)</div><div class="line">abline(h=m0/<span class="number">20</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190831140759.jpeg">

</div>
<p>第1个柱子（灰色）表示提p值小于0.05的基因的数目，从水平线可知，大概有一半p值小于0.05的基因是假阳性，这与前面提到的FDR=0.5是一致的。我们来看一下当柱子的宽度为0.01时FDR的值会更低，但同时我们的显著性差异数目也会降低。</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">h &lt;- hist(pvals,breaks=seq(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0.01</span>))</div><div class="line">polygon(c(<span class="number">0</span>,<span class="number">0.01</span>,<span class="number">0.01</span>,<span class="number">0</span>),c(<span class="number">0</span>,<span class="number">0</span>,h$counts[<span class="number">1</span>],h$counts[<span class="number">1</span>]),col=<span class="string">"grey"</span>)</div><div class="line">abline(h=m0/<span class="number">100</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190831142643.jpeg">

</div>
<p>当柱子的宽度变为0.01时，我们可以看到一个更小的p值cutoff，并且检测到到特征值的数目也会下降（降低了灵敏性sensitivity)，但是，FDR也会降低（提高了特异性specificity）。我们如何设定这个cutoff呢？其中一个方法就是设定一个FDR水平<span class="math inline">\(\alpha\)</span>，然后设置控制错误率的程序即可：<span class="math inline">\(FDR \leq \alpha\)</span>。</p>
<h2 id="benjamini-hochberg">Benjamini-Hochberg</h2>
<p>对于任意给定的<span class="math inline">\(\alpha\)</span>，Benjamini-Hochberg方法都非常适用，这种方法可以让使用者地每个检验的p值进行校正，也能很好地定义一个程序。</p>
<p>Benjamini-Hochberg方法的原理是，先按照升序对p值进行排列，即<span class="math inline">\(p_{(1)},\dots,p_{(m)}\)</span>，然后定义一个<span class="math inline">\(k\)</span>用来表示最大的秩<span class="math inline">\(i\)</span>，它所对应的p值为： <span class="math display">\[
p_{(i)} \leq \frac{i}{m}\alpha
\]</span> 这个程序会拒绝那些p值小于或等于<span class="math inline">\(p_{(k)}\)</span>的检验。现在看一个案例，如何选择<span class="math inline">\(k\)</span>来计算p值，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">alpha &lt;- <span class="number">0.05</span></div><div class="line">i = seq(along=pvals)</div><div class="line">mypar(<span class="number">1</span>,<span class="number">2</span>)</div><div class="line">plot(i,sort(pvals))</div><div class="line">abline(<span class="number">0</span>,i/m*alpha)</div><div class="line"><span class="comment">##close-up</span></div><div class="line">plot(i[<span class="number">1</span>:<span class="number">15</span>],sort(pvals)[<span class="number">1</span>:<span class="number">15</span>],main=<span class="string">"Close-up"</span>)</div><div class="line">abline(<span class="number">0</span>,i/m*alpha)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190831145524.jpeg">

</div>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">k &lt;- max( which( sort(pvals) &lt; i/m*alpha) )</div><div class="line">cutoff &lt;- sort(pvals)[k]</div><div class="line">cat(<span class="string">"k ="</span>,k,<span class="string">"p-value cutoff="</span>,cutoff)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; cat(<span class="string">"k ="</span>,k,<span class="string">"p-value cutoff="</span>,cutoff)</div><div class="line">k = <span class="number">11</span> p-value cutoff= <span class="number">3.763357e-05</span></div></pre></td></tr></table></figure>
<p>我们可以从数学上证明到这个程序可以将FDR控制在5%以下，具体的算法可以参考Benjamini-Hochberg在1995年的论文。这种新的程序计算的结果就是将原来得到的2个有统计学差异的数值提高到了11个。如果我们将FDR的值设为50%，那么这个数字会提高到1063。FWER无法提供这种灵活性，因为只要检测值的数量增加，都会造成FWER的值为1。</p>
<p>这里我们需要注意的是，在R中，已经有了计算FDR的函数，前面的那些复杂代码只是为了说明这种算法，在R中我们可以使用下面的代码进行计算，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">fdr &lt;- p.adjust(pvals, method=<span class="string">"fdr"</span>)</div><div class="line">mypar(<span class="number">1</span>,<span class="number">1</span>)</div><div class="line">plot(pvals,fdr,log=<span class="string">"xy"</span>)</div><div class="line">abline(h=alpha,v=cutoff) <span class="comment">##cutoff was computed above</span></div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190831151618.jpeg">

</div>
<p>我们也可以使用Monte Carlo模拟来确认一下FDR的值实际上小于0.05，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">alpha &lt;- <span class="number">0.05</span></div><div class="line">B &lt;- <span class="number">1000</span> <span class="comment">##number of simulations. We should increase for more precision</span></div><div class="line">res &lt;- replicate(B,&#123;</div><div class="line">  controls &lt;- matrix(sample(population, N*m, replace=<span class="literal">TRUE</span>),nrow=m)</div><div class="line">  treatments &lt;- matrix(sample(population, N*m, replace=<span class="literal">TRUE</span>),nrow=m)</div><div class="line">  treatments[which(!nullHypothesis),]&lt;-treatments[which(!nullHypothesis),]+delta</div><div class="line">  dat &lt;- cbind(controls,treatments)</div><div class="line">  pvals &lt;- rowttests(dat,g)$p.value</div><div class="line">  <span class="comment">##then the FDR</span></div><div class="line">  calls &lt;- p.adjust(pvals,method=<span class="string">"fdr"</span>) &lt; alpha</div><div class="line">  R=sum(calls)</div><div class="line">  Q=ifelse(R&gt;<span class="number">0</span>,sum(nullHypothesis &amp; calls)/R,<span class="number">0</span>)</div><div class="line">  <span class="keyword">return</span>(c(R,Q))</div><div class="line">&#125;)</div><div class="line">Qs &lt;- res[<span class="number">2</span>,]</div><div class="line">mypar(<span class="number">1</span>,<span class="number">1</span>)</div><div class="line">hist(Qs) <span class="comment">##Q is a random variable, this is its distribution</span></div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190831180342.jpeg">

</div>
<p>上述是Q值的直方图（假阳性除以显著性特征值的数目），现在看一下FDR值，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">FDR=mean(Qs)</div><div class="line">print(FDR)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt; FDR=mean(Qs)</div><div class="line">&gt; print(FDR)</div><div class="line">[<span class="number">1</span>] <span class="number">0.03813818</span></div></pre></td></tr></table></figure>
<p>这个FDR的值小于0.05，这个结果是符合预期的，因为我们需要保守一点，从而确保任何值的<span class="math inline">\(m_{0}\)</span>的FDR都小于0.05，例如当每个假设检验都是零的极端情况，例如<span class="math inline">\(m=m_{0}\)</span>。如果你重新模拟上述情况，你会发现FDR会增加。</p>
<p>我们需要注意下面的值：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt; Rs &lt;- res[<span class="number">1</span>,]</div><div class="line">&gt; mean(Rs==<span class="number">0</span>)*<span class="number">100</span></div><div class="line">[<span class="number">1</span>] <span class="number">0.7</span></div></pre></td></tr></table></figure>
<p>在模拟中，这个比例是0.7%，我们没有调用任何有显著性差异的基因。</p>
<p>在R中，<code>p.adjust()</code>函数可以选择一些算法来控制FDR，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; p.adjust.methods</div><div class="line">[<span class="number">1</span>] <span class="string">"holm"</span>       <span class="string">"hochberg"</span>   <span class="string">"hommel"</span>     <span class="string">"bonferroni"</span> <span class="string">"BH"</span>         <span class="string">"BY"</span>         <span class="string">"fdr"</span>        <span class="string">"none"</span></div></pre></td></tr></table></figure>
<p>上面的这些方法不仅仅是估计错误率的不同方法，并且它们的估计值也不同，也就是说FWER与FDR不同。</p>
<h2 id="直接fdr与q值">直接FDR与q值</h2>
<p>这里我们先回顾一下由John D.Storey在J. R. Statist. Soc. B(2002)中提到的结果。Storey与Benjamini-Hochberg方法的不同之处在于，前者不再提前设定<span class="math inline">\(\alpha\)</span>水平。因为在一些高通量实验中，我们感兴趣的仅仅是找到一个基因列表用于验证这些基因，我们会事先考虑将那些p值小于0.01的基因都进行验证。我们人随后会考虑估计的错误率。通常使用这些方法，我们会确保我们的<span class="math inline">\(R&gt;0\)</span>。在上述定义的FDR里，当<span class="math inline">\(R=V=0\)</span>时，我们指定<span class="math inline">\(Q=0\)</span>，因此我们可以计算FDR如下所示： <span class="math display">\[
\mbox{FDR} = E\left( \frac{V}{R} \mid R&gt;0\right) \mbox{Pr}(R&gt;0)
\]</span> 在Storey提出的方法里，我们需要构建一个非空列表，也就是说<span class="math inline">\(R&gt;0\)</span>，那么我们计算阳性FDR(positive FDR)的公式如下所示： <span class="math display">\[
\mbox{pFDR} = E\left( \frac{V}{R} \mid R&gt;0\right)
\]</span> 第二点不同之处在于，Benjamini和Hochberg的程度是在最差的情况下进行控制，最差的情况是指零假设都为真（<span class="math inline">\(m=m_{0}\)</span>的情况），Storey的方法则是让我们从数据中估计<span class="math inline">\(m_{0}\)</span>。因为在高通量实验中，我们已经获得了如此多的数据，使Storey的算法成为了可能。这种算法的大致思路就是，挑选一个相对高值的p值cut-off，将它称为<span class="math inline">\(\lambda\)</span>，并且假设那些p值大于<span class="math inline">\(\Lambda\)</span>的检验在多数情况下其零假设是成立的，因此我们可以计算出估计值<span class="math inline">\(\pi_0 = m_0/m\)</span>为： <span class="math display">\[
\hat{\pi}_0 = \frac{\#\left\{p_i &gt; \lambda \right\} }{ (1-\lambda) m }
\]</span> 还有其它比这种算法更复杂的算法，但是它们的思路都是一样的，例如当我们设定<span class="math inline">\(\lambda=0.1\)</span>时，我们计算一下p值，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">hist(pvals,breaks=seq(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0.05</span>),freq=<span class="literal">FALSE</span>)</div><div class="line">lambda = <span class="number">0.1</span></div><div class="line">pi0=sum(pvals&gt; lambda) /((<span class="number">1</span>-lambda)*m)</div><div class="line">abline(h= pi0)</div><div class="line">print(pi0) <span class="comment">##this is close to the trye pi0=0.9</span></div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190901144305.jpeg">

</div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; print(pi0) ##this is close to the trye pi0=0.9</div><div class="line">[1] 0.9311111</div></pre></td></tr></table></figure>
<p>根据这个估计，我们可以改变一下Benjamini-Hochberg程序，例如选择一个<span class="math inline">\(k\)</span>作为最大值（<span class="math inline">\(k\)</span>这里是最大的<span class="math inline">\(i\)</span>），因此就有如下公式： <span class="math display">\[
\hat{\pi}_0 p_{(i)} \leq \frac{i}{m}\alpha
\]</span> 我们还有一种方法可以计算校正后的p值，即对每个检验计算q值(q-value)，如果一个特征计算的p值为<span class="math inline">\(p\)</span>，那么q值就是一系列含有最小p值为<span class="math inline">\(p\)</span>的特征值的估计pFDR。</p>
<p>除此之外，我们还有一种方法可以计算校正后的p值，即对每个检验计算q值(<code>q-value</code>)，如果一个特征最终计算的p值为<span class="math inline">\(p\)</span>，那么q值就是一系列含有尽可能最小与<span class="math inline">\(p\)</span>相等的p值的特征值的估计pFDR（原文是：However, instead of doing this, we compute a q-value for each test. If a feature resulted in a p-value of <span class="math inline">\(p\)</span>, the q-value is the estimated pFDR for a list of all the features with a p-value at least as small as <span class="math inline">\(p\)</span>.）。</p>
<p>上面这段我也不理解，后来查中文资料，根据Benjamini-Hochberg的算法，q值的定义如下所示：</p>
<p>对于m个独立的假设检验，它们对就的p值为：<span class="math inline">\(p_{i},i=1,2,\cdots,m\)</span></p>
<ol style="list-style-type: decimal">
<li>按照升序的方法对这些p值进行排序，得到：</li>
</ol>
<p><span class="math display">\[
p_{(1)} \leq p_{(1)} \cdots \leq p_{(m)}
\]</span></p>
<ol start="2" style="list-style-type: decimal">
<li>对于给定的统计学检验水平<span class="math inline">\(\alpha in(0,1]\)</span>，找到最大的<span class="math inline">\(k\)</span>，使得：</li>
</ol>
<p><span class="math display">\[
p_{(k)} \leq \frac{a*k}{m}
\]</span></p>
<ol start="3" style="list-style-type: decimal">
<li>对于排序靠前的<span class="math inline">\(k\)</span>个假设检验，认为它们是真阳性，看下面的案例：</li>
</ol>
<p>现在我们做了6个基因的检验，它们的p值如下所示：</p>
<table>
<thead>
<tr class="header">
<th>Gene</th>
<th>p-value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>G1</td>
<td>p1=0.053</td>
</tr>
<tr class="even">
<td>G2</td>
<td>p2=0.001</td>
</tr>
<tr class="odd">
<td>G3</td>
<td>p3=0.045</td>
</tr>
<tr class="even">
<td>G4</td>
<td>p4=0.03</td>
</tr>
<tr class="odd">
<td>G5</td>
<td>p5=0.02</td>
</tr>
<tr class="even">
<td>G6</td>
<td>p6=0.01</td>
</tr>
</tbody>
</table>
<p>现在取检测水平<span class="math inline">\(\alpha=0.05\)</span>，先把p值按从小到大的升序排列：</p>
<table>
<thead>
<tr class="header">
<th>Gene</th>
<th>p-value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>G2</td>
<td>p2=0.001</td>
</tr>
<tr class="even">
<td>G6</td>
<td>p6=0.01</td>
</tr>
<tr class="odd">
<td>G5</td>
<td>p5=0.02</td>
</tr>
<tr class="even">
<td>G4</td>
<td>p4=0.03</td>
</tr>
<tr class="odd">
<td>G3</td>
<td>p3=0.045</td>
</tr>
<tr class="even">
<td>G1</td>
<td>p1=0.053</td>
</tr>
</tbody>
</table>
<p>取检测水平<span class="math inline">\(\alpha=0.05\)</span>，现在我们找到一个值<span class="math inline">\(k\)</span>，这个<span class="math inline">\(k\)</span>满足以下公式： <span class="math display">\[
p_{(k)} \leq \frac{a*k}{m}
\]</span> 当<span class="math inline">\(k=1\)</span>时，<span class="math inline">\(p_{(1)}=0.001 &lt; 0.05*1/6=0.008333333\)</span></p>
<p>当<span class="math inline">\(k=2\)</span>时，<span class="math inline">\(p_{(2)}=0.01&lt;0.05*2/6=0.01666667\)</span></p>
<p>当<span class="math inline">\(k=3\)</span>时，<span class="math inline">\(p_{(3)}=0.02&lt;0.05*3/6=0.025\)</span></p>
<p>当<span class="math inline">\(k=4\)</span>时，<span class="math inline">\(p_{(4)}=0.03&lt;0.05*4/6=0.03333333\)</span></p>
<p>当<span class="math inline">\(k=5\)</span>时，<span class="math inline">\(p_{(5)}=0.045&gt;0.05*5/6=0.04166667\)</span></p>
<p>当<span class="math inline">\(k=6\)</span>时，<span class="math inline">\(p_{(6)}=0.053&gt;0.05*6/6=0.05\)</span></p>
<p>从上面的计算过程可以知道，这个<span class="math inline">\(k\)</span>等于4，也就是说，在FDR&lt;0.05的情况下，G2，G6，G5，G4有差异。</p>
<p>到这里，只是说明了，G2，G6，G5，G4是有差异的，但是q值还没有算出来，继续计算：</p>
<p>前面我们已经把原始的p值按照从小到大的顺序排列好了，也就是<code>[1] 0.001 0.010 0.020 0.030 0.045 0.053</code>，其中最大的p值是<code>0.053</code>，它校正后还是这个值，也就是说这个值是校正后的最大p值，次大的p值是<code>0.045</code>，这个值需要校正，它排序是第5，那么校正的公式就是所有p值的数目（一共是6个p值）除以秩（这里是5），再乘以p值大小，也就是<code>0.045*6/5=0.054</code>，但是，这个值已经大于原来最大的p值（0.053）了，因此这个把它校正后的值也作为0.053，再看倒数第3个值，即0.03的校正p值，即<code>0.03*6/4=0.045</code>，它小于0.053，因此它校正后可以是0.045，现在依次校正剩下的值：</p>
<p><code>0.02*6/3=0.04</code>，<code>0.01*6/2=0.03</code>，<code>0.001*6/1=0.006</code>，也就是说校正后的p值（就是q值），按从小到大的顺序排列就是：<code>0.006，0.03，0.04，0.045，0.053，0.053</code>，从结果中我们可以发现，前4个是有差异的，它们都小于0.05，也就是说G2，G6，G5，G4有差异。</p>
<p>其实公式就是： <span class="math display">\[
q^{(i)}=p_{(k)}^{(i)} * \frac{\text {Total Gene } N u m b e r}{\operatorname{rank}\left(p^{(i)}\right)}=p_{(k)}^{(i)} * \frac{m}{k}
\]</span> 以上是BH法进行q值计算的过程，R中可以使用<code>p.adjust()</code>函数计算q值，所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">p1 &lt;- <span class="number">0.053</span></div><div class="line">p2 &lt;- <span class="number">0.001</span></div><div class="line">p3 &lt;- <span class="number">0.045</span></div><div class="line">p4 &lt;- <span class="number">0.03</span></div><div class="line">p5 &lt;- <span class="number">0.02</span></div><div class="line">p6 &lt;- <span class="number">0.01</span></div><div class="line"></div><div class="line">p0 &lt;- c(p1,p2,p3,p4,p5,p6)</div><div class="line">p.adjust(p0,method = <span class="string">"BH"</span>)</div><div class="line">p.adjust(sort(p0),method = <span class="string">"BH"</span>)</div><div class="line">p.adjust(sort(p0),method = <span class="string">"fdr"</span>)</div><div class="line">sort(p.adjust(p0,method = <span class="string">"BH"</span>))</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&gt; p.adjust(p0,method = <span class="string">"BH"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0.053</span> <span class="number">0.006</span> <span class="number">0.053</span> <span class="number">0.045</span> <span class="number">0.040</span> <span class="number">0.030</span></div><div class="line">&gt; p.adjust(sort(p0),method = <span class="string">"BH"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0.006</span> <span class="number">0.030</span> <span class="number">0.040</span> <span class="number">0.045</span> <span class="number">0.053</span> <span class="number">0.053</span></div><div class="line">&gt; p.adjust(sort(p0),method = <span class="string">"fdr"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0.006</span> <span class="number">0.030</span> <span class="number">0.040</span> <span class="number">0.045</span> <span class="number">0.053</span> <span class="number">0.053</span></div><div class="line">&gt; sort(p.adjust(p0,method = <span class="string">"BH"</span>))</div><div class="line">[<span class="number">1</span>] <span class="number">0.006</span> <span class="number">0.030</span> <span class="number">0.040</span> <span class="number">0.045</span> <span class="number">0.053</span> <span class="number">0.053</span></div></pre></td></tr></table></figure>
<p>从上面的计算结果看来：</p>
<ol style="list-style-type: decimal">
<li><code>method=&quot;BH&quot;</code>等于<code>method=&quot;fdr&quot;</code>，结果没有区别；</li>
<li>在使用<code>p.adjust()</code>函数计算q值时，不用对原始数据进行排序，如果想要结果按从小到大的序列排列，那么就排序原始值，或计算后的值均可。</li>
</ol>
<p>回到原文。</p>
<p>在R中，<code>qvalue</code>包中的<code>qvalue()</code>函数可以用来计算q值，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(qvalue)</div><div class="line">res &lt;- qvalue(pvals)</div><div class="line">qvals &lt;- res$qvalues</div><div class="line">plot(pvals,qvals)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190902153110.jpeg">

</div>
<p>估计一下<span class="math inline">\(\hat{\pi_{0}}\)</span>，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; res$pi0</div><div class="line">[<span class="number">1</span>] <span class="number">0.8813727</span></div></pre></td></tr></table></figure>
<h2 id="练习">练习</h2>
<p>P274</p>
<h2 id="基础探索数据分析">基础探索数据分析</h2>
<p>与低通量数据相比，高通量数据的一个被低估的优点就是它很容易展现数据。例如当我们有了海量的高通量数据后，我们很容易发现那些在少量数据时并不明显的问题。研究这些数据的一个强有力工具就是探索性数据分析(EDA,exploratory data analysis)。这一部分我们就来了解这方面的内容，可以参考作者的<a href="https://github.com/genomicsclass/labs/tree/master/advinference/eda_for_highthroughput.Rmd" target="_blank" rel="external">Github上的原文</a>。</p>
<h3 id="火山图">火山图</h3>
<p>我们使用前面数据做的t检验结果来看一下火山图，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(genefilter)</div><div class="line"><span class="keyword">library</span>(GSE5859Subset)</div><div class="line">data(GSE5859Subset)</div><div class="line">g &lt;- factor(sampleInfo$group)</div><div class="line">results &lt;- rowttests(geneExpression,g)</div><div class="line">pvals &lt;- results$p.value</div></pre></td></tr></table></figure>
<p>我们还可以从一个数据集中生成一些p值，这些数据集中的零假设为真，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">m &lt;- nrow(geneExpression)</div><div class="line">n &lt;- ncol(geneExpression)</div><div class="line">randomData &lt;- matrix(rnorm(n*m),m,n)</div><div class="line">nullpvals &lt;- rowttests(randomData,g)$p.value</div></pre></td></tr></table></figure>
<p>我们前面提到过，当我们报告效应大小(effect size)时，如果仅仅计算p值则会造成一些错误。我们可以通过画一个火山图来展示高通量数据的统计结果。火山图背后的思想是，它能展示出所有的特征值（这里指的是基因表达谱）。火山图的y轴是<code>-log(base 10) p-value</code>，x轴是效应大小(effect size)。当我们经过<code>-log(base 10)</code>转换后，那些有着极显著差异的特征值就会出现在火山图的上方。这里使用log转换是因为，我们可用log转换可以更好地区分一些非常小的数据，例如区分<code>0.01</code>和<span class="math inline">\(10^6\)</span>，此时我们来绘制一个火山图，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">plot(results$dm,-log10(results$p.value),</div><div class="line">xlab=<span class="string">"Effect size"</span>,ylab=<span class="string">"- log (base 10) p-values"</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190902194350.jpeg">

</div>
<h3 id="p值直方图">p值直方图</h3>
<p>另外一种看整体数据的思路就是绘制p值的直方图。当我们的数据完全无效时，那么p值的直方图是服从均匀分布的，而我们的数据有效时，我们可以发现较小的p值频率较高，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(rafalib)</div><div class="line">mypar(<span class="number">1</span>,<span class="number">2</span>)</div><div class="line">hist(nullpvals,ylim=c(<span class="number">0</span>,<span class="number">1400</span>))</div><div class="line">hist(pvals,ylim=c(<span class="number">0</span>,<span class="number">1400</span>))</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190902194645.jpeg">

</div>
<p>左侧的p值是无效数据产生的p值，它服从均匀分布，右侧的p值则是则是我们基因表达谱的数据。</p>
<p>当我们预期大多数假设都是无效时，我们就不会看到服从均匀分布的p值，它也许是一些异常属性的指标，例如相关的样本。如果我们对结果时行置换检验，并计算出p值后，如果样本是独立的，那么我们应该会看到均匀分布，但是，我们的数据却看不到这个结果：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">permg &lt;- sample(g)</div><div class="line">permresults &lt;- rowttests(geneExpression,permg)</div><div class="line">hist(permresults$p.value)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190902195138.jpeg">

</div>
<p>在后面部分中，我们会了解到这个数据集中的每个检验并不是独立的，因此这里用于检验的假设（我们使用的是t检验，而t检验的前提就是样本独立）是不正确的。</p>
<h3 id="箱线图与直方图">箱线图与直方图</h3>
<p>高通量数据实验中，我们会检测每个实验单元的数千个特征值，我们前面也提到了，使用箱线图可以辅助我们来判断这些数据的质量。例如，如果一个样本的分布完全不同于剩余的样本，那么我们就可以认为，这个样本存在着一定问题。虽然一个完全的完全的变化可能是由于真正的生物学差异引起的，但是多数情况下，这就是技术因素造成的。这里我们使用Bioconductor中的基因表达数据，为了模拟出一组异常的数据，我们会对其中的一个样本进行log2转换，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#BiocManager::install("Biobase")</span></div><div class="line"><span class="comment">#devtools::install_github("genomicsclass/GSE5859")</span></div><div class="line"><span class="keyword">library</span>(Biobase)</div><div class="line"><span class="keyword">library</span>(genefilter)</div><div class="line">load(<span class="string">"GSE5859.rda"</span>)</div><div class="line">data(GSE5859)</div><div class="line">ge &lt;- exprs(e) <span class="comment">##ge for gene expression</span></div><div class="line">ge[,<span class="number">49</span>] &lt;- ge[,<span class="number">49</span>]/log2(exp(<span class="number">1</span>)) <span class="comment">##immitate error</span></div><div class="line"></div><div class="line"><span class="keyword">library</span>(rafalib)</div><div class="line">mypar(<span class="number">1</span>,<span class="number">1</span>)</div><div class="line">boxplot(ge,range=<span class="number">0</span>,names=<span class="number">1</span>:ncol(e),col=ifelse(<span class="number">1</span>:ncol(ge)==<span class="number">49</span>,<span class="number">1</span>,<span class="number">2</span>))</div></pre></td></tr></table></figure>
<p>运行过重中发现，<code>GSE5859</code>这个包无法安装，因此可以去官网下载原始文件，直接加载到RStudio中，另外在加载<code>data(GSE5859)</code>时会出错，不用管，运行就行，图形如下所示：</p>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190902202117.jpeg">

</div>
<p>从上图我们可以看到，样本数据大，很难看清楚中间的箱子形状，但是我们很容易发现有一个样本异常，除此之外，我们可以用另外一种方式来展示一下数据，这个数据不画箱子，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">qs &lt;- t(apply(ge,<span class="number">2</span>,quantile,prob=c(<span class="number">0.05</span>,<span class="number">0.25</span>,<span class="number">0.5</span>,<span class="number">0.75</span>,<span class="number">0.95</span>)))</div><div class="line">matplot(qs,type=<span class="string">"l"</span>,lty=<span class="number">1</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190902202322.jpeg">

</div>
<p>这种图形可以称为<code>kaboxplot</code>，因为这是由Karl Broman首次使用的，它绘制的是0.05，0.25，0.5，0.75和0.95分位数的图形。</p>
<p>我们也可以绘制直方图。因为我们的数据很多，因此可以使用很窄的间隔(bin)与柱子，然后将这些柱子进行平滑处理，最终绘制成平滑直方图(smooth histogram)。我们重新再校正这些平滑曲线的高度，那么在<span class="math inline">\(x_{0}\)</span>处的高度与基本单元构成的面积内，它们的点的数目就都比较接近，如下所示：</p>
<p>元区域内的点的数目就与这个基本单元的面积接近积，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mypar(<span class="number">1</span>,<span class="number">1</span>)</div><div class="line">shist(ge,unit=<span class="number">0.5</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190902202859.jpeg">

</div>
<h3 id="ma图">MA图</h3>
<p>散点图(scatterplot)与相关性(correlation)不是检测重复性问题的最佳工具。检测重复性更好的工作就是检测两次之间的差值，如果重复性好，那么这些差值应该是一样的。因此，一种更好的绘图工具就是将散点图旋转一下，这个散点图的y轴上差值，x轴是平均值。这种图最初被叫做Bland-Altman图，但在遗传学中它经常被称为MA图。MA的名称来源于图形的内容，M表示减(minus)，表示两值之差（有的时候是log值之差），A表示平均(Average)，现在绘制一下MA图</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">x &lt;- ge[,<span class="number">1</span>]</div><div class="line">y &lt;- ge[,<span class="number">2</span>]</div><div class="line">mypar(<span class="number">1</span>,<span class="number">2</span>)</div><div class="line">plot(x,y)</div><div class="line">plot((x+y)/<span class="number">2</span>,x-y)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190902215832.jpeg">

</div>
<p>左图是常规的相关图，右图是MA图，需要注意的是，当我们把左图进行旋转后，这些数据的差异的SD就非常直观了：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sd(y-x)</div><div class="line">[<span class="number">1</span>] <span class="number">0.2025465</span></div></pre></td></tr></table></figure>
<p>左图的散点图显示这两个样本的相关性很强，但是显示的信息有限。</p>
<h2 id="参考资料">参考资料</h2>
<ol style="list-style-type: decimal">
<li><a href="https://www.jianshu.com/p/d86823ecd3ac" target="_blank" rel="external">如何理解与计算FDR？（第二版）</a></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-tags" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rvdsd.top/2019/08/21/ggplot2/gganimate/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="RVDSD">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RVDSD的个人笔记本">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/21/ggplot2/gganimate/" itemprop="url">gganimate</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-21T12:00:00+08:00">
                2019-08-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ggplot2/" itemprop="url" rel="index">
                    <span itemprop="name">ggplot2</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  56
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言">前言</h2>
<p><code>gganimate</code> 包是对<code>ggplot2</code>包的扩展，主要用于生成动画。</p>
<h2 id="案例">案例</h2>
<p>如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(ggplot2)</div><div class="line"><span class="keyword">library</span>(gganimate)</div><div class="line"><span class="keyword">library</span>(gifski)</div><div class="line"></div><div class="line">ggplot(mtcars, aes(factor(cyl), mpg)) + </div><div class="line">  geom_boxplot() + </div><div class="line">  <span class="comment"># Here comes the gganimate code</span></div><div class="line">  transition_states(</div><div class="line">    gear,</div><div class="line">    transition_length = <span class="number">2</span>,</div><div class="line">    state_length = <span class="number">1</span></div><div class="line">  ) +</div><div class="line">  enter_fade() + </div><div class="line">  exit_shrink() +</div><div class="line">  ease_aes(<span class="string">'sine-in-out'</span>)</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-tags" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rvdsd.top/2019/08/20/DAL/DALS016_InferenceForHighDimensionalData1_Basic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="RVDSD">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RVDSD的个人笔记本">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/20/DAL/DALS016_InferenceForHighDimensionalData1_Basic/" itemprop="url">DALS016-高维数据推断1-背景介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-20T12:00:00+08:00">
                2019-08-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/生物统计/" itemprop="url" rel="index">
                    <span itemprop="name">生物统计</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3,781
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  16
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言">前言</h2>
<p>这一部分是《Data Analysis for the life sciences》的第6章线性高维数据推断(Inference For High Dimensional Data)的第1小节，这一部分的主要内容涉及高通量数据的介绍，统计学的一些注意事项，相应的R markdown文档可以参考作者的<a href="https://github.com/genomicsclass/labs/tree/master/advinference/intro_to_highthroughput_data.Rmd" target="_blank" rel="external">Github</a>。</p>
<h3 id="高通量技术">高通量技术</h3>
<p>高通量技术已经将基础生物学和生物学从数据贫乏型学科尾成了数据密集型学科。一个典型的例子就是那些对基因表达有兴趣的研究领域。基因表达是这样一个过程，将生命蓝图DNA复制到RNA，而RNA是蛋白质合成的模板，是构成生命的基石。在20世纪90年代，对基因表达数据的分析相当于在一张纸上画了几个点，或从标准曲线上提取了几个数字。随着微阵列等高通量技术的发展，这几个数据就突然变成了筛选成千上万的数字。最近，RNA测序技术又进一步增加了数据的复杂性。生物学家们从使用他们的肉眼或简单的方法来分析结果到每个样本有数千（现在则是数百万个）个数据的分析。在这一篇中，我们佬双重点关注高通量数量的统计推断。具体来说就是，我们会使用统计检验来检测不同组之间的差异，以及使用有意义的方法来量化不确定性问题。我们还公介绍探索性数据分析方法，这些方法会结合高通量数据进行使用。在后面的章节中，我们会研究聚类，机器学习，因子分析和多层级建模(multi-level)。</p>
<p>由于现在有大量可用的公共数据集，我们会使用这些公共数据集来作为我们的学习案例。尽量使用的是公共数据，但是当你学习了这些方法后，在使用了高通量数据技术的其它领域也会派上用场。这些高通量技术包括微阵列，NGS，fRMI与蛋白质谱等。</p>
<h3 id="数据包">数据包</h3>
<p>我们这里使用的数据文件已经在作者的Github上分享了，因此使用<code>devtools</code>包就可以直接下载，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(devtools)</div><div class="line">install_github(<span class="string">"genomicsclass/GSE5859Subset"</span>)</div></pre></td></tr></table></figure>
<h3 id="张表">3张表</h3>
<p>我们用来做为案例学习的这些数据多数都是使用高通量技术生成的。这些技术会检测数千个特征值(feature)。这些特征值可以是基因，可以是基因组的单碱基位置，基因区域，以及图像的像素密度（芯片数据）。每个特定的检测产品被都会被相应地一组特定的功能所定义（我的理解就是，某公司的特定产品，例如检测miRNA的芯片，它的检测结果就是一些表达值，而这些表达值代表了哪些miRNA，就还需要另外一个miRNA名称的数据文件），例如特定基因表达的微阵列数据被一组其检测的基因所定义。一个特定的研究通常会使用一种产品对几个实验单元进行检验，例如几个人的样本。最常见的就是人，不过实验产单元也可以是其它的东西，例如肿瘤组织的一部分。按照实验术语，我们通常称实验单元为样本，这个样本与前面讲的随机样本不是一个东西，后者是统计学术语。</p>
<p>因此，一个高能被实验通常由3张表定义：一个是高通量数据的检测值，第二与第三表是关于列与行的信息。由于这些数据集通常是由一系列的实验单元，以及一些固定的特征构成，因此，高通量数据可以储存为<span class="math inline">\(n \times m\)</span>的形式，其中<span class="math inline">\(n\)</span>表示实验单元（样本），而<span class="math inline">\(m\)</span>表示特征值（通常就是基因），现在 我们来看一个案例：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(GSE5859Subset)</div><div class="line">data(GSE5859Subset) <span class="comment">##this loads the three tables</span></div><div class="line">dim(geneExpression)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; dim(geneExpression)</div><div class="line">[<span class="number">1</span>] <span class="number">8793</span>   <span class="number">24</span></div></pre></td></tr></table></figure>
<p>这个数据是RNA表达谱数据，它检测了24个人（实验单元）的8793个基因。对于大多数的统计分析来说，我们还需要实验样本的一些信息。例如，在这个案例中，最初收集的数据是用于比较不同种族群体的基因表达情况。但是，我们已经创建了这个数据集的一个子集用于说明样本的信息情况，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dim(sampleInfo)</div><div class="line">head(sampleInfo)</div><div class="line">sampleInfo$group</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&gt; dim(sampleInfo)</div><div class="line">[<span class="number">1</span>] <span class="number">24</span>  <span class="number">4</span></div><div class="line">&gt; head(sampleInfo)</div><div class="line">    ethnicity       date         filename group</div><div class="line"><span class="number">107</span>       ASN <span class="number">2005</span>-<span class="number">06</span>-<span class="number">23</span> GSM136508.CEL.gz     <span class="number">1</span></div><div class="line"><span class="number">122</span>       ASN <span class="number">2005</span>-<span class="number">06</span>-<span class="number">27</span> GSM136530.CEL.gz     <span class="number">1</span></div><div class="line"><span class="number">113</span>       ASN <span class="number">2005</span>-<span class="number">06</span>-<span class="number">27</span> GSM136517.CEL.gz     <span class="number">1</span></div><div class="line"><span class="number">163</span>       ASN <span class="number">2005</span>-<span class="number">10</span>-<span class="number">28</span> GSM136576.CEL.gz     <span class="number">1</span></div><div class="line"><span class="number">153</span>       ASN <span class="number">2005</span>-<span class="number">10</span>-<span class="number">07</span> GSM136566.CEL.gz     <span class="number">1</span></div><div class="line"><span class="number">161</span>       ASN <span class="number">2005</span>-<span class="number">10</span>-<span class="number">07</span> GSM136574.CEL.gz     <span class="number">1</span></div><div class="line">&gt; sampleInfo$group</div><div class="line"> [<span class="number">1</span>] <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></div></pre></td></tr></table></figure>
<p>关于样本信息中的一列是文件名，它可以让我们把这个表的行与表达谱的列连接起来，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">match(sampleInfo$filename,colnames(geneExpression))</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; match(sampleInfo$filename,colnames(geneExpression))</div><div class="line"> [<span class="number">1</span>]  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span> <span class="number">10</span> <span class="number">11</span> <span class="number">12</span> <span class="number">13</span> <span class="number">14</span> <span class="number">15</span> <span class="number">16</span> <span class="number">17</span> <span class="number">18</span> <span class="number">19</span> <span class="number">20</span> <span class="number">21</span> <span class="number">22</span> <span class="number">23</span> <span class="number">24</span></div></pre></td></tr></table></figure>
<p>最后，我们还有一张描述特征值的表格，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">dim(geneAnnotation)</div><div class="line">head(geneAnnotation)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&gt; dim(geneAnnotation)</div><div class="line">[<span class="number">1</span>] <span class="number">8793</span>    <span class="number">4</span></div><div class="line">&gt; head(geneAnnotation)</div><div class="line">     PROBEID  CHR     CHRLOC SYMBOL</div><div class="line"><span class="number">1</span>  1007_s_at chr6   <span class="number">30852327</span>   DDR1</div><div class="line"><span class="number">30</span>   1053_at chr7  -<span class="number">73645832</span>   RFC2</div><div class="line"><span class="number">31</span>    117_at chr1  <span class="number">161494036</span>  HSPA6</div><div class="line"><span class="number">32</span>    121_at chr2 -<span class="number">113973574</span>   PAX8</div><div class="line"><span class="number">33</span> 1255_g_at chr6   <span class="number">42123144</span> GUCA1A</div><div class="line"><span class="number">34</span>   1294_at chr3  -<span class="number">49842638</span>   UBA7</div></pre></td></tr></table></figure>
<p>从上面的信息知道，<code>geneAnnotation</code>这个文件里含有ID，这个表的行可以与表达谱的行连接起来，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">head(match(geneAnnotation$PROBEID,rownames(geneExpression)))</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; head(match(geneAnnotation$PROBEID,rownames(geneExpression)))</div><div class="line">[<span class="number">1</span>] <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span></div></pre></td></tr></table></figure>
<h2 id="实际应用">实际应用</h2>
<p>现在假设我们已经拥有了一批高通量数据，这个数据是检测了两组中一些人的基因表达情况。现在我们的问题是：在这两组人中，哪些基因的表达均值存在差异？如果是一个基因，计算起来很简单，我们手工计算就行，但是，高通常数量通常都是几千个基因，显然手工算不太现实，但是寻找差异基因的方法跟前面我们提到的统计推断原理一样。例如，我们可以使用t检验或其它检验来寻找差异基因。</p>
<h3 id="随机变量的p值">随机变量的p值</h3>
<p>这里我们要强调的一个概念就是，p值是一个随机变量。为了能说明这一点，我们来看一个案例。在这个案例中，我们会使用CLT近似的原来生成大量的样本，并通过t检验来计算其p值。然后我们的p值被定义为，正态分布的随机变量的绝对值大于观察到的t检验r值的概率，被称为<span class="math inline">\(Z\)</span>（书中原话是：Then our p-value is defined as the probability that a normally distributed random variable is larger, in absolute value, than the observed t-test, call it Z.），因此，双尾检验的p值公式如下所示： <span class="math display">\[
p = 2 \{ 1 - \Phi(\mid Z \mid)\}
\]</span> 在R中则为：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">2</span>*(<span class="number">1</span>-pnorm(Z))</div></pre></td></tr></table></figure>
<p>因为<span class="math inline">\(Z\)</span>是一个随机变量，并且<span class="math inline">\(\Phi\)</span>是一个确定的函数，<span class="math inline">\(p\)</span>因此也是一个随机变量。我们现在使用Monte Carlo模拟来显示一下<span class="math inline">\(p\)</span>值的变化，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">set.seed(<span class="number">1</span>)</div><div class="line"></div><div class="line">dir &lt;- system.file(package = <span class="string">"dagdata"</span>)</div><div class="line">filename &lt;- file.path(dir,<span class="string">"extdata/femaleControlsPopulation.csv"</span>)</div><div class="line">population &lt;- read.csv(filename)</div><div class="line">population &lt;- unlist(population) <span class="comment"># turn it into a numeric</span></div><div class="line">N &lt;- <span class="number">12</span></div><div class="line">B &lt;- <span class="number">10000</span></div><div class="line">pvals &lt;- replicate(B,&#123;</div><div class="line">  control = sample(population,N)</div><div class="line">  treatment = sample(population,N)</div><div class="line">  t.test(treatment,control)$p.val</div><div class="line">&#125;)</div><div class="line">hist(pvals)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190828112405.jpeg">

</div>
<p>从直方图中我们可以看到，p值属于均匀分布。事实上，我们可以从理论上证明，当零假设为真是，情况确实如此。当我们使用CLT时，我们的零假设<span class="math inline">\(H_{0}\)</span>意味着我们的检验统计量Z服从均值为0，SD为1的正态分布，因此： <span class="math display">\[
p_a = \mbox{Pr}(Z &lt; a \mid H_0) = \Phi(a)
\]</span> 这也说明： <span class="math display">\[
\begin{align*}
\mbox{Pr}(p &lt; p_a) &amp;= \mbox{Pr}[ \Phi^{-1}(p) &lt; \Phi^{-1}(p_a) ] \\
  &amp; = \mbox{Pr}(Z &lt; a) = p_a
\end{align*}
\]</span> 这其实就是均匀分布(uniform distribution)的定义。</p>
<h3 id="千次检验">千次检验</h3>
<p>在上面的案例中，我们有两组数据，分别用0和1表示，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(GSE5859Subset)</div><div class="line">data(GSE5859Subset)</div><div class="line">g &lt;- sampleInfo$group</div><div class="line">g</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt; <span class="keyword">library</span>(GSE5859Subset)</div><div class="line">&gt; data(GSE5859Subset)</div><div class="line">&gt; g &lt;- sampleInfo$group</div><div class="line">&gt; g</div><div class="line"> [<span class="number">1</span>] <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></div></pre></td></tr></table></figure>
<p>如果我们对某个特定的基因感兴趣，例如第25行的那个基因，那么我们就可以简单地使用t检验就行，为了计算p值，我们需要先看一下这个基因数据是否服从t分布，因此我们可以使用qq图来绘制，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">e &lt;- geneExpression[<span class="number">25</span>,]</div><div class="line">e</div><div class="line"><span class="keyword">library</span>(rafalib)</div><div class="line">mypar(<span class="number">1</span>,<span class="number">2</span>)</div><div class="line">qqnorm(e[g==<span class="number">1</span>])</div><div class="line">qqline(e[g==<span class="number">1</span>])</div><div class="line">qqnorm(e[g==<span class="number">0</span>])</div><div class="line">qqline(e[g==<span class="number">0</span>])</div></pre></td></tr></table></figure>
<p>结果如下所示： <figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&gt; e</div><div class="line">GSM136508.CEL.gz GSM136530.CEL.gz GSM136517.CEL.gz GSM136576.CEL.gz GSM136566.CEL.gz GSM136574.CEL.gz GSM136575.CEL.gz </div><div class="line">        <span class="number">10.34172</span>         <span class="number">10.64662</span>         <span class="number">10.69198</span>         <span class="number">10.96155</span>         <span class="number">10.24889</span>         <span class="number">10.74414</span>         <span class="number">10.22206</span> </div><div class="line">GSM136569.CEL.gz GSM136568.CEL.gz GSM136559.CEL.gz GSM136565.CEL.gz GSM136573.CEL.gz GSM136523.CEL.gz GSM136509.CEL.gz </div><div class="line">        <span class="number">10.49094</span>         <span class="number">10.57574</span>         <span class="number">10.47758</span>         <span class="number">10.43493</span>         <span class="number">10.46440</span>         <span class="number">10.58358</span>         <span class="number">10.39607</span> </div><div class="line">GSM136727.CEL.gz GSM136510.CEL.gz GSM136515.CEL.gz GSM136522.CEL.gz GSM136507.CEL.gz GSM136524.CEL.gz GSM136514.CEL.gz </div><div class="line">        <span class="number">10.75837</span>         <span class="number">10.37383</span>         <span class="number">10.57540</span>         <span class="number">10.51203</span>         <span class="number">10.39952</span>         <span class="number">10.70539</span>         <span class="number">10.77077</span> </div><div class="line">GSM136563.CEL.gz GSM136564.CEL.gz GSM136572.CEL.gz </div><div class="line">        <span class="number">10.38333</span>         <span class="number">10.31405</span>         <span class="number">10.25655</span></div></pre></td></tr></table></figure></p>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190828180606.jpeg">

</div>
<p>qq显示，这个数据比较接近于正态分布，但是t检验发现，这个基因在两组之间并无差异，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">t.test(e[g==<span class="number">1</span>],e[g==<span class="number">0</span>])$p.value</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; t.test(e[g==<span class="number">1</span>],e[g==<span class="number">0</span>])$p.value</div><div class="line">[<span class="number">1</span>] <span class="number">0.779303</span></div></pre></td></tr></table></figure>
<p>上面是只计算1个基因的情况，如果要计算所有的基因，那么就需要对每个基因进行t检验，我们来构建一个函数，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">myttest &lt;- <span class="keyword">function</span>(x) t.test(x[g==<span class="number">1</span>],x[g==<span class="number">0</span>],var.equal=<span class="literal">TRUE</span>)$p.value</div><div class="line">pvals &lt;- apply(geneExpression,<span class="number">1</span>,myttest)</div><div class="line">head(pvals)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt; head(pvals)</div><div class="line"> 1007_s_at    1053_at     117_at     121_at  1255_g_at    1294_at </div><div class="line"><span class="number">0.04553344</span> <span class="number">0.03370683</span> <span class="number">0.13604026</span> <span class="number">0.59413846</span> <span class="number">0.96849102</span> <span class="number">0.08489586</span></div></pre></td></tr></table></figure>
<p>现在我们来看一下，p值小于0.05的基因有多少个，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sum(pvals&lt;<span class="number">0.05</span>)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; sum(pvals&lt;<span class="number">0.05</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">1383</span></div></pre></td></tr></table></figure>
<p>也就是说，有1383个基因有差异。</p>
<p>但是，正如我们随后即将详细描述的那样，对于这个结果，我们要谨慎对待。因为这个结果是我们经过8000多次比较后得到的结果（数据集里一共有个8793基因）。如果我们对一批随机数据执行相同的计算过程，在零假设成立的前提下，我们也能计算出一批p值，并且这批p值小于0.05的数目为：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">set.seed(<span class="number">1</span>)</div><div class="line">m &lt;- nrow(geneExpression)</div><div class="line">n &lt;- ncol(geneExpression)</div><div class="line">randomData &lt;- matrix(rnorm(n*m),m,n)</div><div class="line">nullpvals &lt;- apply(randomData,<span class="number">1</span>,myttest)</div><div class="line">sum(nullpvals&lt;<span class="number">0.05</span>)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; sum(nullpvals&lt;<span class="number">0.05</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">419</span></div></pre></td></tr></table></figure>
<p>随后，我们会解释一下这个数值是怎么一回事，实际上，这个数字大概就是8192*0.05的结果（大约为409.6），后面会详细介绍这个原理。</p>
<h3 id="加快t检验的计算">加快t检验的计算</h3>
<p>在我们开始之前，我们需要知道，前面我们构建了一个做t检验的函数，虽然它能计算出相应的p值，但是这种方法比较低效。我们还有其它更快的方法实现这一目的，在Bioconductor项目中就有这样的函数，此时我们要用到<code>rafalib</code>包中的<code>install_bioc()</code>函数，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">install_bioc(<span class="string">"genefilter"</span>)</div></pre></td></tr></table></figure>
<p>现在我们使用<code>rowttests()</code>函数来计算一下p值，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(genefilter)</div><div class="line">results &lt;- rowttests(geneExpression,factor(g))</div><div class="line">max(abs(pvals-results$p))</div><div class="line">sum(results$p&lt;<span class="number">0.05</span>)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt; max(abs(pvals-results$p))</div><div class="line">[<span class="number">1</span>] <span class="number">6.528111e-14</span></div><div class="line">&gt; sum(results$p&lt;<span class="number">0.05</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">1383</span></div></pre></td></tr></table></figure>
<h2 id="p值计算练习">p值计算练习</h2>
<p>为了更好地理解p值是一个随机变量，现在我们再来看一些案例，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">set.seed(<span class="number">1</span>)</div><div class="line"><span class="keyword">library</span>(downloader)</div><div class="line">url = <span class="string">"https://raw.githubusercontent.com/genomicsclass/dagdata/master/inst/extda\</span></div><div class="line"><span class="string">ta/femaleControlsPopulation.csv"</span></div><div class="line">filename = <span class="string">"femaleControlsPopulation.csv"</span></div><div class="line"><span class="keyword">if</span> (!file.exists(filename)) download(url,destfile=filename)</div><div class="line">population = read.csv(filename)</div><div class="line"></div><div class="line">pvals &lt;- replicate(<span class="number">1000</span>,&#123;</div><div class="line">  control = sample(population,<span class="number">12</span>)</div><div class="line">  treatment = sample(population,<span class="number">12</span>)</div><div class="line">  t.test(treatment,control)$p.val&#125;)</div><div class="line">head(pvals)</div><div class="line">hist(pvals)</div></pre></td></tr></table></figure>
<p>结果如下所示： <figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; head(pvals)</div><div class="line">[<span class="number">1</span>] <span class="number">0.76454370</span> <span class="number">0.60237592</span> <span class="number">0.49679830</span> <span class="number">0.23518016</span> <span class="number">0.20882028</span> <span class="number">0.06812489</span></div></pre></td></tr></table></figure></p>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190828191526.jpeg">

</div>
<p>现在回答以下几个问题：</p>
<p><strong>问题一</strong>：小于0.05的p值所占的比例是多少？</p>
<p>答：4.1%，代码如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; sum(pvals &lt; <span class="number">0.05</span>)/length(pvals)*<span class="number">100</span></div><div class="line">[<span class="number">1</span>] <span class="number">4.1</span></div></pre></td></tr></table></figure>
<p><strong>问题二</strong>：小于0.01的p值所占的比例是多少？</p>
<p>答：0.8%，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; sum(pvals &lt; <span class="number">0.01</span>)/length(pvals)*<span class="number">100</span></div><div class="line">[<span class="number">1</span>] <span class="number">0.8</span></div></pre></td></tr></table></figure>
<p><strong>问题三</strong>：假设你正在测试20种饮食对小鼠体重影响的效应。对于20种饮食中的每一种，我们都使用10只对照小鼠和10只实验小鼠。在零假设成立时，也就是说饮食对小鼠的体重没有影响，另外，小鼠的体重是服从正态分布的（均值为30g，SD为2g）。我们对其中的一项进行Monte Carlo模拟：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cases = rnorm(<span class="number">10</span>,<span class="number">30</span>,<span class="number">2</span>)</div><div class="line">controls = rnorm(<span class="number">10</span>,<span class="number">30</span>,<span class="number">2</span>)</div><div class="line">t.test(cases,controls)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&gt; cases = rnorm(<span class="number">10</span>,<span class="number">30</span>,<span class="number">2</span>)</div><div class="line">&gt; controls = rnorm(<span class="number">10</span>,<span class="number">30</span>,<span class="number">2</span>)</div><div class="line">&gt; t.test(cases,controls)</div><div class="line"></div><div class="line">	Welch Two Sample t-test</div><div class="line"></div><div class="line">data:  cases and controls</div><div class="line">t = <span class="number">0.16473</span>, df = <span class="number">17.934</span>, p-value = <span class="number">0.871</span></div><div class="line">alternative hypothesis: true difference <span class="keyword">in</span> means is not equal to <span class="number">0</span></div><div class="line"><span class="number">95</span> percent confidence interval:</div><div class="line"> -<span class="number">1.708669</span>  <span class="number">1.999327</span></div><div class="line">sample estimates:</div><div class="line">mean of x mean of y </div><div class="line"> <span class="number">30.23172</span>  <span class="number">30.08639</span></div></pre></td></tr></table></figure>
<p>问题：现在进行Monte Carlo模拟，模拟所有20种包含的实验结果，如果我们将种子设置为<code>set.seed(100)</code>，那么有多少值低于0.05？</p>
<p>答案是：5%，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">set.seed(<span class="number">100</span>)</div><div class="line">pvals &lt;- replicate(<span class="number">20</span>,&#123;</div><div class="line">  cases = rnorm(<span class="number">10</span>,<span class="number">30</span>,<span class="number">2</span>)</div><div class="line">  controls = rnorm(<span class="number">10</span>,<span class="number">30</span>,<span class="number">2</span>)</div><div class="line">  t.test(cases,controls)$p.val&#125;)</div><div class="line">sum(pvals&lt;<span class="number">0.05</span>)/length(pvals)*<span class="number">100</span></div></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; sum(pvals&lt;<span class="number">0.05</span>)/length(pvals)*<span class="number">100</span></div><div class="line">[<span class="number">1</span>] <span class="number">5</span></div></pre></td></tr></table></figure>
<p><strong>问题四</strong>：现在我们通过模拟数据了解了p值的分布情况，也就是说了解了小于0.05的p值的比例。在问题三中，我们一次运行了20种饮食的实验。现在我们运行1000次实验，并且每次保存下那些p值小于0.05的数目。</p>
<p>操作如下：</p>
<p>随机种子数设为100，即<code>set.seed(100)</code>，运行问题三中的代码1000次，并保存p值小于0.05的次数，计算一下这些数字的平均值，这就是我们拒绝零假设为真时的次数，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">set.seed(<span class="number">100</span>)</div><div class="line">pvals &lt;- replicate(<span class="number">1000</span>,&#123;</div><div class="line">  cases = rnorm(<span class="number">10</span>,<span class="number">30</span>,<span class="number">2</span>)</div><div class="line">  controls = rnorm(<span class="number">10</span>,<span class="number">30</span>,<span class="number">2</span>)</div><div class="line">  t.test(cases,controls)$p.val&#125;)</div><div class="line">sum(pvals&lt;<span class="number">0.05</span>)</div><div class="line">sum(pvals&lt;<span class="number">0.05</span>)/length(pvals)*<span class="number">100</span></div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt; sum(pvals&lt;<span class="number">0.05</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">40</span></div><div class="line">&gt; sum(pvals&lt;<span class="number">0.05</span>)/length(pvals)*<span class="number">100</span></div><div class="line">[<span class="number">1</span>] <span class="number">4</span></div></pre></td></tr></table></figure>
<p><strong>问题五</strong>：这说明，就平均数而言，即使所有的饮食对小鼠的体重都没有影响，我们还能得到一些小于0.05的p值。使用相同的模拟数据来做1000次计算，我们能得到多少假阳性的比例？</p>
<p>答：大概是5%。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-tags" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rvdsd.top/2019/08/20/DAL/DALS014_Linear_Models04ANOVA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="RVDSD">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RVDSD的个人笔记本">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/20/DAL/DALS014_Linear_Models04ANOVA/" itemprop="url">DALS014-Linear Models线性模型04方差分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-20T12:00:00+08:00">
                2019-08-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/生物统计/" itemprop="url" rel="index">
                    <span itemprop="name">生物统计</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2,532
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  11
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言">前言</h2>
<p>这一部分是《Data Analysis for the life sciences》的第5章线性模型的第4小节，这一部分的主要内容涉及ANOVA，有关方差分析的笔记R markdown文档可以参考作者的<a href="https://github.com/genomicsclass/labs/blob/master/linear/interactions_and_contrasts.Rmd" target="_blank" rel="external">Github</a>。</p>
<h2 id="anova简介">ANOVA简介</h2>
<p>现在考虑一种情况，如果我们想知道push与pull的差值在整体上，不同的组中是否有区别。换句话讲，我们并不想比较任意两组有差异，我们就想知道，在所有的有腿中，代表了push和pull差值的3个交互作用导致的push和pull差异是否比正常的差异大（即不考虑交互作用的情况）。</p>
<p>通过方差分析(analysis of variance，ANOVA)就可以解决这个问题。ANOVA的本质在于比较不同复杂模型的残差平方和是被哪些因素降低的（我的理解就是，总的残差平方和都是分布在哪些变量上面，哪些变量分到的最多，哪些变量的效应就最强）。含有8个系数的模型比含有5个系数的模型要复杂的多，在5个系数的模型中，我们是假设push和pull在所有组之间的差异是相等的。最简单的模型只使用一个系数，一个截矩。在某些假设下，我们还可以执行推断，确定与我们观察到的一样大的改进概率(Under certain assumptions we can also perform inference that determines the probability of improvements as large as what we observed)。</p>
<p>下面的ANOVA计算的结果（接前文案例）：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&gt; anova(fitX)</div><div class="line">Analysis of Variance Table</div><div class="line"></div><div class="line">Response: friction</div><div class="line">           Df Sum Sq Mean Sq  <span class="literal">F</span> value    Pr(&gt;<span class="literal">F</span>)    </div><div class="line">type        <span class="number">1</span> <span class="number">42.783</span>  <span class="number">42.783</span> <span class="number">1179.713</span> &lt; <span class="number">2.2e-16</span> ***</div><div class="line">leg         <span class="number">3</span>  <span class="number">2.921</span>   <span class="number">0.974</span>   <span class="number">26.847</span> <span class="number">2.972e-15</span> ***</div><div class="line">type:leg    <span class="number">3</span>  <span class="number">2.098</span>   <span class="number">0.699</span>   <span class="number">19.282</span> <span class="number">2.256e-11</span> ***</div><div class="line">Residuals <span class="number">274</span>  <span class="number">9.937</span>   <span class="number">0.036</span>                       </div><div class="line">---</div><div class="line">Signif. codes:  <span class="number">0</span> ‘***’ <span class="number">0.001</span> ‘**’ <span class="number">0.01</span> ‘*’ <span class="number">0.05</span> ‘.’ <span class="number">0.1</span> ‘ ’ <span class="number">1</span></div></pre></td></tr></table></figure>
<p>结果的第一行中有一个<code>type</code>变量（表示pull或push），它对应的Sum值为42.783，这就表示，这一单一的系数减少了42.783的平方和。我们看一下总的平方和，其实就是线性模型的截矩，也可以是<code>anova(fitX)</code>的第2列的和，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">result &lt;- anova(fitX)</div><div class="line">sum(result$`Sum Sq`)</div><div class="line">mu0 &lt;- mean(spider$friction)</div><div class="line">(initial.ss &lt;- sum((spider$friction - mu0)^<span class="number">2</span>))</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&gt; result &lt;- anova(fitX)</div><div class="line">&gt; sum(result$`Sum Sq`)</div><div class="line">[<span class="number">1</span>] <span class="number">57.73858</span></div><div class="line">&gt; mu0 &lt;- mean(spider$friction)</div><div class="line">&gt; (initial.ss &lt;- sum((spider$friction - mu0)^<span class="number">2</span>))</div><div class="line">[<span class="number">1</span>] <span class="number">57.73858</span></div></pre></td></tr></table></figure>
<p>需要注意是的是，这个平方和的计算公式最初就是来源于样本方差的计算公式，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">N &lt;- nrow(spider)</div><div class="line">(N - <span class="number">1</span>) * var(spider$friction)</div></pre></td></tr></table></figure>
<p>计算结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt; N &lt;- nrow(spider)</div><div class="line">&gt; (N - <span class="number">1</span>) * var(spider$friction)</div><div class="line">[<span class="number">1</span>] <span class="number">57.73858</span></div></pre></td></tr></table></figure>
<p>现在来看一下，前面的42.783是如何得到的。我们需要计算仅包含类型信息模型的残差平方和。我们可以通过计算残差，残差的平方，并将它们加起来就能实现，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">s &lt;- split(spider$friction, spider$type)</div><div class="line">after.type.ss &lt;- sum( sapply(s, <span class="keyword">function</span>(x) &#123;</div><div class="line">residual &lt;- x - mean(x)</div><div class="line">sum(residual^<span class="number">2</span>)</div><div class="line">&#125;) )</div><div class="line">(type.ss &lt;- initial.ss - after.type.ss)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&gt; s &lt;- split(spider$friction, spider$type)</div><div class="line">&gt; after.type.ss &lt;- sum( sapply(s, <span class="keyword">function</span>(x) &#123;</div><div class="line">+   residual &lt;- x - mean(x)</div><div class="line">+   sum(residual^<span class="number">2</span>)</div><div class="line">+ &#125;) )</div><div class="line">&gt; (type.ss &lt;- initial.ss - after.type.ss)</div><div class="line">[<span class="number">1</span>] <span class="number">42.78307</span></div></pre></td></tr></table></figure>
<p>这个降低的程度(就是上面的42.78307)就相当于模型<code>~type</code>和<code>~1</code>拟合值差值的平方和，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sum(sapply(s, length) * (sapply(s, mean) - mu0)^<span class="number">2</span>)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; sum(sapply(s, length) * (sapply(s, mean) - mu0)^<span class="number">2</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">42.78307</span></div></pre></td></tr></table></figure>
<p>线性模型中的各个项的顺序以及ANOVA表格中的顺序很重要：每行表示的是：当添加了一个新的系数后，残差平方和较未添加这个系数之前减少的量。</p>
<p>在ANOVA表（这个表其实就是ANOAVA计算后的结果）还标明了自由度。当引入了<code>type</code>这一项时，它对应的<code>Df</code>就是1，<code>leg</code>变量引入了3个项（即legL2，legL3和legL4），它对应的<code>Df</code>就是3（这一段不太理解）。ANOVA还有一列是<code>F value</code>。F值表示的是包含感兴趣的项（感兴趣的项平方和除以相应自由度）除以残差（ANOVA表中的最后一行除以自自由度），以第一行为例 说明一下就是<code>(42.783/1)/(9.937/274)=1179.686</code>。</p>
<p>书中给出的公式为：</p>
<p><span class="math display">\[
r_i = Y_i - \hat{Y}_i
\]</span> <span class="math display">\[
\mbox{Mean Sq Residuals} = \frac{1}{N - p} \sum_{i=1}^N r_i^2
\]</span></p>
<p>其中<code>p</code>表示模型中系数的总数（在这个模型中，包括截矩在内的系数总数是8）。</p>
<p>在零假设成立的前提下（零假设就是添加系数的真值为0），我们会得到每行F值分布的理论结果。这种近似所需的假设类似于t分布近似的假设，例如我们在使用CLT时需要大量的样本，或者是总体的数据服从正态分布。</p>
<p>现在我们来解释一下p值，看最后一行，即<code>type:leg</code>，内容是<code>type:leg    3  2.098   0.699   19.282 2.256e-11 ***</code>，<code>type:leg</code>表示的是3个交互作用系数。在零假设下，这3个附加项的真实值为0，例如，<span class="math inline">\(\beta_{push,L2}=0\)</span>，<span class="math inline">\(\beta_{push,L3}=0\)</span>，<span class="math inline">\(\beta_{push,L4}=0\)</span>，然后我们就计算出ANOVA表的这一行观察到的这么大的F值的概率。这里需要记住，我们只关注大的F值，因为我们有一个平方和的比，因此F值只能是正数（原文：Remember that we are only concerned with large values here, because we have a ratio of sum of squares, the F-value can only be positive. ）。<code>type:leg</code>这一行中的p值可以这么解释：在零假设下，我们认为push和pull的差值在所有组之间是没有差异的，p值表示了，在这个零假设成立时，我们观察到的如此大的方差的可能性。从计算结果中我们可以看到，我们的p值非常小，我们就可以拒绝零假设，即可以认为，push和pull的差值在不同组之间是不同的。</p>
<p>另外，ANOVA中的F值与F分布有关，F分布有2个以参数，一个是分子的自由度（分子是研究对象的自由度，例如前面提到的交互作用），一个是分母的自由度（残差）。从结果可以看到，交互作用系数的自由度是3，残差的自由度是274。</p>
<h2 id="anova模型的另外表示">ANOVA模型的另外表示</h2>
<p>现在来看一下ANOVA模型的另外表示方法，在这种方式里，我们假设每一对type与leg都有自己的均值（这样，对于每一条腿来说，push与pull的效应就不会相同）。这种表述方式在某种程度上来说更加简单，但是，我们不能像前面那样构建ANOVA表，因为这种方式无法区分交互作用系数。</p>
<p>首先我们会先构建一个因子变量，这个因子变量表示的是<code>type</code>与<code>leg</code>的组合，在公式中含有<code>~0</code>，它表示，我们不在线性模型中包含截矩，其中我们通过<code>rafalib</code>包中的<code>imagemat()</code>函数绘制了组变量的矩阵示意图，这个示意图也有8项，它针对每一个type和leg组合进行了拟合，代码如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">##earlier, we defined the 'group' column:</span></div><div class="line">spider$group &lt;- factor(paste0(spider$leg, spider$type))</div><div class="line">X &lt;- model.matrix(~ <span class="number">0</span> + group, data=spider)</div><div class="line">colnames(X)</div><div class="line">head(X)</div><div class="line"><span class="keyword">library</span>(rafalib)</div><div class="line">imagemat(X, main=<span class="string">"Model matrix for linear model with group variable"</span>)</div><div class="line">fitG &lt;- lm(friction ~ <span class="number">0</span> + group, data=spider)</div><div class="line">summary(fitG)</div><div class="line">coefs &lt;- coef(fitG)</div><div class="line">coefs</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">&gt; colnames(X)</div><div class="line">[<span class="number">1</span>] <span class="string">"groupL1pull"</span> <span class="string">"groupL1push"</span> <span class="string">"groupL2pull"</span> <span class="string">"groupL2push"</span> <span class="string">"groupL3pull"</span></div><div class="line">[<span class="number">6</span>] <span class="string">"groupL3push"</span> <span class="string">"groupL4pull"</span> <span class="string">"groupL4push"</span></div><div class="line">&gt; head(X)</div><div class="line">  groupL1pull groupL1push groupL2pull groupL2push groupL3pull groupL3push</div><div class="line"><span class="number">1</span>           <span class="number">1</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span></div><div class="line"><span class="number">2</span>           <span class="number">1</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span></div><div class="line"><span class="number">3</span>           <span class="number">1</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span></div><div class="line"><span class="number">4</span>           <span class="number">1</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span></div><div class="line"><span class="number">5</span>           <span class="number">1</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span></div><div class="line"><span class="number">6</span>           <span class="number">1</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span></div><div class="line">  groupL4pull groupL4push</div><div class="line"><span class="number">1</span>           <span class="number">0</span>           <span class="number">0</span></div><div class="line"><span class="number">2</span>           <span class="number">0</span>           <span class="number">0</span></div><div class="line"><span class="number">3</span>           <span class="number">0</span>           <span class="number">0</span></div><div class="line"><span class="number">4</span>           <span class="number">0</span>           <span class="number">0</span></div><div class="line"><span class="number">5</span>           <span class="number">0</span>           <span class="number">0</span></div><div class="line"><span class="number">6</span>           <span class="number">0</span>           <span class="number">0</span></div><div class="line">&gt; <span class="keyword">library</span>(rafalib)</div><div class="line">&gt; imagemat(X, main=<span class="string">"Model matrix for linear model with group variable"</span>)</div><div class="line">&gt; fitG &lt;- lm(friction ~ <span class="number">0</span> + group, data=spider)</div><div class="line">&gt; summary(fitG)</div><div class="line"></div><div class="line">Call:</div><div class="line">lm(formula = friction ~ <span class="number">0</span> + group, data = spider)</div><div class="line"></div><div class="line">Residuals:</div><div class="line">     Min       1Q   Median       3Q      Max </div><div class="line">-<span class="number">0.46385</span> -<span class="number">0.10735</span> -<span class="number">0.01111</span>  <span class="number">0.07848</span>  <span class="number">0.76853</span> </div><div class="line"></div><div class="line">Coefficients:</div><div class="line">            Estimate Std. Error t value Pr(&gt;|t|)    </div><div class="line">groupL1pull  <span class="number">0.92147</span>    <span class="number">0.03266</span>   <span class="number">28.21</span>   &lt;<span class="number">2e-16</span> ***</div><div class="line">groupL1push  <span class="number">0.40735</span>    <span class="number">0.03266</span>   <span class="number">12.47</span>   &lt;<span class="number">2e-16</span> ***</div><div class="line">groupL2pull  <span class="number">1.14533</span>    <span class="number">0.04917</span>   <span class="number">23.29</span>   &lt;<span class="number">2e-16</span> ***</div><div class="line">groupL2push  <span class="number">0.52733</span>    <span class="number">0.04917</span>   <span class="number">10.72</span>   &lt;<span class="number">2e-16</span> ***</div><div class="line">groupL3pull  <span class="number">1.27385</span>    <span class="number">0.02641</span>   <span class="number">48.24</span>   &lt;<span class="number">2e-16</span> ***</div><div class="line">groupL3push  <span class="number">0.37596</span>    <span class="number">0.02641</span>   <span class="number">14.24</span>   &lt;<span class="number">2e-16</span> ***</div><div class="line">groupL4pull  <span class="number">1.40075</span>    <span class="number">0.03011</span>   <span class="number">46.52</span>   &lt;<span class="number">2e-16</span> ***</div><div class="line">groupL4push  <span class="number">0.49075</span>    <span class="number">0.03011</span>   <span class="number">16.30</span>   &lt;<span class="number">2e-16</span> ***</div><div class="line">---</div><div class="line">Signif. codes:  <span class="number">0</span> ‘***’ <span class="number">0.001</span> ‘**’ <span class="number">0.01</span> ‘*’ <span class="number">0.05</span> ‘.’ <span class="number">0.1</span> ‘ ’ <span class="number">1</span></div><div class="line"></div><div class="line">Residual standard error: <span class="number">0.1904</span> on <span class="number">274</span> degrees of freedom</div><div class="line">Multiple R-squared:   <span class="number">0.96</span>,	Adjusted R-squared:  <span class="number">0.9588</span> </div><div class="line"><span class="literal">F</span>-statistic:   <span class="number">821</span> on <span class="number">8</span> and <span class="number">274</span> DF,  p-value: &lt; <span class="number">2.2e-16</span></div><div class="line"></div><div class="line">&gt; coefs &lt;- coef(fitG)</div><div class="line">&gt; coefs</div><div class="line">groupL1pull groupL1push groupL2pull groupL2push groupL3pull groupL3push groupL4pull </div><div class="line">  <span class="number">0.9214706</span>   <span class="number">0.4073529</span>   <span class="number">1.1453333</span>   <span class="number">0.5273333</span>   <span class="number">1.2738462</span>   <span class="number">0.3759615</span>   <span class="number">1.4007500</span> </div><div class="line">groupL4push </div><div class="line">  <span class="number">0.4907500</span></div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190824171912.jpeg">

</div>
<h2 id="计算估计系数">计算估计系数</h2>
<p>现在我们绘制出上面计算结果的示意图，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">stripchart(split(spider$friction, spider$group), </div><div class="line">           vertical=<span class="literal">TRUE</span>, pch=<span class="number">1</span>, method=<span class="string">"jitter"</span>, las=<span class="number">2</span>, xlim=c(<span class="number">0</span>,<span class="number">11</span>), ylim=c(<span class="number">0</span>,<span class="number">2</span>))</div><div class="line">cols &lt;- brewer.pal(<span class="number">8</span>,<span class="string">"Dark2"</span>)</div><div class="line">abline(h=<span class="number">0</span>)</div><div class="line"><span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1</span>:<span class="number">8</span>) &#123;</div><div class="line">  arrows(i+a,<span class="number">0</span>,i+a,coefs[i],lwd=<span class="number">3</span>,col=cols[i],length=lgth)</div><div class="line">&#125;</div><div class="line">legend(<span class="string">"right"</span>,names(coefs),fill=cols,cex=<span class="number">.75</span>,bg=<span class="string">"white"</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190824172337.jpeg">

</div>
<h2 id="使用contrast包进行简单比较">使用contrast包进行简单比较</h2>
<p>虽然无法使用这个公式来进行ANOVA分析，但是可以使用<code>contrast()</code>函数对每组的估计系数进行比较，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">groupL2push.vs.pull &lt;- contrast(fitG,</div><div class="line">                                list(group = <span class="string">"L2push"</span>),</div><div class="line">                                list(group = <span class="string">"L2pull"</span>))</div><div class="line">groupL2push.vs.pull</div><div class="line">coefs[<span class="number">4</span>] - coefs[<span class="number">3</span>]</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&gt; groupL2push.vs.pull</div><div class="line">lm model parameter contrast</div><div class="line"></div><div class="line">  Contrast      S.E.      Lower      Upper     t  df Pr(&gt;|t|)</div><div class="line"><span class="number">1</span>   -<span class="number">0.618</span> <span class="number">0.0695372</span> -<span class="number">0.7548951</span> -<span class="number">0.4811049</span> -<span class="number">8.89</span> <span class="number">274</span>        <span class="number">0</span></div><div class="line">&gt; coefs[<span class="number">4</span>] - coefs[<span class="number">3</span>]</div><div class="line">groupL2push </div><div class="line">     -<span class="number">0.618</span></div></pre></td></tr></table></figure>
<h2 id="无截矩时差值的差异">无截矩时差值的差异</h2>
<p>我们还可以进行push和pull在各级之间的两两(pair-wise)比较。例如，现在我们想比较L3与L2的push和pull的差值，如下所示：</p>
<p><span class="math display">\[
(\mbox{L3push} - \mbox{L3pull}) - (\mbox{L2push} - \mbox{L2pull})
\]</span> <span class="math display">\[
= \mbox{L3 push} + \mbox{L2pull} - \mbox{L3pull} - \mbox{L2push}
\]</span></p>
<p>其过程如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">C &lt;- matrix(c(<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,-<span class="number">1</span>,-<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>), <span class="number">1</span>)</div><div class="line">groupL3vsL2interaction &lt;- glht(fitG, linfct=C)</div><div class="line">summary(groupL3vsL2interaction)</div><div class="line">names(coefs)</div><div class="line">(coefs[<span class="number">6</span>] - coefs[<span class="number">5</span>]) - (coefs[<span class="number">4</span>] - coefs[<span class="number">3</span>])</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&gt; C &lt;- matrix(c(<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,-<span class="number">1</span>,-<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>), <span class="number">1</span>)</div><div class="line">&gt; groupL3vsL2interaction &lt;- glht(fitG, linfct=C)</div><div class="line">&gt; summary(groupL3vsL2interaction)</div><div class="line"></div><div class="line">	 Simultaneous Tests <span class="keyword">for</span> General Linear Hypotheses</div><div class="line"></div><div class="line">Fit: lm(formula = friction ~ <span class="number">0</span> + group, data = spider)</div><div class="line"></div><div class="line">Linear Hypotheses:</div><div class="line">       Estimate Std. Error t value Pr(&gt;|t|)    </div><div class="line"><span class="number">1</span> == <span class="number">0</span> -<span class="number">0.27988</span>    <span class="number">0.07893</span>  -<span class="number">3.546</span>  <span class="number">0.00046</span> ***</div><div class="line">---</div><div class="line">Signif. codes:  <span class="number">0</span> ‘***’ <span class="number">0.001</span> ‘**’ <span class="number">0.01</span> ‘*’ <span class="number">0.05</span> ‘.’ <span class="number">0.1</span> ‘ ’ <span class="number">1</span></div><div class="line">(Adjusted p values reported -- single-step method)</div><div class="line"></div><div class="line">&gt; names(coefs)</div><div class="line">[<span class="number">1</span>] <span class="string">"groupL1pull"</span> <span class="string">"groupL1push"</span> <span class="string">"groupL2pull"</span> <span class="string">"groupL2push"</span> <span class="string">"groupL3pull"</span></div><div class="line">[<span class="number">6</span>] <span class="string">"groupL3push"</span> <span class="string">"groupL4pull"</span> <span class="string">"groupL4push"</span></div><div class="line">&gt; (coefs[<span class="number">6</span>] - coefs[<span class="number">5</span>]) - (coefs[<span class="number">4</span>] - coefs[<span class="number">3</span>])</div><div class="line">groupL3push </div><div class="line"> -<span class="number">0.2798846</span></div></pre></td></tr></table></figure>
<h2 id="练习">练习</h2>
<p>P230</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-tags" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rvdsd.top/2019/08/20/DAL/DALS015_Linear_Models05Collinearity/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="RVDSD">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RVDSD的个人笔记本">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/20/DAL/DALS015_Linear_Models05Collinearity/" itemprop="url">DALS015-Linear Models线性模型05共线性</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-20T12:00:00+08:00">
                2019-08-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/生物统计/" itemprop="url" rel="index">
                    <span itemprop="name">生物统计</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  4,113
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  18
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言">前言</h2>
<p>这一部分是《Data Analysis for the life sciences》的第5章线性模型的第5小节，这一部分的主要内容涉及矩阵的共线性(Co-linearity)，秩(rank)，QR分解，有关共线性和秩的笔记R markdown文档可以参考作者的<a href="https://github.com/genomicsclass/labs/blob/master/linear/collinearity.Rmd" target="_blank" rel="external">Github</a>，QR分解见<a href="https://github.com/genomicsclass/labs/blob/master/linear/qr_and_regression.Rmd" target="_blank" rel="external">另外一篇</a>。</p>
<h2 id="共线性co-linearity">共线性(Co-linearity)</h2>
<p>如果一个实验设计不合理，那么我们就无法对目标参数进行估计。同样，当我们分析数据时，不合理地使用一个模型时也会得错误的结论。我们使用线性模型时，通过检查设计矩阵的共线性(collinearity)就能从数学角度来考虑我们选择的这个模型是否合理。</p>
<h2 id="方程组案例">方程组案例</h2>
<p>我们来看一个方程组，如下所示： <span class="math display">\[
\begin{align*}
a+c &amp;=1\\
b-c &amp;=1\\
a+b &amp;=2
\end{align*}
\]</span> 这个方程就不止一个解，因为有无数组数据满足<code>a=1-c</code>，<code>b=1+c</code>。例如<code>a=1, b=1, c=0</code>和<code>a=0,b=c,c=1</code>。</p>
<h2 id="矩阵代数方法">矩阵代数方法</h2>
<p>现在我们使用矩阵来说明一下上面的情况，上面的方程组我们写成矩阵形式如下所示： <span class="math display">\[
\,
\begin{pmatrix}
1&amp;0&amp;1\\
0&amp;1&amp;-1\\
1&amp;1&amp;0\\
\end{pmatrix}
\begin{pmatrix}
a\\
b\\
c
\end{pmatrix}
=
\begin{pmatrix}
1\\
1\\
2
\end{pmatrix}
\]</span> 从矩阵中我们可以发现，其实矩阵的第3列就是第1列和第2列的线性组合，如下所示： <span class="math display">\[
\,
\begin{pmatrix}
1\\
0\\
1
\end{pmatrix}
+
-1 \begin{pmatrix}
0\\
1\\
1
\end{pmatrix}
=
\begin{pmatrix}
1\\
-1\\
0
\end{pmatrix}
\]</span> 因此，我们可以说第3列与前2列共线性(collinear)，这也就是说，我们可以将上面的矩阵写成下面的这个形式： <span class="math display">\[
\,
\begin{pmatrix}
1&amp;0&amp;1\\
0&amp;1&amp;-1\\
1&amp;1&amp;0
\end{pmatrix}
\begin{pmatrix}
a\\
b\\
c
\end{pmatrix}
=
a
\begin{pmatrix}
1\\
0\\
1
\end{pmatrix}
+
b \begin{pmatrix}
0\\
1\\
1
\end{pmatrix}
+
c
\begin{pmatrix}
1-0\\
0-1\\
1-1
\end{pmatrix}
\]</span></p>
<p><span class="math display">\[
=(a+c)
\begin{pmatrix}
1\\
0\\
1\\
\end{pmatrix}
+
(b-c)
\begin{pmatrix}
0\\
1\\
1\\
\end{pmatrix}
\]</span></p>
<p>新的矩阵也就说明了，第3列其实没什么用，我们真正有的是3个方程和2个未知数，即<code>a+c</code>和<code>b+c</code>。一旦我们得到了这两个量（即<code>a+c</code>和<code>b+c</code>），那么<code>a, b, c</code>这个未知数就有无数种解。</p>
<h2 id="共线性和最小平方">共线性和最小平方</h2>
<p>现在我们考虑一个设计矩阵<span class="math inline">\(\mathbf{X}\)</span>，这个矩阵含有2个共线性列。我们创建一个极端的例子，在这个例子中，有两列互为相反，如下所示： <span class="math display">\[
\mathbf{X} = \begin{pmatrix}
\mathbf{1}&amp;\mathbf{X}_1&amp;\mathbf{X}_2&amp;\mathbf{X}_3\\
\end{pmatrix}
\mbox{ with, say, }
\mathbf{X}_3 = - \mathbf{X}_2
\]</span> 这就意味着，我们可以把上面的矩阵写为如下形式： <span class="math display">\[
\mathbf{Y}- \left\{ \mathbf{1}\beta_0 + \mathbf{X}_1\beta_1 + \mathbf{X}_2\beta_2 + \mathbf{X}_3\beta_3\right\}\\ 
= \mathbf{Y}- \left\{ \mathbf{1}\beta_0 + \mathbf{X}_1\beta_1 + \mathbf{X}_2\beta_2 - \mathbf{X}_2\beta_3\right\}\\
= \mathbf{Y}- \left\{\mathbf{1}\beta_0 + \mathbf{X}_1 \beta_1 + \mathbf{X}_2(\beta_2  - \beta_3)\right\}
\]</span></p>
<p>如果<span class="math inline">\(\hat{\beta}_1\)</span>, <span class="math inline">\(\hat{\beta}_2\)</span>, <span class="math inline">\(\hat{\beta}_3\)</span> 是一个最小平方解(least squares solution)，那么，例如<span class="math inline">\(\hat{\beta}_1\)</span>, <span class="math inline">\(\hat{\beta}_2+1\)</span>, <span class="math inline">\(\hat{\beta}_3+1\)</span>也是一个解。</p>
<h2 id="混淆confounding案例分析">混淆(confounding)案例分析</h2>
<p>现在我们将演示一下共线性是如何帮助我们解决当前实验设计中最常见的错误之一的：混淆(confounding)。 为了说明这个问题。现在我们设想一个实验，例如我们感兴趣的是四种处理因素，即A，B，C和D。我们给每种处理因素分配2只小鼠。当我们给A、B处理分配的是雌性小鼠后，我们意识到性别(sex)有可能对实验造成影响。我们决定给C和D两组雄性小鼠，从而估计性别对实验的影响。但是，通过这种方式我们能否估计出性别的影响呢，这个实验我们表示为矩阵形式，则如下所示： <span class="math display">\[
\,
\begin{pmatrix}
Sex &amp; A &amp; B &amp; C &amp; D\\
0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 \\
0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 \\
1 &amp; 0 &amp; 0 &amp; 1 &amp; 0 \\
1 &amp; 0 &amp; 0 &amp; 1 &amp; 0 \\
1 &amp; 0 &amp; 0 &amp; 0 &amp; 1 \\
1 &amp; 0 &amp; 0 &amp; 0 &amp; 1\\
\end{pmatrix}
\]</span> 在这个矩阵里，我们可以看到处理因素与性别产生了混淆(confound)，尤其是，性别这一列可以用C列和D列进行表示（也就是说共线性），如下所示： <span class="math display">\[
\,
\begin{pmatrix}
Sex \\
0\\
0 \\
0 \\
0 \\
1\\
1\\
1 \\
1 \\
\end{pmatrix}
=
\begin{pmatrix}
C \\
0\\
0\\
0\\
0\\
1\\
1\\
0\\
0\\
\end{pmatrix}
+
\begin{pmatrix}
D \\
0\\
0\\
0\\
0\\
0\\
0\\
1\\
1\\
\end{pmatrix}
\]</span> 这就说明了，无法使用最小平方和来对实验结果进行计算。</p>
<h2 id="秩rank">秩(rank)</h2>
<p>一个矩阵的秩(rank)表示的是，矩阵中独立于其他列的数目。如果矩阵的秩小于列的数目，那么LSE则不唯一。在R中，我们可以使用<code>qr()</code>函数来获取一个矩阵的秩，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Sex &lt;- c(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>)</div><div class="line">A &lt;- c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</div><div class="line">B &lt;- c(<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</div><div class="line">C &lt;- c(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>)</div><div class="line">D &lt;- c(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>)</div><div class="line">X &lt;- model.matrix(~Sex+A+B+C+D-<span class="number">1</span>)</div><div class="line">cat(<span class="string">"ncol="</span>,ncol(X),<span class="string">"rank="</span>, qr(X)$rank,<span class="string">"\n"</span>)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ncol= <span class="number">5</span> rank= <span class="number">4</span></div></pre></td></tr></table></figure>
<h2 id="移除混淆">移除混淆</h2>
<p>前面我们提到的那个实验可以设计得更加完全。使用相同数量的雄性小鼠和雌性小鼠可以很容易设计一个实验来研究性别影响与干预影响。具体来说就是，当我们平衡了性别与干预后，混淆就会被消除，也就是说，通过一定的合理实验设计，就是使秩与列的数目相同，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Sex &lt;- c(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>)</div><div class="line">A &lt;- c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</div><div class="line">B &lt;- c(<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</div><div class="line">C &lt;- c(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>)</div><div class="line">D &lt;- c(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>)</div><div class="line">X &lt;- model.matrix(~Sex+A+B+C+D-<span class="number">1</span>)</div><div class="line">cat(<span class="string">"ncol="</span>,ncol(X),<span class="string">"rank="</span>, qr(X)$rank,<span class="string">"\n"</span>)</div></pre></td></tr></table></figure>
<p>计算结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ncol= <span class="number">5</span> rank= <span class="number">5</span></div></pre></td></tr></table></figure>
<h2 id="练习">*练习</h2>
<p>P237</p>
<h2 id="矩阵的qr分解">矩阵的QR分解</h2>
<p>这一部分的R markdown参考文档见<a href="https://github.com/genomicsclass/labs/blob/master/linear/qr_and_regression.Rmd" target="_blank" rel="external">Github</a>。</p>
<p>前面我们已经了解到了通过逆转一个矩阵来计算LSE，前面使用了<code>solve()</code>函数。但是，这并非是一种稳定的解决方式方式。当我们进行LSE计算时，可以使用QR分解。</p>
<h2 id="逆转">逆转</h2>
<p>为了使RSS最小： <span class="math display">\[
(\mathbf{Y}-\mathbf{X}\boldsymbol{\beta})^\top
(\mathbf{Y}-\mathbf{X}\boldsymbol{\beta})
\]</span> 我们需要解下面方程： <span class="math display">\[
\mathbf{X}^\top \mathbf{X} \boldsymbol{\hat{\beta}} = \mathbf{X}^\top \mathbf{Y}
\]</span> 解为： <span class="math display">\[
\boldsymbol{\hat{\beta}} = (\mathbf{X}^\top \mathbf{X})^{-1} \mathbf{X}^\top \mathbf{Y}
\]</span> 因此，我们需要计算<span class="math inline">\((\mathbf{X}^\top \mathbf{X})^{-1}\)</span></p>
<p>这个解在数学上是不稳定的(solve is numerically unstable)。</p>
<p>为了说明什么叫<code>在数学上是不稳定的</code>，我们来看下面的代码：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">n &lt;- <span class="number">50</span>;M &lt;- <span class="number">500</span></div><div class="line">x &lt;- seq(<span class="number">1</span>,M,len=n)</div><div class="line">X &lt;- cbind(<span class="number">1</span>,x,x^<span class="number">2</span>,x^<span class="number">3</span>)</div><div class="line">colnames(X) &lt;- c(<span class="string">"Intercept"</span>,<span class="string">"x"</span>,<span class="string">"x2"</span>,<span class="string">"x3"</span>)</div><div class="line">beta &lt;- matrix(c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>),<span class="number">4</span>,<span class="number">1</span>)</div><div class="line">set.seed(<span class="number">1</span>)</div><div class="line">y &lt;- X%*%beta+rnorm(n,sd=<span class="number">1</span>)</div><div class="line">solve(crossprod(X)) %*% crossprod(X,y)</div></pre></td></tr></table></figure>
<p>运行后就出错了，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt; solve(crossprod(X)) %*% crossprod(X,y)</div><div class="line">Error <span class="keyword">in</span> solve.default(crossprod(X)) : </div><div class="line">  system is computationally singular: reciprocal condition number = <span class="number">2.93617e-17</span></div></pre></td></tr></table></figure>
<p>现在我们来看一下为什么会出现这种错误，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">options(digits=<span class="number">4</span>)</div><div class="line">log10(crossprod(X))</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&gt; options(digits=<span class="number">4</span>)</div><div class="line">&gt; log10(crossprod(X))</div><div class="line">          Intercept      x     x2     x3</div><div class="line">Intercept     <span class="number">1.699</span>  <span class="number">4.098</span>  <span class="number">6.625</span>  <span class="number">9.203</span></div><div class="line">x             <span class="number">4.098</span>  <span class="number">6.625</span>  <span class="number">9.203</span> <span class="number">11.810</span></div><div class="line">x2            <span class="number">6.625</span>  <span class="number">9.203</span> <span class="number">11.810</span> <span class="number">14.434</span></div><div class="line">x3            <span class="number">9.203</span> <span class="number">11.810</span> <span class="number">14.434</span> <span class="number">17.070</span></div></pre></td></tr></table></figure>
<p>这里我们要注意一下数量级的差异。常用的数字计算机储存的数字范围有限。 当我们要要考虑使用非常大的数字时，这会使一些数字看起来像0。 这反过来又会导致由0划分导致的错误划分（原文是：This in turn leads to divisions that are practically divisions by 0 errors）。</p>
<h2 id="分解factorization">分解(factorization)</h2>
<p>QR分解是基于一种数学结果，它能告诉我们可以分解任意的全秩(any full rank)的<span class="math inline">\(N \times p\)</span>矩阵<span class="math inline">\(\mathbf{X}\)</span>，如下所示： <span class="math display">\[
\mathbf{X}=\mathbf{QR}
\]</span> 其中：</p>
<ul>
<li><span class="math inline">\(\mathbf{X}\)</span>是一个<span class="math inline">\(N \times p\)</span>矩阵，<span class="math inline">\(\mathbf{Q}^{T}\mathbf{Q}=I\)</span></li>
<li><span class="math inline">\(\mathbf{R}\)</span>是一个<span class="math inline">\(p \times p\)</span>矩阵，上三角矩阵。</li>
</ul>
<p>上三角矩阵在解方程组方面非常有用。</p>
<h3 id="什么是上三角矩阵">什么是上三角矩阵</h3>
<p>在下面的案例中，最左边的就是上三角矩阵：上三角矩阵的特点就是，矩阵对角线的左下方都是0，右上方不为零，根据矩阵的运算规则，这就很容易解方程组，如下所示： <span class="math display">\[
\,
\begin{pmatrix}
1&amp;2&amp;-1\\
0&amp;1&amp;2\\
0&amp;0&amp;1\\
\end{pmatrix}
\begin{pmatrix}
a\\
b\\
c\\
\end{pmatrix}
=
\begin{pmatrix}
6\\
4\\
1\\
\end{pmatrix}
\]</span> 从上面的形式我们就能马上看出来，<span class="math inline">\(c=1, b + 2 = 4, a = 3\)</span>。</p>
<h3 id="利用qr来计算lse">利用QR来计算LSE</h3>
<p>如果我们重新使用<span class="math inline">\(\mathbf{QR}\)</span>来替代<span class="math inline">\(\mathbf{X}\)</span>来写LSE的公式，则如下所示：</p>
<p><span class="math display">\[
\mathbf{X}^\top \mathbf{X} \boldsymbol{\beta} = \mathbf{X}^\top \mathbf{Y}
\]</span></p>
<p><span class="math display">\[
(\mathbf{Q}\mathbf{R})^\top (\mathbf{Q}\mathbf{R}) \boldsymbol{\beta} = (\mathbf{Q}\mathbf{R})^\top \mathbf{Y}
\]</span></p>
<p><span class="math display">\[
\mathbf{R}^\top (\mathbf{Q}^\top \mathbf{Q}) \mathbf{R} \boldsymbol{\beta} = \mathbf{R}^\top \mathbf{Q}^\top \mathbf{Y}
\]</span></p>
<p><span class="math display">\[
\mathbf{R}^\top \mathbf{R} \boldsymbol{\beta} = \mathbf{R}^\top \mathbf{Q}^\top \mathbf{Y}
\]</span></p>
<p><span class="math display">\[
(\mathbf{R}^\top)^{-1} \mathbf{R}^\top \mathbf{R} \boldsymbol{\beta} = (\mathbf{R}^\top)^{-1} \mathbf{R}^\top \mathbf{Q}^\top \mathbf{Y}
\]</span></p>
<p><span class="math display">\[
\mathbf{R} \boldsymbol{\beta} = \mathbf{Q}^\top \mathbf{Y}
\]</span></p>
<p>其中，<span class="math inline">\(\mathbf{R}\)</span>是上三角矩阵，它能够更加稳定地求出LSE。此外，由于<span class="math inline">\(\mathbf{Q}^T\mathbf{Q}=\mathbf{I}\)</span>，我们知道<span class="math inline">\(\mathbf{Q}\)</span>的列能够稳定右侧（这一段不太懂，原文：we know that the columns of Q are in the same scale which stabilizes the right side)。</p>
<p>现在我们就可以通过QR分解来计算LSE了，也就是解下面的这个方程：</p>
<p><span class="math display">\[
\mathbf{R} \boldsymbol{\beta} = \mathbf{Q}^\top \mathbf{Y}
\]</span></p>
<p>在R中我们使用<code>backsolve()</code>函数来角这个方程，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">QR &lt;- qr(X)</div><div class="line">Q &lt;- qr.Q( QR )</div><div class="line">R &lt;- qr.R( QR )</div><div class="line">(betahat &lt;- backsolve(R, crossprod(Q,y) ) )</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&gt; QR &lt;- qr(X)</div><div class="line">&gt; Q &lt;- qr.Q( QR )</div><div class="line">&gt; R &lt;- qr.R( QR )</div><div class="line">&gt; (betahat &lt;- backsolve(R, crossprod(Q,y) ) )</div><div class="line">          [,<span class="number">1</span>]</div><div class="line">[<span class="number">1</span>,] <span class="number">0.9038372</span></div><div class="line">[<span class="number">2</span>,] <span class="number">1.0066440</span></div><div class="line">[<span class="number">3</span>,] <span class="number">0.9999622</span></div><div class="line">[<span class="number">4</span>,] <span class="number">1.0000001</span></div></pre></td></tr></table></figure>
<p>实际上，R中有内置函数<code>solve.qr()</code>也能实现此功能，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">QR &lt;- qr(X)</div><div class="line">(betahat &lt;- solve.qr(QR, y))</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&gt; QR &lt;- qr(X)</div><div class="line">&gt; (betahat &lt;- solve.qr(QR, y))</div><div class="line">               [,<span class="number">1</span>]</div><div class="line">Intercept <span class="number">0.9038372</span></div><div class="line">x         <span class="number">1.0066440</span></div><div class="line">x2        <span class="number">0.9999622</span></div><div class="line">x3        <span class="number">1.0000001</span></div></pre></td></tr></table></figure>
<h3 id="拟合值">拟合值</h3>
<p>这种分解过程也能简化拟合值的计算，如下所示： <span class="math display">\[
\mathbf{X}\boldsymbol{\hat{\beta}} = 
(\mathbf{QR})\mathbf{R}^{-1}\mathbf{Q}^\top \mathbf{y}= \mathbf{Q}\mathbf{Q}^\top\mathbf{y}
\]</span></p>
<p>在R中，计算如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(rafalib)</div><div class="line">mypar(<span class="number">1</span>,<span class="number">1</span>)</div><div class="line">plot(x,y)</div><div class="line">fitted &lt;- tcrossprod(Q)%*%y</div><div class="line">lines(x,fitted,col=<span class="number">2</span>)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190826133645.jpeg">

</div>
<h3 id="标准误">标准误</h3>
<p>如果要计算LSE的标准误，需要考虑如下公式：</p>
<p><span class="math display">\[
(\mathbf{X^\top X})^{-1} = (\mathbf{R^\top Q^\top QR})^{-1} = (\mathbf{R^\top R})^{-1}
\]</span> 使用<code>chol12inv()</code>函数是专门用于计算这个逆矩阵的，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">df &lt;- length(y) - QR$rank</div><div class="line">sigma2 &lt;- sum((y-fitted)^<span class="number">2</span>)/df</div><div class="line">varbeta &lt;- sigma2*chol2inv(qr.R(QR))</div><div class="line">SE &lt;- sqrt(diag(varbeta))</div><div class="line">cbind(betahat,SE)</div><div class="line">summary(lm(y~<span class="number">0</span>+X))$coef</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&gt; cbind(betahat,SE)</div><div class="line">                              SE</div><div class="line">Intercept <span class="number">0.9038372</span> <span class="number">4.508440e-01</span></div><div class="line">x         <span class="number">1.0066440</span> <span class="number">7.858164e-03</span></div><div class="line">x2        <span class="number">0.9999622</span> <span class="number">3.661705e-05</span></div><div class="line">x3        <span class="number">1.0000001</span> <span class="number">4.802429e-08</span></div><div class="line">&gt; summary(lm(y~<span class="number">0</span>+X))$coef</div><div class="line">            Estimate   Std. Error      t value      Pr(&gt;|t|)</div><div class="line">XIntercept <span class="number">0.9038372</span> <span class="number">4.508440e-01</span> <span class="number">2.004767e+00</span>  <span class="number">5.089408e-02</span></div><div class="line">Xx         <span class="number">1.0066440</span> <span class="number">7.858164e-03</span> <span class="number">1.281017e+02</span>  <span class="number">2.171355e-60</span></div><div class="line">Xx2        <span class="number">0.9999622</span> <span class="number">3.661705e-05</span> <span class="number">2.730865e+04</span> <span class="number">1.745091e-167</span></div><div class="line">Xx3        <span class="number">1.0000001</span> <span class="number">4.802429e-08</span> <span class="number">2.082280e+07</span> <span class="number">4.558613e-300</span></div></pre></td></tr></table></figure>
<h2 id="其它线性模型">其它线性模型</h2>
<p>这一部分的参考R markdown文档见<a href="https://github.com/genomicsclass/labs/blob/master/linear/linear_models_going_further.Rmd" target="_blank" rel="external">Github</a>。</p>
<p>线性模型的用途使用非常广，并且它还可以扩展到其它方面，后面就介绍一些线性模型的拓展。</p>
<h3 id="稳健线性模型robust-linear-models">稳健线性模型(Robust linear models)</h3>
<p>在标准线性模型里，我们在计算它的解以及估计误差时，我们通常会通过计算最小平方误差来实现目标。这就涉及所有点的平方和，同时，这也表明，一旦数据中存在着异常值，那么这些异常值就会对计算结果产生重要的影响。此外，我们在使用线性模型时，我们是假定误差是恒定的（也就是同方差性，或齐方差性，homoskedasticity），不过在实际运用过程中，这种假设并非总成立（如果误差不剂，我们称为异方差性，heteroskedasticity）。因此需要其它一些方法用于产生稳健的解决方案，这些新的方法可以很好地处理异常值，或者是当我们的假设（也是同方差时）不满足时，这些模型也能很好地实现目的。在R的官网上，有介绍这些方差的内容<a href="https://cran.r-project.org/web/views/Robust.html" target="_blank" rel="external">《CRAN Task View: Robust Statistical Methods》</a>。</p>
<h3 id="广义线性模型generalized-linear-modelsglm">广义线性模型(Generalized linear models,GLM)</h3>
<p>在标准线性模型里，我们对<span class="math inline">\(\mathbf{Y}\)</span>的分布没做任何假设，但是在某些情况下，如果我们知道了<span class="math inline">\(\mathbf{Y}\)</span>，例如<span class="math inline">\(\mathbf{Y}\)</span>仅限于非负整数 <span class="math inline">\(0,1,2,\dots\)</span>，或者是限于区间<span class="math inline">\([0,1]\)</span>。用于分析这类情况的框架被称为广义线性模型，通常缩写为GLMs。GLM的两个关键组成部分就是链接函数与概率分布。链接函数<span class="math inline">\(g\)</span>会通常以下方式将我们熟悉的矩阵乘积 <span class="math inline">\(\mathbf{X} \boldsymbol{\beta}\)</span> 与<span class="math inline">\(\mathbf{Y}\)</span>值链接起来：</p>
<p><span class="math display">\[
\textrm{E}(\mathbf{Y}) = g^{-1}( \mathbf{X} \boldsymbol{\beta} )
\]</span></p>
<p>在R中，使用<code>glm()</code>函数来拟合GLMs，并使用与<code>lm()</code>函数类似的形式来进行计算。其它的参数还包括<code>family</code>，它用于指定<span class="math inline">\(\mathbf{Y}\)</span>的分布假设。在<a href="https://www.statmethods.net/advstats/glm.html" target="_blank" rel="external">QuickR</a>网站上，我们可以看到很多GLM的使用案例。</p>
<h3 id="混合效应线性模型mixed-effects-linear-models">混合效应线性模型(Mixed effects linear models)</h3>
<p>在标准线性模型里，我们假设矩阵<span class="math inline">\(\mathbf{X}\)</span>是固定的(fixed)，并不随机。例如，我们检测了每对腿的摩擦系数，以及push和pull方向。在<span class="math inline">\(\mathbf{X}\)</span>矩阵中，如果在特定的列中含有1，那么这1列就不是随机的，而是由设计矩阵决定的。但是在父子高度的案例中，我们并没有固定父亲身高的数值，而是观察到了这些值（通过一些误差来对抽样数据进行检测）。用于研究<span class="math inline">\(\mathbf{X}\)</span>中各个列的随机性影响的框架被称为混合效应模型，这就意味着一些效应是固定的，一些是效应是随机的。R中用于拟合线性模型的一个包是<code>lme4</code>，这个包还发了相应的论文《 Fitting Linear Mixed-Effects Models using lme4》。</p>
<h3 id="贝叶斯线性模型bayesian-linear-models">贝叶斯线性模型(Bayesian linear models)</h3>
<p>这种方法呈现的是假设<span class="math inline">\(\beta\)</span>是一个固定参数（非随机）。我们提取了估计此参数的方法，以及估计过程中如何量化这些参数不确定性的标准误差。这种方法是就所谓的频率论方法(frequentist)。另一种方法是假设<span class="math inline">\(\beta\)</span>是随机的，它的分布可以对我们先前关于<span class="math inline">\(\beta\)</span>应该是什么进行量化。一旦我们观察到数据，那么我们通过计算给定数据的<span class="math inline">\(\beta\)</span>条件分布（称为后验分布,posterior)，我们就就更新我们先前的信息，这种方法称贝叶斯方法。例如，一旦我们计算了<span class="math inline">\(\beta\)</span>的后验分布，我们就可以计算出某事件最容易发生的一个区间（可信区间）。此外，许多模型可以连接在一起，也就是所谓的分层模型(hierarchical mode)。在后面的内容里，我们会介绍贝叶斯统计和层次模型。贝叶斯分层模型的一本很好的书是<a href="http://www.stat.columbia.edu/~gelman/book/" target="_blank" rel="external">《Bayesian Data Analysis》</a>，在CRAN里，也有计算贝叶斯线性模型的包。其它的一些计算贝叶斯模型的软件是stan和BUGS。</p>
<h3 id="惩罚线性模型penalized-linear-models">惩罚线性模型(Penalized linear models)</h3>
<p>如果我们在模型中包含足够的参数，我们就可以实现残差平方和为0。惩罚纯情模型引入了一个惩罚项到最小化的最小二乘方程里。这些惩罚项通常是<span class="math inline">\(\lambda \sum_{j=1}^p \|\beta_j\|^k\)</span>这个形式，它们对大的绝对值以及大量的参数进行惩罚。添加这个额外的参数的目的就是避免过拟合。如果要使用这些模型，我们需要选择使用哪种模式来决定我们的惩罚程度。当<span class="math inline">\(k=2\)</span>时，这种模型称为岭回归(ridge regression)，Tikhonov正则化(regularization)L2正则化。当<span class="math inline">\(k=1\)</span>时，被称为LASSO或L1正则化。有关这些惩罚线性模型的一本书是《Elements of Statistical Learn》（网上有免费的电子版）。与这些模型有关的R函数包括<code>MASS</code>包里的<code>lm.ridge</code>函数，还有<code>lars</code>包，<code>glmnet</code>包。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-tags" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rvdsd.top/2019/08/19/DAL/DALS013_Linear_Models03ContrastInteraction/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="RVDSD">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RVDSD的个人笔记本">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/19/DAL/DALS013_Linear_Models03ContrastInteraction/" itemprop="url">DALS013-Linear Models线性模型03比较(contrast)与交互项</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-19T12:00:00+08:00">
                2019-08-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/生物统计/" itemprop="url" rel="index">
                    <span itemprop="name">生物统计</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  6,412
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  30
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言">前言</h2>
<p>这一部分是《Data Analysis for the life sciences》的第5章线性模型的第3小节。这一部分的主要内容涉及线性回归的比较与交互项。</p>
<h2 id="文献解读">文献解读</h2>
<p>我们会使用一篇文献中的数据集来学习复杂的线性模型，这个数据集包括了蜘蛛不同腿上的不同摩擦系数，具体地说就是，我们要研究腿部的推拉运动是否会产生不同强度的摩擦力。</p>
<p>文献信息如下所示：</p>
<blockquote>
<p>Jonas O. Wolff &amp; Stanislav N. Gorb, Radial arrangement of Janus-like setae permits friction control in spiders⁷³, Scientific Reports, 22 January 2013.</p>
</blockquote>
<p>通过这篇文献的摘要我们大致知道这篇文献的主要研究内容是，研究了一种游猎型蜘蛛Cupiennius Salei（蜘蛛目，蜘蛛科）在其远端腿上有毛状附着垫(爪状毛)，这个附着垫是由定向分枝的刚毛组成的。作者测量了爪状毛在光滑玻璃上的摩擦力，从而揭示了垫内刚毛排列的功能效应。</p>
<p>文献的Figure1如下所示：</p>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190823170434.jpg">

</div>
<p>Figure1一些有关蜘蛛爪状毛(claw tufts)的电镜照片，这些都是专业知识，我们不用管，我们主要的兴趣在Figure4上，如下所示：</p>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190823170634.jpg">

</div>
<p>Figure4比较了拉(pulling)与推(pushing)这两个动作 ，也就是Figure3中的A图，如下所示：</p>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190823171338.png">

</div>
<h2 id="导入数据">导入数据</h2>
<p>作者已经在他的Github上分享的文献的原始实验数据，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">url &lt;- <span class="string">"https://raw.githubusercontent.com/genomicsclass/dagdata/master/inst/extd\</span></div><div class="line"><span class="string">ata/spider_wolff_gorb_2013.csv"</span></div><div class="line">filename &lt;- <span class="string">"spider_wolff_gorb_2013.csv"</span></div><div class="line"><span class="keyword">library</span>(downloader)</div><div class="line"><span class="keyword">if</span> (!file.exists(filename)) download(url, filename)</div><div class="line">spider &lt;- read.csv(filename, skip=<span class="number">1</span>)</div></pre></td></tr></table></figure>
<p>先来大概看一下数据，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&gt; table(spider$leg,spider$type)</div><div class="line">    </div><div class="line">     pull push</div><div class="line">  L1   <span class="number">34</span>   <span class="number">34</span></div><div class="line">  L2   <span class="number">15</span>   <span class="number">15</span></div><div class="line">  L3   <span class="number">52</span>   <span class="number">52</span></div><div class="line">  L4   <span class="number">40</span>   <span class="number">40</span></div></pre></td></tr></table></figure>
<p>其中L1~L4是蜘蛛身上不同的腿，现在我们画一个箱线图来看一下这些数据，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">boxplot(spider$friction ~ spider$type * spider$leg,</div><div class="line">col=c(<span class="string">"grey90"</span>,<span class="string">"grey40"</span>), las=<span class="number">2</span>,</div><div class="line">main=<span class="string">"Comparison of friction coefficients of different leg pairs"</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190823171743.jpeg">

</div>
<p>从这张图上我们可以直接看出2点信息：</p>
<ol style="list-style-type: decimal">
<li>拉(pulling)比推(pushing)产生的摩擦力更大；</li>
<li>后腿（也就是L4）产生的拉力(puling friction)最高。</li>
</ol>
<p>另外，如果仔细看箱线图的话，还会发现，不同组之间的平均值分布不同，这就是组内方差(within-group variance)。对于线性模型来说，有时候组内方差会成为一个问题，因为我们会假设每组的均值会在总体均值附近波动，也就是说误差<span class="math inline">\(\varepsilon_{i}\)</span> 的分布是相同的，也就是说，每组的方差是相同的。如果忽视不同的组的不同方差，那么一些方差比较小的组就会显示过于“保守”（因为方差的总体估计会大于这些组的估计），并且具有较大方差的那些之间的比较置信度会过高。如果这些异常分布与摩擦力的范围有关，那么摩擦力值较大的数据造成的影响也大，因此可以采用log或sqrt转换来对数据进行预处理。</p>
<p>如果不进行数据转换（例如log转换或sqrt转换），那么我们也可以使用其他的统计检验，例如Welch t检验或Satterthwaite approximation（这两种都是t检验的扩展，可以在方差不齐的时候使用），或Wilcoxon秩和检验。但是，在这里，我们为了说明一些问题，我们会采用一个线性模型，这个模型假定不同组的方差相同。</p>
<h2 id="单变量线性模型">单变量线性模型</h2>
<p>先看简单的案例，也就是先研究一个变量，即我们现在只研究L1腿，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">head(spider)</div><div class="line">spider.sub &lt;- spider[spider$leg == <span class="string">"L1"</span>,]</div><div class="line">head(spider.sub)</div><div class="line">fit &lt;- lm(friction ~ type, data=spider.sub)</div><div class="line">summary(fit)</div><div class="line">(coefs &lt;- coef(fit))</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"> head(spider)</div><div class="line">  leg type friction</div><div class="line"><span class="number">1</span>  L1 pull     <span class="number">0.90</span></div><div class="line"><span class="number">2</span>  L1 pull     <span class="number">0.91</span></div><div class="line"><span class="number">3</span>  L1 pull     <span class="number">0.86</span></div><div class="line"><span class="number">4</span>  L1 pull     <span class="number">0.85</span></div><div class="line"><span class="number">5</span>  L1 pull     <span class="number">0.80</span></div><div class="line"><span class="number">6</span>  L1 pull     <span class="number">0.87</span></div><div class="line">&gt; spider.sub &lt;- spider[spider$leg == <span class="string">"L1"</span>,]</div><div class="line">&gt; head(spider.sub)</div><div class="line">  leg type friction</div><div class="line"><span class="number">1</span>  L1 pull     <span class="number">0.90</span></div><div class="line"><span class="number">2</span>  L1 pull     <span class="number">0.91</span></div><div class="line"><span class="number">3</span>  L1 pull     <span class="number">0.86</span></div><div class="line"><span class="number">4</span>  L1 pull     <span class="number">0.85</span></div><div class="line"><span class="number">5</span>  L1 pull     <span class="number">0.80</span></div><div class="line"><span class="number">6</span>  L1 pull     <span class="number">0.87</span></div><div class="line">&gt; fit &lt;- lm(friction ~ type, data=spider.sub)</div><div class="line">&gt; summary(fit)</div><div class="line"></div><div class="line">Call:</div><div class="line">lm(formula = friction ~ type, data = spider.sub)</div><div class="line"></div><div class="line">Residuals:</div><div class="line">     Min       1Q   Median       3Q      Max </div><div class="line">-<span class="number">0.33147</span> -<span class="number">0.10735</span> -<span class="number">0.04941</span> -<span class="number">0.00147</span>  <span class="number">0.76853</span> </div><div class="line"></div><div class="line">Coefficients:</div><div class="line">            Estimate Std. Error t value Pr(&gt;|t|)</div><div class="line">(Intercept)  <span class="number">0.92147</span>    <span class="number">0.03827</span>  <span class="number">24.078</span>  &lt; <span class="number">2e-16</span></div><div class="line">typepush    -<span class="number">0.51412</span>    <span class="number">0.05412</span>  -<span class="number">9.499</span>  <span class="number">5.7e-14</span></div><div class="line">               </div><div class="line">(Intercept) ***</div><div class="line">typepush    ***</div><div class="line">---</div><div class="line">Signif. codes:  </div><div class="line"><span class="number">0</span> ‘***’ <span class="number">0.001</span> ‘**’ <span class="number">0.01</span> ‘*’ <span class="number">0.05</span> ‘.’ <span class="number">0.1</span> ‘ ’ <span class="number">1</span></div><div class="line"></div><div class="line">Residual standard error: <span class="number">0.2232</span> on <span class="number">66</span> degrees of freedom</div><div class="line">Multiple R-squared:  <span class="number">0.5776</span>,	Adjusted R-squared:  <span class="number">0.5711</span> </div><div class="line"><span class="literal">F</span>-statistic: <span class="number">90.23</span> on <span class="number">1</span> and <span class="number">66</span> DF,  p-value: <span class="number">5.698e-14</span></div><div class="line">&gt; (coefs &lt;- coef(fit))</div><div class="line">(Intercept)    typepush </div><div class="line">  <span class="number">0.9214706</span>  -<span class="number">0.5141176</span></div></pre></td></tr></table></figure>
<p>从上面的结果可以看出，L1这一组（L1这一组中有push，有pull）的均值为0.9214706，拉(pull)与推(push)摩擦力的差值是-0.5141176 ，现在我们在R中再计算一下，看是否相符，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">s &lt;- split(spider.sub$friction, spider.sub$type)</div><div class="line">mean(s[[<span class="string">"pull"</span>]])</div><div class="line">mean(s[[<span class="string">"push"</span>]]) - mean(s[[<span class="string">"pull"</span>]])</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt; s &lt;- split(spider.sub$friction, spider.sub$type)</div><div class="line">&gt; mean(s[[<span class="string">"pull"</span>]])</div><div class="line">[<span class="number">1</span>] <span class="number">0.9214706</span></div><div class="line">&gt; mean(s[[<span class="string">"push"</span>]]) - mean(s[[<span class="string">"pull"</span>]])</div><div class="line">[<span class="number">1</span>] -<span class="number">0.5141176</span></div></pre></td></tr></table></figure>
<p>上面的是常规方法，我们也可以通过设计矩阵来进行计算，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">X &lt;- model.matrix(~ type, data=spider.sub)</div><div class="line">colnames(X)</div><div class="line">head(X)</div><div class="line">tail(X)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&gt; X &lt;- model.matrix(~ type, data=spider.sub)</div><div class="line">&gt; colnames(X)</div><div class="line">[<span class="number">1</span>] <span class="string">"(Intercept)"</span> <span class="string">"typepush"</span>   </div><div class="line">&gt; head(X)</div><div class="line">  (Intercept) typepush</div><div class="line"><span class="number">1</span>           <span class="number">1</span>        <span class="number">0</span></div><div class="line"><span class="number">2</span>           <span class="number">1</span>        <span class="number">0</span></div><div class="line"><span class="number">3</span>           <span class="number">1</span>        <span class="number">0</span></div><div class="line"><span class="number">4</span>           <span class="number">1</span>        <span class="number">0</span></div><div class="line"><span class="number">5</span>           <span class="number">1</span>        <span class="number">0</span></div><div class="line"><span class="number">6</span>           <span class="number">1</span>        <span class="number">0</span></div><div class="line">&gt; tail(X)</div><div class="line">   (Intercept) typepush</div><div class="line"><span class="number">63</span>           <span class="number">1</span>        <span class="number">1</span></div><div class="line"><span class="number">64</span>           <span class="number">1</span>        <span class="number">1</span></div><div class="line"><span class="number">65</span>           <span class="number">1</span>        <span class="number">1</span></div><div class="line"><span class="number">66</span>           <span class="number">1</span>        <span class="number">1</span></div><div class="line"><span class="number">67</span>           <span class="number">1</span>        <span class="number">1</span></div><div class="line"><span class="number">68</span>           <span class="number">1</span>        <span class="number">1</span></div></pre></td></tr></table></figure>
<p>现在我们来绘制一个<span class="math inline">\(\mathbf{X}\)</span>矩阵的示意图，其中，黑块表示1，白块表示0，这种方法对于我们理解线性模型比较有用。在这个图形中，y轴表示样本数目（也就是数据的行数），x轴是设计矩阵<span class="math inline">\(\mathbf{X}\)</span>的列。我们使用<code>rafalib</code>包中的<code>imagemat()</code>函数即可，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(rafalib)</div><div class="line">imagemat(X, main=<span class="string">"Model matrix for linear model with one variable"</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190823175538.jpeg">

</div>
<h3 id="计算估计系数examining-the-estimated-coefficients">计算估计系数(examining the estimated coefficients)</h3>
<p>下图是由线性模型计算而来的估计系数：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">set.seed(<span class="number">1</span>) <span class="comment">#same jitter in stripchart</span></div><div class="line">stripchart(split(spider.sub$friction, spider.sub$type), </div><div class="line">           vertical=<span class="literal">TRUE</span>, pch=<span class="number">1</span>, method=<span class="string">"jitter"</span>, las=<span class="number">2</span>, xlim=c(<span class="number">0</span>,<span class="number">3</span>), ylim=c(<span class="number">0</span>,<span class="number">2</span>))</div><div class="line">a &lt;- -<span class="number">0.25</span></div><div class="line">lgth &lt;- <span class="number">.1</span></div><div class="line"><span class="keyword">library</span>(RColorBrewer)</div><div class="line">cols &lt;- brewer.pal(<span class="number">3</span>,<span class="string">"Dark2"</span>)</div><div class="line">abline(h=<span class="number">0</span>)</div><div class="line">arrows(<span class="number">1</span>+a,<span class="number">0</span>,<span class="number">1</span>+a,coefs[<span class="number">1</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">1</span>],length=lgth)</div><div class="line">abline(h=coefs[<span class="number">1</span>],col=cols[<span class="number">1</span>])</div><div class="line">arrows(<span class="number">2</span>+a,coefs[<span class="number">1</span>],<span class="number">2</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">2</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">2</span>],length=lgth)</div><div class="line">abline(h=coefs[<span class="number">1</span>]+coefs[<span class="number">2</span>],col=cols[<span class="number">2</span>])</div><div class="line">legend(<span class="string">"right"</span>,names(coefs),fill=cols,cex=<span class="number">.75</span>,bg=<span class="string">"white"</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190823191147.jpeg">

</div>
<p>其中，绿色箭头表示截矩(Intercept)，其范围是从0到参考组均值的距离(这里的参考组是pull)。橘黄色的箭头表示push组与pull组的差值，在上面图形中，箭头向下，表示负值。小圆圈表示的是每个数据，其中为了避免相同数据的重叠，就在水平上进行了一定程度的波动。</p>
<h2 id="双变量线性模型">双变量线性模型</h2>
<p>再进一步，现在我们研究整个数据集。为了研究不同的腿（L1，L2，L3和L4）的push和pull的差异，我们需要构建一个双变量R公式(R formula)，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">X &lt;- model.matrix(~ type + leg, data=spider)</div><div class="line">colnames(X)</div><div class="line">head(X)</div><div class="line">imagemat(X, main=<span class="string">"Model matrix for linear model with two factors"</span>)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&gt; X &lt;- model.matrix(~ type + leg, data=spider)</div><div class="line">&gt; colnames(X)</div><div class="line">[<span class="number">1</span>] <span class="string">"(Intercept)"</span> <span class="string">"typepush"</span>    <span class="string">"legL2"</span>       <span class="string">"legL3"</span>       <span class="string">"legL4"</span>      </div><div class="line">&gt; head(X)</div><div class="line">  (Intercept) typepush legL2 legL3 legL4</div><div class="line"><span class="number">1</span>           <span class="number">1</span>        <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></div><div class="line"><span class="number">2</span>           <span class="number">1</span>        <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></div><div class="line"><span class="number">3</span>           <span class="number">1</span>        <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></div><div class="line"><span class="number">4</span>           <span class="number">1</span>        <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></div><div class="line"><span class="number">5</span>           <span class="number">1</span>        <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></div><div class="line"><span class="number">6</span>           <span class="number">1</span>        <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190823180943.jpeg">

</div>
<p>上面的黑白图是对公式<code>type+leg</code>的简单表示。</p>
<p>从计算结果，以及黑白示意图上我们可以知道：</p>
<p>第1列是截矩(intercept)，所有值都是1；</p>
<p>第2列：含有1的是push，从示意图上可以看出来，1是黑色，连续的黑色方块一共是4块，因此一共是4组；</p>
<p>第3列：含有1的是L2；</p>
<p>第4列：含有1的是L3；</p>
<p>第5列：含有1的是L4。</p>
<p>这里没有提到L1是因为L1是leg变量的参考水平。同样的，里面也没有提到pull，因为pull是type变量的参考水平。</p>
<p>如果要计算出相应的系数，需要使用<code>lm()</code>函数，公式为<code>~ type + leg</code>，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">fitTL &lt;- lm(friction ~ type + leg, data=spider)</div><div class="line">summary(fitTL)</div><div class="line">(coefs &lt;- coef(fitTL))</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">&gt; fitTL &lt;- lm(friction ~ type + leg, data=spider)</div><div class="line">&gt; summary(fitTL)</div><div class="line"></div><div class="line">Call:</div><div class="line">lm(formula = friction ~ type + leg, data = spider)</div><div class="line"></div><div class="line">Residuals:</div><div class="line">     Min       1Q   Median       3Q      Max </div><div class="line">-<span class="number">0.46392</span> -<span class="number">0.13441</span> -<span class="number">0.00525</span>  <span class="number">0.10547</span>  <span class="number">0.69509</span> </div><div class="line"></div><div class="line">Coefficients:</div><div class="line">            Estimate Std. Error t value Pr(&gt;|t|)    </div><div class="line">(Intercept)  <span class="number">1.05392</span>    <span class="number">0.02816</span>  <span class="number">37.426</span>  &lt; <span class="number">2e-16</span> ***</div><div class="line">typepush    -<span class="number">0.77901</span>    <span class="number">0.02482</span> -<span class="number">31.380</span>  &lt; <span class="number">2e-16</span> ***</div><div class="line">legL2        <span class="number">0.17192</span>    <span class="number">0.04569</span>   <span class="number">3.763</span> <span class="number">0.000205</span> ***</div><div class="line">legL3        <span class="number">0.16049</span>    <span class="number">0.03251</span>   <span class="number">4.937</span> <span class="number">1.37e-06</span> ***</div><div class="line">legL4        <span class="number">0.28134</span>    <span class="number">0.03438</span>   <span class="number">8.183</span> <span class="number">1.01e-14</span> ***</div><div class="line">---</div><div class="line">Signif. codes:  <span class="number">0</span> ‘***’ <span class="number">0.001</span> ‘**’ <span class="number">0.01</span> ‘*’ <span class="number">0.05</span> ‘.’ <span class="number">0.1</span> ‘ ’ <span class="number">1</span></div><div class="line"></div><div class="line">Residual standard error: <span class="number">0.2084</span> on <span class="number">277</span> degrees of freedom</div><div class="line">Multiple R-squared:  <span class="number">0.7916</span>,	Adjusted R-squared:  <span class="number">0.7886</span> </div><div class="line"><span class="literal">F</span>-statistic:   <span class="number">263</span> on <span class="number">4</span> and <span class="number">277</span> DF,  p-value: &lt; <span class="number">2.2e-16</span></div><div class="line">&gt; (coefs &lt;- coef(fitTL))</div><div class="line">(Intercept)    typepush       legL2       legL3       legL4 </div><div class="line">  <span class="number">1.0539153</span>  -<span class="number">0.7790071</span>   <span class="number">0.1719216</span>   <span class="number">0.1604921</span>   <span class="number">0.2813382</span></div></pre></td></tr></table></figure>
<p>R的计算结果中，在<code>coefficient</code>这一部分中含有最小方差估计值。</p>
<h2 id="数学表达式">数学表达式</h2>
<p>我们拟合的线性模型可以使用下面的式子表示： <span class="math display">\[
Y_i = \beta_0 + \beta_1 x_{i,1} + \beta_2 x_{i,2} + \beta_3 x_{i,3} + \beta_4 x_{i,4} + \varepsilon_i, i=1,\dots,N
\]</span> 其中，<span class="math inline">\(x\)</span>表示所有的指示变量(indicator variables)，在这个案例中指提是不同腿的push与pull。例如对于第3条腿的push来说，就是<span class="math inline">\(x_{i,1}\)</span>与<span class="math inline">\(x_{i,3}\)</span>等于1，剩下的等于0。<span class="math inline">\(\beta\)</span>指的是它们表示的效应大小。例如<span class="math inline">\(\beta_{0}\)</span>表示截矩，而<span class="math inline">\(\beta_{1}\)</span>表示pull效应(pull effect)，而<span class="math inline">\(\beta_{2}\)</span>一表示L2效应等。上面计算结果里没有直接表明系数，即<span class="math inline">\(\beta_{1}\)</span>，但是标明了估计值，例如<span class="math inline">\(\hat{\beta_{4}}\)</span>。</p>
<p>我们还可以使用矩阵来计算最小二乘估计，如下所示：</p>
<p><span class="math display">\[
\hat{\boldsymbol{\beta}} = (\mathbf{X}^\top \mathbf{X})^{-1} \mathbf{X}^\top \mathbf{Y}
\]</span> 如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Y &lt;- spider$friction</div><div class="line">X &lt;- model.matrix(~ type + leg, data=spider)</div><div class="line">beta.hat &lt;- solve(t(X) %*% X) %*% t(X) %*% Y</div><div class="line">t(beta.hat)</div><div class="line">coefs</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&gt; t(beta.hat)</div><div class="line">     (Intercept)   typepush     legL2     legL3     legL4</div><div class="line">[<span class="number">1</span>,]    <span class="number">1.053915</span> -<span class="number">0.7790071</span> <span class="number">0.1719216</span> <span class="number">0.1604921</span> <span class="number">0.2813382</span></div><div class="line">&gt; coefs</div><div class="line">(Intercept)    typepush       legL2       legL3       legL4 </div><div class="line">  <span class="number">1.0539153</span>  -<span class="number">0.7790071</span>   <span class="number">0.1719216</span>   <span class="number">0.1604921</span>   <span class="number">0.2813382</span></div></pre></td></tr></table></figure>
<p>从上面的结果可以看出来，这个与<code>lm()</code>计算出来的结果一样。</p>
<h3 id="计算估计值系数">计算估计值系数</h3>
<p>现在绘制出上述结果的示意图，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">spider$group &lt;- factor(paste0(spider$leg, spider$type))</div><div class="line">stripchart(split(spider$friction, spider$group), </div><div class="line">           vertical=<span class="literal">TRUE</span>, pch=<span class="number">1</span>, method=<span class="string">"jitter"</span>, las=<span class="number">2</span>, xlim=c(<span class="number">0</span>,<span class="number">11</span>), ylim=c(<span class="number">0</span>,<span class="number">2</span>))</div><div class="line">cols &lt;- brewer.pal(<span class="number">5</span>,<span class="string">"Dark2"</span>)</div><div class="line">abline(h=<span class="number">0</span>)</div><div class="line">arrows(<span class="number">1</span>+a,<span class="number">0</span>,<span class="number">1</span>+a,coefs[<span class="number">1</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">1</span>],length=lgth)</div><div class="line">abline(h=coefs[<span class="number">1</span>],col=cols[<span class="number">1</span>])</div><div class="line">arrows(<span class="number">3</span>+a,coefs[<span class="number">1</span>],<span class="number">3</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">3</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">3</span>],length=lgth)</div><div class="line">arrows(<span class="number">5</span>+a,coefs[<span class="number">1</span>],<span class="number">5</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">4</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">4</span>],length=lgth)</div><div class="line">arrows(<span class="number">7</span>+a,coefs[<span class="number">1</span>],<span class="number">7</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">5</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">5</span>],length=lgth)</div><div class="line">arrows(<span class="number">2</span>+a,coefs[<span class="number">1</span>],<span class="number">2</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">2</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">2</span>],length=lgth)</div><div class="line">segments(<span class="number">3</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">3</span>],<span class="number">4</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">3</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">3</span>])</div><div class="line">arrows(<span class="number">4</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">3</span>],<span class="number">4</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">3</span>]+coefs[<span class="number">2</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">2</span>],length=lgth)</div><div class="line">segments(<span class="number">5</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">4</span>],<span class="number">6</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">4</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">4</span>])</div><div class="line">arrows(<span class="number">6</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">4</span>],<span class="number">6</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">4</span>]+coefs[<span class="number">2</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">2</span>],length=lgth)</div><div class="line">segments(<span class="number">7</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">5</span>],<span class="number">8</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">5</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">5</span>])</div><div class="line">arrows(<span class="number">8</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">5</span>],<span class="number">8</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">5</span>]+coefs[<span class="number">2</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">2</span>],length=lgth)</div><div class="line">legend(<span class="string">"right"</span>,names(coefs),fill=cols,cex=<span class="number">.75</span>,bg=<span class="string">"white"</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190823191256.jpeg">

</div>
<p>上图是线性模型的估计值示意图。其中茶绿色(teal-green)箭头表示截矩(intercept)，它拟合的是参考组，这里指的是L1的pull。紫色(purple)、粉色(pink)，黄绿色(yello-green)表示提其它组与L1的差值。黄色箭头(orange arrow)表示是push和push的差值。</p>
<p>在这个案例中，每组拟合的均值是由拟合的系数推导出来的， 它与我们简单地从8组中计算的均值不太一致。原因是，我们的模型使用了5个系数，而不是8个。我们假设效应是可加的(additive)。但是我们在下文中还会考虑更多的因素来进行拟合，例如考虑这个数据集中的交互因素。</p>
<p>现在看一下简单地计算平均值与线性模型推导出来的平均值，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">s &lt;- split(spider$friction, spider$group)</div><div class="line">mean(s[[<span class="string">"L1pull"</span>]])</div><div class="line">coefs[<span class="number">1</span>]</div><div class="line">mean(s[[<span class="string">"L1push"</span>]])</div><div class="line">coefs[<span class="number">1</span>] + coefs[<span class="number">2</span>]</div></pre></td></tr></table></figure>
<p>计算结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&gt; s &lt;- split(spider$friction, spider$group)</div><div class="line">&gt; mean(s[[<span class="string">"L1pull"</span>]])</div><div class="line">[<span class="number">1</span>] <span class="number">0.9214706</span></div><div class="line">&gt; coefs[<span class="number">1</span>]</div><div class="line">(Intercept) </div><div class="line">   <span class="number">1.053915</span> </div><div class="line">&gt; mean(s[[<span class="string">"L1push"</span>]])</div><div class="line">[<span class="number">1</span>] <span class="number">0.4073529</span></div><div class="line">&gt; coefs[<span class="number">1</span>] + coefs[<span class="number">2</span>]</div><div class="line">(Intercept) </div><div class="line">  <span class="number">0.2749082</span></div></pre></td></tr></table></figure>
<p>上面的计算过程是比较push与pull的估计值，其中<code>coefs[2]</code>是每组均值差异的加权平均值。此外，权重(weight)是由每组的样本数量决定的。这里计算的过程非常简单，因为每组的样本数目(pull与push)都相等。如果样本数目不等（例如push和pull不等），那么权重的计算就比较复杂，但是，每组的样本数目，总的样本数目以及系数的数目都会计算出相应唯一的权重。这可能通过<span class="math inline">\((\mathbf{X}^\top \mathbf{X})^{-1} \mathbf{X}^\top\)</span>计算得到，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">means &lt;- sapply(s, mean)</div><div class="line">##the sample size of push or pull groups for each leg pair</div><div class="line">ns &lt;- sapply(s, length)[c(1,3,5,7)]</div><div class="line">(w &lt;- ns/sum(ns))</div><div class="line">sum(w * (means[c(2,4,6,8)] - means[c(1,3,5,7)]))</div><div class="line">coefs[2]</div><div class="line">sum(w * (means[c(2,4,6,8)] - means[c(1,3,5,7)]))</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&gt; (w &lt;- ns/sum(ns))</div><div class="line">   L1pull    L2pull    L3pull    L4pull </div><div class="line"><span class="number">0.2411348</span> <span class="number">0.1063830</span> <span class="number">0.3687943</span> <span class="number">0.2836879</span> </div><div class="line">&gt; sum(w * (means[c(<span class="number">2</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">8</span>)] - means[c(<span class="number">1</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">7</span>)]))</div><div class="line">[<span class="number">1</span>] -<span class="number">0.7790071</span></div><div class="line">&gt; coefs[<span class="number">2</span>]</div><div class="line">  typepush </div><div class="line">-<span class="number">0.7790071</span> </div><div class="line">&gt; sum(w * (means[c(<span class="number">2</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">8</span>)] - means[c(<span class="number">1</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">7</span>)]))</div><div class="line">[<span class="number">1</span>] -<span class="number">0.7790071</span></div></pre></td></tr></table></figure>
<h2 id="比较系数contrasting-coefficients">比较系数(Contrasting coefficients)</h2>
<p>有的时候，我们可能对模型中单个系数表示的比较结果感兴趣，例如push与pull的差值，也就是上面的<code>coefs[2]</code>。但是，有的时候，由单一的系数无法得到想要的比较结果，但是联合使用几个系数可以进行比较，这就是比较系数(contrast)。为了引入<code>contrast</code>的概念，我们先来看一下<code>coefs</code>这个变量，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt; coefs</div><div class="line">(Intercept)    typepush       legL2       legL3       legL4 </div><div class="line">  <span class="number">1.0539153</span>  -<span class="number">0.7790071</span>   <span class="number">0.1719216</span>   <span class="number">0.1604921</span>   <span class="number">0.2813382</span></div></pre></td></tr></table></figure>
<p>这个结果包含截矩的估计值，push与pull的估计效应，L2与L1效应的估计值，L3与L1效应估计值，L4与L1效应的估计值。假设我们想要比较两组数的效应大小，并且其中一组不是L1怎么办？这个解决过程就叫比较(<code>contrast</code>)。</p>
<p>比较(contrast)是对估计效应(estimated coefficient)的联合过计算，即<span class="math inline">\(\mathbf{c^\top} \hat{\boldsymbol{\beta}}\)</span>，其中<span class="math inline">\(\mathbf{c}\)</span>是一个列向量，其行数与线性模型系数的数目相同。如果<span class="math inline">\(\mathbf{c}\)</span>中含有1个或多个0，那就表示相应的<span class="math inline">\(\hat{\beta}\)</span>中的估计系数就不参与相应的比较系数(contrast)计算。</p>
<p>如果我们想比较L2和L3，它就相当于在线性模型中比较这两个系数，因为它们都是与L1进行比较的，如下所示：</p>
<p><span class="math display">\[
(\mbox{L3} - \mbox{L1}) - (\mbox{L2} - \mbox{L1}) = \mbox{L3} - \mbox{L2 }
\]</span> 对这两种进行比较的一个简单途径就是使用<code>constrast</code>包中的<code>contrast()</code>函数。我们只需要指定要比较的两组名称即可，现在我们来比较一下pull或push类型，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(contrast) <span class="comment">#Available from CRAN</span></div><div class="line">L3vsL2 &lt;- contrast(fitTL,list(leg=<span class="string">"L3"</span>,type=<span class="string">"pull"</span>),list(leg=<span class="string">"L2"</span>,type=<span class="string">"pull"</span>))</div><div class="line">L3vsL2</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt; L3vsL2</div><div class="line">lm model parameter contrast</div><div class="line"></div><div class="line">    Contrast       S.E.      Lower      Upper     t  df Pr(&gt;|t|)</div><div class="line"> -<span class="number">0.01142949</span> <span class="number">0.04319685</span> -<span class="number">0.0964653</span> <span class="number">0.07360632</span> -<span class="number">0.26</span> <span class="number">277</span>   <span class="number">0.7915</span></div></pre></td></tr></table></figure>
<p>第1列是<code>Contrast</code>，它表示的是L3与L2的估计值。</p>
<p>我们可以证明，系数的线性组合的最小二乘估计是这些估计的相同线性组合。因此，效应大小估计值(effect size estimate)就是两者之间的差值。使用<code>contrast()</code>函数进行比较的比较向量，被储备成为一个称为<code>X</code>变量中，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">coefs[<span class="number">4</span>] - coefs[<span class="number">3</span>]</div><div class="line">(cT &lt;- L3vsL2$X)</div><div class="line">cT %*% coefs</div></pre></td></tr></table></figure>
<p>计算结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&gt; coefs[<span class="number">4</span>] - coefs[<span class="number">3</span>]</div><div class="line">      legL3 </div><div class="line">-<span class="number">0.01142949</span> </div><div class="line">&gt; (cT &lt;- L3vsL2$X)</div><div class="line">  (Intercept) typepush legL2 legL3 legL4</div><div class="line"><span class="number">1</span>           <span class="number">0</span>        <span class="number">0</span>    -<span class="number">1</span>     <span class="number">1</span>     <span class="number">0</span></div><div class="line">attr(,<span class="string">"assign"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span></div><div class="line">attr(,<span class="string">"contrasts"</span>)</div><div class="line">attr(,<span class="string">"contrasts"</span>)$type</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div><div class="line"></div><div class="line">attr(,<span class="string">"contrasts"</span>)$leg</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div><div class="line"></div><div class="line">&gt; cT %*% coefs</div><div class="line">         [,<span class="number">1</span>]</div><div class="line"><span class="number">1</span> -<span class="number">0.01142949</span></div></pre></td></tr></table></figure>
<p>计算结果里面还有t检验与标准误，我们以前提到过，t检验是一个估计值，它的除数就标准误。比较估计值的标准误是由比较向量<span class="math inline">\(\mathbf{c}\)</span>乘以估计的协方差矩阵<span class="math inline">\(\hat{\Sigma}\)</span>的任意一边得到的，我们对var<span class="math inline">\(\hat{\beta}\)</span>的估计值如下所示： <span class="math display">\[
\sqrt{\mathbf{c^\top} \hat{\boldsymbol{\Sigma}} \mathbf{c}}
\]</span></p>
<p>系数的协方差为： <span class="math display">\[
\boldsymbol{\Sigma} = \sigma^2 (\mathbf{X}^\top \mathbf{X})^{-1}
\]</span> 我们使用样本估计值<span class="math inline">\(\hat{\sigma}^2\)</span>来估计<span class="math inline">\({\sigma}^2\)</span>，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Sigma.hat &lt;- sum(fitTL$residuals^<span class="number">2</span>)/(nrow(X) - ncol(X)) * solve(t(X) %*% X)</div><div class="line">signif(Sigma.hat, <span class="number">2</span>)</div><div class="line">sqrt(cT %*% Sigma.hat %*% t(cT))</div><div class="line">L3vsL2$SE</div></pre></td></tr></table></figure>
<p>计算结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&gt; Sigma.hat &lt;- sum(fitTL$residuals^<span class="number">2</span>)/(nrow(X) - ncol(X)) * solve(t(X) %*% X)</div><div class="line">&gt; signif(Sigma.hat, <span class="number">2</span>)</div><div class="line">            (Intercept) typepush    legL2    legL3    legL4</div><div class="line">(Intercept)     <span class="number">0.00079</span> -<span class="number">3.1e-04</span> -<span class="number">0.00064</span> -<span class="number">0.00064</span> -<span class="number">0.00064</span></div><div class="line">typepush       -<span class="number">0.00031</span>  <span class="number">6.2e-04</span>  <span class="number">0.00000</span>  <span class="number">0.00000</span>  <span class="number">0.00000</span></div><div class="line">legL2          -<span class="number">0.00064</span> -<span class="number">6.4e-20</span>  <span class="number">0.00210</span>  <span class="number">0.00064</span>  <span class="number">0.00064</span></div><div class="line">legL3          -<span class="number">0.00064</span> -<span class="number">6.4e-20</span>  <span class="number">0.00064</span>  <span class="number">0.00110</span>  <span class="number">0.00064</span></div><div class="line">legL4          -<span class="number">0.00064</span> -<span class="number">1.2e-19</span>  <span class="number">0.00064</span>  <span class="number">0.00064</span>  <span class="number">0.00120</span></div><div class="line">&gt; sqrt(cT %*% Sigma.hat %*% t(cT))</div><div class="line">           <span class="number">1</span></div><div class="line"><span class="number">1</span> <span class="number">0.04319685</span></div><div class="line">&gt; L3vsL2$SE</div><div class="line">[<span class="number">1</span>] <span class="number">0.04319685</span></div></pre></td></tr></table></figure>
<p>如果我们选择参数<code>type=&quot;push&quot;</code>，那么我们就会获得与L3和L2比较的一样的结果。其原因就是，在差值的两侧都添加了<code>typepush</code>效应（这一句不太理解）我们可以取消它，如下所示： <figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">L3vsL2.equiv &lt;- contrast(fitTL,list(leg=<span class="string">"L3"</span>,type=<span class="string">"push"</span>),list(leg=<span class="string">"L2"</span>,type=<span class="string">"push"</span>))</div><div class="line">L3vsL2.equiv$X</div></pre></td></tr></table></figure></p>
<p>运行结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&gt; L3vsL2.equiv &lt;- contrast(fitTL,list(leg=<span class="string">"L3"</span>,type=<span class="string">"push"</span>),list(leg=<span class="string">"L2"</span>,type=<span class="string">"push"</span>))</div><div class="line">&gt; L3vsL2.equiv$X</div><div class="line">  (Intercept) typepush legL2 legL3 legL4</div><div class="line"><span class="number">1</span>           <span class="number">0</span>        <span class="number">0</span>    -<span class="number">1</span>     <span class="number">1</span>     <span class="number">0</span></div><div class="line">attr(,<span class="string">"assign"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span></div><div class="line">attr(,<span class="string">"contrasts"</span>)</div><div class="line">attr(,<span class="string">"contrasts"</span>)$type</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div><div class="line"></div><div class="line">attr(,<span class="string">"contrasts"</span>)$leg</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div></pre></td></tr></table></figure>
<p>##交互项(<code>interaction terms</code>)</p>
<p>在前面的线性模型案例中，我们假设pull与push的效应对于所有的腿(leg)都是相同的（也就是说橘黄色的箭头是一样的），但是从我们最终计算的结果来看，并不能很好的捕获数据的趋势，换句话讲，就是简单与每组的平均值并不完全一致。例如L1组，push与pull估计系数太大，而L3组，push与pull又太小。</p>
<p>此时，我们引入交互项(interaction terms)，这个引入的系数可以解决不同组中push与pull差值过大的问题。由于我们在模型中已经有了push与pull项，因此我们只需要再添加三个项就能够找到leg-piar特异性push和pull的差异。在下面我们会向模型的设计矩阵中添加交互项(interaction terms)，其方法是将代表现有项的设计矩阵列相乘。</p>
<p>我们可以在<code>type</code>和<code>leg</code>之间构建一个交互项，即<code>type:leg</code>，其中的冒号<code>:</code>表示两个变量存在交互作用，另外一种相同的做法就是<code>~type*leg</code>，这两种写法都是主要研究<code>type</code>与<code>leg</code>之间的交互作用，而不研究其他变量之间的交互作用，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">url &lt;- <span class="string">"https://raw.githubusercontent.com/genomicsclass/dagdata/master/inst/extd\</span></div><div class="line"><span class="string">ata/spider_wolff_gorb_2013.csv"</span></div><div class="line">filename &lt;- <span class="string">"spider_wolff_gorb_2013.csv"</span></div><div class="line"><span class="keyword">library</span>(downloader)</div><div class="line"><span class="keyword">if</span> (!file.exists(filename)) download(url, filename)</div><div class="line">spider &lt;- read.csv(filename, skip=<span class="number">1</span>)</div><div class="line">X &lt;- model.matrix(~ type + leg + type:leg, data=spider)</div><div class="line">colnames(X)</div><div class="line">X &lt;- model.matrix(~type*leg, data=spider)</div><div class="line">colnames(X)</div><div class="line">head(X)</div><div class="line"><span class="keyword">library</span>(rafalib)</div><div class="line">imagemat(X, main=<span class="string">"Model matrix for linear model with interactions"</span>)</div></pre></td></tr></table></figure>
<p>计算结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&gt; X &lt;- model.matrix(~ type + leg + type:leg, data=spider)</div><div class="line">&gt; colnames(X)</div><div class="line">[<span class="number">1</span>] <span class="string">"(Intercept)"</span>    <span class="string">"typepush"</span>       <span class="string">"legL2"</span>          <span class="string">"legL3"</span>         </div><div class="line">[<span class="number">5</span>] <span class="string">"legL4"</span>          <span class="string">"typepush:legL2"</span> <span class="string">"typepush:legL3"</span> <span class="string">"typepush:legL4"</span></div><div class="line">&gt; X &lt;- model.matrix(~type*leg, data=spider)</div><div class="line">&gt; colnames(X)</div><div class="line">[<span class="number">1</span>] <span class="string">"(Intercept)"</span>    <span class="string">"typepush"</span>       <span class="string">"legL2"</span>          <span class="string">"legL3"</span>         </div><div class="line">[<span class="number">5</span>] <span class="string">"legL4"</span>          <span class="string">"typepush:legL2"</span> <span class="string">"typepush:legL3"</span> <span class="string">"typepush:legL4"</span></div><div class="line">&gt; head(X)</div><div class="line">  (Intercept) typepush legL2 legL3 legL4 typepush:legL2 typepush:legL3</div><div class="line"><span class="number">1</span>           <span class="number">1</span>        <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>              <span class="number">0</span>              <span class="number">0</span></div><div class="line"><span class="number">2</span>           <span class="number">1</span>        <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>              <span class="number">0</span>              <span class="number">0</span></div><div class="line"><span class="number">3</span>           <span class="number">1</span>        <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>              <span class="number">0</span>              <span class="number">0</span></div><div class="line"><span class="number">4</span>           <span class="number">1</span>        <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>              <span class="number">0</span>              <span class="number">0</span></div><div class="line"><span class="number">5</span>           <span class="number">1</span>        <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>              <span class="number">0</span>              <span class="number">0</span></div><div class="line"><span class="number">6</span>           <span class="number">1</span>        <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>              <span class="number">0</span>              <span class="number">0</span></div><div class="line">  typepush:legL4</div><div class="line"><span class="number">1</span>              <span class="number">0</span></div><div class="line"><span class="number">2</span>              <span class="number">0</span></div><div class="line"><span class="number">3</span>              <span class="number">0</span></div><div class="line"><span class="number">4</span>              <span class="number">0</span></div><div class="line"><span class="number">5</span>              <span class="number">0</span></div><div class="line"><span class="number">6</span>              <span class="number">0</span></div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190823225213.jpeg">

</div>
<p>其中，第6到8列表示的是：<code>typepush:legL2</code>，<code>typepush:legL3</code>与<code>typepush:legL4</code>，也就是说，它们是由第2列的<code>typepush</code>和第3到5列的<code>legL2</code>，<code>legL3</code>和<code>legL4</code>产生的。我们看最后1列，即<code>typepush:legL4</code>列，这是另外的一个系数，即<span class="math inline">\(\beta_{push,L4}\)</span>，此系数表示push与L4共同作用的样本。这就可能对L4-push这一组样本的均值的差异进行解释，例如当我们通过估计的截距、估计的typepush系数，估计的L4系数LegL4来对数据进行预测时产生偏差（例如数据点不在估计的直线上），当我们考虑了交互作用后，其结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">fitX &lt;- lm(friction ~ type + leg + type:leg, data=spider)</div><div class="line">summary(fitX)</div><div class="line">coefs &lt;- coef(fitX)</div><div class="line">coefs</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">&gt; fitX &lt;- lm(friction ~ type + leg + type:leg, data=spider)</div><div class="line">&gt; summary(fitX)</div><div class="line"></div><div class="line">Call:</div><div class="line">lm(formula = friction ~ type + leg + type:leg, data = spider)</div><div class="line"></div><div class="line">Residuals:</div><div class="line">     Min       1Q   Median       3Q      Max </div><div class="line">-<span class="number">0.46385</span> -<span class="number">0.10735</span> -<span class="number">0.01111</span>  <span class="number">0.07848</span>  <span class="number">0.76853</span> </div><div class="line"></div><div class="line">Coefficients:</div><div class="line">               Estimate Std. Error t value Pr(&gt;|t|)    </div><div class="line">(Intercept)     <span class="number">0.92147</span>    <span class="number">0.03266</span>  <span class="number">28.215</span>  &lt; <span class="number">2e-16</span> ***</div><div class="line">typepush       -<span class="number">0.51412</span>    <span class="number">0.04619</span> -<span class="number">11.131</span>  &lt; <span class="number">2e-16</span> ***</div><div class="line">legL2           <span class="number">0.22386</span>    <span class="number">0.05903</span>   <span class="number">3.792</span> <span class="number">0.000184</span> ***</div><div class="line">legL3           <span class="number">0.35238</span>    <span class="number">0.04200</span>   <span class="number">8.390</span> <span class="number">2.62e-15</span> ***</div><div class="line">legL4           <span class="number">0.47928</span>    <span class="number">0.04442</span>  <span class="number">10.789</span>  &lt; <span class="number">2e-16</span> ***</div><div class="line">typepush:legL2 -<span class="number">0.10388</span>    <span class="number">0.08348</span>  -<span class="number">1.244</span> <span class="number">0.214409</span>    </div><div class="line">typepush:legL3 -<span class="number">0.38377</span>    <span class="number">0.05940</span>  -<span class="number">6.461</span> <span class="number">4.73e-10</span> ***</div><div class="line">typepush:legL4 -<span class="number">0.39588</span>    <span class="number">0.06282</span>  -<span class="number">6.302</span> <span class="number">1.17e-09</span> ***</div><div class="line">---</div><div class="line">Signif. codes:  <span class="number">0</span> ‘***’ <span class="number">0.001</span> ‘**’ <span class="number">0.01</span> ‘*’ <span class="number">0.05</span> ‘.’ <span class="number">0.1</span> ‘ ’ <span class="number">1</span></div><div class="line"></div><div class="line">Residual standard error: <span class="number">0.1904</span> on <span class="number">274</span> degrees of freedom</div><div class="line">Multiple R-squared:  <span class="number">0.8279</span>,	Adjusted R-squared:  <span class="number">0.8235</span> </div><div class="line"><span class="literal">F</span>-statistic: <span class="number">188.3</span> on <span class="number">7</span> and <span class="number">274</span> DF,  p-value: &lt; <span class="number">2.2e-16</span></div><div class="line">&gt; coefs</div><div class="line">   (Intercept)       typepush          legL2          legL3          legL4 </div><div class="line">     <span class="number">0.9214706</span>     -<span class="number">0.5141176</span>      <span class="number">0.2238627</span>      <span class="number">0.3523756</span>      <span class="number">0.4792794</span> </div><div class="line">typepush:legL2 typepush:legL3 typepush:legL4 </div><div class="line">    -<span class="number">0.1038824</span>     -<span class="number">0.3837670</span>     -<span class="number">0.3958824</span></div></pre></td></tr></table></figure>
<h3 id="计算估计系数">计算估计系数</h3>
<p>现在我们先画一下上面的计算结果，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(RColorBrewer)</div><div class="line">spider$group &lt;- factor(paste0(spider$leg, spider$type))</div><div class="line">stripchart(split(spider$friction, spider$group), </div><div class="line">           vertical=<span class="literal">TRUE</span>, pch=<span class="number">1</span>, method=<span class="string">"jitter"</span>, las=<span class="number">2</span>, xlim=c(<span class="number">0</span>,<span class="number">11</span>), ylim=c(<span class="number">0</span>,<span class="number">2</span>))</div><div class="line">cols &lt;- brewer.pal(<span class="number">8</span>,<span class="string">"Dark2"</span>)</div><div class="line">abline(h=<span class="number">0</span>)</div><div class="line">arrows(<span class="number">1</span>+a,<span class="number">0</span>,<span class="number">1</span>+a,coefs[<span class="number">1</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">1</span>],length=lgth)</div><div class="line">abline(h=coefs[<span class="number">1</span>],col=cols[<span class="number">1</span>])</div><div class="line">arrows(<span class="number">2</span>+a,coefs[<span class="number">1</span>],<span class="number">2</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">2</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">2</span>],length=lgth)</div><div class="line">arrows(<span class="number">3</span>+a,coefs[<span class="number">1</span>],<span class="number">3</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">3</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">3</span>],length=lgth)</div><div class="line">arrows(<span class="number">5</span>+a,coefs[<span class="number">1</span>],<span class="number">5</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">4</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">4</span>],length=lgth)</div><div class="line">arrows(<span class="number">7</span>+a,coefs[<span class="number">1</span>],<span class="number">7</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">5</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">5</span>],length=lgth)</div><div class="line"><span class="comment">#now the interactions:</span></div><div class="line">segments(<span class="number">3</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">3</span>],<span class="number">4</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">3</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">3</span>])</div><div class="line">arrows(<span class="number">4</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">3</span>],<span class="number">4</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">3</span>]+coefs[<span class="number">2</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">2</span>],length=lgth)</div><div class="line">arrows(<span class="number">4</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">2</span>]+coefs[<span class="number">3</span>],<span class="number">4</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">2</span>]+coefs[<span class="number">3</span>]+coefs[<span class="number">6</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">6</span>],length=lgth)</div><div class="line">segments(<span class="number">5</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">4</span>],<span class="number">6</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">4</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">4</span>])</div><div class="line">arrows(<span class="number">6</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">4</span>],<span class="number">6</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">4</span>]+coefs[<span class="number">2</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">2</span>],length=lgth)</div><div class="line">arrows(<span class="number">6</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">4</span>]+coefs[<span class="number">2</span>],<span class="number">6</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">4</span>]+coefs[<span class="number">2</span>]+coefs[<span class="number">7</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">7</span>],length=lgth)</div><div class="line">segments(<span class="number">7</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">5</span>],<span class="number">8</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">5</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">5</span>])</div><div class="line">arrows(<span class="number">8</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">5</span>],<span class="number">8</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">5</span>]+coefs[<span class="number">2</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">2</span>],length=lgth)</div><div class="line">arrows(<span class="number">8</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">5</span>]+coefs[<span class="number">2</span>],<span class="number">8</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">5</span>]+coefs[<span class="number">2</span>]+coefs[<span class="number">8</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">8</span>],length=lgth)</div><div class="line">legend(<span class="string">"right"</span>,names(coefs),fill=cols,cex=<span class="number">.75</span>,bg=<span class="string">"white"</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190823232236.jpeg">

</div>
<p>估计的交互作用系数就能反映出在对push和pull进行比较时，leg-pair-specific导致的差值不同。上图的橘黄色简单表示的是与L1相比，push和pull的差值估计。如果估计的交互系数过大，那么push与pull差值的均值就与参考组相比（也就是L1组中push和pull差值的均值），非常不同。</p>
<p>### 比较(contrast)</p>
<p>在一些简单案例中，我们会使用<code>contrast</code>包来进行比较，混合计算估计系数。例如我们知道L2样本的push与pull效应。我们可以从上面箭图中看出来（也就是黄色箭头加上橘黄色简单），我们也可以在<code>contrast()</code>函数中指定要比较哪两组，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(contrast) <span class="comment">##Available from CRAN</span></div><div class="line">L2push.vs.pull &lt;- contrast(fitX,</div><div class="line">list(leg=<span class="string">"L2"</span>, type = <span class="string">"push"</span>),</div><div class="line">list(leg=<span class="string">"L2"</span>, type = <span class="string">"pull"</span>))</div><div class="line">L2push.vs.pull</div><div class="line">coefs[<span class="number">2</span>] + coefs[<span class="number">6</span>] <span class="comment">##we know this is also orange + yellow arrow</span></div></pre></td></tr></table></figure>
<p>计算结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&gt; L2push.vs.pull</div><div class="line">lm model parameter contrast</div><div class="line"></div><div class="line"> Contrast      S.E.      Lower      Upper     t  df Pr(&gt;|t|)</div><div class="line">   -<span class="number">0.618</span> <span class="number">0.0695372</span> -<span class="number">0.7548951</span> -<span class="number">0.4811049</span> -<span class="number">8.89</span> <span class="number">274</span>        <span class="number">0</span></div><div class="line">&gt; coefs[<span class="number">2</span>] + coefs[<span class="number">6</span>] <span class="comment">##we know this is also orange + yellow arrow</span></div><div class="line">typepush </div><div class="line">  -<span class="number">0.618</span></div></pre></td></tr></table></figure>
<h2 id="差值的差异differences-of-differences">差值的差异(Differences of differences)</h2>
<p>push与pull在L2中的差异和push与pull在L1中的差异是不同的，为什么会不同的，我们可以使用模型中的<code>typepush:legL2</code>估计系数，也就是上图中的黄色箭头。这个系数的p值是否等于0，可以从上面的<code>summary(fitX)</code>函数来查看。同样的，我们也可以看出来L3与L1中差值(push和pull的差值)的差异和L4与L1的差值。假设我们想知道push与pull在L3中的差异与L2中的差值是否相同。在上面的图形中，我们可以看到，除了L1之外的其他腿的push和pull效应就是typepush箭头加上该组的交互作用项。</p>
<p>如果我们想比较两个非参考组，那么数学公式如下所示： <span class="math display">\[
(\mbox{typepush} + \mbox{typepush:legL3}) - (\mbox{typepush} + \mbox{typepush:legL2})
\]</span> 可以简写为： <span class="math display">\[
= \mbox{typepush:legL3} - \mbox{typepush:legL2}
\]</span> 在这里我们无法使用<code>contrast()</code>函数直接比较，但是我们可以使用<code>glht()</code>函数进行比较（这个函数的全称是<code>general liner hypothesis test</code>)，这个函数在<code>multcomp</code>包中。为了使用<code>glht()</code>这个函数，我们需要构建一个矩阵，这个矩阵只有一行，其中<code>-1</code>表示<code>typepush:legL2</code>系数，其中<code>+1</code>表示<code>typepush:legL3</code>系数。我们将这个矩阵加入到<code>linfct()</code>函数中（这个函数是linear function的缩写），当成<code>linfct()</code>的参数，计算后，我们会获得一个有关估计交互系数比较的表，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(multcomp) <span class="comment">##Available from CRAN</span></div><div class="line">C &lt;- matrix(c(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,-<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>), <span class="number">1</span>)</div><div class="line">C</div><div class="line">L3vsL2interaction &lt;- glht(fitX, linfct=C)</div><div class="line">summary(L3vsL2interaction)</div></pre></td></tr></table></figure>
<p>计算结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&gt; C</div><div class="line">     [,<span class="number">1</span>] [,<span class="number">2</span>] [,<span class="number">3</span>] [,<span class="number">4</span>] [,<span class="number">5</span>] [,<span class="number">6</span>] [,<span class="number">7</span>] [,<span class="number">8</span>]</div><div class="line">[<span class="number">1</span>,]    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>   -<span class="number">1</span>    <span class="number">1</span>    <span class="number">0</span></div><div class="line">&gt; L3vsL2interaction &lt;- glht(fitX, linfct=C)</div><div class="line">&gt; summary(L3vsL2interaction)</div><div class="line"></div><div class="line">	 Simultaneous Tests <span class="keyword">for</span> General Linear Hypotheses</div><div class="line"></div><div class="line">Fit: lm(formula = friction ~ type + leg + type:leg, data = spider)</div><div class="line"></div><div class="line">Linear Hypotheses:</div><div class="line">       Estimate Std. Error t value Pr(&gt;|t|)    </div><div class="line"><span class="number">1</span> == <span class="number">0</span> -<span class="number">0.27988</span>    <span class="number">0.07893</span>  -<span class="number">3.546</span>  <span class="number">0.00046</span> ***</div><div class="line">---</div><div class="line">Signif. codes:  <span class="number">0</span> ‘***’ <span class="number">0.001</span> ‘**’ <span class="number">0.01</span> ‘*’ <span class="number">0.05</span> ‘.’ <span class="number">0.1</span> ‘ ’ <span class="number">1</span></div><div class="line">(Adjusted p values reported -- single-step method)</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-tags" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rvdsd.top/2019/08/18/DAL/DALS012_Linear_Models02MatrixMath/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="RVDSD">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RVDSD的个人笔记本">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/18/DAL/DALS012_Linear_Models02MatrixMath/" itemprop="url">DALS012-Linear Models线性模型02矩阵知识</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-18T12:00:00+08:00">
                2019-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/生物统计/" itemprop="url" rel="index">
                    <span itemprop="name">生物统计</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3,904
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  17
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言">前言</h2>
<p>这一部分是《Data Analysis for the life sciences》的第5章线性模型的第2小节。这一部分的主要内容涉及矩阵的数学计算原理。</p>
<p>先来看一下前面的一个案例。</p>
<h2 id="小鼠饲料案例">小鼠饲料案例</h2>
<p>在前面的内容中，我们使用了t检验来研究高脂饲料(hf)饲喂的小鼠与普通饲料(chow)饲喂的小鼠体重的差异，现在我们使用线性模型来研究一下这两种小鼠的体重是否有差异，最终我们会发现，这两种统计方法在本质上是一样的，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">dir &lt;- system.file(package = <span class="string">"dagdata"</span>)</div><div class="line">list.files(dir)</div><div class="line">dir</div><div class="line">filename &lt;- file.path(dir,<span class="string">"extdata/femaleMiceWeights.csv"</span>)</div><div class="line">dat &lt;- read.csv(filename)</div><div class="line"><span class="comment"># input raw data</span></div><div class="line">head(dat)</div><div class="line">str(dat)</div><div class="line">stripchart(dat$Bodyweight ~ dat$Diet, vertical=<span class="literal">TRUE</span>, method=<span class="string">"jitter"</span>,</div><div class="line">main=<span class="string">"Bodyweight over Diet"</span>)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&gt; head(dat)</div><div class="line">  Diet Bodyweight</div><div class="line"><span class="number">1</span> chow      <span class="number">21.51</span></div><div class="line"><span class="number">2</span> chow      <span class="number">28.14</span></div><div class="line"><span class="number">3</span> chow      <span class="number">24.04</span></div><div class="line"><span class="number">4</span> chow      <span class="number">23.45</span></div><div class="line"><span class="number">5</span> chow      <span class="number">23.68</span></div><div class="line"><span class="number">6</span> chow      <span class="number">19.79</span></div><div class="line">&gt; str(dat)</div><div class="line"><span class="string">'data.frame'</span>:	<span class="number">24</span> obs. of  <span class="number">2</span> variables:</div><div class="line"> $ Diet      : Factor w/ <span class="number">2</span> levels <span class="string">"chow"</span>,<span class="string">"hf"</span>: <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="keyword">...</span></div><div class="line"> $ Bodyweight: num  <span class="number">21.5</span> <span class="number">28.1</span> <span class="number">24</span> <span class="number">23.4</span> <span class="number">23.7</span> <span class="keyword">...</span></div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190817104902.jpeg">

</div>
<p>从这张图上我们大致可以看出来，hf组的小鼠体重比chow组的小鼠体重高一些。现在我们使用设计矩阵<span class="math inline">\(\mathbf{X}\)</span>（公式为<code>~Diet</code>）来计算一下这个结果，在设计矩阵中，第2列是分组信息，也就是饲料的类型，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">levels(dat$Diet)</div><div class="line">X &lt;- model.matrix(~ Diet, data=dat)</div><div class="line">X</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">&gt; X</div><div class="line">   (Intercept) Diethf</div><div class="line"><span class="number">1</span>            <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">2</span>            <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">3</span>            <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">4</span>            <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">5</span>            <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">6</span>            <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">7</span>            <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">8</span>            <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">9</span>            <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">10</span>           <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">11</span>           <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">12</span>           <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">13</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">14</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">15</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">16</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">17</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">18</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">19</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">20</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">21</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">22</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">23</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">24</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line">attr(,<span class="string">"assign"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0</span> <span class="number">1</span></div><div class="line">attr(,<span class="string">"contrasts"</span>)</div><div class="line">attr(,<span class="string">"contrasts"</span>)$Diet</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div></pre></td></tr></table></figure>
<h2 id="lm函数背后的数学原理"><code>lm()</code>函数背后的数学原理</h2>
<p>现在我们先不用<code>lm()</code>来进行计算，先用设计矩阵%<span class="math inline">\(来计算一下\)</span>$，这个值能够使线性模型的平方和最小，公式如下所示： <span class="math display">\[
\hat{\boldsymbol{\beta}} = (\mathbf{X}^\top \mathbf{X})^{-1} \mathbf{X}^\top \mathbf{Y}
\]</span> 在R中，可以使用矩阵相乘的符号<code>%*%</code>，以及<code>solve()</code>函数来求解上述方程，如下所示： <figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Y &lt;- dat$Bodyweight</div><div class="line">X &lt;- model.matrix(~ Diet, data=dat)</div><div class="line">solve(t(X) %*% X) %*% t(X) %*% Y</div></pre></td></tr></table></figure></p>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&gt; Y &lt;- dat$Bodyweight</div><div class="line">&gt; X &lt;- model.matrix(~ Diet, data=dat)</div><div class="line">&gt; solve(t(X) %*% X) %*% t(X) %*% Y</div><div class="line">                 [,<span class="number">1</span>]</div><div class="line">(Intercept) <span class="number">23.813333</span></div><div class="line">Diethf       <span class="number">3.020833</span></div></pre></td></tr></table></figure>
<p>这些系数是对照组的平均值（23.813333），以及两组的差值（3.020833），计算一下，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">s &lt;- split(dat$Bodyweight, dat$Diet)</div><div class="line">mean(s[[<span class="string">"chow"</span>]])</div><div class="line">mean(s[[<span class="string">"hf"</span>]]) - mean(s[[<span class="string">"chow"</span>]])</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt; s &lt;- split(dat$Bodyweight, dat$Diet)</div><div class="line">&gt; mean(s[[<span class="string">"chow"</span>]])</div><div class="line">[<span class="number">1</span>] <span class="number">23.81333</span></div><div class="line">&gt; mean(s[[<span class="string">"hf"</span>]]) - mean(s[[<span class="string">"chow"</span>]])</div><div class="line">[<span class="number">1</span>] <span class="number">3.020833</span></div></pre></td></tr></table></figure>
<p>现在我们使用<code>lm()</code>函数两周来计算一下，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">fit &lt;- lm(Bodyweight ~ Diet, data=dat)</div><div class="line">summary(fit)</div><div class="line">(coefs &lt;- coef(fit))</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&gt; summary(fit)</div><div class="line"></div><div class="line">Call:</div><div class="line">lm(formula = Bodyweight ~ Diet, data = dat)</div><div class="line"></div><div class="line">Residuals:</div><div class="line">    Min      1Q  Median      3Q     Max </div><div class="line">-<span class="number">6.1042</span> -<span class="number">2.4358</span> -<span class="number">0.4138</span>  <span class="number">2.8335</span>  <span class="number">7.1858</span> </div><div class="line"></div><div class="line">Coefficients:</div><div class="line">            Estimate Std. Error t value Pr(&gt;|t|)    </div><div class="line">(Intercept)   <span class="number">23.813</span>      <span class="number">1.039</span>  <span class="number">22.912</span>   &lt;<span class="number">2e-16</span> ***</div><div class="line">Diethf         <span class="number">3.021</span>      <span class="number">1.470</span>   <span class="number">2.055</span>   <span class="number">0.0519</span> .  </div><div class="line">---</div><div class="line">Signif. codes:  <span class="number">0</span> ‘***’ <span class="number">0.001</span> ‘**’ <span class="number">0.01</span> ‘*’ <span class="number">0.05</span> ‘.’ <span class="number">0.1</span> ‘ ’ <span class="number">1</span></div><div class="line"></div><div class="line">Residual standard error: <span class="number">3.6</span> on <span class="number">22</span> degrees of freedom</div><div class="line">Multiple R-squared:  <span class="number">0.1611</span>,	Adjusted R-squared:  <span class="number">0.1229</span> </div><div class="line"><span class="literal">F</span>-statistic: <span class="number">4.224</span> on <span class="number">1</span> and <span class="number">22</span> DF,  p-value: <span class="number">0.05192</span></div><div class="line">&gt; (coefs &lt;- coef(fit))</div><div class="line">(Intercept)      Diethf </div><div class="line">  <span class="number">23.813333</span>    <span class="number">3.020833</span></div></pre></td></tr></table></figure>
<h2 id="线性回归系数">线性回归系数</h2>
<p>下图说明了前面我们计算出来的2个系数，即对照组小鼠的平均体重，以及hf组的小鼠体重与对照组的差异，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">stripchart(dat$Bodyweight ~ dat$Diet, vertical=<span class="literal">TRUE</span>, method=<span class="string">"jitter"</span>,</div><div class="line">           main=<span class="string">"Bodyweight over Diet"</span>, ylim=c(<span class="number">0</span>,<span class="number">40</span>), xlim=c(<span class="number">0</span>,<span class="number">3</span>))</div><div class="line">a &lt;- -<span class="number">0.25</span></div><div class="line">lgth &lt;- <span class="number">.1</span></div><div class="line"><span class="keyword">library</span>(RColorBrewer)</div><div class="line">cols &lt;- brewer.pal(<span class="number">3</span>,<span class="string">"Dark2"</span>)</div><div class="line">abline(h=<span class="number">0</span>)</div><div class="line">arrows(<span class="number">1</span>+a,<span class="number">0</span>,<span class="number">1</span>+a,coefs[<span class="number">1</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">1</span>],length=lgth)</div><div class="line">abline(h=coefs[<span class="number">1</span>],col=cols[<span class="number">1</span>])</div><div class="line">arrows(<span class="number">2</span>+a,coefs[<span class="number">1</span>],<span class="number">2</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">2</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">2</span>],length=lgth)</div><div class="line">abline(h=coefs[<span class="number">1</span>]+coefs[<span class="number">2</span>],col=cols[<span class="number">2</span>])</div><div class="line">legend(<span class="string">"right"</span>,names(coefs),fill=cols,cex=<span class="number">.75</span>,bg=<span class="string">"white"</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190817114032.jpeg">

</div>
<p>在这里使用前面的小鼠案例主要是为了说明了回归与t检验在本质上是一样的，这个简单的线性回归模型给出了与特定类型t检验相同的结果（t统计量与p值）。这是两组之间的t检验，前提是两组的总体标准差相同。当我们假设误差<span class="math inline">\(\boldsymbol{\varepsilon}\)</span>都是均匀分布时，这些误差被编码到线性模型中。虽然在这种情况下的线性模相当于t检验，但我们可以对线性模型进行拓展，将其扩展到复杂的形式。在下面的内容中，我们将会说明线性模型能够得到几乎相同的结果：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt; summary(fit)$coefficients</div><div class="line">             Estimate Std. Error   t value     Pr(&gt;|t|)</div><div class="line">(Intercept) <span class="number">23.813333</span>   <span class="number">1.039353</span> <span class="number">22.911684</span> <span class="number">7.642256e-17</span></div><div class="line">Diethf       <span class="number">3.020833</span>   <span class="number">1.469867</span>  <span class="number">2.055174</span> <span class="number">5.192480e-02</span></div></pre></td></tr></table></figure>
<p>t检验的结果与之相同：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ttest &lt;- t.test(s[[<span class="string">"hf"</span>]], s[[<span class="string">"chow"</span>]], var.equal=<span class="literal">TRUE</span>)</div><div class="line">summary(fit)$coefficients[<span class="number">2</span>,<span class="number">3</span>]</div><div class="line">ttest$statistic</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt; summary(fit)$coefficients[<span class="number">2</span>,<span class="number">3</span>]</div><div class="line">[<span class="number">1</span>] <span class="number">2.055174</span></div><div class="line">&gt; ttest$statistic</div><div class="line">       t </div><div class="line"><span class="number">2.055174</span></div></pre></td></tr></table></figure>
<h2 id="练习">练习</h2>
<p>P189</p>
<h2 id="标准误">标准误</h2>
<p>使用矩阵代数来计算最小二乘估计时，所得到的估计值是取机变量。我们还能计算这些值的标准误。线性代数也能满足这些任务，先看一些案例。</p>
<h2 id="自由落体">自由落体</h2>
<p>在学习统计学的过程中，了解随机源于何处是有必要的。在自由落体这个案例中，当我们对落下来的球进行测量时，就会出现检测误差，这就是自由落体运行中随机的来源。假设我们做了好几次实验，每次实验我们都会得到一组测量误差。这就意味着，我们得到的数据基本是随机变化的，这反过来，也意味着，我们计算得到的估计值也是随机变化的。在这个案例中，每次我们进行实验时，引力常数的估计值也都在发生变化。引力常数是一个确定的值，但是我们对它的估计不是。为了说明这一步，我们可以使用Monte Carlo模拟一下。具体来说，我们将会重复地生成数据，并对每次的二次项(quadratic term)进行估计，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">set.seed(<span class="number">1</span>)</div><div class="line">B &lt;- <span class="number">10000</span></div><div class="line">h0 &lt;- <span class="number">56.67</span></div><div class="line">v0 &lt;- <span class="number">0</span></div><div class="line">g &lt;- <span class="number">9.8</span> <span class="comment">##meters per second</span></div><div class="line">n &lt;- <span class="number">25</span></div><div class="line">tt &lt;- seq(<span class="number">0</span>,<span class="number">3.4</span>,len=n) <span class="comment">##time in secs, t is a base function</span></div><div class="line">X &lt;-cbind(<span class="number">1</span>,tt,tt^<span class="number">2</span>)</div><div class="line"><span class="comment">##create X'X^-1 X'</span></div><div class="line">A &lt;- solve(crossprod(X)) %*% t(X)</div><div class="line">betahat&lt;-replicate(B,&#123;</div><div class="line">y &lt;- h0 + v0*tt - <span class="number">0.5</span>*g*tt^<span class="number">2</span> + rnorm(n,sd=<span class="number">1</span>)</div><div class="line">betahats &lt;- A%*%y</div><div class="line"><span class="keyword">return</span>(betahats[<span class="number">3</span>])</div><div class="line">&#125;)</div><div class="line">head(betahat)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; head(betahat)</div><div class="line">[<span class="number">1</span>] -<span class="number">5.038646</span> -<span class="number">4.894362</span> -<span class="number">5.143756</span> -<span class="number">5.220960</span> -<span class="number">5.063322</span> -<span class="number">4.777521</span></div></pre></td></tr></table></figure>
<p>从上面结果我们可以发现，每次的估计值都不一样，这是因为估计值<span class="math inline">\(\hat{\beta}\)</span>是一个随机变量，它其实是服从正态分布的，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(rafalib)</div><div class="line">mypar(<span class="number">1</span>,<span class="number">2</span>)</div><div class="line">hist(betahat)</div><div class="line">qqnorm(betahat)</div><div class="line">qqline(betahat)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190817124445.jpeg">

</div>
<p>上图显示的是，通过Monte Carlo模拟生成的自由落体运行数据对回归系数的估计值的分布。左侧是直方图，右侧是qq图。</p>
<p>由于<span class="math inline">\(\hat{\beta}\)</span>是我们生成的那些服从正态分布的数据的线性组合，因此从QQ图上我们也可以看出，<span class="math inline">\(\hat{\beta}\)</span>也服从正态分布。此外，这个分布的均值的真实参数0.5g，可以通过Monte Carlo模拟来所证实，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">round(mean(betahat),<span class="number">1</span>)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; round(mean(betahat),<span class="number">1</span>)</div><div class="line">[<span class="number">1</span>] -<span class="number">4.9</span></div></pre></td></tr></table></figure>
<p>但是，当我们对估计值进行计算时，无法得到精确的数值，这是因为我们估计值的标准误大约是：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; sd(betahat)</div><div class="line">[<span class="number">1</span>] <span class="number">0.2129976</span></div></pre></td></tr></table></figure>
<p>在接下来的案例中，我们将会演示一下，不通过Monte Carlo模拟来计算标准误的方法，因为在实际的分析中，我们无法精确地知道误差是如何产生的。</p>
<h2 id="父子身高">父子身高</h2>
<p>在父母身高的案例中，我们也遇到了随机问题，因为我们是对父子身高的总体进行随机抽样。为了说明这个问题，现在假设我们已经有了这个总体：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(UsingR)</div><div class="line">x &lt;- father.son$fheight</div><div class="line">y &lt;- father.son$sheight</div><div class="line">n &lt;- length(y)</div></pre></td></tr></table></figure>
<p>现在我们使用Monte Carlo模拟来生成一个含有50个数据的样本，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">N &lt;- <span class="number">50</span></div><div class="line">B &lt;-<span class="number">1000</span></div><div class="line">betahat &lt;- replicate(B,&#123;</div><div class="line">index &lt;- sample(n,N)</div><div class="line">sampledat &lt;- father.son[index,]</div><div class="line">x &lt;- sampledat$fheight</div><div class="line">y &lt;- sampledat$sheight</div><div class="line">lm(y~x)$coef</div><div class="line">&#125;)</div><div class="line">betahat &lt;- t(betahat) <span class="comment">#have estimates in two columns</span></div></pre></td></tr></table></figure>
<p>现在绘制一个QQ图，我们看到，我们的估计值大致是服从标准正态分布的，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">mypar(<span class="number">1</span>,<span class="number">2</span>)</div><div class="line">qqnorm(betahat[,<span class="number">1</span>])</div><div class="line">qqline(betahat[,<span class="number">1</span>])</div><div class="line">qqnorm(betahat[,<span class="number">2</span>])</div><div class="line">qqline(betahat[,<span class="number">2</span>])</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190817130758.jpeg">

</div>
<p>现在看一下估计值之间的相关性，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; cor(betahat[,<span class="number">1</span>],betahat[,<span class="number">2</span>])</div><div class="line">[<span class="number">1</span>] -<span class="number">0.9992293</span></div></pre></td></tr></table></figure>
<p>当我们计算我们估计值的线性组合时，我们需要知道这个信息能够正确地计算出这些线性组合的标准误差。在接下来的部分中，我们会提到方差-协方差(variance-covariance)矩阵。两个随机变量的协方差定义如下：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mean( (betahat[,<span class="number">1</span>]-mean(betahat[,<span class="number">1</span>] ))* (betahat[,<span class="number">2</span>]-mean(betahat[,<span class="number">2</span>])))</div></pre></td></tr></table></figure>
<p>结果为：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; mean( (betahat[,<span class="number">1</span>]-mean(betahat[,<span class="number">1</span>] ))* (betahat[,<span class="number">2</span>]-mean(betahat[,<span class="number">2</span>])))</div><div class="line">[<span class="number">1</span>] -<span class="number">1.035291</span></div></pre></td></tr></table></figure>
<p>协方差是相关系数乘以每个随机变量的标准差，如下所示：</p>
<p><span class="math display">\[
\mbox{Corr}(X,Y) = \frac{\mbox{Cov}(X,Y)}{\sigma_X \sigma_Y}
\]</span></p>
<p>除此之外，这个量在实际分析中没有一个现实意义上解释。但是，它对于数学推导的过程来说，有着重要意义。在接下来的部分中，我们会描述用于计算线性模型估计的标准差的矩阵代数计算方法。</p>
<h2 id="方差-协方差矩阵">方差-协方差矩阵</h2>
<p>我们先来定义一什么是方差-协方差矩阵(variance-covariance matrix)<span class="math inline">\(\Sigma\)</span>。地于一个元素是随机变量的向量<span class="math inline">\(\mathbf{Y}\)</span>来说，我们定义<span class="math inline">\(\Sigma\)</span>是含有<span class="math inline">\(i,j\)</span>维的矩阵，如下所示： <span class="math display">\[
\Sigma_{i,j} \equiv \mbox{Cov}(Y_i, Y_j)
\]</span></p>
<p>如果<span class="math inline">\(i=j\)</span>，那么协方差就等于方差，如果变量都是独立的，则协方差都为0。在我们现在所学到的各种向量里，<span class="math inline">\(\mathbf{Y}\)</span>向量的每个观测值<span class="math inline">\(Y_{i}\)</span>是从总体中抽样得到的，我们可以假设它的每个元素都是独立的，并且<span class="math inline">\(Y_{i}\)</span>有着相同的方差<span class="math inline">\(\sigma^2\)</span>，因此方差-协方差矩阵只有两类元素，如下所示： <span class="math display">\[
\mbox{Cov}(Y_i, Y_i) = \mbox{var}(Y_i) = \sigma^2
\]</span> <span class="math display">\[
\mbox{Cov}(Y_i, Y_j) = 0, \mbox{ for } i \neq j
\]</span></p>
<p>这就是暗示了<span class="math inline">\(\boldsymbol{\Sigma} = \sigma^2 \mathbf{I}\)</span> ，其中<span class="math inline">\(\mathbf{I}\)</span>是单位矩阵(Identity matrix)。</p>
<h2 id="线性组合的方差">线性组合的方差</h2>
<p>线性代数提供的一个有用结果就是<span class="math inline">\(\mathbf{Y}\)</span>的<span class="math inline">\(\mathbf{AY}\)</span>线性结合的方差-协方差矩阵，它的计算如下所示： <span class="math display">\[
\mbox{var}(\mathbf{AY}) = \mathbf{A}\mbox{var}(\mathbf{Y}) \mathbf{A}^\top
\]</span> 例如，如果<span class="math inline">\(Y_{1}\)</span>和<span class="math inline">\(Y_{2}\)</span>是独立的，并且其方差为<span class="math inline">\(\sigma^2\)</span>，那么：</p>
<p><span class="math display">\[
\mbox{var}\{Y_1+Y_2\} = 
\mbox{var}\left\{ \begin{pmatrix}1&amp;1\end{pmatrix}\begin{pmatrix} Y_1\\Y_2\\ \end{pmatrix}\right\}=\begin{pmatrix}1&amp;1\end{pmatrix} \sigma^2 \mathbf{I}\begin{pmatrix} 1\\1\\ \end{pmatrix}=2\sigma^2
\]</span></p>
<p>我们会使用上述的结果来获取LSE的标准误。</p>
<h2 id="les标准误">LES标准误</h2>
<p><span class="math inline">\(\hat{\beta}\)</span>是一个线性组合，即 <span class="math inline">\(\mathbf{Y}\)</span>: <span class="math inline">\(\mathbf{AY}\)</span> with <span class="math inline">\(\mathbf{A}=\mathbf{(X^\top X)^{-1}X}^\top\)</span>的线性组合，因此我们可以使用上面的公式来计算一个我们估计值的方差：</p>
<p>$$ () = (  ) =</p>
<p>\ (Y) ()^= \</p>
<p> ^2  ()^= \</p>
<p>^2   = \ ^2 $$</p>
<p>其中，这个矩阵的平方根的对角线含有我们估计值的标准误。</p>
<h2 id="估计sigma2">估计<span class="math inline">\(\sigma^2\)</span></h2>
<p>为了从上述公式中获得一个精确的估计值，我们需要估计<span class="math inline">\(\sigma^2\)</span>。在前面我们通过抽样估计了标准误。但是<span class="math inline">\(Y\)</span>的抽样标准误不是<span class="math inline">\(\sigma\)</span>，因为<span class="math inline">\(Y\)</span>还包含了变异，这些变量是由模型<span class="math inline">\(\mathbf{X\beta}\)</span>的确定部分引入的。此时我们采用的方法是利用残差。</p>
<p>我们可以按下面的公式构建残差： <span class="math display">\[
\mathbf{r}\equiv\boldsymbol{\hat{\varepsilon}} = \mathbf{Y}-\mathbf{X}\boldsymbol{\hat{\beta}}
\]</span> 其中，<span class="math inline">\(r\)</span>和<span class="math inline">\(\hat{\epsilon}\)</span>都可以用来表示残差(residuals)。然后我们使用上述的公式来估计残差，这种方式与单变量情况下类似： <span class="math display">\[
s^2 \equiv \hat{\sigma}^2 = \frac{1}{N-p}\mathbf{r}^\top\mathbf{r} = \frac{1}{N-p}\sum_{i=1}^N r_i^2
\]</span></p>
<p>其中，<span class="math inline">\(N\)</span>是样本数目，<span class="math inline">\(p\)</span>是<span class="math inline">\(\mathbf{X}\)</span>的列数，或者是参数的数目（包括截矩<span class="math inline">\(\beta_{0}\)</span>）。公式中还要除以<span class="math inline">\(N-p\)</span>，这是因为根据数学理论（不用深究，这个跟自由度能关），除以<span class="math inline">\(N-p\)</span>，表示无偏估计。下面在R中计算一下，观察一下我们是否能够获得与Monte Carlo模拟一样的数值：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">n &lt;- nrow(father.son)</div><div class="line">N &lt;- <span class="number">50</span></div><div class="line">index &lt;- sample(n,N)</div><div class="line">sampledat &lt;- father.son[index,]</div><div class="line">x &lt;- sampledat$fheight</div><div class="line">y &lt;- sampledat$sheight</div><div class="line">X &lt;- model.matrix(~x)</div><div class="line">N &lt;- nrow(X)</div><div class="line">p &lt;- ncol(X)</div><div class="line">XtXinv &lt;- solve(crossprod(X))</div><div class="line">resid &lt;- y - X %*% XtXinv %*% crossprod(X,y)</div><div class="line">s &lt;- sqrt( sum(resid^<span class="number">2</span>)/(N-p))</div><div class="line">ses &lt;- sqrt(diag(XtXinv))*s</div><div class="line">summary(lm(y~x))$coef[,<span class="number">2</span>]</div><div class="line">ses</div><div class="line">apply(betahat,<span class="number">2</span>,sd)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&gt; summary(lm(y~x))$coef[,<span class="number">2</span>]</div><div class="line">(Intercept)           x </div><div class="line">  <span class="number">8.3899781</span>   <span class="number">0.1240767</span> </div><div class="line">&gt; ses</div><div class="line">(Intercept)           x </div><div class="line">  <span class="number">8.3899781</span>   <span class="number">0.1240767</span> </div><div class="line">&gt; apply(betahat,<span class="number">2</span>,sd)</div><div class="line">(Intercept)           x </div><div class="line">  <span class="number">8.3817556</span>   <span class="number">0.1237362</span></div></pre></td></tr></table></figure>
<p>从上面我们可以看出来，我们的计算结果与Monte Carlo模拟的结果几乎一样。</p>
<h2 id="估计值的线性组合">估计值的线性组合</h2>
<p>多数情况下，我们会计算估计值的一个线性组合，例如<span class="math inline">\(\hat{\beta_{2}}-\hat{\beta_{1}}\)</span>。这就是<span class="math inline">\(\hat{\beta}\)</span>的一个线性组合，如下所示： <span class="math display">\[
\hat{\beta}_2 - \hat{\beta}_1 = 
\begin{pmatrix}0&amp;-1&amp;1&amp;0&amp;\dots&amp;0\end{pmatrix} \begin{pmatrix}
\hat{\beta}_0\\
\hat{\beta}_1 \\ 
\hat{\beta}_2 \\ 
\vdots\\
\hat{\beta}_p
\end{pmatrix}
\]</span> 通过上述的公式，我们就知道中如何计算<span class="math inline">\(\hat{\beta}\)</span>的方差-协方差矩阵。</p>
<h2 id="clt与t分布">CLT与t分布</h2>
<p>我们已经了解了如何过计算估计值的标准误。但是，我们在第1章中了解到，在计算置信区间时，我们需要知道随机变量的分布。我们努力计算标准误的原因是因为，CLT适用于线性模型。如果<span class="math inline">\(N\)</span>足够大，那么LSE就会服从正态分布，其中这个正态分布的均值为<span class="math inline">\(\beta\)</span>，标准误就是前面计算的标准误。对于小样本来说，如果<span class="math inline">\(\varepsilon\)</span>服从正态分布，那么<span class="math inline">\(\hat{\beta}-\hat{\beta}\)</span>服从t分布。在这里，我们不需要知道空上计算过程，但是这个结果很有，因为这是我们在线性模型中计算p值，置信区间的基础。</p>
<h2 id="代码与数学">代码与数学</h2>
<p>构建线性模型的标准做法要么是假设<span class="math inline">\(\mathbf{X}\)</span>是固定的，要么我们给它们设置条件。因此<span class="math inline">\(\mathbf{X\beta}\)</span>没有像<span class="math inline">\(\mathbf{X}\)</span>那样固定的方差。这就浊为什么我们要写 <span class="math inline">\(\mbox{var}(Y_i) = \mbox{var}(\varepsilon_i)=\sigma^2\)</span>。在实际计算中，这有可能造成误解，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">x = father.son$fheight</div><div class="line">beta = c(<span class="number">34</span>,<span class="number">0.5</span>)</div><div class="line">var(beta[<span class="number">1</span>]+beta[<span class="number">2</span>]*x)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; var(beta[<span class="number">1</span>]+beta[<span class="number">2</span>]*x)</div><div class="line">[<span class="number">1</span>] <span class="number">1.883576</span></div></pre></td></tr></table></figure>
<p>这个值并不等于0，也不接近于0。这就是为什么我们要谨慎区分代码与数学的一个案例。<code>var()</code>函数仅仅是用于计算我们输入数值的方差，而数学对方差的定义则是要考虑到这些数字是否是随机变量。在上述的R代码中，<code>x</code>并没有固定：我们只是让它发生变化，但是，当我们写下<span class="math inline">\(\mbox{var}(Y_i) = \sigma^2\)</span>时，我们是把数学上的<code>x</code>强制固定下来。同样，如果我们使用R来计算自由落体运行案例中<span class="math inline">\(Y\)</span>的方差，我们也会获得一个与<span class="math inline">\(\sigma^2=1\)</span>（已知方差）明显不同的数值，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">n &lt;- length(tt)</div><div class="line">y &lt;- h0 + v0*tt - <span class="number">0.5</span>*g*tt^<span class="number">2</span> + rnorm(n,sd=<span class="number">1</span>)</div><div class="line">var(y)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt; n &lt;- length(tt)</div><div class="line">&gt; y &lt;- h0 + v0*tt - <span class="number">0.5</span>*g*tt^<span class="number">2</span> + rnorm(n,sd=<span class="number">1</span>)</div><div class="line">&gt; var(y)</div><div class="line">[<span class="number">1</span>] <span class="number">329.5136</span></div></pre></td></tr></table></figure>
<h2 id="练习-1">练习</h2>
<p>P199</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-tags" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rvdsd.top/2019/08/17/DAL/DALS011_Linear_Models01MatrixDescription/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="RVDSD">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RVDSD的个人笔记本">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/17/DAL/DALS011_Linear_Models01MatrixDescription/" itemprop="url">DALS011-Linear Models线性模型01MatrixDescription</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-17T12:00:00+08:00">
                2019-08-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/生物统计/" itemprop="url" rel="index">
                    <span itemprop="name">生物统计</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3,766
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  16
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言">前言</h2>
<p>这一部分是《Data Analysis for the life sciences》的第5章线性模型的第1小节。这一部分的主要内容涉及矩阵的表示方法。</p>
<h2 id="背景知识">背景知识</h2>
<p>数据分析中的很多模型都可以用矩阵代数来表示。我们指的这些模型都是线性模型(linear models)。线性(Linear)并不是说它们是直线，而是说是线性组合。使用矩阵代数来描述线性模型非常方便，因为我们可以更好地构建这些模型，并使用数学工具来方便计算。在这一部分中，我们将详细地描述我们如何使用矩阵代数来构建并拟合线性模型。</p>
<p>在本书中，我们关注的线性模型是基于二分法的线性模型：例如治疗组与对照组。在前面提到的小鼠饲料的案例中就是这种线性模型的一个典型案例。在这一部分中，我们会描述一些比较复杂的案例，不过还会继续关注二分法变量的线性模型。</p>
<p>当我们学习线性模型时，需要记住，我们使用的变量仍然是随机变量。这就意味着，我们使用线性模型获得的估计值也是随机变量。虽然数学上这理解起来比较复杂，但是我们前面学到的一些概念在这里仍然适用。现在可以先做一些练习，在线性模型的练习中复习一些随机变量的概念。</p>
<h2 id="练习">练习</h2>
<p>P172</p>
<h2 id="设计矩阵the-design-matrix">设计矩阵(The Design Matrix)</h2>
<p>R中的<code>formual()</code>和<code>model.matrix()</code>可以用于生成各种线性模型的设计矩阵(design matrices)（也被称为模型矩阵，即model matrices)。例如，在小鼠的饲料实验中，我们可以这样构建模型，如下所示： <span class="math display">\[
Y_{i}=\beta_{0}+\beta_{1} x_{i}+\varepsilon, i=1, \ldots, N
\]</span> 其中，<span class="math inline">\(Y_{i}\)</span>表示体重，而<span class="math inline">\(x_{i}\)</span>等于1的时候，表示小鼠<span class="math inline">\(i\)</span>吃的是高脂饲料(hf)。我们可以使用实验单位(Experimental unit)来表示N个不同的实验动物，这里的实验单位是小鼠。我们称这类变量为指示变量(indicator variables)，因此这类变量仅用于标明实验单位，表示某种干预的有无。现在用矩阵代数来描述就是以下形式： <span class="math display">\[
\mathbf{Y}=\left(\begin{array}{c}{Y_{1}} \\ {Y_{2}} \\ {\vdots} \\ {Y_{N}}\end{array}\right), \mathbf{X}=\left(\begin{array}{cc}{1} &amp; {x_{1}} \\ {1} &amp; {x_{2}} \\ {\vdots} &amp; {} \\ {1} &amp; {x_{N}}\end{array}\right), \beta=\left(\begin{array}{c}{\beta_{0}} \\ {\beta_{1}}\end{array}\right) \text { and } \varepsilon=\left(\begin{array}{c}{\varepsilon_{1}} \\ {\varepsilon_{2}} \\ {\vdots} \\ {\varepsilon_{N}}\end{array}\right)
\]</span> 或为： <span class="math display">\[
\left(\begin{array}{c}{Y_{1}} \\ {Y_{2}} \\ {\vdots} \\ {Y_{N}}\end{array}\right)=\left(\begin{array}{cc}{1} &amp; {x_{1}} \\ {1} &amp; {x_{2}} \\ {\vdots} &amp; {} \\ {1} &amp; {x_{N}}\end{array}\right)\left(\begin{array}{c}{\beta_{0}} \\ {\beta_{1}}\end{array}\right)+\left(\begin{array}{c}{\varepsilon_{1}} \\ {\varepsilon_{2}} \\ {\vdots} \\ {\varepsilon_{N}}\end{array}\right)
\]</span> 简化形式为： <span class="math display">\[
\mathrm{Y}=\mathrm{X} \boldsymbol{\beta}+\varepsilon
\]</span> 其中<span class="math inline">\(\mathbf{X}\)</span>是设计矩阵，一旦我们定义了设计矩阵，那么我们就能计算出最小二乘估计。这个过程称为拟合模型(fitting the model)。在R中，我们可以直接在<code>lm()</code>函数中输入一个公式(formula)直接进行拟合。在后面的一个脚本中，我们会使用<code>model.matrix()</code>函数，这个函数是在<code>lm()</code>函数内部使用的。这种使用方式哦可以方便地让我们将R的formula与矩阵<span class="math inline">\(\mathbf{X}\)</span>连接起来，有助于我们对<code>lm()</code>的结果进行解释。</p>
<h2 id="设计方案">设计方案</h2>
<p>设计矩阵的选择是线性模型中的关键步骤，因为它编码了哪些系数将适合用于建模，以及样本之间的相互关系。一个常见的误解就是，选择实验设计要遵循简单明了的原则，即要在描述中直接标明样本。事实并非如此。关于每个样本（无论是对照组还是处理组，实验批次等）的基础信息里并不意味着这是一个“正确”的设计矩阵。设计矩阵还应该对<span class="math inline">\(X\)</span>中的变量是如何解释<span class="math inline">\(Y\)</span>的值这些信息进行编码，这是研究者们必须要考虑的。</p>
<p>在这一部分的案例中，我们使用线性模型来比较不同组之间的差异。因此，最终进行计算的设计矩阵应该至少包含两列，即截矩(intercept)列，截矩列是第1列，另外就是第2列，第2列指定样本。在这种情况下，线性模型中的两个系数(coefficient)分别为：第1个系数是截矩(interccept)，它代表了第1组的总体均数，第2个系数是差值，这个差值表示的是第2组与第1组总体的差值。当我们进行统计学分析时，往往第2个系数是我们最感兴趣的，因为我们想知道这两组数据是否有差异。</p>
<p>我们可以在R中通过2行代码来编制实验设计。我们先是使用波浪线<code>~</code>来构建一个公式。这种形式的公式意味着，我们想使用波浪线右侧的变量的观测值来构建统计模型。然后我们再放进一个变量的名称，就能知道样本来源于哪些组。</p>
<p>看一个案例。 现在我们有两组数据，分别是对照组和高脂饲料组(hf)小鼠的体重数据。现在我们用1来表示对照组小鼠，2来表示hf组。我们首先要告诉R，这些值不能被当成数值，而是应该当成因子。然后使用公式<code>~group</code>来构建模型，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">group &lt;- factor( c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>) )</div><div class="line">model.matrix(~ group)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&gt; group &lt;- factor( c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>) )</div><div class="line">&gt; model.matrix(~ group)</div><div class="line">  (Intercept) group2</div><div class="line"><span class="number">1</span>           <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">2</span>           <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">3</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">4</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line">attr(,<span class="string">"assign"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0</span> <span class="number">1</span></div><div class="line">attr(,<span class="string">"contrasts"</span>)</div><div class="line">attr(,<span class="string">"contrasts"</span>)$group</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div></pre></td></tr></table></figure>
<p>这里面有很多信息，<code>attr</code>后面的信息不用管。</p>
<p>其实上面的计算过程也可以使用<code>model.matrix()</code>来构建，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">group &lt;- factor( c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>) )</div><div class="line">model.matrix(formula(~ group))</div></pre></td></tr></table></figure>
<p>如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&gt; group &lt;- factor( c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>) )</div><div class="line">&gt; model.matrix(formula(~ group))</div><div class="line">  (Intercept) group2</div><div class="line"><span class="number">1</span>           <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">2</span>           <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">3</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">4</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line">attr(,<span class="string">"assign"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0</span> <span class="number">1</span></div><div class="line">attr(,<span class="string">"contrasts"</span>)</div><div class="line">attr(,<span class="string">"contrasts"</span>)$group</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div></pre></td></tr></table></figure>
<p>如果我们不对组别(<code>group</code>)进行因子转换，那么就会出现下面的情况：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">group &lt;- c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>)</div><div class="line">model.matrix(~ group)</div></pre></td></tr></table></figure>
<p>即：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&gt; model.matrix(~ group)</div><div class="line">  (Intercept) group</div><div class="line"><span class="number">1</span>           <span class="number">1</span>     <span class="number">1</span></div><div class="line"><span class="number">2</span>           <span class="number">1</span>     <span class="number">1</span></div><div class="line"><span class="number">3</span>           <span class="number">1</span>     <span class="number">2</span></div><div class="line"><span class="number">4</span>           <span class="number">1</span>     <span class="number">2</span></div><div class="line">attr(,<span class="string">"assign"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0</span> <span class="number">1</span></div></pre></td></tr></table></figure>
<p>这种形式不是设计矩阵。因为没有经过factor转换的数值就是单纯的数值，而非指示变量(indicator variable)，因子类型变量的数值与具体的数字无关，字符串也能生成这些变量，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">group &lt;- factor(c(<span class="string">"control"</span>,<span class="string">"control"</span>,<span class="string">"highfat"</span>,<span class="string">"highfat"</span>))</div><div class="line">model.matrix(~ group)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&gt; group &lt;- factor(c(<span class="string">"control"</span>,<span class="string">"control"</span>,<span class="string">"highfat"</span>,<span class="string">"highfat"</span>))</div><div class="line">&gt; model.matrix(~ group)</div><div class="line">  (Intercept) grouphighfat</div><div class="line"><span class="number">1</span>           <span class="number">1</span>            <span class="number">0</span></div><div class="line"><span class="number">2</span>           <span class="number">1</span>            <span class="number">0</span></div><div class="line"><span class="number">3</span>           <span class="number">1</span>            <span class="number">1</span></div><div class="line"><span class="number">4</span>           <span class="number">1</span>            <span class="number">1</span></div><div class="line">attr(,<span class="string">"assign"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0</span> <span class="number">1</span></div><div class="line">attr(,<span class="string">"contrasts"</span>)</div><div class="line">attr(,<span class="string">"contrasts"</span>)$group</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div></pre></td></tr></table></figure>
<h2 id="多组设计">多组设计</h2>
<p>现在我们设计了3组数据，如下所示： <figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">group &lt;- factor(c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>))</div><div class="line">model.matrix(~ group)</div></pre></td></tr></table></figure></p>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&gt; group &lt;- factor(c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>))</div><div class="line">&gt; model.matrix(~ group)</div><div class="line">  (Intercept) group2 group3</div><div class="line"><span class="number">1</span>           <span class="number">1</span>      <span class="number">0</span>      <span class="number">0</span></div><div class="line"><span class="number">2</span>           <span class="number">1</span>      <span class="number">0</span>      <span class="number">0</span></div><div class="line"><span class="number">3</span>           <span class="number">1</span>      <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">4</span>           <span class="number">1</span>      <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">5</span>           <span class="number">1</span>      <span class="number">0</span>      <span class="number">1</span></div><div class="line"><span class="number">6</span>           <span class="number">1</span>      <span class="number">0</span>      <span class="number">1</span></div><div class="line">attr(,<span class="string">"assign"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0</span> <span class="number">1</span> <span class="number">1</span></div><div class="line">attr(,<span class="string">"contrasts"</span>)</div><div class="line">attr(,<span class="string">"contrasts"</span>)$group</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div></pre></td></tr></table></figure>
<p>现在我们的设计矩阵中有了第3列，这个第3列属于第3组。另外一种方法就是通过在公式中指定<code>+0</code>来添加第3组，如下所示： <figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">group &lt;- factor(c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>))</div><div class="line">model.matrix(~ group + <span class="number">0</span>)</div></pre></td></tr></table></figure></p>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&gt; group &lt;- factor(c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>))</div><div class="line">&gt; model.matrix(~ group + <span class="number">0</span>)</div><div class="line">  group1 group2 group3</div><div class="line"><span class="number">1</span>      <span class="number">1</span>      <span class="number">0</span>      <span class="number">0</span></div><div class="line"><span class="number">2</span>      <span class="number">1</span>      <span class="number">0</span>      <span class="number">0</span></div><div class="line"><span class="number">3</span>      <span class="number">0</span>      <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">4</span>      <span class="number">0</span>      <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">5</span>      <span class="number">0</span>      <span class="number">0</span>      <span class="number">1</span></div><div class="line"><span class="number">6</span>      <span class="number">0</span>      <span class="number">0</span>      <span class="number">1</span></div><div class="line">attr(,<span class="string">"assign"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">1</span> <span class="number">1</span> <span class="number">1</span></div><div class="line">attr(,<span class="string">"contrasts"</span>)</div><div class="line">attr(,<span class="string">"contrasts"</span>)$group</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div></pre></td></tr></table></figure>
<p>注：在这一处我不太理解，原文是<code>This group now fits a separate coefficient for each group.</code>翻译为汉语则是<code>这一组现在适用于每组的单独系数</code>，等后文中有介绍的时候再补上，以下是其它的参考书（数学建模：基于R.薛毅 著）对这一内容的理解：</p>
<p><code>lm()</code>中的参数<code>formula</code>是模型公式：</p>
<ol style="list-style-type: decimal">
<li><code>y ~ 1+x1 + x2</code>这种形式，表示常数项，<span class="math inline">\(X_{1}\)</span>，<span class="math inline">\(X_{2}\)</span>的系数；</li>
<li><code>y ~ x1 + x2</code>这种形式，去掉了1，其意义与原来加1的一样。</li>
<li><code>y ~ 0 + x1 + x2</code>这种形式，添加了0，表示拟合成就齐次线性模型（或者是改为<code>y ~ -1 + x1 + x2</code>）。</li>
</ol>
<h2 id="多变量设计">多变量设计</h2>
<p>前面我们构建的线性模型只有1个变量，即饲料。而在生命科学中，在一次实验中，往往会涉及多个变量，例如我们也许会研究饲料与性别这两个因素对体重的影响，在这种情况下，我们也许就会设计4组，如下所示： <figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">diet &lt;- factor(c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>))</div><div class="line">sex &lt;- factor(c(<span class="string">"f"</span>,<span class="string">"f"</span>,<span class="string">"m"</span>,<span class="string">"m"</span>,<span class="string">"f"</span>,<span class="string">"f"</span>,<span class="string">"m"</span>,<span class="string">"m"</span>))</div><div class="line">table(diet,sex)</div></pre></td></tr></table></figure></p>
<p>组别如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt; table(diet,sex)</div><div class="line">    sex</div><div class="line">diet f m</div><div class="line">   <span class="number">1</span> <span class="number">2</span> <span class="number">2</span></div><div class="line">   <span class="number">2</span> <span class="number">2</span> <span class="number">2</span></div></pre></td></tr></table></figure>
<p>假如我们认为饲料对体重的影响和性别对体重的影响（这只是假设）是相同的，那么我们就可以构建一个线性模型，如下所示： <span class="math display">\[
Y_{i}=\beta_{0}+\beta_{1} x_{i, 1}+\beta_{2} x_{i, 2}+\varepsilon_{i}
\]</span> 现在我们在R中对这个模型进行拟合，此时我们需要添加另外一个变量来构建一个设计矩阵，如下所示： <figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">diet &lt;- factor(c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>))</div><div class="line">sex &lt;- factor(c(<span class="string">"f"</span>,<span class="string">"f"</span>,<span class="string">"m"</span>,<span class="string">"m"</span>,<span class="string">"f"</span>,<span class="string">"f"</span>,<span class="string">"m"</span>,<span class="string">"m"</span>))</div><div class="line">model.matrix(~ diet + sex)</div></pre></td></tr></table></figure></p>
<p>如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&gt; diet &lt;- factor(c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>))</div><div class="line">&gt; sex &lt;- factor(c(<span class="string">"f"</span>,<span class="string">"f"</span>,<span class="string">"m"</span>,<span class="string">"m"</span>,<span class="string">"f"</span>,<span class="string">"f"</span>,<span class="string">"m"</span>,<span class="string">"m"</span>))</div><div class="line">&gt; model.matrix(~ diet + sex)</div><div class="line">  (Intercept) diet2 sexm</div><div class="line"><span class="number">1</span>           <span class="number">1</span>     <span class="number">0</span>    <span class="number">0</span></div><div class="line"><span class="number">2</span>           <span class="number">1</span>     <span class="number">0</span>    <span class="number">0</span></div><div class="line"><span class="number">3</span>           <span class="number">1</span>     <span class="number">0</span>    <span class="number">1</span></div><div class="line"><span class="number">4</span>           <span class="number">1</span>     <span class="number">0</span>    <span class="number">1</span></div><div class="line"><span class="number">5</span>           <span class="number">1</span>     <span class="number">1</span>    <span class="number">0</span></div><div class="line"><span class="number">6</span>           <span class="number">1</span>     <span class="number">1</span>    <span class="number">0</span></div><div class="line"><span class="number">7</span>           <span class="number">1</span>     <span class="number">1</span>    <span class="number">1</span></div><div class="line"><span class="number">8</span>           <span class="number">1</span>     <span class="number">1</span>    <span class="number">1</span></div><div class="line">attr(,<span class="string">"assign"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0</span> <span class="number">1</span> <span class="number">2</span></div><div class="line">attr(,<span class="string">"contrasts"</span>)</div><div class="line">attr(,<span class="string">"contrasts"</span>)$diet</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div><div class="line"></div><div class="line">attr(,<span class="string">"contrasts"</span>)$sex</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div></pre></td></tr></table></figure>
<p>这个设计矩阵包含一个截矩(intercept)，一个饲料变量(diet)，一个性别变量(sex)。我们可以说这个线性模型解释了组间差异与条件变量的差异。但是，如上所述，这个模型成立的前提是，我们假设了饮食和性别的差异会对小鼠的体重产生相同的影响。我们称这些情况为累加效应(additive effect)。对于每一个变量，我们添加一个效应时，不用考虑其它的变量是什么。针对这种情况，还有一种线性模型，这种线性模型里还会考虑两个变量之间的潜在交互作用。</p>
<p>如果我们要考虑交互作用的话，模型的构建如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">model.matrix(~ diet + sex + diet:sex)</div><div class="line"><span class="comment"># OR</span></div><div class="line"><span class="comment"># model.matrix(~ diet*sex)</span></div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&gt; </div><div class="line">&gt; model.matrix(~ diet + sex + diet:sex)</div><div class="line">  (Intercept) diet2 sexm diet2:sexm</div><div class="line"><span class="number">1</span>           <span class="number">1</span>     <span class="number">0</span>    <span class="number">0</span>          <span class="number">0</span></div><div class="line"><span class="number">2</span>           <span class="number">1</span>     <span class="number">0</span>    <span class="number">0</span>          <span class="number">0</span></div><div class="line"><span class="number">3</span>           <span class="number">1</span>     <span class="number">0</span>    <span class="number">1</span>          <span class="number">0</span></div><div class="line"><span class="number">4</span>           <span class="number">1</span>     <span class="number">0</span>    <span class="number">1</span>          <span class="number">0</span></div><div class="line"><span class="number">5</span>           <span class="number">1</span>     <span class="number">1</span>    <span class="number">0</span>          <span class="number">0</span></div><div class="line"><span class="number">6</span>           <span class="number">1</span>     <span class="number">1</span>    <span class="number">0</span>          <span class="number">0</span></div><div class="line"><span class="number">7</span>           <span class="number">1</span>     <span class="number">1</span>    <span class="number">1</span>          <span class="number">1</span></div><div class="line"><span class="number">8</span>           <span class="number">1</span>     <span class="number">1</span>    <span class="number">1</span>          <span class="number">1</span></div><div class="line">attr(,<span class="string">"assign"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span></div><div class="line">attr(,<span class="string">"contrasts"</span>)</div><div class="line">attr(,<span class="string">"contrasts"</span>)$diet</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div><div class="line"></div><div class="line">attr(,<span class="string">"contrasts"</span>)$sex</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div></pre></td></tr></table></figure>
<h2 id="指定比较水平relevel">指定比较水平relevel()</h2>
<p>在构建设计矩阵时，我们所选水平的参考水平用于比较。默认情况下，我们都是按照第1个水平因素进行比较，但是我们可以使用<code>relevel()</code>函数来指定哪个水平因素作用为对照，例如我们选择第2组作为参考水平，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">group &lt;- factor(c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>))</div><div class="line">group &lt;- relevel(group, <span class="string">"2"</span>)</div><div class="line">model.matrix(~ group)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&gt; model.matrix(~ group)</div><div class="line">  (Intercept) group1</div><div class="line"><span class="number">1</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">2</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">3</span>           <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">4</span>           <span class="number">1</span>      <span class="number">0</span></div><div class="line">attr(,<span class="string">"assign"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0</span> <span class="number">1</span></div><div class="line">attr(,<span class="string">"contrasts"</span>)</div><div class="line">attr(,<span class="string">"contrasts"</span>)$group</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div></pre></td></tr></table></figure>
<p>这里涉及了<code>relevel</code>函数，此函数信息如下所示：</p>
<h3 id="relevel函数">relevel()函数</h3>
<p>全称reorder levels of factor，函数的功能是：对一个因子的水平重新排序，以通过指定<code>ref</code>来指定第1个水平作为参考水平（例如在回归中使用二元解释变量，可以指定哪个水平作为参考水平），其余的往后移。在<code>contr.treatment</code>对照中非常有用，<code>contr.treatment</code>通常会将第1个水平当作参考水平。 用法： <code>relevel(x,ref,...)</code>，其中x是一个未排序的因子，ref：指定的参考水平，通常是一个字符串。</p>
<p>或者是在<code>factor()</code>中直接明确地指出，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">group &lt;- factor(c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>))</div><div class="line">group &lt;- factor(group, levels=c(<span class="string">"1"</span>,<span class="string">"2"</span>))</div><div class="line">model.matrix(~ group)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&gt; group &lt;- factor(c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>))</div><div class="line">&gt; group &lt;- factor(group, levels=c(<span class="string">"1"</span>,<span class="string">"2"</span>))</div><div class="line">&gt; model.matrix(~ group)</div><div class="line">  (Intercept) group2</div><div class="line"><span class="number">1</span>           <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">2</span>           <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">3</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">4</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line">attr(,<span class="string">"assign"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0</span> <span class="number">1</span></div><div class="line">attr(,<span class="string">"contrasts"</span>)</div><div class="line">attr(,<span class="string">"contrasts"</span>)$group</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div></pre></td></tr></table></figure>
<h2 id="model.matrix的计算"><code>model.matrix</code>的计算</h2>
<p><code>model.matrix()</code>函数会捕获R全局环境中的变量，除非这些数据已经作为数据框的形式提供给到<code>model.matrix()</code>函数，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">group &lt;- <span class="number">1</span>:<span class="number">4</span></div><div class="line">model.matrix(~ group, data=data.frame(group=<span class="number">5</span>:<span class="number">8</span>))</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&gt; group &lt;- <span class="number">1</span>:<span class="number">4</span></div><div class="line">&gt; model.matrix(~ group, data=data.frame(group=<span class="number">5</span>:<span class="number">8</span>))</div><div class="line">  (Intercept) group</div><div class="line"><span class="number">1</span>           <span class="number">1</span>     <span class="number">5</span></div><div class="line"><span class="number">2</span>           <span class="number">1</span>     <span class="number">6</span></div><div class="line"><span class="number">3</span>           <span class="number">1</span>     <span class="number">7</span></div><div class="line"><span class="number">4</span>           <span class="number">1</span>     <span class="number">8</span></div><div class="line">attr(,<span class="string">"assign"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0</span> <span class="number">1</span></div></pre></td></tr></table></figure>
<h2 id="连续型变量">连续型变量</h2>
<p>前面内容中的变量都是指示数据（有的统计学书中指的是分类变量，哑变量），而在一些实验设计中，我们研究的是数值型变量（连续型变量），不需要将它们转换到第1列。例如在自由落体实验中，时间是一个连续型变量，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">tt &lt;- seq(<span class="number">0</span>,<span class="number">3.4</span>,len=<span class="number">4</span>)</div><div class="line">model.matrix(~ tt + I(tt^<span class="number">2</span>))</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&gt; tt &lt;- seq(<span class="number">0</span>,<span class="number">3.4</span>,len=<span class="number">4</span>)</div><div class="line">&gt; model.matrix(~ tt + I(tt^<span class="number">2</span>))</div><div class="line">  (Intercept)       tt   I(tt^<span class="number">2</span>)</div><div class="line"><span class="number">1</span>           <span class="number">1</span> <span class="number">0.000000</span>  <span class="number">0.000000</span></div><div class="line"><span class="number">2</span>           <span class="number">1</span> <span class="number">1.133333</span>  <span class="number">1.284444</span></div><div class="line"><span class="number">3</span>           <span class="number">1</span> <span class="number">2.266667</span>  <span class="number">5.137778</span></div><div class="line"><span class="number">4</span>           <span class="number">1</span> <span class="number">3.400000</span> <span class="number">11.560000</span></div><div class="line">attr(,<span class="string">"assign"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0</span> <span class="number">1</span> <span class="number">2</span></div></pre></td></tr></table></figure>
<p>在这个模型里，我们用到了<code>I()</code>函数，<code>I()</code>的功能是，对一个变量进行数学变换，在上面的公式里，<code>I(tt^2)</code>的意思是就是，通过<code>I()</code>，将<code>tt^2</code>这个变量当作是一个变量，如果不加<code>I()</code>，则是单纯地计算<code>tt^2</code>的值。查看<code>I()</code>的文档就可以发现，这个函数的全称是<code>Inhibit Interpretation/Conversion of Objects</code>。</p>
<p>在生命科学中，我们还有可能会涉及这样一种情况，例如我们想研究一个药物的量效关系，例如研究这个药物在0mg，10mg和20mg时的效果。 将连续型数据强制作为变量很难进行分析。这就是为什么指示变量只是假设2组的均值不同，而连续型变量会假设预测测变量和结果之间存在着某种特定的关系。</p>
<p>在自由落体实验中，我们有重力加速度这个理论的支持。而在父子身高案例中，由于这些数据是二元正态分布变量，如果我们加上一些条件的话，父子之间的身高存在着线性关系。但是，我们发现，如果不对年龄等这类变量进行“调整(adjust)”的话，并将它们包含在线性模型中，其统计结果就值得商榷。我们不支持将这样的变量加到线性模型中，除非已经有支持这种数据的模型出现。</p>
<h2 id="练习-1">练习</h2>
<p>P183</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-tags" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rvdsd.top/2019/08/16/DAL/DALS009_Matrix_Algebra01_Motivating_Examples/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="RVDSD">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RVDSD的个人笔记本">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/16/DAL/DALS009_Matrix_Algebra01_Motivating_Examples/" itemprop="url">DALS009-Matrix Algebra(矩阵代数)01-简单线性回归</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-16T12:00:00+08:00">
                2019-08-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/生物统计/" itemprop="url" rel="index">
                    <span itemprop="name">生物统计</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2,982
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  12
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言">前言</h2>
<p>这篇笔记是《Data Analysis for the Life Sciences》的第4章：矩阵代数的第1部分。这一部分的主要内容涉及线性方程的简单理解。</p>
<h2 id="简单案例">简单案例</h2>
<p>在这一部分中，我们将会提到3个例子，第1个来源于物理学(physics)，一个来源于遗传学(genetics)，一具是来源于小鼠实验(mouse experiment)。这3个例子明显不同，但是在分析数据中却都用了相同的统计学方法：拟合线性模型(fitting linear models)。在学习线性模型时，通常使用矩阵代数(Matrix Algebra)来进行讲解和描述。</p>
<h2 id="第1案例-自由落体">第1案例-自由落体</h2>
<p>先来看第1个案例，这个案例是与物理学有关。</p>
<p>试想，你是16世纪的伽里略(Galileo)，你想要描述一个自由落体物体的速度(velocity)。此时，一个助手爬上比萨斜塔，并在上面松开手，落下一个球，同时其他的助手记录一下球在不同时间点的位置。此时，我们就来模拟一下这个过程，在模拟的这个过程里，由于我们已经知道了自由落体运动的公式，因此我们会向这个模拟数据里添加一些检测误差，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">set.seed(<span class="number">1</span>)</div><div class="line">g &lt;- <span class="number">9.8</span> <span class="comment">##meters per second</span></div><div class="line">n &lt;- <span class="number">25</span></div><div class="line">tt &lt;- seq(<span class="number">0</span>,<span class="number">3.4</span>,len=n) <span class="comment">##time in secs, note: we use tt because t is a base function</span></div><div class="line">d &lt;- <span class="number">56.67</span> - <span class="number">0.5</span>*g*tt^<span class="number">2</span> + rnorm(n,sd=<span class="number">1</span>) <span class="comment">##meters</span></div></pre></td></tr></table></figure>
<p>现在绘制出助手们记录的不同时间点的球的位置，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mypar()</div><div class="line">plot(tt,d,ylab=<span class="string">"Distance in meters"</span>,xlab=<span class="string">"Time in seconds"</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190816133037.jpeg">

</div>
<p>假如助手不知道准确的自由落体运行，但是通过观察这个图形，他大致可以推导出这个位置-时间关系应该遵循抛物线，因此可以对上述的数据进行建模，如下所示：</p>
<p><span class="math display">\[
Y_i = \beta_0 + \beta_1 x_i + \beta_2 x_i^2 + \varepsilon_i, i=1,\dots,n
\]</span></p>
<p>其中， <span class="math inline">\(Y_i\)</span> 代表了球的位置， <span class="math inline">\(x_i\)</span> 代表了时间， <span class="math inline">\(\varepsilon_i\)</span> 表示测量误差。这是一个线性模型，因为这个方程是一个已知量（也就是一系列的<span class="math inline">\(x\)</span>，即预测因子(predictors)或协变量(covariates)）和一个未知量（即一系列的<span class="math inline">\(\beta\)</span>）的线性组合。</p>
<h2 id="第2案例-父子身高">第2案例-父子身高</h2>
<p>再来看第2个案例， 这个案例与遗传学有关。</p>
<p>试想，你是19世纪的Francis Galton，你收集了很多对父子的身高，你怀疑身高与遗传因素有关，你的数据如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(UsingR)</div><div class="line">x=father.son$fheight</div><div class="line">y=father.son$sheight</div><div class="line">plot(x,y,xlab=<span class="string">"Father's height"</span>,ylab=<span class="string">"Son's height"</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190816134929.png">

</div>
<p>从这个张图上我们大概能觉得，父亲身高在一定程度上影响了儿子的身高，此时我们就可以构建一个模型来描述这种情况，如下所示： <span class="math display">\[
Y_{i}=\beta_{0}+\beta_{1} x_{i}+\varepsilon, i=1, \ldots, N
\]</span></p>
<p>这也是一个线性模型，其中<span class="math inline">\(x_i\)</span> 表示了第<span class="math inline">\(i\)</span>对父亲的身高，<span class="math inline">\(Y_i\)</span>表示了第<span class="math inline">\(i\)</span>对儿子的身高。而 <span class="math inline">\(\varepsilon_i\)</span>表示其余变量。在这个案例中，我们认为父亲的身高是预测因素，并且是固定的（不是随机的），因此我们使用小写字母来表示父亲的身高。仅仅用测量误差是无法完全解释 <span class="math inline">\(\varepsilon_i\)</span>代表的变异程度，因为这个模型中并没有包含其它的变量，例如母亲的身高，遗传的随机因素以及环境因素也有可能影响儿子的身高。</p>
<h2 id="第3案例-多个总体的抽样">第3案例-多个总体的抽样</h2>
<p>第3个案例有是关小鼠实验的。还以这本书刚开始的案例说明一下，我们有两类小鼠的体重，这两类小鼠分别使用正常饲料(chow)和高脂饲料(high fat, hf)进行饲喂。现在我们从这两个种群的小鼠中各随机抽取12个样本。我们的研究重点在于，饲料的不同是否会影响小鼠的体重，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># library(devtools)</span></div><div class="line"><span class="comment"># install_github("genomicsclass/dagdata")</span></div><div class="line">dir &lt;- system.file(package = <span class="string">"dagdata"</span>)</div><div class="line">list.files(dir)</div><div class="line">dir</div><div class="line">filename &lt;- file.path(dir,<span class="string">"extdata/femaleMiceWeights.csv"</span>)</div><div class="line">dat &lt;- read.csv(filename)</div><div class="line"><span class="comment"># input raw data</span></div><div class="line">head(dat)</div><div class="line">str(dat)</div></pre></td></tr></table></figure>
<p>数据如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&gt; list.files(dir)</div><div class="line">[<span class="number">1</span>] <span class="string">"data"</span>        <span class="string">"DESCRIPTION"</span> <span class="string">"extdata"</span>     <span class="string">"help"</span>        <span class="string">"html"</span>       </div><div class="line">[<span class="number">6</span>] <span class="string">"Meta"</span>        <span class="string">"NAMESPACE"</span>   <span class="string">"script"</span>     </div><div class="line">&gt; dir</div><div class="line">[<span class="number">1</span>] <span class="string">"C:/Users/20161111/Documents/R/win-library/3.5/dagdata"</span></div><div class="line">&gt; filename &lt;- file.path(dir,<span class="string">"extdata/femaleMiceWeights.csv"</span>)</div><div class="line">&gt; dat &lt;- read.csv(filename)</div><div class="line">&gt; <span class="comment"># input raw data</span></div><div class="line">&gt; head(dat)</div><div class="line">  Diet Bodyweight</div><div class="line"><span class="number">1</span> chow      <span class="number">21.51</span></div><div class="line"><span class="number">2</span> chow      <span class="number">28.14</span></div><div class="line"><span class="number">3</span> chow      <span class="number">24.04</span></div><div class="line"><span class="number">4</span> chow      <span class="number">23.45</span></div><div class="line"><span class="number">5</span> chow      <span class="number">23.68</span></div><div class="line"><span class="number">6</span> chow      <span class="number">19.79</span></div><div class="line">&gt; str(dat)</div><div class="line"><span class="string">'data.frame'</span>:	<span class="number">24</span> obs. of  <span class="number">2</span> variables:</div><div class="line"> $ Diet      : Factor w/ <span class="number">2</span> levels <span class="string">"chow"</span>,<span class="string">"hf"</span>: <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="keyword">...</span></div><div class="line"> $ Bodyweight: num  <span class="number">21.5</span> <span class="number">28.1</span> <span class="number">24</span> <span class="number">23.4</span> <span class="number">23.7</span> <span class="keyword">...</span></div></pre></td></tr></table></figure>
<p>查看一下小鼠的体重抽样结果，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">stripchart(Bodyweight~Diet,data=dat,vertical=<span class="literal">TRUE</span>,method=<span class="string">"jitter"</span>,pch=<span class="number">1</span>,main=<span class="string">"Mi\</span></div><div class="line"><span class="string">ce weights"</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190816143047.png">

</div>
<p>假如我们想要判断一下这饮食是否对小鼠的平均体重有所影响。我们可以使用t检验和置信区间来进行统计。同时我们也可以使用一个线性模型来进行精确的检验，如下所示： <span class="math display">\[
Y_{i}=\beta_{0}+\beta_{1} x_{i}+\varepsilon_{i}
\]</span> 其中<span class="math inline">\(\beta_0\)</span>表示了正常饲料饲喂的小鼠平均体重，而<span class="math inline">\(\beta_1\)</span>则表示了高脂饲料(hf)饲喂的小鼠平均体重与正常饲料饲喂小鼠体重的差值，其中 <span class="math inline">\(x_i = 1\)</span> 表示第<span class="math inline">\(i\)</span>只小鼠吃的hf饲料，<span class="math inline">\(x_i = 0\)</span> 表示小鼠吃的是正常饲料，而<span class="math inline">\(\varepsilon_i\)</span>则是说明，源于相同总体的小鼠个体差异。</p>
<p>## 线性模型的一般形式</p>
<p>通过前面的3个案例我们知道了线性模型，包含了上述统计模型的线性模型的一般形式可以写为如下公式： <span class="math display">\[
Y_{i}=\beta_{0}+\beta_{1} x_{i, 1}+\beta_{2} x_{i, 2}+\cdots+\beta_{2} x_{i, p}+\varepsilon_{i}, i=1, \ldots, n
\]</span> 即： <span class="math display">\[
Y_{i}=\beta_{0}+\sum_{j=1}^{p} \beta_{j} x_{i, j}+\varepsilon_{i}, i=1, \ldots, n
\]</span> 在这个公式里，我们使用了一个预测量<span class="math inline">\(p\)</span>，矩阵代数提供了一种精练的语言和数学框架来计算以及推导那些满足上述框架的任何线性模型。</p>
<h2 id="估计参数estimating-parameters">估计参数(Estimating parameters)</h2>
<p>当我们用上述的模型来估计未知量<span class="math inline">\(\beta\)</span>时非常有用。例如，在第1个案例中，我们通过线性模型来计算其中的未知的参数。在第2个案例中，通过估计其中的未知参数，我们可以更好地理解遗传因素(inheritance)在父子身高方面的影响。在第3个案例中，我们想研究饲料是否对小鼠的体重有影响，也就是说我们要计算出<span class="math inline">\(\beta_{1} \neq 0\)</span>。</p>
<p>在科学研究中，标准的做法就是找出能拟合这些数据的线性模型中的那些数值（也就是上面的<span class="math inline">\(\beta_{j}\)</span>），找到的这个线性方向与这些点的距离最小。这个过程通常是通过最小二乘(Least Squares, LS)的思想来实现的，下面的这个公式被称为最小平方(Least squares)方程： <span class="math display">\[
\sum_{i=1}^{n}\left\{Y_{i}-\left(\beta_{0}+\sum_{j=1}^{p} \beta_{j} x_{i, j}\right)\right\}^{2}
\]</span></p>
<p>一旦我们找到了这些值，我们就称这些值为最小二乘估计(Least Squares Estimates, LSE)，并将其命名为<span class="math inline">\(\hat{\beta}\)</span>。当我们在估计值处计算出了最小二乘方程后，上面的那个公式就称为残差平方和(Residual Sum of Squares, RSS)。由于RSS所有的量都是取决于Y，因此这个值是随机变量。</p>
<h2 id="自由落体案例回顾">自由落体案例回顾</h2>
<p>在高中物理课本中我们就知道，自由落体运行的方程为： <span class="math display">\[
d=h_{0}+v_{0} t-0.5 \times 9.8 t^{2}
\]</span> 其中，<span class="math inline">\(h_{0}\)</span>和<span class="math inline">\(v_{0}\)</span>分别是起始的高度与速度。在我们模拟的自由落体运行方程中，<span class="math inline">\(v_{0}=0\)</span>，<span class="math inline">\(h_{0}=56.67\)</span>，R代码如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">g &lt;- <span class="number">9.8</span> <span class="comment">##meters per second</span></div><div class="line">n &lt;- <span class="number">25</span></div><div class="line">tt &lt;- seq(<span class="number">0</span>,<span class="number">3.4</span>,len=n) <span class="comment">##time in secs, t is a base function</span></div><div class="line">f &lt;- <span class="number">56.67</span> - <span class="number">0.5</span>*g*tt^<span class="number">2</span></div><div class="line">y &lt;- f + rnorm(n,sd=<span class="number">1</span>)</div><div class="line"></div><div class="line">png(file=<span class="string">"../Figs/falling.png"</span>, width=<span class="number">1200</span>, height=<span class="number">1200</span>, res=<span class="number">300</span>,</div><div class="line">    pointsize=<span class="number">10</span>)</div><div class="line">plot(tt,y,ylab=<span class="string">"Distance in meters"</span>,xlab=<span class="string">"Time in seconds"</span>)</div><div class="line">lines(tt,f,col=<span class="number">2</span>)</div><div class="line">dev.off()</div></pre></td></tr></table></figure>
<p>我们模拟的自由落体运行图形如下所示：</p>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190816152214.png">

</div>
<p>但是，当我们假设自己是伽利略时，这个方程还没有被推导出来，因此我们并不知道其中相应的参数，这些数据只是表现得像一条抛物线，因此我们可以对这些数据进行建模，如下所示： <span class="math display">\[
Y_{i}=\beta_{0}+\beta_{1} x_{i}+\beta_{2} x_{i}^{2}+\varepsilon, i=1, \ldots, n
\]</span> 此时，我们如何找到LSE？</p>
<h2 id="lm函数">lm()函数</h2>
<p>R中的<code>lm()</code>函数可以很好地计算线性方程，现在我们先来简单计算一下这个方程，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">g &lt;- <span class="number">9.8</span> <span class="comment">##meters per second</span></div><div class="line">tt &lt;- seq(<span class="number">0</span>,<span class="number">3.4</span>,len=n) <span class="comment">##time in secs, t is a base function</span></div><div class="line">y &lt;- f + rnorm(n,sd=<span class="number">1</span>)</div><div class="line">tt2 &lt;-tt^<span class="number">2</span></div><div class="line">fit &lt;- lm(y~tt+tt2)</div><div class="line">summary(fit)$coef</div></pre></td></tr></table></figure>
<p>计算结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt; summary(fit)$coef</div><div class="line">              Estimate Std. Error     t value     Pr(&gt;|t|)</div><div class="line">(Intercept) <span class="number">57.1399311</span>  <span class="number">0.5484054</span> <span class="number">104.1928697</span> <span class="number">3.897090e-31</span></div><div class="line">tt          -<span class="number">0.1997275</span>  <span class="number">0.7470438</span>  -<span class="number">0.2673572</span> <span class="number">7.916846e-01</span></div><div class="line">tt2         -<span class="number">4.9193723</span>  <span class="number">0.2122243</span> -<span class="number">23.1800643</span> <span class="number">5.973048e-17</span></div></pre></td></tr></table></figure>
<p>这样就计算出了LSE，以及标准误，p值。</p>
<h2 id="最小二乘估计the-least-squares-estimate-lse">最小二乘估计(The Least squares estimate, LSE)</h2>
<p>现在我们写一个函数，这个函数的功能在于计算任任<span class="math inline">\(\beta\)</span>的RSS，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">rss &lt;- <span class="keyword">function</span>(Beta0,Beta1,Beta2)&#123;</div><div class="line">    r &lt;- y - (Beta0+Beta1*tt+Beta2*tt^<span class="number">2</span>)</div><div class="line">    <span class="keyword">return</span>(sum(r^<span class="number">2</span>))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所以对于任何三维向量，我们得到一个RSS。下图是当我们保持另外两个<span class="math inline">\(\beta\)</span>固定时，关于<span class="math inline">\(\beta_{2}\)</span>的函数的RSS的曲线，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">rss &lt;- <span class="keyword">function</span>(Beta0,Beta1,Beta2)&#123;</div><div class="line">    r &lt;- y - (Beta0+Beta1*tt+Beta2*tt^<span class="number">2</span>)</div><div class="line">    <span class="keyword">return</span>(sum(r^<span class="number">2</span>))</div><div class="line">&#125;</div><div class="line"></div><div class="line">Beta2s&lt;- seq(-<span class="number">10</span>,<span class="number">0</span>,len=<span class="number">100</span>)</div><div class="line">plot(Beta2s,sapply(Beta2s,rss,Beta0=<span class="number">55</span>,Beta1=<span class="number">0</span>),</div><div class="line">     ylab=<span class="string">"RSS"</span>,xlab=<span class="string">"Beta2"</span>,type=<span class="string">"l"</span>)</div><div class="line"><span class="comment">##Let's add another curve fixing another pair:</span></div><div class="line">Beta2s&lt;- seq(-<span class="number">10</span>,<span class="number">0</span>,len=<span class="number">100</span>)</div><div class="line">lines(Beta2s,sapply(Beta2s,rss,Beta0=<span class="number">65</span>,Beta1=<span class="number">0</span>),col=<span class="number">2</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190816155010.png">

</div>
<p>反复计算在这里行不通，相反，我们会使用微积分(calculus)的方法来进行计算，通过取偏导数(partial derivatives)，将它们设为0，然后求解。当然，如果我们有很多参数，这些方程会变得相当复杂。线性代数为这个问题提供了精练且通用的方法。</p>
<h2 id="galton拓展">Galton拓展</h2>
<p>Galton在研究父子身高问题时，他通过探索性数据分析有了一个新颖的发现，如下所示：</p>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190816155451.png">

</div>
<p>Galton发现，如果他将父子的身高数据制成表格，然后将那些x和y值的和都相同的点连接起来，就构成了一个椭圆。通过计算还会进一步发现，这些数据服从二元正态分布（具体的高尔顿图可以参考《于忠义, YUZhong-yi. 高尔顿发现相关与回归的历史回顾与反思[J]. 统计与信息论坛, 2009, 24(9):17-25.》）如下所示： <span class="math display">\[
\operatorname{Pr}(X&lt;a, Y&lt;b)=\\ \int_{-\infty}^{a} \int_{-\infty}^{b} \frac{1}{2 \pi \sigma_{x} \sigma_{y} \sqrt{1-\rho^{2}}} \exp \left\{\frac{1}{2\left(1-\rho^{2}\right)}\left[\left(\frac{x-\mu_{x}}{\sigma_{x}}\right)^{2}-2 \rho\left(\frac{x-\mu_{x}}{\sigma_{x}}\right)\left(\frac{y-\mu_{y}}{\sigma_{y}}\right)+\left(\frac{y-\mu_{y}}{\sigma_{y}}\right)^{2}\right]\right\}
\]</span> 从上面的公式我们知道，当我们保持<span class="math inline">\(X\)</span>不变时（也就是设定好<span class="math inline">\(x\)</span>），<span class="math inline">\(Y\)</span>的分布是服从正态分布的，即服从均值为<span class="math inline">\(\mu_{x}+\sigma_{y} \rho\left(\frac{x-\mu_{x}}{\sigma_{x}}\right)\)</span>，标准差为<span class="math inline">\(\sigma_{y} \sqrt{1-\rho^{2}}\)</span>的正态分布。<span class="math inline">\(\rho\)</span>是<span class="math inline">\(X\)</span>和<span class="math inline">\(Y\)</span>的相关系数，这就说明，如果我们设定<span class="math inline">\(X=x\)</span>，<span class="math inline">\(Y\)</span>实际上是一个线性模型。在我们的这个简单线性模型中，<span class="math inline">\(\beta_{0}\)</span>和<span class="math inline">\(\beta_{1}\)</span>参数表示为<span class="math inline">\(\mu_{x}, \mu_{y}, \sigma_{x}, \sigma_{y}\)</span>和<span class="math inline">\(\rho\)</span>。</p>
<h2 id="练习">练习</h2>
<p>P152</p>
<h2 id="参考资料">参考资料</h2>
<ol style="list-style-type: decimal">
<li>Rafael A Irizarry and Michael I Love.Data Analysis for the Life Sciences.This book is for sale at http://leanpub.com/dataanalysisforthelifesciences</li>
<li>于忠义, YUZhong-yi. 高尔顿发现相关与回归的历史回顾与反思[J]. 统计与信息论坛, 2009, 24(9):17-25.</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-tags" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rvdsd.top/2019/08/16/DAL/DALS010_Matrix_Algebra02_Matrix_Notation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="RVDSD">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RVDSD的个人笔记本">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/16/DAL/DALS010_Matrix_Algebra02_Matrix_Notation/" itemprop="url">DALS010-Matrix Algebra(矩阵代数)02-Matrix Notation</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-16T12:00:00+08:00">
                2019-08-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/生物统计/" itemprop="url" rel="index">
                    <span itemprop="name">生物统计</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  4,386
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  21
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言">前言</h2>
<p>这一部分是《Data Analysis for the life sciences》的第4章：矩阵代数的第2小节，这一部分的主要内容涉及矩阵的表示方法。</p>
<h2 id="线性模型语言">线性模型语言</h2>
<p>线性代数的符号化实际上简化了线性模型的数学描述和操作，以及R中的代码。这一部分的练习主要是通过使用矩阵符号来表示线性模型，并使用它来解最小二乘方程。</p>
<h2 id="解方程组">解方程组</h2>
<p>数学家创建线性代数是为了解以下这样的线性方程组： <span class="math display">\[
\begin{array}{r}{a+b+c=6} \\ {3 a-2 b+c=2} \\ {2 a+b-c=1}\end{array}
\]</span> 它提供了非常有用的机制来解决这些常见问题。我们将会学习如何使用矩阵代数来表示以及求解这些方程组，如下所示： <span class="math display">\[
\left(\begin{array}{ccc}{1} &amp; {1} &amp; {1} \\ {3} &amp; {-2} &amp; {1} \\ {2} &amp; {1} &amp; {-1}\end{array}\right)\left(\begin{array}{l}{a} \\ {b} \\ {c}\end{array}\right)=\left(\begin{array}{l}{6} \\ {2} \\ {1}\end{array}\right) \Rightarrow\left(\begin{array}{l}{a} \\ {b} \\ {c}\end{array}\right)=\left(\begin{array}{ccc}{1} &amp; {1} &amp; {1} \\ {3} &amp; {-2} &amp; {1} \\ {2} &amp; {1} &amp; {-1}\end{array}\right)^{-1}\left(\begin{array}{l}{6} \\ {2} \\ {1}\end{array}\right)
\]</span> 这一部分就是要解释上面的这些符号是什么意思，以及在统计学中如何用这些符号来计算线性方程。</p>
<h2 id="向量矩阵与标量">向量，矩阵与标量</h2>
<p>线性代数中的基本元素包括向量(vector)，矩阵(matrix)和标题(scalar)。</p>
<h3 id="向量">向量</h3>
<p>在自由落体运行，父子身高以及小鼠体重实验中，与这些数据有关的随机变量我们通常用<span class="math inline">\(Y_{1}, \ldots, Y_{n}\)</span>来表示，我们可以将它们视为一个向量(Vector)，其实R中就是这么干的，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(UsingR)</div><div class="line">y=father.son$fheight</div><div class="line">head(y)</div></pre></td></tr></table></figure>
<p>如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; head(y)</div><div class="line">[<span class="number">1</span>] <span class="number">65.04851</span> <span class="number">63.25094</span> <span class="number">64.95532</span> <span class="number">65.75250</span> <span class="number">61.13723</span> <span class="number">63.02254</span></div></pre></td></tr></table></figure>
<h3 id="矩阵">矩阵</h3>
<p>在数学中，我们可以只用一个符号来表示向量，我们通常用一个加粗的黑体字母，即<span class="math inline">\(\mathbf{Y}\)</span>来表示向量，从而将它与<span class="math inline">\(Y\)</span>区分开来，如下所示： <span class="math display">\[
\mathbf{Y}=\left(\begin{array}{c}{Y_{1}} \\ {Y_{2}} \\ {\vdots} \\ {Y_{N}}\end{array}\right)
\]</span> 因此，我们知道，一个数据向量的默认就是<span class="math inline">\(N \times 1\)</span>维，而不是<span class="math inline">\(1 \times N\)</span>维。这里不使用加粗字母是因为，在文中通常会告诉我们这是一个矩阵，而不是一个向量。类似的，我们可以使用数学符合来表示协方差(covariates)或预测因子(predictors)，如果我们有两个预测因子，那么就可以按以下形式表示： <span class="math display">\[
\mathrm{X}_{1}=\left(\begin{array}{c}{x_{1,1}} \\ {\vdots} \\ {x_{N, 1}}\end{array}\right) \text { and } \mathrm{X}_{2}=\left(\begin{array}{c}{x_{1,2}} \\ {\vdots} \\ {x_{N, 2}}\end{array}\right)
\]</span> 在自由落体案例中，<span class="math inline">\(x_{1,1}=t_{i}\)</span>，<span class="math inline">\(x_{i, 1}=t_{i}^{2}\)</span>，其中，<span class="math inline">\(t_{i}\)</span>表示的是第i次的观测值，这里再强调一次，向量可以被视为<span class="math inline">\(N \times 1\)</span>矩阵。因此上面的两个预测因子可以转换为矩阵，如下所示： <span class="math display">\[
\mathbf{X}=\left[\mathbf{X}_{1} \mathbf{X}_{2}\right]=\left(\begin{array}{cc}{x_{1,1}} &amp; {x_{1,2}} \\ {\vdots} \\ {x_{N, 1}} &amp; {x_{N, 2}}\end{array}\right)
\]</span> 此时，这个矩阵就是<span class="math inline">\(N \times 2\)</span>维，在R中，我们可以创建这个矩阵，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">n &lt;- <span class="number">25</span></div><div class="line">tt &lt;- seq(<span class="number">0</span>,<span class="number">3.4</span>,len=n) <span class="comment">##time in secs, t is a base function</span></div><div class="line">X &lt;- cbind(X1=tt,X2=tt^<span class="number">2</span>)</div><div class="line">head(X)</div><div class="line">dim(X)</div></pre></td></tr></table></figure>
<p>如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&gt; head(X)</div><div class="line">            X1         X2</div><div class="line">[<span class="number">1</span>,] <span class="number">0.0000000</span> <span class="number">0.00000000</span></div><div class="line">[<span class="number">2</span>,] <span class="number">0.1416667</span> <span class="number">0.02006944</span></div><div class="line">[<span class="number">3</span>,] <span class="number">0.2833333</span> <span class="number">0.08027778</span></div><div class="line">[<span class="number">4</span>,] <span class="number">0.4250000</span> <span class="number">0.18062500</span></div><div class="line">[<span class="number">5</span>,] <span class="number">0.5666667</span> <span class="number">0.32111111</span></div><div class="line">[<span class="number">6</span>,] <span class="number">0.7083333</span> <span class="number">0.50173611</span></div><div class="line">&gt; dim(X)</div><div class="line">[<span class="number">1</span>] <span class="number">25</span>  <span class="number">2</span></div></pre></td></tr></table></figure>
<p>我们也可以使用这些符号来表示任意<span class="math inline">\(N \times p\)</span>维的矩阵，如下所示： <span class="math display">\[
\mathbf{X}=\left(\begin{array}{ccc}{x_{1,1}} &amp; {\dots} &amp; {x_{1, p}} \\ {x_{2,1}} &amp; {\dots} &amp; {x_{2, p}} \\ {} &amp; {\vdots} \\ {x_{N, 1}} &amp; {\dots} &amp; {x_{N, p}}\end{array}\right)
\]</span> 在R中，可以使用<code>matrix()</code>函数来创建矩阵，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">N &lt;- <span class="number">100</span>; p &lt;- <span class="number">5</span></div><div class="line">X &lt;- matrix(<span class="number">1</span>:(N*p),N,p)</div><div class="line">head(X)</div><div class="line">dim(X)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&gt; head(X)</div><div class="line">     [,<span class="number">1</span>] [,<span class="number">2</span>] [,<span class="number">3</span>] [,<span class="number">4</span>] [,<span class="number">5</span>]</div><div class="line">[<span class="number">1</span>,]    <span class="number">1</span>  <span class="number">101</span>  <span class="number">201</span>  <span class="number">301</span>  <span class="number">401</span></div><div class="line">[<span class="number">2</span>,]    <span class="number">2</span>  <span class="number">102</span>  <span class="number">202</span>  <span class="number">302</span>  <span class="number">402</span></div><div class="line">[<span class="number">3</span>,]    <span class="number">3</span>  <span class="number">103</span>  <span class="number">203</span>  <span class="number">303</span>  <span class="number">403</span></div><div class="line">[<span class="number">4</span>,]    <span class="number">4</span>  <span class="number">104</span>  <span class="number">204</span>  <span class="number">304</span>  <span class="number">404</span></div><div class="line">[<span class="number">5</span>,]    <span class="number">5</span>  <span class="number">105</span>  <span class="number">205</span>  <span class="number">305</span>  <span class="number">405</span></div><div class="line">[<span class="number">6</span>,]    <span class="number">6</span>  <span class="number">106</span>  <span class="number">206</span>  <span class="number">306</span>  <span class="number">406</span></div><div class="line">&gt; dim(X)</div><div class="line">[<span class="number">1</span>] <span class="number">100</span>   <span class="number">5</span></div></pre></td></tr></table></figure>
<p>默认情况下，在R中，矩阵是按照列的顺序进行填充的，如果加上参数<code>byrow=TRUE</code>，则矩阵会按照行进行填充，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">N &lt;- <span class="number">100</span>; p &lt;- <span class="number">5</span></div><div class="line">X &lt;- matrix(<span class="number">1</span>:(N*p),N,p,byrow=<span class="literal">TRUE</span>)</div><div class="line">head(X)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&gt; head(X)</div><div class="line">     [,<span class="number">1</span>] [,<span class="number">2</span>] [,<span class="number">3</span>] [,<span class="number">4</span>] [,<span class="number">5</span>]</div><div class="line">[<span class="number">1</span>,]    <span class="number">1</span>    <span class="number">2</span>    <span class="number">3</span>    <span class="number">4</span>    <span class="number">5</span></div><div class="line">[<span class="number">2</span>,]    <span class="number">6</span>    <span class="number">7</span>    <span class="number">8</span>    <span class="number">9</span>   <span class="number">10</span></div><div class="line">[<span class="number">3</span>,]   <span class="number">11</span>   <span class="number">12</span>   <span class="number">13</span>   <span class="number">14</span>   <span class="number">15</span></div><div class="line">[<span class="number">4</span>,]   <span class="number">16</span>   <span class="number">17</span>   <span class="number">18</span>   <span class="number">19</span>   <span class="number">20</span></div><div class="line">[<span class="number">5</span>,]   <span class="number">21</span>   <span class="number">22</span>   <span class="number">23</span>   <span class="number">24</span>   <span class="number">25</span></div><div class="line">[<span class="number">6</span>,]   <span class="number">26</span>   <span class="number">27</span>   <span class="number">28</span>   <span class="number">29</span>   <span class="number">30</span></div></pre></td></tr></table></figure>
<h3 id="标量">标量</h3>
<p>标量仅仅是一个数字，通常使用小写字母来表示标量，并且不加粗。</p>
<h2 id="练习">练习</h2>
<p>P157</p>
<h2 id="数学运算">数学运算</h2>
<p>前面我们提到了一个方程组，如下所示： <span class="math display">\[
\begin{aligned} a+b+c &amp;=6 \\ 3 a-2 b+c &amp;=2 \\ 2 a+b-c &amp;=1 \end{aligned}
\]</span> 如果用矩阵代数来表示，就是下面的形式： <span class="math display">\[
\left(\begin{array}{ccc}{1} &amp; {1} &amp; {1} \\ {3} &amp; {-2} &amp; {1} \\ {2} &amp; {1} &amp; {-1}\end{array}\right)\left(\begin{array}{l}{a} \\ {b} \\ {c}\end{array}\right)=\left(\begin{array}{l}{6} \\ {2} \\ {1}\end{array}\right) \Rightarrow\left(\begin{array}{l}{a} \\ {b} \\ {c}\end{array}\right)=\left(\begin{array}{ccc}{1} &amp; {1} &amp; {1} \\ {3} &amp; {-2} &amp; {1} \\ {2} &amp; {1} &amp; {-1}\end{array}\right)^{-1}\left(\begin{array}{l}{6} \\ {2} \\ {1}\end{array}\right)
\]</span></p>
<h2 id="矩阵与标量相乘">矩阵与标量相乘</h2>
<p>这是矩阵运算中最简单的操作，一个矩阵<span class="math inline">\(\mathbf{X}\)</span>与一个标量<span class="math inline">\(a\)</span>相乘，矩阵的每一个元素都与这个标量相乘，如下所示： <span class="math display">\[
\mathbf{X}=\left(\begin{array}{ccc}{x_{1,1}} &amp; {\dots} &amp; {x_{1, p}} \\ {x_{2,1}} &amp; {\dots} &amp; {x_{2, p}} \\ {} &amp; {\vdots} &amp; {} \\ {x_{N, 1}} &amp; {\dots} &amp; {x_{N, p}}\end{array}\right) \Rightarrow a \mathbf{X}=\left(\begin{array}{ccc}{a x_{1,1}} &amp; {\dots} &amp; {a x_{1, p}} \\ {a x_{2,1}} &amp; {\dots} &amp; {a x_{2, p}} \\ {} &amp; {\vdots} \\ {a_{N, 1}} &amp; {\dots} &amp; {a x_{N, p}}\end{array}\right)
\]</span> R中的运算会自动遵循这个规则，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">X &lt;- matrix(<span class="number">1</span>:<span class="number">12</span>,<span class="number">4</span>,<span class="number">3</span>)</div><div class="line">print(X)</div><div class="line">a &lt;- <span class="number">2</span></div><div class="line">print(a*X)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&gt; X &lt;- matrix(<span class="number">1</span>:<span class="number">12</span>,<span class="number">4</span>,<span class="number">3</span>)</div><div class="line">&gt; print(X)</div><div class="line">     [,<span class="number">1</span>] [,<span class="number">2</span>] [,<span class="number">3</span>]</div><div class="line">[<span class="number">1</span>,]    <span class="number">1</span>    <span class="number">5</span>    <span class="number">9</span></div><div class="line">[<span class="number">2</span>,]    <span class="number">2</span>    <span class="number">6</span>   <span class="number">10</span></div><div class="line">[<span class="number">3</span>,]    <span class="number">3</span>    <span class="number">7</span>   <span class="number">11</span></div><div class="line">[<span class="number">4</span>,]    <span class="number">4</span>    <span class="number">8</span>   <span class="number">12</span></div><div class="line">&gt; a &lt;- <span class="number">2</span></div><div class="line">&gt; print(a*X)</div><div class="line">     [,<span class="number">1</span>] [,<span class="number">2</span>] [,<span class="number">3</span>]</div><div class="line">[<span class="number">1</span>,]    <span class="number">2</span>   <span class="number">10</span>   <span class="number">18</span></div><div class="line">[<span class="number">2</span>,]    <span class="number">4</span>   <span class="number">12</span>   <span class="number">20</span></div><div class="line">[<span class="number">3</span>,]    <span class="number">6</span>   <span class="number">14</span>   <span class="number">22</span></div><div class="line">[<span class="number">4</span>,]    <span class="number">8</span>   <span class="number">16</span>   <span class="number">24</span></div></pre></td></tr></table></figure>
<h2 id="转置transpose">转置(Transpose)</h2>
<p>矩阵的转置就是将矩阵的行与列颠倒，通常使用<span class="math inline">\(T\)</span>这个符号表示矩阵的转置运算，如下所示： <span class="math display">\[
\mathbf{X}=\left(\begin{array}{ccc}{x_{1,1}} &amp; {\ldots} &amp; {x_{1, p}} \\ {x_{2,1}} &amp; {\ldots} &amp; {x_{2, p}} \\ {} &amp; {\vdots} &amp; {} \\ {x_{N, 1}} &amp; {\ldots} &amp; {x_{N, p}}\end{array}\right) \Rightarrow \mathbf{X}^{\top}=\left(\begin{array}{ccc}{x_{1,1}} &amp; {\ldots} &amp; {x_{p, 1}} \\ {x_{1,2}} &amp; {\ldots} &amp; {x_{p, 2}} \\ {} &amp; {\vdots} &amp; {} \\ {x_{1, N}} &amp; {\ldots} &amp; {x_{p, N}}\end{array}\right)
\]</span> 在R中，直接使用<code>t()</code>函数就行，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">X &lt;- matrix(<span class="number">1</span>:<span class="number">12</span>,<span class="number">4</span>,<span class="number">3</span>)</div><div class="line">X</div><div class="line">t(X)</div></pre></td></tr></table></figure>
<p>如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&gt; X &lt;- matrix(<span class="number">1</span>:<span class="number">12</span>,<span class="number">4</span>,<span class="number">3</span>)</div><div class="line">&gt; X</div><div class="line">     [,<span class="number">1</span>] [,<span class="number">2</span>] [,<span class="number">3</span>]</div><div class="line">[<span class="number">1</span>,]    <span class="number">1</span>    <span class="number">5</span>    <span class="number">9</span></div><div class="line">[<span class="number">2</span>,]    <span class="number">2</span>    <span class="number">6</span>   <span class="number">10</span></div><div class="line">[<span class="number">3</span>,]    <span class="number">3</span>    <span class="number">7</span>   <span class="number">11</span></div><div class="line">[<span class="number">4</span>,]    <span class="number">4</span>    <span class="number">8</span>   <span class="number">12</span></div><div class="line">&gt; t(X)</div><div class="line">     [,<span class="number">1</span>] [,<span class="number">2</span>] [,<span class="number">3</span>] [,<span class="number">4</span>]</div><div class="line">[<span class="number">1</span>,]    <span class="number">1</span>    <span class="number">2</span>    <span class="number">3</span>    <span class="number">4</span></div><div class="line">[<span class="number">2</span>,]    <span class="number">5</span>    <span class="number">6</span>    <span class="number">7</span>    <span class="number">8</span></div><div class="line">[<span class="number">3</span>,]    <span class="number">9</span>   <span class="number">10</span>   <span class="number">11</span>   <span class="number">12</span></div></pre></td></tr></table></figure>
<h2 id="矩阵的相乘">矩阵的相乘</h2>
<p>还以开始三元一次方程组为例说明一下，如下所示： <span class="math display">\[
\begin{array}{r}{a+b+c=6} \\ {3 a-2 b+c=2} \\ {2 a+b-c=1}\end{array}
\]</span></p>
<p>两个矩阵相乘的运算法则是，第1个矩阵的行乘以第2个矩阵的列（第1个矩阵的列数与第2个矩阵的行数相同）。由于第2个矩阵只有1列，因此相乘的结果如下所示： <span class="math display">\[
\left(\begin{array}{ccc}{1} &amp; {1} &amp; {1} \\ {3} &amp; {-2} &amp; {1} \\ {2} &amp; {1} &amp; {-1}\end{array}\right)\left(\begin{array}{l}{a} \\ {b} \\ {c}\end{array}\right)=\left(\begin{array}{c}{a+b+c} \\ {3 a-2 b+c} \\ {2 a+b-c}\end{array}\right)
\]</span> 下面我们在R中计算一下，我们来看一下<code>abc=c(3,2,1)</code>是否是上述方程组的一个解，计算结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">X &lt;- matrix(c(<span class="number">1</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>,-<span class="number">2</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,-<span class="number">1</span>),<span class="number">3</span>,<span class="number">3</span>)</div><div class="line">abc &lt;- c(<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>) <span class="comment">#use as an example</span></div><div class="line">rbind( sum(X[<span class="number">1</span>,]*abc), sum(X[<span class="number">2</span>,]*abc), sum(X[<span class="number">3</span>,]%*%abc))</div></pre></td></tr></table></figure>
<p>计算结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt; rbind( sum(X[<span class="number">1</span>,]*abc), sum(X[<span class="number">2</span>,]*abc), sum(X[<span class="number">3</span>,]%*%abc))</div><div class="line">     [,<span class="number">1</span>]</div><div class="line">[<span class="number">1</span>,]    <span class="number">6</span></div><div class="line">[<span class="number">2</span>,]    <span class="number">6</span></div><div class="line">[<span class="number">3</span>,]    <span class="number">7</span></div></pre></td></tr></table></figure>
<p>使用<code>%*%</code>可以进行矩阵相乘，这种方法很简单，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">X%*%abc</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt; X%*%abc</div><div class="line">     [,<span class="number">1</span>]</div><div class="line">[<span class="number">1</span>,]    <span class="number">6</span></div><div class="line">[<span class="number">2</span>,]    <span class="number">6</span></div><div class="line">[<span class="number">3</span>,]    <span class="number">7</span></div></pre></td></tr></table></figure>
<p>从上面结果我们可以知道，<code>c(3,2,1)</code>不是方程组的解。为了求解方程组，我们需要逆转(inverse)左边的矩阵（后面要学习的内容）。在这里，我们定义矩阵<span class="math inline">\(A\)</span>与<span class="math inline">\(X\)</span>相乘的一般规则，如下所示： <span class="math display">\[
\mathbf{A X}=\left(\begin{array}{cccc}{a_{1,1}} &amp; {a_{1,2}} &amp; {\dots} &amp; {a_{1, N}} \\ {a_{2,1}} &amp; {a_{2,2}} &amp; {\dots} &amp; {a_{2, N}} \\ {} &amp; {} &amp; {\vdots} \\ {a_{M, 1}} &amp; {a_{M, 2}} &amp; {\dots} &amp; {a_{M, N}}\end{array}\right)\left(\begin{array}{ccc}{x_{1,1}} &amp; {\dots} &amp; {x_{1, p}} \\ {x_{2,1}} &amp; {\dots} &amp; {x_{2, p}} \\ {} &amp; {\vdots} \\ {x_{N, 1}} &amp; {\dots} &amp; {x_{N, p}}\end{array}\right)\\=\left(\begin{array}{ccc}{\sum_{i=1}^{N} a_{1, i} x_{i, 1}} &amp; {\ldots} &amp; {\sum_{i=1}^{N} a_{1, i} x_{i, p}} \\ {} &amp; {\vdots} &amp; {} \\ {\sum_{i=1}^{N} a_{M, i} x_{i, 1}} &amp; {\ldots} &amp; {\sum_{i=1}^{N} a_{M, i} x_{i, p}}\end{array}\right)
\]</span> 只有当矩阵<span class="math inline">\(A\)</span>的列数与矩阵<span class="math inline">\(X\)</span>的行数相等时，才能得到两个矩阵相乘的结果。</p>
<h2 id="单位矩阵the-identity-matrix">单位矩阵(The identity matrix)</h2>
<p>在矩阵代数中，单位矩阵的意义与1类似，一个矩阵乘以单位矩阵，还是其本身，单位矩阵的定义如下所示： <span class="math display">\[
\mathbf{I}=\left(\begin{array}{cccccc}{1} &amp; {0} &amp; {0} &amp; {\ldots} &amp; {0} &amp; {0} \\ {0} &amp; {1} &amp; {0} &amp; {\ldots} &amp; {0} &amp; {0} \\ {0} &amp; {0} &amp; {1} &amp; {\ldots} &amp; {0} &amp; {0} \\ {\vdots} &amp; {\vdots} &amp; {\vdots} &amp; {\ddots} &amp; {\vdots} &amp; {\vdots} \\ {0} &amp; {0} &amp; {0} &amp; {\ldots} &amp; {1} &amp; {0} \\ {0} &amp; {0} &amp; {0} &amp; {\ldots} &amp; {0} &amp; {1}\end{array}\right)
\]</span> 单位矩阵的行与列数目相等，从左上解到右下解的元素都为1，其余都为0。现在我们看一下一个矩阵与单位矩阵的相乘结果，如下所示： <span class="math display">\[
\mathbf{X I}=\left(\begin{array}{ccc}{x_{1,1}} &amp; {\dots} &amp; {x_{1, p}} \\ {} &amp; {\vdots} &amp; {} \\ {x_{N, 1}} &amp; {\dots} &amp; {x_{N, p}}\end{array}\right)\left(\begin{array}{cccccc}{1} &amp; {0} &amp; {0} &amp; {\dots} &amp; {0} &amp; {0} \\ {0} &amp; {1} &amp; {0} &amp; {\dots} &amp; {0} &amp; {0} \\ {0} &amp; {0} &amp; {1} &amp; {\dots} &amp; {0} &amp; {0} \\ {} &amp; {} &amp; {} &amp; {\vdots} &amp; {} \\ {0} &amp; {0} &amp; {0} &amp; {\dots} &amp; {1} &amp; {0} \\ {0} &amp; {0} &amp; {0} &amp; {\dots} &amp; {0} &amp; {1}\end{array}\right)=\left(\begin{array}{ccc}{x_{1,1}} &amp; {\dots} &amp; {x_{1, p}} \\ {} &amp; {\vdots} &amp; {} \\ {x_{N, 1}} &amp; {\dots} &amp; {x_{N, p}}\end{array}\right)
\]</span> R中可以通过<code>diag()</code>函数来生成单位矩阵，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">n &lt;- <span class="number">5</span> <span class="comment">#pick dimensions</span></div><div class="line">diag(n)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&gt; n &lt;- <span class="number">5</span> <span class="comment">#pick dimensions</span></div><div class="line">&gt; diag(n)</div><div class="line">     [,<span class="number">1</span>] [,<span class="number">2</span>] [,<span class="number">3</span>] [,<span class="number">4</span>] [,<span class="number">5</span>]</div><div class="line">[<span class="number">1</span>,]    <span class="number">1</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span></div><div class="line">[<span class="number">2</span>,]    <span class="number">0</span>    <span class="number">1</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span></div><div class="line">[<span class="number">3</span>,]    <span class="number">0</span>    <span class="number">0</span>    <span class="number">1</span>    <span class="number">0</span>    <span class="number">0</span></div><div class="line">[<span class="number">4</span>,]    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">1</span>    <span class="number">0</span></div><div class="line">[<span class="number">5</span>,]    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">1</span></div></pre></td></tr></table></figure>
<h2 id="矩阵的逆转inverse">矩阵的逆转(inverse)</h2>
<p>矩阵<span class="math inline">\(X\)</span>的逆转可以表示为<span class="math inline">\(X^{-1}\)</span>，逆转后的矩阵与原矩阵相乘，会得到单位矩阵，即<span class="math inline">\(X^{-1} X=I\)</span>，但是，并非所有的矩阵都可以逆转（逆转后的矩阵称为逆矩阵）。</p>
<p>当我们计算一个线性模型时，就要用到逆矩阵。在R中可以使用<code>solve()</code>函数来进行运算，<code>solve()</code>函数就是计算一个矩阵的逆矩阵，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">X &lt;- matrix(c(<span class="number">1</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>,-<span class="number">2</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,-<span class="number">1</span>),<span class="number">3</span>,<span class="number">3</span>)</div><div class="line">y &lt;- matrix(c(<span class="number">6</span>,<span class="number">2</span>,<span class="number">1</span>),<span class="number">3</span>,<span class="number">1</span>)</div><div class="line">solve(X)</div><div class="line">solve(X)%*%y <span class="comment">#equivalent to solve(X,y)</span></div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&gt; solve(X)</div><div class="line">           [,<span class="number">1</span>]        [,<span class="number">2</span>]       [,<span class="number">3</span>]</div><div class="line">[<span class="number">1</span>,] <span class="number">0.07692308</span>  <span class="number">0.15384615</span>  <span class="number">0.2307692</span></div><div class="line">[<span class="number">2</span>,] <span class="number">0.38461538</span> -<span class="number">0.23076923</span>  <span class="number">0.1538462</span></div><div class="line">[<span class="number">3</span>,] <span class="number">0.53846154</span>  <span class="number">0.07692308</span> -<span class="number">0.3846154</span></div><div class="line">&gt; solve(X)%*%y <span class="comment">#equivalent to solve(X,y)</span></div><div class="line">     [,<span class="number">1</span>]</div><div class="line">[<span class="number">1</span>,]    <span class="number">1</span></div><div class="line">[<span class="number">2</span>,]    <span class="number">2</span></div><div class="line">[<span class="number">3</span>,]    <span class="number">3</span></div></pre></td></tr></table></figure>
<h2 id="练习-1">练习</h2>
<p>P163</p>
<h2 id="矩阵案例">矩阵案例</h2>
<p>前面内容是关于矩阵的简单案例，以及它们在数据分析过程中的重要作用。我们最终要达到的目标是：如何使用矩阵代数符号来描述线性模型以及求解最小二乘问题。</p>
<h3 id="均值">均值</h3>
<p>为了计算样本的均值和方差，例如我们使用<span class="math inline">\(\overline{Y}=\frac{1}{N} Y_{i}\)</span>来计算均值，使用<span class="math inline">\(\operatorname{var}(Y)=\frac{1}{N} \sum_{i=1}^{N}\left(Y_{i}-\overline{Y}\right)^{2}\)</span>来计算方差。我们也可以使用矩阵乘法来计睡这些结果。</p>
<p>第一步：定义一个<span class="math inline">\(N\times1\)</span>矩阵，它只有1列，如下所示： <span class="math display">\[
A=\left(\begin{array}{l}{1} \\ {1} \\ {\vdots} \\ {1}\end{array}\right)
\]</span> 我们可以使用下面的公式来计算均值： <span class="math display">\[
\frac{1}{N} \mathbf{A}^{\top} Y=\frac{1}{N}\left(\begin{array}{llll}{1} &amp; {1} &amp; {\ldots} &amp; {1}\end{array}\right)\left(\begin{array}{l}{Y_{1}} \\ {Y_{2}} \\ {\vdots} \\ {Y_{N}}\end{array}\right)=\frac{1}{N} \sum_{i=1}^{N} Y_{i}=\overline{Y}
\]</span> 从上面的公式我们可以看到，里面乘了一个标量，即<span class="math inline">\(1/N\)</span>，在R中，可以使用<code>%*%</code>来实现，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(UsingR)</div><div class="line">y &lt;- father.son$sheight</div><div class="line">print(mean(y))</div><div class="line">N &lt;- length(y)</div><div class="line">Y&lt;- matrix(y,N,<span class="number">1</span>)</div><div class="line">A &lt;- matrix(<span class="number">1</span>,N,<span class="number">1</span>)</div><div class="line">barY=t(A)%*%Y / N</div><div class="line">print(barY)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&gt; <span class="keyword">library</span>(UsingR)</div><div class="line">&gt; y &lt;- father.son$sheight</div><div class="line">&gt; print(mean(y))</div><div class="line">[<span class="number">1</span>] <span class="number">68.68407</span></div><div class="line">&gt; N &lt;- length(y)</div><div class="line">&gt; Y&lt;- matrix(y,N,<span class="number">1</span>)</div><div class="line">&gt; A &lt;- matrix(<span class="number">1</span>,N,<span class="number">1</span>)</div><div class="line">&gt; barY=t(A)%*%Y / N</div><div class="line">&gt; print(barY)</div><div class="line">         [,<span class="number">1</span>]</div><div class="line">[<span class="number">1</span>,] <span class="number">68.68407</span></div></pre></td></tr></table></figure>
<h3 id="方差">方差</h3>
<p>在统计学中，常常会用到矩阵转置后的相乘，而在R中，可以直接进行运算，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">barY=crossprod(A,Y) / N</div><div class="line">print(barY)</div><div class="line">barY2 &lt;- t(A)%*%Y/N</div><div class="line">print(barY2)</div></pre></td></tr></table></figure>
<p>计算结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&gt; print(barY)</div><div class="line">         [,<span class="number">1</span>]</div><div class="line">[<span class="number">1</span>,] <span class="number">68.68407</span></div><div class="line">&gt; barY2 &lt;- t(A)%*%Y/N</div><div class="line">&gt; print(barY2)</div><div class="line">         [,<span class="number">1</span>]</div><div class="line">[<span class="number">1</span>,] <span class="number">68.68407</span></div></pre></td></tr></table></figure>
<p>在计算方差时，公式如下所示： <span class="math display">\[
\mathbf{r} \equiv\left(\begin{array}{c}{Y_{1}-\overline{Y}} \\ {\vdots} \\ {Y_{N}-\overline{Y}}\end{array}\right), \frac{1}{N} \mathbf{r}^{\top} \mathbf{r}=\frac{1}{N} \sum_{i=1}^{N}\left(Y_{i}-\overline{Y}\right)^{2}
\]</span> 在R中，如果<code>crossprod()</code>函数只有一个矩阵参数，那么计算的就是<span class="math inline">\(r^{\top} r\)</span>，可以简单地写为以下形式：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">r &lt;- y - barY</div><div class="line">crossprod(r)/N</div><div class="line">t(r)%*%r/N</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&gt; crossprod(r)/N</div><div class="line">         [,<span class="number">1</span>]</div><div class="line">[<span class="number">1</span>,] <span class="number">7.915196</span></div><div class="line">&gt; t(r)%*%r/N</div><div class="line">         [,<span class="number">1</span>]</div><div class="line">[<span class="number">1</span>,] <span class="number">7.915196</span></div></pre></td></tr></table></figure>
<p>上述计算过程也等于以下形式：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(rafalib)</div><div class="line">popvar(y)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; popvar(y)</div><div class="line">[<span class="number">1</span>] <span class="number">7.915196</span></div></pre></td></tr></table></figure>
<h2 id="线性模型">线性模型</h2>
<p>现在我们应用一下线性模型，还以Galton的案例为例说明一下，我们先定义以下矩阵： <span class="math display">\[
\mathbf{Y}=\left(\begin{array}{c}{Y_{1}} \\ {Y_{2}} \\ {\vdots} \\ {Y_{N}}\end{array}\right), \mathbf{X}=\left(\begin{array}{cc}{1} &amp; {x_{1}} \\ {1} &amp; {x_{2}} \\ {\vdots} &amp; {} \\ {1} &amp; {x_{N}}\end{array}\right), \beta=\left(\begin{array}{c}{\beta_{0}} \\ {\beta_{1}}\end{array}\right) \text { and } \varepsilon=\left(\begin{array}{c}{\varepsilon_{1}} \\ {\varepsilon_{2}} \\ {\vdots} \\ {\varepsilon_{N}}\end{array}\right)
\]</span> 然后写出线性模型，如下所示： <span class="math display">\[
Y_{i}=\beta_{0}+\beta_{1} x_{i}+\varepsilon, i=1, \ldots, N
\]</span> 它等于以下形式： <span class="math display">\[
\left(\begin{array}{c}{Y_{1}} \\ {Y_{2}} \\ {\vdots} \\ {Y_{N}}\end{array}\right)=\left(\begin{array}{cc}{1} &amp; {x_{1}} \\ {1} &amp; {x_{2}} \\ {\vdots} &amp; {} \\ {1} &amp; {x_{N}}\end{array}\right)\left(\begin{array}{c}{\beta_{0}} \\ {\beta_{1}}\end{array}\right)+\left(\begin{array}{c}{\varepsilon_{1}} \\ {\varepsilon_{2}} \\ {\vdots} \\ {\varepsilon_{N}}\end{array}\right)
\]</span> 简化一下，就是下面的形式： <span class="math display">\[
\mathrm{Y}=\mathrm{X} \beta+\varepsilon
\]</span> 那么最小二乘方程就变得比较简单，如下所示： <span class="math display">\[
(\mathrm{Y}-\mathrm{X} \boldsymbol{\beta})^{\top}(\mathrm{Y}-\mathrm{X} \boldsymbol{\beta})
\]</span> 现在我们计算的目标就是，找到<span class="math inline">\(\beta\)</span>的值，使得上述方程的值最小，我们可以使用微积分的手段来进行计算。</p>
<h2 id="线性模型的微积分计算">线性模型的微积分计算</h2>
<p>在使用矩阵符号来计算偏微分方程(partial derivative equation)时，需要遵循几个规则。通过当微分方程为0时，计算出<span class="math inline">\(\beta\)</span>，这个就是我们要求的解。在这里，我们上述的微分方程是以下形式： <span class="math display">\[
\begin{array}{c}{2 \mathbf{X}^{\top}(\mathbf{Y}-\mathbf{X} \hat{\boldsymbol{\beta}})=0} \\ {\mathbf{X}^{\top} \mathbf{X} \hat{\boldsymbol{\beta}}=\mathbf{X}^{\top} \mathbf{Y}} \\ {\hat{\boldsymbol{\beta}}=\left(\mathbf{X}^{\top} \mathbf{X}\right)^{-1} \mathbf{X}^{\top} \mathbf{Y}}\end{array}
\]</span> 对于求出的解，也就是<span class="math inline">\(\beta\)</span>，通常在上面加一个帽子结构，即<span class="math inline">\(\hat{\beta}\)</span>，这个表示是对真实的<span class="math inline">\(\beta\)</span>值的估计。这里我们需要记住的是，最小二乘类似于一个幂运算，这个公式类似于<span class="math inline">\(f(x)^{2}\)</span>的导数2<span class="math inline">\(f(x) f^{\prime}(x)\)</span>。</p>
<h2 id="在r中计算lse">在R中计算LSE</h2>
<p>代码如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(UsingR)</div><div class="line">x=father.son$fheight</div><div class="line">y=father.son$sheight</div><div class="line">X &lt;- cbind(<span class="number">1</span>,x)</div><div class="line">betahat &lt;- solve( t(X) %*% X ) %*% t(X) %*% y</div><div class="line"><span class="comment">###or</span></div><div class="line">betahat &lt;- solve( crossprod(X) ) %*% crossprod( X, y )</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt; betahat</div><div class="line">       [,<span class="number">1</span>]</div><div class="line">  <span class="number">33.886604</span></div><div class="line">x  <span class="number">0.514093</span></div></pre></td></tr></table></figure>
<p>通过计算估计的<span class="math inline">\(\hat{\beta_{0}}+\hat{\beta_{1}}x\)</span>就能计算出相应的<span class="math inline">\(x\)</span>的值，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">newx &lt;- seq(min(x),max(x),len=<span class="number">100</span>)</div><div class="line">X &lt;- cbind(<span class="number">1</span>,newx)</div><div class="line">fitted &lt;- X%*%betahat</div><div class="line">plot(x,y,xlab=<span class="string">"Father's height"</span>,ylab=<span class="string">"Son's height"</span>)</div><div class="line">lines(newx,fitted,col=<span class="number">2</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190816192553.jpeg">

</div>
<p>其中，<span class="math inline">\(\hat{\boldsymbol{\beta}}=\left(\mathbf{X}^{\top} \mathbf{X}\right)^{-1} \mathbf{X}^{\top} \mathbf{Y}\)</span>是数据分析中最常用的公式之一，它的一大优势就是可以应用于多种情况，例如在自由落体运算中：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">set.seed(<span class="number">1</span>)</div><div class="line">g &lt;- <span class="number">9.8</span> <span class="comment">#meters per second</span></div><div class="line">n &lt;- <span class="number">25</span></div><div class="line">tt &lt;- seq(<span class="number">0</span>,<span class="number">3.4</span>,len=n) <span class="comment">#time in secs, t is a base function</span></div><div class="line">d &lt;- <span class="number">56.67</span> - <span class="number">0.5</span>*g*tt^<span class="number">2</span> + rnorm(n,sd=<span class="number">1</span>)</div></pre></td></tr></table></figure>
<p>我们几乎用了与前面相同的代码，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">X &lt;- cbind(<span class="number">1</span>,tt,tt^<span class="number">2</span>)</div><div class="line">y &lt;- d</div><div class="line">betahat &lt;- solve(crossprod(X))%*%crossprod(X,y)</div><div class="line">newtt &lt;- seq(min(tt),max(tt),len=<span class="number">100</span>)</div><div class="line">X &lt;- cbind(<span class="number">1</span>,newtt,newtt^<span class="number">2</span>)</div><div class="line">fitted &lt;- X%*%betahat</div><div class="line">plot(tt,y,xlab=<span class="string">"Time"</span>,ylab=<span class="string">"Height"</span>)</div><div class="line">lines(newtt,fitted,col=<span class="number">2</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190816192833.jpeg">

</div>
<p>最终的估计值为：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt; betahat</div><div class="line">         [,<span class="number">1</span>]</div><div class="line">   <span class="number">56.5317368</span></div><div class="line">tt  <span class="number">0.5013565</span></div><div class="line">   -<span class="number">5.0386455</span></div></pre></td></tr></table></figure>
<h2 id="lm函数"><code>lm()</code>函数</h2>
<p>现在我们使用<code>lm()</code>函数来计算一下自由落体运动，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">X &lt;- cbind(tt,tt^<span class="number">2</span>)</div><div class="line">fit=lm(y~X)</div><div class="line">summary(fit)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&gt; summary(fit)</div><div class="line"></div><div class="line">Call:</div><div class="line">lm(formula = y ~ X)</div><div class="line"></div><div class="line">Residuals:</div><div class="line">    Min      1Q  Median      3Q     Max </div><div class="line">-<span class="number">2.5295</span> -<span class="number">0.4882</span>  <span class="number">0.2537</span>  <span class="number">0.6560</span>  <span class="number">1.5455</span> </div><div class="line"></div><div class="line">Coefficients:</div><div class="line">            Estimate Std. Error t value Pr(&gt;|t|)    </div><div class="line">(Intercept)  <span class="number">56.5317</span>     <span class="number">0.5451</span> <span class="number">103.701</span>   &lt;<span class="number">2e-16</span> ***</div><div class="line">Xtt           <span class="number">0.5014</span>     <span class="number">0.7426</span>   <span class="number">0.675</span>    <span class="number">0.507</span>    </div><div class="line">X            -<span class="number">5.0386</span>     <span class="number">0.2110</span> -<span class="number">23.884</span>   &lt;<span class="number">2e-16</span> ***</div><div class="line">---</div><div class="line">Signif. codes:  <span class="number">0</span> ‘***’ <span class="number">0.001</span> ‘**’ <span class="number">0.01</span> ‘*’ <span class="number">0.05</span> ‘.’ <span class="number">0.1</span> ‘ ’ <span class="number">1</span></div><div class="line"></div><div class="line">Residual standard error: <span class="number">0.9822</span> on <span class="number">22</span> degrees of freedom</div><div class="line">Multiple R-squared:  <span class="number">0.9973</span>,	Adjusted R-squared:  <span class="number">0.997</span> </div><div class="line"><span class="literal">F</span>-statistic:  <span class="number">4025</span> on <span class="number">2</span> and <span class="number">22</span> DF,  p-value: &lt; <span class="number">2.2e-16</span></div></pre></td></tr></table></figure>
<p>这个结果与前面的计算结果一致。</p>
<h2 id="总结">总结</h2>
<p>在这一部分中，我们学习了如何使用线性代数来描述线性模型。随后我们研究了几个案例，其中的一些是与实验设计有有。我们还演示了最小二乘估计。但是，我们需要记住，由于y是一个随机变量，这些估计也是随机的。在后面的章节中，我们将学习如何计算这些随机变量，以及随机变量的标准误以及统计推断。</p>
<h2 id="练习-2">练习</h2>
<p>P171</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/22/">22</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">RVDSD</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">211</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">98</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">RVDSD</span>

  
</div>



<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_pv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>


<div class="BbeiAn-info">
	<a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41018102000118" style="color:#909090;text-decoration:none;padding-left:0px;no-repeat left center" rel="nofollow">豫公网安备 41018102000118</a>	  <!--这里将图标作为了背景，以使得能和后面的文字在同一行-->
</div>

  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.3</div>




<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共840.3k字</span>
</div>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="custom_mathjax_source">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
  


  

  

</body>
</html>
