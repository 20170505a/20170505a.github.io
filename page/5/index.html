<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="RVDSD的个人笔记本">
<meta property="og:url" content="http://rvdsd.top/page/5/index.html">
<meta property="og:site_name" content="RVDSD的个人笔记本">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="RVDSD的个人笔记本">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://rvdsd.top/page/5/"/>





  <title>RVDSD的个人笔记本</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">RVDSD的个人笔记本</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-tags" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rvdsd.top/2019/08/15/DAL/DALS015_Linear_Models05Collinearity/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="RVDSD">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RVDSD的个人笔记本">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/15/DAL/DALS015_Linear_Models05Collinearity/" itemprop="url">DALS015-Linear Models线性模型05共线性</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-15T12:00:00+08:00">
                2019-08-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Data-Analysis-for-the-life-sciences/" itemprop="url" rel="index">
                    <span itemprop="name">Data Analysis for the life sciences</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  4,113
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  18
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言">前言</h2>
<p>这一部分是《Data Analysis for the life sciences》的第5章线性模型的第5小节，这一部分的主要内容涉及矩阵的共线性(Co-linearity)，秩(rank)，QR分解，有关共线性和秩的笔记R markdown文档可以参考作者的<a href="https://github.com/genomicsclass/labs/blob/master/linear/collinearity.Rmd" target="_blank" rel="external">Github</a>，QR分解见<a href="https://github.com/genomicsclass/labs/blob/master/linear/qr_and_regression.Rmd" target="_blank" rel="external">另外一篇</a>。</p>
<h2 id="共线性co-linearity">共线性(Co-linearity)</h2>
<p>如果一个实验设计不合理，那么我们就无法对目标参数进行估计。同样，当我们分析数据时，不合理地使用一个模型时也会得错误的结论。我们使用线性模型时，通过检查设计矩阵的共线性(collinearity)就能从数学角度来考虑我们选择的这个模型是否合理。</p>
<h2 id="方程组案例">方程组案例</h2>
<p>我们来看一个方程组，如下所示： <span class="math display">\[
\begin{align*}
a+c &amp;=1\\
b-c &amp;=1\\
a+b &amp;=2
\end{align*}
\]</span> 这个方程就不止一个解，因为有无数组数据满足<code>a=1-c</code>，<code>b=1+c</code>。例如<code>a=1, b=1, c=0</code>和<code>a=0,b=c,c=1</code>。</p>
<h2 id="矩阵代数方法">矩阵代数方法</h2>
<p>现在我们使用矩阵来说明一下上面的情况，上面的方程组我们写成矩阵形式如下所示： <span class="math display">\[
\,
\begin{pmatrix}
1&amp;0&amp;1\\
0&amp;1&amp;-1\\
1&amp;1&amp;0\\
\end{pmatrix}
\begin{pmatrix}
a\\
b\\
c
\end{pmatrix}
=
\begin{pmatrix}
1\\
1\\
2
\end{pmatrix}
\]</span> 从矩阵中我们可以发现，其实矩阵的第3列就是第1列和第2列的线性组合，如下所示： <span class="math display">\[
\,
\begin{pmatrix}
1\\
0\\
1
\end{pmatrix}
+
-1 \begin{pmatrix}
0\\
1\\
1
\end{pmatrix}
=
\begin{pmatrix}
1\\
-1\\
0
\end{pmatrix}
\]</span> 因此，我们可以说第3列与前2列共线性(collinear)，这也就是说，我们可以将上面的矩阵写成下面的这个形式： <span class="math display">\[
\,
\begin{pmatrix}
1&amp;0&amp;1\\
0&amp;1&amp;-1\\
1&amp;1&amp;0
\end{pmatrix}
\begin{pmatrix}
a\\
b\\
c
\end{pmatrix}
=
a
\begin{pmatrix}
1\\
0\\
1
\end{pmatrix}
+
b \begin{pmatrix}
0\\
1\\
1
\end{pmatrix}
+
c
\begin{pmatrix}
1-0\\
0-1\\
1-1
\end{pmatrix}
\]</span></p>
<p><span class="math display">\[
=(a+c)
\begin{pmatrix}
1\\
0\\
1\\
\end{pmatrix}
+
(b-c)
\begin{pmatrix}
0\\
1\\
1\\
\end{pmatrix}
\]</span></p>
<p>新的矩阵也就说明了，第3列其实没什么用，我们真正有的是3个方程和2个未知数，即<code>a+c</code>和<code>b+c</code>。一旦我们得到了这两个量（即<code>a+c</code>和<code>b+c</code>），那么<code>a, b, c</code>这个未知数就有无数种解。</p>
<h2 id="共线性和最小平方">共线性和最小平方</h2>
<p>现在我们考虑一个设计矩阵<span class="math inline">\(\mathbf{X}\)</span>，这个矩阵含有2个共线性列。我们创建一个极端的例子，在这个例子中，有两列互为相反，如下所示： <span class="math display">\[
\mathbf{X} = \begin{pmatrix}
\mathbf{1}&amp;\mathbf{X}_1&amp;\mathbf{X}_2&amp;\mathbf{X}_3\\
\end{pmatrix}
\mbox{ with, say, }
\mathbf{X}_3 = - \mathbf{X}_2
\]</span> 这就意味着，我们可以把上面的矩阵写为如下形式： <span class="math display">\[
\mathbf{Y}- \left\{ \mathbf{1}\beta_0 + \mathbf{X}_1\beta_1 + \mathbf{X}_2\beta_2 + \mathbf{X}_3\beta_3\right\}\\ 
= \mathbf{Y}- \left\{ \mathbf{1}\beta_0 + \mathbf{X}_1\beta_1 + \mathbf{X}_2\beta_2 - \mathbf{X}_2\beta_3\right\}\\
= \mathbf{Y}- \left\{\mathbf{1}\beta_0 + \mathbf{X}_1 \beta_1 + \mathbf{X}_2(\beta_2  - \beta_3)\right\}
\]</span></p>
<p>如果<span class="math inline">\(\hat{\beta}_1\)</span>, <span class="math inline">\(\hat{\beta}_2\)</span>, <span class="math inline">\(\hat{\beta}_3\)</span> 是一个最小平方解(least squares solution)，那么，例如<span class="math inline">\(\hat{\beta}_1\)</span>, <span class="math inline">\(\hat{\beta}_2+1\)</span>, <span class="math inline">\(\hat{\beta}_3+1\)</span>也是一个解。</p>
<h2 id="混淆confounding案例分析">混淆(confounding)案例分析</h2>
<p>现在我们将演示一下共线性是如何帮助我们解决当前实验设计中最常见的错误之一的：混淆(confounding)。 为了说明这个问题。现在我们设想一个实验，例如我们感兴趣的是四种处理因素，即A，B，C和D。我们给每种处理因素分配2只小鼠。当我们给A、B处理分配的是雌性小鼠后，我们意识到性别(sex)有可能对实验造成影响。我们决定给C和D两组雄性小鼠，从而估计性别对实验的影响。但是，通过这种方式我们能否估计出性别的影响呢，这个实验我们表示为矩阵形式，则如下所示： <span class="math display">\[
\,
\begin{pmatrix}
Sex &amp; A &amp; B &amp; C &amp; D\\
0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 \\
0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 \\
1 &amp; 0 &amp; 0 &amp; 1 &amp; 0 \\
1 &amp; 0 &amp; 0 &amp; 1 &amp; 0 \\
1 &amp; 0 &amp; 0 &amp; 0 &amp; 1 \\
1 &amp; 0 &amp; 0 &amp; 0 &amp; 1\\
\end{pmatrix}
\]</span> 在这个矩阵里，我们可以看到处理因素与性别产生了混淆(confound)，尤其是，性别这一列可以用C列和D列进行表示（也就是说共线性），如下所示： <span class="math display">\[
\,
\begin{pmatrix}
Sex \\
0\\
0 \\
0 \\
0 \\
1\\
1\\
1 \\
1 \\
\end{pmatrix}
=
\begin{pmatrix}
C \\
0\\
0\\
0\\
0\\
1\\
1\\
0\\
0\\
\end{pmatrix}
+
\begin{pmatrix}
D \\
0\\
0\\
0\\
0\\
0\\
0\\
1\\
1\\
\end{pmatrix}
\]</span> 这就说明了，无法使用最小平方和来对实验结果进行计算。</p>
<h2 id="秩rank">秩(rank)</h2>
<p>一个矩阵的秩(rank)表示的是，矩阵中独立于其他列的数目。如果矩阵的秩小于列的数目，那么LSE则不唯一。在R中，我们可以使用<code>qr()</code>函数来获取一个矩阵的秩，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Sex &lt;- c(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>)</div><div class="line">A &lt;- c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</div><div class="line">B &lt;- c(<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</div><div class="line">C &lt;- c(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>)</div><div class="line">D &lt;- c(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>)</div><div class="line">X &lt;- model.matrix(~Sex+A+B+C+D-<span class="number">1</span>)</div><div class="line">cat(<span class="string">"ncol="</span>,ncol(X),<span class="string">"rank="</span>, qr(X)$rank,<span class="string">"\n"</span>)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ncol= <span class="number">5</span> rank= <span class="number">4</span></div></pre></td></tr></table></figure>
<h2 id="移除混淆">移除混淆</h2>
<p>前面我们提到的那个实验可以设计得更加完全。使用相同数量的雄性小鼠和雌性小鼠可以很容易设计一个实验来研究性别影响与干预影响。具体来说就是，当我们平衡了性别与干预后，混淆就会被消除，也就是说，通过一定的合理实验设计，就是使秩与列的数目相同，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Sex &lt;- c(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>)</div><div class="line">A &lt;- c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</div><div class="line">B &lt;- c(<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</div><div class="line">C &lt;- c(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>)</div><div class="line">D &lt;- c(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>)</div><div class="line">X &lt;- model.matrix(~Sex+A+B+C+D-<span class="number">1</span>)</div><div class="line">cat(<span class="string">"ncol="</span>,ncol(X),<span class="string">"rank="</span>, qr(X)$rank,<span class="string">"\n"</span>)</div></pre></td></tr></table></figure>
<p>计算结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ncol= <span class="number">5</span> rank= <span class="number">5</span></div></pre></td></tr></table></figure>
<h2 id="练习">*练习</h2>
<p>P237</p>
<h2 id="矩阵的qr分解">矩阵的QR分解</h2>
<p>这一部分的R markdown参考文档见<a href="https://github.com/genomicsclass/labs/blob/master/linear/qr_and_regression.Rmd" target="_blank" rel="external">Github</a>。</p>
<p>前面我们已经了解到了通过逆转一个矩阵来计算LSE，前面使用了<code>solve()</code>函数。但是，这并非是一种稳定的解决方式方式。当我们进行LSE计算时，可以使用QR分解。</p>
<h2 id="逆转">逆转</h2>
<p>为了使RSS最小： <span class="math display">\[
(\mathbf{Y}-\mathbf{X}\boldsymbol{\beta})^\top
(\mathbf{Y}-\mathbf{X}\boldsymbol{\beta})
\]</span> 我们需要解下面方程： <span class="math display">\[
\mathbf{X}^\top \mathbf{X} \boldsymbol{\hat{\beta}} = \mathbf{X}^\top \mathbf{Y}
\]</span> 解为： <span class="math display">\[
\boldsymbol{\hat{\beta}} = (\mathbf{X}^\top \mathbf{X})^{-1} \mathbf{X}^\top \mathbf{Y}
\]</span> 因此，我们需要计算<span class="math inline">\((\mathbf{X}^\top \mathbf{X})^{-1}\)</span></p>
<p>这个解在数学上是不稳定的(solve is numerically unstable)。</p>
<p>为了说明什么叫<code>在数学上是不稳定的</code>，我们来看下面的代码：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">n &lt;- <span class="number">50</span>;M &lt;- <span class="number">500</span></div><div class="line">x &lt;- seq(<span class="number">1</span>,M,len=n)</div><div class="line">X &lt;- cbind(<span class="number">1</span>,x,x^<span class="number">2</span>,x^<span class="number">3</span>)</div><div class="line">colnames(X) &lt;- c(<span class="string">"Intercept"</span>,<span class="string">"x"</span>,<span class="string">"x2"</span>,<span class="string">"x3"</span>)</div><div class="line">beta &lt;- matrix(c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>),<span class="number">4</span>,<span class="number">1</span>)</div><div class="line">set.seed(<span class="number">1</span>)</div><div class="line">y &lt;- X%*%beta+rnorm(n,sd=<span class="number">1</span>)</div><div class="line">solve(crossprod(X)) %*% crossprod(X,y)</div></pre></td></tr></table></figure>
<p>运行后就出错了，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt; solve(crossprod(X)) %*% crossprod(X,y)</div><div class="line">Error <span class="keyword">in</span> solve.default(crossprod(X)) : </div><div class="line">  system is computationally singular: reciprocal condition number = <span class="number">2.93617e-17</span></div></pre></td></tr></table></figure>
<p>现在我们来看一下为什么会出现这种错误，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">options(digits=<span class="number">4</span>)</div><div class="line">log10(crossprod(X))</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&gt; options(digits=<span class="number">4</span>)</div><div class="line">&gt; log10(crossprod(X))</div><div class="line">          Intercept      x     x2     x3</div><div class="line">Intercept     <span class="number">1.699</span>  <span class="number">4.098</span>  <span class="number">6.625</span>  <span class="number">9.203</span></div><div class="line">x             <span class="number">4.098</span>  <span class="number">6.625</span>  <span class="number">9.203</span> <span class="number">11.810</span></div><div class="line">x2            <span class="number">6.625</span>  <span class="number">9.203</span> <span class="number">11.810</span> <span class="number">14.434</span></div><div class="line">x3            <span class="number">9.203</span> <span class="number">11.810</span> <span class="number">14.434</span> <span class="number">17.070</span></div></pre></td></tr></table></figure>
<p>这里我们要注意一下数量级的差异。常用的数字计算机储存的数字范围有限。 当我们要要考虑使用非常大的数字时，这会使一些数字看起来像0。 这反过来又会导致由0划分导致的错误划分（原文是：This in turn leads to divisions that are practically divisions by 0 errors）。</p>
<h2 id="分解factorization">分解(factorization)</h2>
<p>QR分解是基于一种数学结果，它能告诉我们可以分解任意的全秩(any full rank)的<span class="math inline">\(N \times p\)</span>矩阵<span class="math inline">\(\mathbf{X}\)</span>，如下所示： <span class="math display">\[
\mathbf{X}=\mathbf{QR}
\]</span> 其中：</p>
<ul>
<li><span class="math inline">\(\mathbf{X}\)</span>是一个<span class="math inline">\(N \times p\)</span>矩阵，<span class="math inline">\(\mathbf{Q}^{T}\mathbf{Q}=I\)</span></li>
<li><span class="math inline">\(\mathbf{R}\)</span>是一个<span class="math inline">\(p \times p\)</span>矩阵，上三角矩阵。</li>
</ul>
<p>上三角矩阵在解方程组方面非常有用。</p>
<h3 id="什么是上三角矩阵">什么是上三角矩阵</h3>
<p>在下面的案例中，最左边的就是上三角矩阵：上三角矩阵的特点就是，矩阵对角线的左下方都是0，右上方不为零，根据矩阵的运算规则，这就很容易解方程组，如下所示： <span class="math display">\[
\,
\begin{pmatrix}
1&amp;2&amp;-1\\
0&amp;1&amp;2\\
0&amp;0&amp;1\\
\end{pmatrix}
\begin{pmatrix}
a\\
b\\
c\\
\end{pmatrix}
=
\begin{pmatrix}
6\\
4\\
1\\
\end{pmatrix}
\]</span> 从上面的形式我们就能马上看出来，<span class="math inline">\(c=1, b + 2 = 4, a = 3\)</span>。</p>
<h3 id="利用qr来计算lse">利用QR来计算LSE</h3>
<p>如果我们重新使用<span class="math inline">\(\mathbf{QR}\)</span>来替代<span class="math inline">\(\mathbf{X}\)</span>来写LSE的公式，则如下所示：</p>
<p><span class="math display">\[
\mathbf{X}^\top \mathbf{X} \boldsymbol{\beta} = \mathbf{X}^\top \mathbf{Y}
\]</span></p>
<p><span class="math display">\[
(\mathbf{Q}\mathbf{R})^\top (\mathbf{Q}\mathbf{R}) \boldsymbol{\beta} = (\mathbf{Q}\mathbf{R})^\top \mathbf{Y}
\]</span></p>
<p><span class="math display">\[
\mathbf{R}^\top (\mathbf{Q}^\top \mathbf{Q}) \mathbf{R} \boldsymbol{\beta} = \mathbf{R}^\top \mathbf{Q}^\top \mathbf{Y}
\]</span></p>
<p><span class="math display">\[
\mathbf{R}^\top \mathbf{R} \boldsymbol{\beta} = \mathbf{R}^\top \mathbf{Q}^\top \mathbf{Y}
\]</span></p>
<p><span class="math display">\[
(\mathbf{R}^\top)^{-1} \mathbf{R}^\top \mathbf{R} \boldsymbol{\beta} = (\mathbf{R}^\top)^{-1} \mathbf{R}^\top \mathbf{Q}^\top \mathbf{Y}
\]</span></p>
<p><span class="math display">\[
\mathbf{R} \boldsymbol{\beta} = \mathbf{Q}^\top \mathbf{Y}
\]</span></p>
<p>其中，<span class="math inline">\(\mathbf{R}\)</span>是上三角矩阵，它能够更加稳定地求出LSE。此外，由于<span class="math inline">\(\mathbf{Q}^T\mathbf{Q}=\mathbf{I}\)</span>，我们知道<span class="math inline">\(\mathbf{Q}\)</span>的列能够稳定右侧（这一段不太懂，原文：we know that the columns of Q are in the same scale which stabilizes the right side)。</p>
<p>现在我们就可以通过QR分解来计算LSE了，也就是解下面的这个方程：</p>
<p><span class="math display">\[
\mathbf{R} \boldsymbol{\beta} = \mathbf{Q}^\top \mathbf{Y}
\]</span></p>
<p>在R中我们使用<code>backsolve()</code>函数来角这个方程，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">QR &lt;- qr(X)</div><div class="line">Q &lt;- qr.Q( QR )</div><div class="line">R &lt;- qr.R( QR )</div><div class="line">(betahat &lt;- backsolve(R, crossprod(Q,y) ) )</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&gt; QR &lt;- qr(X)</div><div class="line">&gt; Q &lt;- qr.Q( QR )</div><div class="line">&gt; R &lt;- qr.R( QR )</div><div class="line">&gt; (betahat &lt;- backsolve(R, crossprod(Q,y) ) )</div><div class="line">          [,<span class="number">1</span>]</div><div class="line">[<span class="number">1</span>,] <span class="number">0.9038372</span></div><div class="line">[<span class="number">2</span>,] <span class="number">1.0066440</span></div><div class="line">[<span class="number">3</span>,] <span class="number">0.9999622</span></div><div class="line">[<span class="number">4</span>,] <span class="number">1.0000001</span></div></pre></td></tr></table></figure>
<p>实际上，R中有内置函数<code>solve.qr()</code>也能实现此功能，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">QR &lt;- qr(X)</div><div class="line">(betahat &lt;- solve.qr(QR, y))</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&gt; QR &lt;- qr(X)</div><div class="line">&gt; (betahat &lt;- solve.qr(QR, y))</div><div class="line">               [,<span class="number">1</span>]</div><div class="line">Intercept <span class="number">0.9038372</span></div><div class="line">x         <span class="number">1.0066440</span></div><div class="line">x2        <span class="number">0.9999622</span></div><div class="line">x3        <span class="number">1.0000001</span></div></pre></td></tr></table></figure>
<h3 id="拟合值">拟合值</h3>
<p>这种分解过程也能简化拟合值的计算，如下所示： <span class="math display">\[
\mathbf{X}\boldsymbol{\hat{\beta}} = 
(\mathbf{QR})\mathbf{R}^{-1}\mathbf{Q}^\top \mathbf{y}= \mathbf{Q}\mathbf{Q}^\top\mathbf{y}
\]</span></p>
<p>在R中，计算如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(rafalib)</div><div class="line">mypar(<span class="number">1</span>,<span class="number">1</span>)</div><div class="line">plot(x,y)</div><div class="line">fitted &lt;- tcrossprod(Q)%*%y</div><div class="line">lines(x,fitted,col=<span class="number">2</span>)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190826133645.jpeg">

</div>
<h3 id="标准误">标准误</h3>
<p>如果要计算LSE的标准误，需要考虑如下公式：</p>
<p><span class="math display">\[
(\mathbf{X^\top X})^{-1} = (\mathbf{R^\top Q^\top QR})^{-1} = (\mathbf{R^\top R})^{-1}
\]</span> 使用<code>chol12inv()</code>函数是专门用于计算这个逆矩阵的，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">df &lt;- length(y) - QR$rank</div><div class="line">sigma2 &lt;- sum((y-fitted)^<span class="number">2</span>)/df</div><div class="line">varbeta &lt;- sigma2*chol2inv(qr.R(QR))</div><div class="line">SE &lt;- sqrt(diag(varbeta))</div><div class="line">cbind(betahat,SE)</div><div class="line">summary(lm(y~<span class="number">0</span>+X))$coef</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&gt; cbind(betahat,SE)</div><div class="line">                              SE</div><div class="line">Intercept <span class="number">0.9038372</span> <span class="number">4.508440e-01</span></div><div class="line">x         <span class="number">1.0066440</span> <span class="number">7.858164e-03</span></div><div class="line">x2        <span class="number">0.9999622</span> <span class="number">3.661705e-05</span></div><div class="line">x3        <span class="number">1.0000001</span> <span class="number">4.802429e-08</span></div><div class="line">&gt; summary(lm(y~<span class="number">0</span>+X))$coef</div><div class="line">            Estimate   Std. Error      t value      Pr(&gt;|t|)</div><div class="line">XIntercept <span class="number">0.9038372</span> <span class="number">4.508440e-01</span> <span class="number">2.004767e+00</span>  <span class="number">5.089408e-02</span></div><div class="line">Xx         <span class="number">1.0066440</span> <span class="number">7.858164e-03</span> <span class="number">1.281017e+02</span>  <span class="number">2.171355e-60</span></div><div class="line">Xx2        <span class="number">0.9999622</span> <span class="number">3.661705e-05</span> <span class="number">2.730865e+04</span> <span class="number">1.745091e-167</span></div><div class="line">Xx3        <span class="number">1.0000001</span> <span class="number">4.802429e-08</span> <span class="number">2.082280e+07</span> <span class="number">4.558613e-300</span></div></pre></td></tr></table></figure>
<h2 id="其它线性模型">其它线性模型</h2>
<p>这一部分的参考R markdown文档见<a href="https://github.com/genomicsclass/labs/blob/master/linear/linear_models_going_further.Rmd" target="_blank" rel="external">Github</a>。</p>
<p>线性模型的用途使用非常广，并且它还可以扩展到其它方面，后面就介绍一些线性模型的拓展。</p>
<h3 id="稳健线性模型robust-linear-models">稳健线性模型(Robust linear models)</h3>
<p>在标准线性模型里，我们在计算它的解以及估计误差时，我们通常会通过计算最小平方误差来实现目标。这就涉及所有点的平方和，同时，这也表明，一旦数据中存在着异常值，那么这些异常值就会对计算结果产生重要的影响。此外，我们在使用线性模型时，我们是假定误差是恒定的（也就是同方差性，或齐方差性，homoskedasticity），不过在实际运用过程中，这种假设并非总成立（如果误差不剂，我们称为异方差性，heteroskedasticity）。因此需要其它一些方法用于产生稳健的解决方案，这些新的方法可以很好地处理异常值，或者是当我们的假设（也是同方差时）不满足时，这些模型也能很好地实现目的。在R的官网上，有介绍这些方差的内容<a href="https://cran.r-project.org/web/views/Robust.html" target="_blank" rel="external">《CRAN Task View: Robust Statistical Methods》</a>。</p>
<h3 id="广义线性模型generalized-linear-modelsglm">广义线性模型(Generalized linear models,GLM)</h3>
<p>在标准线性模型里，我们对<span class="math inline">\(\mathbf{Y}\)</span>的分布没做任何假设，但是在某些情况下，如果我们知道了<span class="math inline">\(\mathbf{Y}\)</span>，例如<span class="math inline">\(\mathbf{Y}\)</span>仅限于非负整数 <span class="math inline">\(0,1,2,\dots\)</span>，或者是限于区间<span class="math inline">\([0,1]\)</span>。用于分析这类情况的框架被称为广义线性模型，通常缩写为GLMs。GLM的两个关键组成部分就是链接函数与概率分布。链接函数<span class="math inline">\(g\)</span>会通常以下方式将我们熟悉的矩阵乘积 <span class="math inline">\(\mathbf{X} \boldsymbol{\beta}\)</span> 与<span class="math inline">\(\mathbf{Y}\)</span>值链接起来：</p>
<p><span class="math display">\[
\textrm{E}(\mathbf{Y}) = g^{-1}( \mathbf{X} \boldsymbol{\beta} )
\]</span></p>
<p>在R中，使用<code>glm()</code>函数来拟合GLMs，并使用与<code>lm()</code>函数类似的形式来进行计算。其它的参数还包括<code>family</code>，它用于指定<span class="math inline">\(\mathbf{Y}\)</span>的分布假设。在<a href="https://www.statmethods.net/advstats/glm.html" target="_blank" rel="external">QuickR</a>网站上，我们可以看到很多GLM的使用案例。</p>
<h3 id="混合效应线性模型mixed-effects-linear-models">混合效应线性模型(Mixed effects linear models)</h3>
<p>在标准线性模型里，我们假设矩阵<span class="math inline">\(\mathbf{X}\)</span>是固定的(fixed)，并不随机。例如，我们检测了每对腿的摩擦系数，以及push和pull方向。在<span class="math inline">\(\mathbf{X}\)</span>矩阵中，如果在特定的列中含有1，那么这1列就不是随机的，而是由设计矩阵决定的。但是在父子高度的案例中，我们并没有固定父亲身高的数值，而是观察到了这些值（通过一些误差来对抽样数据进行检测）。用于研究<span class="math inline">\(\mathbf{X}\)</span>中各个列的随机性影响的框架被称为混合效应模型，这就意味着一些效应是固定的，一些是效应是随机的。R中用于拟合线性模型的一个包是<code>lme4</code>，这个包还发了相应的论文《 Fitting Linear Mixed-Effects Models using lme4》。</p>
<h3 id="贝叶斯线性模型bayesian-linear-models">贝叶斯线性模型(Bayesian linear models)</h3>
<p>这种方法呈现的是假设<span class="math inline">\(\beta\)</span>是一个固定参数（非随机）。我们提取了估计此参数的方法，以及估计过程中如何量化这些参数不确定性的标准误差。这种方法是就所谓的频率论方法(frequentist)。另一种方法是假设<span class="math inline">\(\beta\)</span>是随机的，它的分布可以对我们先前关于<span class="math inline">\(\beta\)</span>应该是什么进行量化。一旦我们观察到数据，那么我们通过计算给定数据的<span class="math inline">\(\beta\)</span>条件分布（称为后验分布,posterior)，我们就就更新我们先前的信息，这种方法称贝叶斯方法。例如，一旦我们计算了<span class="math inline">\(\beta\)</span>的后验分布，我们就可以计算出某事件最容易发生的一个区间（可信区间）。此外，许多模型可以连接在一起，也就是所谓的分层模型(hierarchical mode)。在后面的内容里，我们会介绍贝叶斯统计和层次模型。贝叶斯分层模型的一本很好的书是<a href="http://www.stat.columbia.edu/~gelman/book/" target="_blank" rel="external">《Bayesian Data Analysis》</a>，在CRAN里，也有计算贝叶斯线性模型的包。其它的一些计算贝叶斯模型的软件是stan和BUGS。</p>
<h3 id="惩罚线性模型penalized-linear-models">惩罚线性模型(Penalized linear models)</h3>
<p>如果我们在模型中包含足够的参数，我们就可以实现残差平方和为0。惩罚纯情模型引入了一个惩罚项到最小化的最小二乘方程里。这些惩罚项通常是<span class="math inline">\(\lambda \sum_{j=1}^p \|\beta_j\|^k\)</span>这个形式，它们对大的绝对值以及大量的参数进行惩罚。添加这个额外的参数的目的就是避免过拟合。如果要使用这些模型，我们需要选择使用哪种模式来决定我们的惩罚程度。当<span class="math inline">\(k=2\)</span>时，这种模型称为岭回归(ridge regression)，Tikhonov正则化(regularization)L2正则化。当<span class="math inline">\(k=1\)</span>时，被称为LASSO或L1正则化。有关这些惩罚线性模型的一本书是《Elements of Statistical Learn》（网上有免费的电子版）。与这些模型有关的R函数包括<code>MASS</code>包里的<code>lm.ridge</code>函数，还有<code>lars</code>包，<code>glmnet</code>包。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-tags" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rvdsd.top/2019/08/14/DAL/DALS014_Linear_Models04ANOVA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="RVDSD">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RVDSD的个人笔记本">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/14/DAL/DALS014_Linear_Models04ANOVA/" itemprop="url">DALS014-Linear Models线性模型04方差分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-14T12:00:00+08:00">
                2019-08-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Data-Analysis-for-the-life-sciences/" itemprop="url" rel="index">
                    <span itemprop="name">Data Analysis for the life sciences</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2,532
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  11
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言">前言</h2>
<p>这一部分是《Data Analysis for the life sciences》的第5章线性模型的第4小节，这一部分的主要内容涉及ANOVA，有关方差分析的笔记R markdown文档可以参考作者的<a href="https://github.com/genomicsclass/labs/blob/master/linear/interactions_and_contrasts.Rmd" target="_blank" rel="external">Github</a>。</p>
<h2 id="anova简介">ANOVA简介</h2>
<p>现在考虑一种情况，如果我们想知道push与pull的差值在整体上，不同的组中是否有区别。换句话讲，我们并不想比较任意两组有差异，我们就想知道，在所有的有腿中，代表了push和pull差值的3个交互作用导致的push和pull差异是否比正常的差异大（即不考虑交互作用的情况）。</p>
<p>通过方差分析(analysis of variance，ANOVA)就可以解决这个问题。ANOVA的本质在于比较不同复杂模型的残差平方和是被哪些因素降低的（我的理解就是，总的残差平方和都是分布在哪些变量上面，哪些变量分到的最多，哪些变量的效应就最强）。含有8个系数的模型比含有5个系数的模型要复杂的多，在5个系数的模型中，我们是假设push和pull在所有组之间的差异是相等的。最简单的模型只使用一个系数，一个截矩。在某些假设下，我们还可以执行推断，确定与我们观察到的一样大的改进概率(Under certain assumptions we can also perform inference that determines the probability of improvements as large as what we observed)。</p>
<p>下面的ANOVA计算的结果（接前文案例）：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&gt; anova(fitX)</div><div class="line">Analysis of Variance Table</div><div class="line"></div><div class="line">Response: friction</div><div class="line">           Df Sum Sq Mean Sq  <span class="literal">F</span> value    Pr(&gt;<span class="literal">F</span>)    </div><div class="line">type        <span class="number">1</span> <span class="number">42.783</span>  <span class="number">42.783</span> <span class="number">1179.713</span> &lt; <span class="number">2.2e-16</span> ***</div><div class="line">leg         <span class="number">3</span>  <span class="number">2.921</span>   <span class="number">0.974</span>   <span class="number">26.847</span> <span class="number">2.972e-15</span> ***</div><div class="line">type:leg    <span class="number">3</span>  <span class="number">2.098</span>   <span class="number">0.699</span>   <span class="number">19.282</span> <span class="number">2.256e-11</span> ***</div><div class="line">Residuals <span class="number">274</span>  <span class="number">9.937</span>   <span class="number">0.036</span>                       </div><div class="line">---</div><div class="line">Signif. codes:  <span class="number">0</span> ‘***’ <span class="number">0.001</span> ‘**’ <span class="number">0.01</span> ‘*’ <span class="number">0.05</span> ‘.’ <span class="number">0.1</span> ‘ ’ <span class="number">1</span></div></pre></td></tr></table></figure>
<p>结果的第一行中有一个<code>type</code>变量（表示pull或push），它对应的Sum值为42.783，这就表示，这一单一的系数减少了42.783的平方和。我们看一下总的平方和，其实就是线性模型的截矩，也可以是<code>anova(fitX)</code>的第2列的和，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">result &lt;- anova(fitX)</div><div class="line">sum(result$`Sum Sq`)</div><div class="line">mu0 &lt;- mean(spider$friction)</div><div class="line">(initial.ss &lt;- sum((spider$friction - mu0)^<span class="number">2</span>))</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&gt; result &lt;- anova(fitX)</div><div class="line">&gt; sum(result$`Sum Sq`)</div><div class="line">[<span class="number">1</span>] <span class="number">57.73858</span></div><div class="line">&gt; mu0 &lt;- mean(spider$friction)</div><div class="line">&gt; (initial.ss &lt;- sum((spider$friction - mu0)^<span class="number">2</span>))</div><div class="line">[<span class="number">1</span>] <span class="number">57.73858</span></div></pre></td></tr></table></figure>
<p>需要注意是的是，这个平方和的计算公式最初就是来源于样本方差的计算公式，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">N &lt;- nrow(spider)</div><div class="line">(N - <span class="number">1</span>) * var(spider$friction)</div></pre></td></tr></table></figure>
<p>计算结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt; N &lt;- nrow(spider)</div><div class="line">&gt; (N - <span class="number">1</span>) * var(spider$friction)</div><div class="line">[<span class="number">1</span>] <span class="number">57.73858</span></div></pre></td></tr></table></figure>
<p>现在来看一下，前面的42.783是如何得到的。我们需要计算仅包含类型信息模型的残差平方和。我们可以通过计算残差，残差的平方，并将它们加起来就能实现，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">s &lt;- split(spider$friction, spider$type)</div><div class="line">after.type.ss &lt;- sum( sapply(s, <span class="keyword">function</span>(x) &#123;</div><div class="line">residual &lt;- x - mean(x)</div><div class="line">sum(residual^<span class="number">2</span>)</div><div class="line">&#125;) )</div><div class="line">(type.ss &lt;- initial.ss - after.type.ss)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&gt; s &lt;- split(spider$friction, spider$type)</div><div class="line">&gt; after.type.ss &lt;- sum( sapply(s, <span class="keyword">function</span>(x) &#123;</div><div class="line">+   residual &lt;- x - mean(x)</div><div class="line">+   sum(residual^<span class="number">2</span>)</div><div class="line">+ &#125;) )</div><div class="line">&gt; (type.ss &lt;- initial.ss - after.type.ss)</div><div class="line">[<span class="number">1</span>] <span class="number">42.78307</span></div></pre></td></tr></table></figure>
<p>这个降低的程度(就是上面的42.78307)就相当于模型<code>~type</code>和<code>~1</code>拟合值差值的平方和，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sum(sapply(s, length) * (sapply(s, mean) - mu0)^<span class="number">2</span>)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; sum(sapply(s, length) * (sapply(s, mean) - mu0)^<span class="number">2</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">42.78307</span></div></pre></td></tr></table></figure>
<p>线性模型中的各个项的顺序以及ANOVA表格中的顺序很重要：每行表示的是：当添加了一个新的系数后，残差平方和较未添加这个系数之前减少的量。</p>
<p>在ANOVA表（这个表其实就是ANOAVA计算后的结果）还标明了自由度。当引入了<code>type</code>这一项时，它对应的<code>Df</code>就是1，<code>leg</code>变量引入了3个项（即legL2，legL3和legL4），它对应的<code>Df</code>就是3（这一段不太理解）。ANOVA还有一列是<code>F value</code>。F值表示的是包含感兴趣的项（感兴趣的项平方和除以相应自由度）除以残差（ANOVA表中的最后一行除以自自由度），以第一行为例 说明一下就是<code>(42.783/1)/(9.937/274)=1179.686</code>。</p>
<p>书中给出的公式为：</p>
<p><span class="math display">\[
r_i = Y_i - \hat{Y}_i
\]</span> <span class="math display">\[
\mbox{Mean Sq Residuals} = \frac{1}{N - p} \sum_{i=1}^N r_i^2
\]</span></p>
<p>其中<code>p</code>表示模型中系数的总数（在这个模型中，包括截矩在内的系数总数是8）。</p>
<p>在零假设成立的前提下（零假设就是添加系数的真值为0），我们会得到每行F值分布的理论结果。这种近似所需的假设类似于t分布近似的假设，例如我们在使用CLT时需要大量的样本，或者是总体的数据服从正态分布。</p>
<p>现在我们来解释一下p值，看最后一行，即<code>type:leg</code>，内容是<code>type:leg    3  2.098   0.699   19.282 2.256e-11 ***</code>，<code>type:leg</code>表示的是3个交互作用系数。在零假设下，这3个附加项的真实值为0，例如，<span class="math inline">\(\beta_{push,L2}=0\)</span>，<span class="math inline">\(\beta_{push,L3}=0\)</span>，<span class="math inline">\(\beta_{push,L4}=0\)</span>，然后我们就计算出ANOVA表的这一行观察到的这么大的F值的概率。这里需要记住，我们只关注大的F值，因为我们有一个平方和的比，因此F值只能是正数（原文：Remember that we are only concerned with large values here, because we have a ratio of sum of squares, the F-value can only be positive. ）。<code>type:leg</code>这一行中的p值可以这么解释：在零假设下，我们认为push和pull的差值在所有组之间是没有差异的，p值表示了，在这个零假设成立时，我们观察到的如此大的方差的可能性。从计算结果中我们可以看到，我们的p值非常小，我们就可以拒绝零假设，即可以认为，push和pull的差值在不同组之间是不同的。</p>
<p>另外，ANOVA中的F值与F分布有关，F分布有2个以参数，一个是分子的自由度（分子是研究对象的自由度，例如前面提到的交互作用），一个是分母的自由度（残差）。从结果可以看到，交互作用系数的自由度是3，残差的自由度是274。</p>
<h2 id="anova模型的另外表示">ANOVA模型的另外表示</h2>
<p>现在来看一下ANOVA模型的另外表示方法，在这种方式里，我们假设每一对type与leg都有自己的均值（这样，对于每一条腿来说，push与pull的效应就不会相同）。这种表述方式在某种程度上来说更加简单，但是，我们不能像前面那样构建ANOVA表，因为这种方式无法区分交互作用系数。</p>
<p>首先我们会先构建一个因子变量，这个因子变量表示的是<code>type</code>与<code>leg</code>的组合，在公式中含有<code>~0</code>，它表示，我们不在线性模型中包含截矩，其中我们通过<code>rafalib</code>包中的<code>imagemat()</code>函数绘制了组变量的矩阵示意图，这个示意图也有8项，它针对每一个type和leg组合进行了拟合，代码如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">##earlier, we defined the 'group' column:</span></div><div class="line">spider$group &lt;- factor(paste0(spider$leg, spider$type))</div><div class="line">X &lt;- model.matrix(~ <span class="number">0</span> + group, data=spider)</div><div class="line">colnames(X)</div><div class="line">head(X)</div><div class="line"><span class="keyword">library</span>(rafalib)</div><div class="line">imagemat(X, main=<span class="string">"Model matrix for linear model with group variable"</span>)</div><div class="line">fitG &lt;- lm(friction ~ <span class="number">0</span> + group, data=spider)</div><div class="line">summary(fitG)</div><div class="line">coefs &lt;- coef(fitG)</div><div class="line">coefs</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">&gt; colnames(X)</div><div class="line">[<span class="number">1</span>] <span class="string">"groupL1pull"</span> <span class="string">"groupL1push"</span> <span class="string">"groupL2pull"</span> <span class="string">"groupL2push"</span> <span class="string">"groupL3pull"</span></div><div class="line">[<span class="number">6</span>] <span class="string">"groupL3push"</span> <span class="string">"groupL4pull"</span> <span class="string">"groupL4push"</span></div><div class="line">&gt; head(X)</div><div class="line">  groupL1pull groupL1push groupL2pull groupL2push groupL3pull groupL3push</div><div class="line"><span class="number">1</span>           <span class="number">1</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span></div><div class="line"><span class="number">2</span>           <span class="number">1</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span></div><div class="line"><span class="number">3</span>           <span class="number">1</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span></div><div class="line"><span class="number">4</span>           <span class="number">1</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span></div><div class="line"><span class="number">5</span>           <span class="number">1</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span></div><div class="line"><span class="number">6</span>           <span class="number">1</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span></div><div class="line">  groupL4pull groupL4push</div><div class="line"><span class="number">1</span>           <span class="number">0</span>           <span class="number">0</span></div><div class="line"><span class="number">2</span>           <span class="number">0</span>           <span class="number">0</span></div><div class="line"><span class="number">3</span>           <span class="number">0</span>           <span class="number">0</span></div><div class="line"><span class="number">4</span>           <span class="number">0</span>           <span class="number">0</span></div><div class="line"><span class="number">5</span>           <span class="number">0</span>           <span class="number">0</span></div><div class="line"><span class="number">6</span>           <span class="number">0</span>           <span class="number">0</span></div><div class="line">&gt; <span class="keyword">library</span>(rafalib)</div><div class="line">&gt; imagemat(X, main=<span class="string">"Model matrix for linear model with group variable"</span>)</div><div class="line">&gt; fitG &lt;- lm(friction ~ <span class="number">0</span> + group, data=spider)</div><div class="line">&gt; summary(fitG)</div><div class="line"></div><div class="line">Call:</div><div class="line">lm(formula = friction ~ <span class="number">0</span> + group, data = spider)</div><div class="line"></div><div class="line">Residuals:</div><div class="line">     Min       1Q   Median       3Q      Max </div><div class="line">-<span class="number">0.46385</span> -<span class="number">0.10735</span> -<span class="number">0.01111</span>  <span class="number">0.07848</span>  <span class="number">0.76853</span> </div><div class="line"></div><div class="line">Coefficients:</div><div class="line">            Estimate Std. Error t value Pr(&gt;|t|)    </div><div class="line">groupL1pull  <span class="number">0.92147</span>    <span class="number">0.03266</span>   <span class="number">28.21</span>   &lt;<span class="number">2e-16</span> ***</div><div class="line">groupL1push  <span class="number">0.40735</span>    <span class="number">0.03266</span>   <span class="number">12.47</span>   &lt;<span class="number">2e-16</span> ***</div><div class="line">groupL2pull  <span class="number">1.14533</span>    <span class="number">0.04917</span>   <span class="number">23.29</span>   &lt;<span class="number">2e-16</span> ***</div><div class="line">groupL2push  <span class="number">0.52733</span>    <span class="number">0.04917</span>   <span class="number">10.72</span>   &lt;<span class="number">2e-16</span> ***</div><div class="line">groupL3pull  <span class="number">1.27385</span>    <span class="number">0.02641</span>   <span class="number">48.24</span>   &lt;<span class="number">2e-16</span> ***</div><div class="line">groupL3push  <span class="number">0.37596</span>    <span class="number">0.02641</span>   <span class="number">14.24</span>   &lt;<span class="number">2e-16</span> ***</div><div class="line">groupL4pull  <span class="number">1.40075</span>    <span class="number">0.03011</span>   <span class="number">46.52</span>   &lt;<span class="number">2e-16</span> ***</div><div class="line">groupL4push  <span class="number">0.49075</span>    <span class="number">0.03011</span>   <span class="number">16.30</span>   &lt;<span class="number">2e-16</span> ***</div><div class="line">---</div><div class="line">Signif. codes:  <span class="number">0</span> ‘***’ <span class="number">0.001</span> ‘**’ <span class="number">0.01</span> ‘*’ <span class="number">0.05</span> ‘.’ <span class="number">0.1</span> ‘ ’ <span class="number">1</span></div><div class="line"></div><div class="line">Residual standard error: <span class="number">0.1904</span> on <span class="number">274</span> degrees of freedom</div><div class="line">Multiple R-squared:   <span class="number">0.96</span>,	Adjusted R-squared:  <span class="number">0.9588</span> </div><div class="line"><span class="literal">F</span>-statistic:   <span class="number">821</span> on <span class="number">8</span> and <span class="number">274</span> DF,  p-value: &lt; <span class="number">2.2e-16</span></div><div class="line"></div><div class="line">&gt; coefs &lt;- coef(fitG)</div><div class="line">&gt; coefs</div><div class="line">groupL1pull groupL1push groupL2pull groupL2push groupL3pull groupL3push groupL4pull </div><div class="line">  <span class="number">0.9214706</span>   <span class="number">0.4073529</span>   <span class="number">1.1453333</span>   <span class="number">0.5273333</span>   <span class="number">1.2738462</span>   <span class="number">0.3759615</span>   <span class="number">1.4007500</span> </div><div class="line">groupL4push </div><div class="line">  <span class="number">0.4907500</span></div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190824171912.jpeg">

</div>
<h2 id="计算估计系数">计算估计系数</h2>
<p>现在我们绘制出上面计算结果的示意图，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">stripchart(split(spider$friction, spider$group), </div><div class="line">           vertical=<span class="literal">TRUE</span>, pch=<span class="number">1</span>, method=<span class="string">"jitter"</span>, las=<span class="number">2</span>, xlim=c(<span class="number">0</span>,<span class="number">11</span>), ylim=c(<span class="number">0</span>,<span class="number">2</span>))</div><div class="line">cols &lt;- brewer.pal(<span class="number">8</span>,<span class="string">"Dark2"</span>)</div><div class="line">abline(h=<span class="number">0</span>)</div><div class="line"><span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1</span>:<span class="number">8</span>) &#123;</div><div class="line">  arrows(i+a,<span class="number">0</span>,i+a,coefs[i],lwd=<span class="number">3</span>,col=cols[i],length=lgth)</div><div class="line">&#125;</div><div class="line">legend(<span class="string">"right"</span>,names(coefs),fill=cols,cex=<span class="number">.75</span>,bg=<span class="string">"white"</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190824172337.jpeg">

</div>
<h2 id="使用contrast包进行简单比较">使用contrast包进行简单比较</h2>
<p>虽然无法使用这个公式来进行ANOVA分析，但是可以使用<code>contrast()</code>函数对每组的估计系数进行比较，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">groupL2push.vs.pull &lt;- contrast(fitG,</div><div class="line">                                list(group = <span class="string">"L2push"</span>),</div><div class="line">                                list(group = <span class="string">"L2pull"</span>))</div><div class="line">groupL2push.vs.pull</div><div class="line">coefs[<span class="number">4</span>] - coefs[<span class="number">3</span>]</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&gt; groupL2push.vs.pull</div><div class="line">lm model parameter contrast</div><div class="line"></div><div class="line">  Contrast      S.E.      Lower      Upper     t  df Pr(&gt;|t|)</div><div class="line"><span class="number">1</span>   -<span class="number">0.618</span> <span class="number">0.0695372</span> -<span class="number">0.7548951</span> -<span class="number">0.4811049</span> -<span class="number">8.89</span> <span class="number">274</span>        <span class="number">0</span></div><div class="line">&gt; coefs[<span class="number">4</span>] - coefs[<span class="number">3</span>]</div><div class="line">groupL2push </div><div class="line">     -<span class="number">0.618</span></div></pre></td></tr></table></figure>
<h2 id="无截矩时差值的差异">无截矩时差值的差异</h2>
<p>我们还可以进行push和pull在各级之间的两两(pair-wise)比较。例如，现在我们想比较L3与L2的push和pull的差值，如下所示：</p>
<p><span class="math display">\[
(\mbox{L3push} - \mbox{L3pull}) - (\mbox{L2push} - \mbox{L2pull})
\]</span> <span class="math display">\[
= \mbox{L3 push} + \mbox{L2pull} - \mbox{L3pull} - \mbox{L2push}
\]</span></p>
<p>其过程如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">C &lt;- matrix(c(<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,-<span class="number">1</span>,-<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>), <span class="number">1</span>)</div><div class="line">groupL3vsL2interaction &lt;- glht(fitG, linfct=C)</div><div class="line">summary(groupL3vsL2interaction)</div><div class="line">names(coefs)</div><div class="line">(coefs[<span class="number">6</span>] - coefs[<span class="number">5</span>]) - (coefs[<span class="number">4</span>] - coefs[<span class="number">3</span>])</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&gt; C &lt;- matrix(c(<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,-<span class="number">1</span>,-<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>), <span class="number">1</span>)</div><div class="line">&gt; groupL3vsL2interaction &lt;- glht(fitG, linfct=C)</div><div class="line">&gt; summary(groupL3vsL2interaction)</div><div class="line"></div><div class="line">	 Simultaneous Tests <span class="keyword">for</span> General Linear Hypotheses</div><div class="line"></div><div class="line">Fit: lm(formula = friction ~ <span class="number">0</span> + group, data = spider)</div><div class="line"></div><div class="line">Linear Hypotheses:</div><div class="line">       Estimate Std. Error t value Pr(&gt;|t|)    </div><div class="line"><span class="number">1</span> == <span class="number">0</span> -<span class="number">0.27988</span>    <span class="number">0.07893</span>  -<span class="number">3.546</span>  <span class="number">0.00046</span> ***</div><div class="line">---</div><div class="line">Signif. codes:  <span class="number">0</span> ‘***’ <span class="number">0.001</span> ‘**’ <span class="number">0.01</span> ‘*’ <span class="number">0.05</span> ‘.’ <span class="number">0.1</span> ‘ ’ <span class="number">1</span></div><div class="line">(Adjusted p values reported -- single-step method)</div><div class="line"></div><div class="line">&gt; names(coefs)</div><div class="line">[<span class="number">1</span>] <span class="string">"groupL1pull"</span> <span class="string">"groupL1push"</span> <span class="string">"groupL2pull"</span> <span class="string">"groupL2push"</span> <span class="string">"groupL3pull"</span></div><div class="line">[<span class="number">6</span>] <span class="string">"groupL3push"</span> <span class="string">"groupL4pull"</span> <span class="string">"groupL4push"</span></div><div class="line">&gt; (coefs[<span class="number">6</span>] - coefs[<span class="number">5</span>]) - (coefs[<span class="number">4</span>] - coefs[<span class="number">3</span>])</div><div class="line">groupL3push </div><div class="line"> -<span class="number">0.2798846</span></div></pre></td></tr></table></figure>
<h2 id="练习">练习</h2>
<p>P230</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-tags" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rvdsd.top/2019/08/13/DAL/DALS013_Linear_Models03ContrastInteraction/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="RVDSD">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RVDSD的个人笔记本">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/13/DAL/DALS013_Linear_Models03ContrastInteraction/" itemprop="url">DALS013-Linear Models线性模型03比较(contrast)与交互项</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-13T12:00:00+08:00">
                2019-08-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Data-Analysis-for-the-life-sciences/" itemprop="url" rel="index">
                    <span itemprop="name">Data Analysis for the life sciences</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  6,412
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  30
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言">前言</h2>
<p>这一部分是《Data Analysis for the life sciences》的第5章线性模型的第3小节。这一部分的主要内容涉及线性回归的比较与交互项。</p>
<h2 id="文献解读">文献解读</h2>
<p>我们会使用一篇文献中的数据集来学习复杂的线性模型，这个数据集包括了蜘蛛不同腿上的不同摩擦系数，具体地说就是，我们要研究腿部的推拉运动是否会产生不同强度的摩擦力。</p>
<p>文献信息如下所示：</p>
<blockquote>
<p>Jonas O. Wolff &amp; Stanislav N. Gorb, Radial arrangement of Janus-like setae permits friction control in spiders⁷³, Scientific Reports, 22 January 2013.</p>
</blockquote>
<p>通过这篇文献的摘要我们大致知道这篇文献的主要研究内容是，研究了一种游猎型蜘蛛Cupiennius Salei（蜘蛛目，蜘蛛科）在其远端腿上有毛状附着垫(爪状毛)，这个附着垫是由定向分枝的刚毛组成的。作者测量了爪状毛在光滑玻璃上的摩擦力，从而揭示了垫内刚毛排列的功能效应。</p>
<p>文献的Figure1如下所示：</p>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190823170434.jpg">

</div>
<p>Figure1一些有关蜘蛛爪状毛(claw tufts)的电镜照片，这些都是专业知识，我们不用管，我们主要的兴趣在Figure4上，如下所示：</p>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190823170634.jpg">

</div>
<p>Figure4比较了拉(pulling)与推(pushing)这两个动作 ，也就是Figure3中的A图，如下所示：</p>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190823171338.png">

</div>
<h2 id="导入数据">导入数据</h2>
<p>作者已经在他的Github上分享的文献的原始实验数据，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">url &lt;- <span class="string">"https://raw.githubusercontent.com/genomicsclass/dagdata/master/inst/extd\</span></div><div class="line"><span class="string">ata/spider_wolff_gorb_2013.csv"</span></div><div class="line">filename &lt;- <span class="string">"spider_wolff_gorb_2013.csv"</span></div><div class="line"><span class="keyword">library</span>(downloader)</div><div class="line"><span class="keyword">if</span> (!file.exists(filename)) download(url, filename)</div><div class="line">spider &lt;- read.csv(filename, skip=<span class="number">1</span>)</div></pre></td></tr></table></figure>
<p>先来大概看一下数据，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&gt; table(spider$leg,spider$type)</div><div class="line">    </div><div class="line">     pull push</div><div class="line">  L1   <span class="number">34</span>   <span class="number">34</span></div><div class="line">  L2   <span class="number">15</span>   <span class="number">15</span></div><div class="line">  L3   <span class="number">52</span>   <span class="number">52</span></div><div class="line">  L4   <span class="number">40</span>   <span class="number">40</span></div></pre></td></tr></table></figure>
<p>其中L1~L4是蜘蛛身上不同的腿，现在我们画一个箱线图来看一下这些数据，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">boxplot(spider$friction ~ spider$type * spider$leg,</div><div class="line">col=c(<span class="string">"grey90"</span>,<span class="string">"grey40"</span>), las=<span class="number">2</span>,</div><div class="line">main=<span class="string">"Comparison of friction coefficients of different leg pairs"</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190823171743.jpeg">

</div>
<p>从这张图上我们可以直接看出2点信息：</p>
<ol style="list-style-type: decimal">
<li>拉(pulling)比推(pushing)产生的摩擦力更大；</li>
<li>后腿（也就是L4）产生的拉力(puling friction)最高。</li>
</ol>
<p>另外，如果仔细看箱线图的话，还会发现，不同组之间的平均值分布不同，这就是组内方差(within-group variance)。对于线性模型来说，有时候组内方差会成为一个问题，因为我们会假设每组的均值会在总体均值附近波动，也就是说误差<span class="math inline">\(\varepsilon_{i}\)</span> 的分布是相同的，也就是说，每组的方差是相同的。如果忽视不同的组的不同方差，那么一些方差比较小的组就会显示过于“保守”（因为方差的总体估计会大于这些组的估计），并且具有较大方差的那些之间的比较置信度会过高。如果这些异常分布与摩擦力的范围有关，那么摩擦力值较大的数据造成的影响也大，因此可以采用log或sqrt转换来对数据进行预处理。</p>
<p>如果不进行数据转换（例如log转换或sqrt转换），那么我们也可以使用其他的统计检验，例如Welch t检验或Satterthwaite approximation（这两种都是t检验的扩展，可以在方差不齐的时候使用），或Wilcoxon秩和检验。但是，在这里，我们为了说明一些问题，我们会采用一个线性模型，这个模型假定不同组的方差相同。</p>
<h2 id="单变量线性模型">单变量线性模型</h2>
<p>先看简单的案例，也就是先研究一个变量，即我们现在只研究L1腿，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">head(spider)</div><div class="line">spider.sub &lt;- spider[spider$leg == <span class="string">"L1"</span>,]</div><div class="line">head(spider.sub)</div><div class="line">fit &lt;- lm(friction ~ type, data=spider.sub)</div><div class="line">summary(fit)</div><div class="line">(coefs &lt;- coef(fit))</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"> head(spider)</div><div class="line">  leg type friction</div><div class="line"><span class="number">1</span>  L1 pull     <span class="number">0.90</span></div><div class="line"><span class="number">2</span>  L1 pull     <span class="number">0.91</span></div><div class="line"><span class="number">3</span>  L1 pull     <span class="number">0.86</span></div><div class="line"><span class="number">4</span>  L1 pull     <span class="number">0.85</span></div><div class="line"><span class="number">5</span>  L1 pull     <span class="number">0.80</span></div><div class="line"><span class="number">6</span>  L1 pull     <span class="number">0.87</span></div><div class="line">&gt; spider.sub &lt;- spider[spider$leg == <span class="string">"L1"</span>,]</div><div class="line">&gt; head(spider.sub)</div><div class="line">  leg type friction</div><div class="line"><span class="number">1</span>  L1 pull     <span class="number">0.90</span></div><div class="line"><span class="number">2</span>  L1 pull     <span class="number">0.91</span></div><div class="line"><span class="number">3</span>  L1 pull     <span class="number">0.86</span></div><div class="line"><span class="number">4</span>  L1 pull     <span class="number">0.85</span></div><div class="line"><span class="number">5</span>  L1 pull     <span class="number">0.80</span></div><div class="line"><span class="number">6</span>  L1 pull     <span class="number">0.87</span></div><div class="line">&gt; fit &lt;- lm(friction ~ type, data=spider.sub)</div><div class="line">&gt; summary(fit)</div><div class="line"></div><div class="line">Call:</div><div class="line">lm(formula = friction ~ type, data = spider.sub)</div><div class="line"></div><div class="line">Residuals:</div><div class="line">     Min       1Q   Median       3Q      Max </div><div class="line">-<span class="number">0.33147</span> -<span class="number">0.10735</span> -<span class="number">0.04941</span> -<span class="number">0.00147</span>  <span class="number">0.76853</span> </div><div class="line"></div><div class="line">Coefficients:</div><div class="line">            Estimate Std. Error t value Pr(&gt;|t|)</div><div class="line">(Intercept)  <span class="number">0.92147</span>    <span class="number">0.03827</span>  <span class="number">24.078</span>  &lt; <span class="number">2e-16</span></div><div class="line">typepush    -<span class="number">0.51412</span>    <span class="number">0.05412</span>  -<span class="number">9.499</span>  <span class="number">5.7e-14</span></div><div class="line">               </div><div class="line">(Intercept) ***</div><div class="line">typepush    ***</div><div class="line">---</div><div class="line">Signif. codes:  </div><div class="line"><span class="number">0</span> ‘***’ <span class="number">0.001</span> ‘**’ <span class="number">0.01</span> ‘*’ <span class="number">0.05</span> ‘.’ <span class="number">0.1</span> ‘ ’ <span class="number">1</span></div><div class="line"></div><div class="line">Residual standard error: <span class="number">0.2232</span> on <span class="number">66</span> degrees of freedom</div><div class="line">Multiple R-squared:  <span class="number">0.5776</span>,	Adjusted R-squared:  <span class="number">0.5711</span> </div><div class="line"><span class="literal">F</span>-statistic: <span class="number">90.23</span> on <span class="number">1</span> and <span class="number">66</span> DF,  p-value: <span class="number">5.698e-14</span></div><div class="line">&gt; (coefs &lt;- coef(fit))</div><div class="line">(Intercept)    typepush </div><div class="line">  <span class="number">0.9214706</span>  -<span class="number">0.5141176</span></div></pre></td></tr></table></figure>
<p>从上面的结果可以看出，L1这一组（L1这一组中有push，有pull）的均值为0.9214706，拉(pull)与推(push)摩擦力的差值是-0.5141176 ，现在我们在R中再计算一下，看是否相符，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">s &lt;- split(spider.sub$friction, spider.sub$type)</div><div class="line">mean(s[[<span class="string">"pull"</span>]])</div><div class="line">mean(s[[<span class="string">"push"</span>]]) - mean(s[[<span class="string">"pull"</span>]])</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt; s &lt;- split(spider.sub$friction, spider.sub$type)</div><div class="line">&gt; mean(s[[<span class="string">"pull"</span>]])</div><div class="line">[<span class="number">1</span>] <span class="number">0.9214706</span></div><div class="line">&gt; mean(s[[<span class="string">"push"</span>]]) - mean(s[[<span class="string">"pull"</span>]])</div><div class="line">[<span class="number">1</span>] -<span class="number">0.5141176</span></div></pre></td></tr></table></figure>
<p>上面的是常规方法，我们也可以通过设计矩阵来进行计算，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">X &lt;- model.matrix(~ type, data=spider.sub)</div><div class="line">colnames(X)</div><div class="line">head(X)</div><div class="line">tail(X)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&gt; X &lt;- model.matrix(~ type, data=spider.sub)</div><div class="line">&gt; colnames(X)</div><div class="line">[<span class="number">1</span>] <span class="string">"(Intercept)"</span> <span class="string">"typepush"</span>   </div><div class="line">&gt; head(X)</div><div class="line">  (Intercept) typepush</div><div class="line"><span class="number">1</span>           <span class="number">1</span>        <span class="number">0</span></div><div class="line"><span class="number">2</span>           <span class="number">1</span>        <span class="number">0</span></div><div class="line"><span class="number">3</span>           <span class="number">1</span>        <span class="number">0</span></div><div class="line"><span class="number">4</span>           <span class="number">1</span>        <span class="number">0</span></div><div class="line"><span class="number">5</span>           <span class="number">1</span>        <span class="number">0</span></div><div class="line"><span class="number">6</span>           <span class="number">1</span>        <span class="number">0</span></div><div class="line">&gt; tail(X)</div><div class="line">   (Intercept) typepush</div><div class="line"><span class="number">63</span>           <span class="number">1</span>        <span class="number">1</span></div><div class="line"><span class="number">64</span>           <span class="number">1</span>        <span class="number">1</span></div><div class="line"><span class="number">65</span>           <span class="number">1</span>        <span class="number">1</span></div><div class="line"><span class="number">66</span>           <span class="number">1</span>        <span class="number">1</span></div><div class="line"><span class="number">67</span>           <span class="number">1</span>        <span class="number">1</span></div><div class="line"><span class="number">68</span>           <span class="number">1</span>        <span class="number">1</span></div></pre></td></tr></table></figure>
<p>现在我们来绘制一个 <span class="math inline">\(\mathbf{X}\)</span> 矩阵的示意图，其中，黑块表示1，白块表示0，这种方法对于我们理解线性模型比较有用。在这个图形中，y轴表示样本数目（也就是数据的行数），x轴是设计矩阵<span class="math inline">\(\mathbf{X}\)</span>的列。我们使用<code>rafalib</code>包中的<code>imagemat()</code>函数即可，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(rafalib)</div><div class="line">imagemat(X, main=<span class="string">"Model matrix for linear model with one variable"</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190823175538.jpeg">

</div>
<h3 id="计算估计系数examining-the-estimated-coefficients">计算估计系数(examining the estimated coefficients)</h3>
<p>下图是由线性模型计算而来的估计系数：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">set.seed(<span class="number">1</span>) <span class="comment">#same jitter in stripchart</span></div><div class="line">stripchart(split(spider.sub$friction, spider.sub$type), </div><div class="line">           vertical=<span class="literal">TRUE</span>, pch=<span class="number">1</span>, method=<span class="string">"jitter"</span>, las=<span class="number">2</span>, xlim=c(<span class="number">0</span>,<span class="number">3</span>), ylim=c(<span class="number">0</span>,<span class="number">2</span>))</div><div class="line">a &lt;- -<span class="number">0.25</span></div><div class="line">lgth &lt;- <span class="number">.1</span></div><div class="line"><span class="keyword">library</span>(RColorBrewer)</div><div class="line">cols &lt;- brewer.pal(<span class="number">3</span>,<span class="string">"Dark2"</span>)</div><div class="line">abline(h=<span class="number">0</span>)</div><div class="line">arrows(<span class="number">1</span>+a,<span class="number">0</span>,<span class="number">1</span>+a,coefs[<span class="number">1</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">1</span>],length=lgth)</div><div class="line">abline(h=coefs[<span class="number">1</span>],col=cols[<span class="number">1</span>])</div><div class="line">arrows(<span class="number">2</span>+a,coefs[<span class="number">1</span>],<span class="number">2</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">2</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">2</span>],length=lgth)</div><div class="line">abline(h=coefs[<span class="number">1</span>]+coefs[<span class="number">2</span>],col=cols[<span class="number">2</span>])</div><div class="line">legend(<span class="string">"right"</span>,names(coefs),fill=cols,cex=<span class="number">.75</span>,bg=<span class="string">"white"</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190823191147.jpeg">

</div>
<p>其中，绿色箭头表示截矩(Intercept)，其范围是从0到参考组均值的距离(这里的参考组是pull)。橘黄色的箭头表示push组与pull组的差值，在上面图形中，箭头向下，表示负值。小圆圈表示的是每个数据，其中为了避免相同数据的重叠，就在水平上进行了一定程度的波动。</p>
<h2 id="双变量线性模型">双变量线性模型</h2>
<p>再进一步，现在我们研究整个数据集。为了研究不同的腿（L1，L2，L3和L4）的push和pull的差异，我们需要构建一个双变量R公式(R formula)，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">X &lt;- model.matrix(~ type + leg, data=spider)</div><div class="line">colnames(X)</div><div class="line">head(X)</div><div class="line">imagemat(X, main=<span class="string">"Model matrix for linear model with two factors"</span>)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&gt; X &lt;- model.matrix(~ type + leg, data=spider)</div><div class="line">&gt; colnames(X)</div><div class="line">[<span class="number">1</span>] <span class="string">"(Intercept)"</span> <span class="string">"typepush"</span>    <span class="string">"legL2"</span>       <span class="string">"legL3"</span>       <span class="string">"legL4"</span>      </div><div class="line">&gt; head(X)</div><div class="line">  (Intercept) typepush legL2 legL3 legL4</div><div class="line"><span class="number">1</span>           <span class="number">1</span>        <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></div><div class="line"><span class="number">2</span>           <span class="number">1</span>        <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></div><div class="line"><span class="number">3</span>           <span class="number">1</span>        <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></div><div class="line"><span class="number">4</span>           <span class="number">1</span>        <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></div><div class="line"><span class="number">5</span>           <span class="number">1</span>        <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></div><div class="line"><span class="number">6</span>           <span class="number">1</span>        <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190823180943.jpeg">

</div>
<p>上面的黑白图是对公式<code>type+leg</code>的简单表示。</p>
<p>从计算结果，以及黑白示意图上我们可以知道：</p>
<p>第1列是截矩(intercept)，所有值都是1；</p>
<p>第2列：含有1的是push，从示意图上可以看出来，1是黑色，连续的黑色方块一共是4块，因此一共是4组；</p>
<p>第3列：含有1的是L2；</p>
<p>第4列：含有1的是L3；</p>
<p>第5列：含有1的是L4。</p>
<p>这里没有提到L1是因为L1是leg变量的参考水平。同样的，里面也没有提到pull，因为pull是type变量的参考水平。</p>
<p>如果要计算出相应的系数，需要使用<code>lm()</code>函数，公式为<code>~ type + leg</code>，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">fitTL &lt;- lm(friction ~ type + leg, data=spider)</div><div class="line">summary(fitTL)</div><div class="line">(coefs &lt;- coef(fitTL))</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">&gt; fitTL &lt;- lm(friction ~ type + leg, data=spider)</div><div class="line">&gt; summary(fitTL)</div><div class="line"></div><div class="line">Call:</div><div class="line">lm(formula = friction ~ type + leg, data = spider)</div><div class="line"></div><div class="line">Residuals:</div><div class="line">     Min       1Q   Median       3Q      Max </div><div class="line">-<span class="number">0.46392</span> -<span class="number">0.13441</span> -<span class="number">0.00525</span>  <span class="number">0.10547</span>  <span class="number">0.69509</span> </div><div class="line"></div><div class="line">Coefficients:</div><div class="line">            Estimate Std. Error t value Pr(&gt;|t|)    </div><div class="line">(Intercept)  <span class="number">1.05392</span>    <span class="number">0.02816</span>  <span class="number">37.426</span>  &lt; <span class="number">2e-16</span> ***</div><div class="line">typepush    -<span class="number">0.77901</span>    <span class="number">0.02482</span> -<span class="number">31.380</span>  &lt; <span class="number">2e-16</span> ***</div><div class="line">legL2        <span class="number">0.17192</span>    <span class="number">0.04569</span>   <span class="number">3.763</span> <span class="number">0.000205</span> ***</div><div class="line">legL3        <span class="number">0.16049</span>    <span class="number">0.03251</span>   <span class="number">4.937</span> <span class="number">1.37e-06</span> ***</div><div class="line">legL4        <span class="number">0.28134</span>    <span class="number">0.03438</span>   <span class="number">8.183</span> <span class="number">1.01e-14</span> ***</div><div class="line">---</div><div class="line">Signif. codes:  <span class="number">0</span> ‘***’ <span class="number">0.001</span> ‘**’ <span class="number">0.01</span> ‘*’ <span class="number">0.05</span> ‘.’ <span class="number">0.1</span> ‘ ’ <span class="number">1</span></div><div class="line"></div><div class="line">Residual standard error: <span class="number">0.2084</span> on <span class="number">277</span> degrees of freedom</div><div class="line">Multiple R-squared:  <span class="number">0.7916</span>,	Adjusted R-squared:  <span class="number">0.7886</span> </div><div class="line"><span class="literal">F</span>-statistic:   <span class="number">263</span> on <span class="number">4</span> and <span class="number">277</span> DF,  p-value: &lt; <span class="number">2.2e-16</span></div><div class="line">&gt; (coefs &lt;- coef(fitTL))</div><div class="line">(Intercept)    typepush       legL2       legL3       legL4 </div><div class="line">  <span class="number">1.0539153</span>  -<span class="number">0.7790071</span>   <span class="number">0.1719216</span>   <span class="number">0.1604921</span>   <span class="number">0.2813382</span></div></pre></td></tr></table></figure>
<p>R的计算结果中，在<code>coefficient</code>这一部分中含有最小方差估计值。</p>
<h2 id="数学表达式">数学表达式</h2>
<p>我们拟合的线性模型可以使用下面的式子表示： <span class="math display">\[
Y_i = \beta_0 + \beta_1 x_{i,1} + \beta_2 x_{i,2} + \beta_3 x_{i,3} + \beta_4 x_{i,4} + \varepsilon_i, i=1,\dots,N
\]</span> 其中，<span class="math inline">\(x\)</span>表示所有的指示变量(indicator variables)，在这个案例中指提是不同腿的push与pull。例如对于第3条腿的push来说，就是<span class="math inline">\(x_{i,1}\)</span>与<span class="math inline">\(x_{i,3}\)</span>等于1，剩下的等于0。<span class="math inline">\(\beta\)</span>指的是它们表示的效应大小。例如<span class="math inline">\(\beta_{0}\)</span>表示截矩，而<span class="math inline">\(\beta_{1}\)</span>表示pull效应(pull effect)，而<span class="math inline">\(\beta_{2}\)</span>一表示L2效应等。上面计算结果里没有直接表明系数，即<span class="math inline">\(\beta_{1}\)</span>，但是标明了估计值，例如<span class="math inline">\(\hat{\beta_{4}}\)</span>。</p>
<p>我们还可以使用矩阵来计算最小二乘估计，如下所示：</p>
<p><span class="math display">\[
\hat{\boldsymbol{\beta}} = (\mathbf{X}^\top \mathbf{X})^{-1} \mathbf{X}^\top \mathbf{Y}
\]</span> 如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Y &lt;- spider$friction</div><div class="line">X &lt;- model.matrix(~ type + leg, data=spider)</div><div class="line">beta.hat &lt;- solve(t(X) %*% X) %*% t(X) %*% Y</div><div class="line">t(beta.hat)</div><div class="line">coefs</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&gt; t(beta.hat)</div><div class="line">     (Intercept)   typepush     legL2     legL3     legL4</div><div class="line">[<span class="number">1</span>,]    <span class="number">1.053915</span> -<span class="number">0.7790071</span> <span class="number">0.1719216</span> <span class="number">0.1604921</span> <span class="number">0.2813382</span></div><div class="line">&gt; coefs</div><div class="line">(Intercept)    typepush       legL2       legL3       legL4 </div><div class="line">  <span class="number">1.0539153</span>  -<span class="number">0.7790071</span>   <span class="number">0.1719216</span>   <span class="number">0.1604921</span>   <span class="number">0.2813382</span></div></pre></td></tr></table></figure>
<p>从上面的结果可以看出来，这个与<code>lm()</code>计算出来的结果一样。</p>
<h3 id="计算估计值系数">计算估计值系数</h3>
<p>现在绘制出上述结果的示意图，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">spider$group &lt;- factor(paste0(spider$leg, spider$type))</div><div class="line">stripchart(split(spider$friction, spider$group), </div><div class="line">           vertical=<span class="literal">TRUE</span>, pch=<span class="number">1</span>, method=<span class="string">"jitter"</span>, las=<span class="number">2</span>, xlim=c(<span class="number">0</span>,<span class="number">11</span>), ylim=c(<span class="number">0</span>,<span class="number">2</span>))</div><div class="line">cols &lt;- brewer.pal(<span class="number">5</span>,<span class="string">"Dark2"</span>)</div><div class="line">abline(h=<span class="number">0</span>)</div><div class="line">arrows(<span class="number">1</span>+a,<span class="number">0</span>,<span class="number">1</span>+a,coefs[<span class="number">1</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">1</span>],length=lgth)</div><div class="line">abline(h=coefs[<span class="number">1</span>],col=cols[<span class="number">1</span>])</div><div class="line">arrows(<span class="number">3</span>+a,coefs[<span class="number">1</span>],<span class="number">3</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">3</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">3</span>],length=lgth)</div><div class="line">arrows(<span class="number">5</span>+a,coefs[<span class="number">1</span>],<span class="number">5</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">4</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">4</span>],length=lgth)</div><div class="line">arrows(<span class="number">7</span>+a,coefs[<span class="number">1</span>],<span class="number">7</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">5</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">5</span>],length=lgth)</div><div class="line">arrows(<span class="number">2</span>+a,coefs[<span class="number">1</span>],<span class="number">2</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">2</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">2</span>],length=lgth)</div><div class="line">segments(<span class="number">3</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">3</span>],<span class="number">4</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">3</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">3</span>])</div><div class="line">arrows(<span class="number">4</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">3</span>],<span class="number">4</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">3</span>]+coefs[<span class="number">2</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">2</span>],length=lgth)</div><div class="line">segments(<span class="number">5</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">4</span>],<span class="number">6</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">4</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">4</span>])</div><div class="line">arrows(<span class="number">6</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">4</span>],<span class="number">6</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">4</span>]+coefs[<span class="number">2</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">2</span>],length=lgth)</div><div class="line">segments(<span class="number">7</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">5</span>],<span class="number">8</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">5</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">5</span>])</div><div class="line">arrows(<span class="number">8</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">5</span>],<span class="number">8</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">5</span>]+coefs[<span class="number">2</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">2</span>],length=lgth)</div><div class="line">legend(<span class="string">"right"</span>,names(coefs),fill=cols,cex=<span class="number">.75</span>,bg=<span class="string">"white"</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190823191256.jpeg">

</div>
<p>上图是线性模型的估计值示意图。其中茶绿色(teal-green)箭头表示截矩(intercept)，它拟合的是参考组，这里指的是L1的pull。紫色(purple)、粉色(pink)，黄绿色(yello-green)表示提其它组与L1的差值。黄色箭头(orange arrow)表示是push和push的差值。</p>
<p>在这个案例中，每组拟合的均值是由拟合的系数推导出来的， 它与我们简单地从8组中计算的均值不太一致。原因是，我们的模型使用了5个系数，而不是8个。我们假设效应是可加的(additive)。但是我们在下文中还会考虑更多的因素来进行拟合，例如考虑这个数据集中的交互因素。</p>
<p>现在看一下简单地计算平均值与线性模型推导出来的平均值，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">s &lt;- split(spider$friction, spider$group)</div><div class="line">mean(s[[<span class="string">"L1pull"</span>]])</div><div class="line">coefs[<span class="number">1</span>]</div><div class="line">mean(s[[<span class="string">"L1push"</span>]])</div><div class="line">coefs[<span class="number">1</span>] + coefs[<span class="number">2</span>]</div></pre></td></tr></table></figure>
<p>计算结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&gt; s &lt;- split(spider$friction, spider$group)</div><div class="line">&gt; mean(s[[<span class="string">"L1pull"</span>]])</div><div class="line">[<span class="number">1</span>] <span class="number">0.9214706</span></div><div class="line">&gt; coefs[<span class="number">1</span>]</div><div class="line">(Intercept) </div><div class="line">   <span class="number">1.053915</span> </div><div class="line">&gt; mean(s[[<span class="string">"L1push"</span>]])</div><div class="line">[<span class="number">1</span>] <span class="number">0.4073529</span></div><div class="line">&gt; coefs[<span class="number">1</span>] + coefs[<span class="number">2</span>]</div><div class="line">(Intercept) </div><div class="line">  <span class="number">0.2749082</span></div></pre></td></tr></table></figure>
<p>上面的计算过程是比较push与pull的估计值，其中<code>coefs[2]</code>是每组均值差异的加权平均值。此外，权重(weight)是由每组的样本数量决定的。这里计算的过程非常简单，因为每组的样本数目(pull与push)都相等。如果样本数目不等（例如push和pull不等），那么权重的计算就比较复杂，但是，每组的样本数目，总的样本数目以及系数的数目都会计算出相应唯一的权重。这可能通过<span class="math inline">\((\mathbf{X}^\top \mathbf{X})^{-1} \mathbf{X}^\top\)</span>计算得到，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">means &lt;- sapply(s, mean)</div><div class="line">##the sample size of push or pull groups for each leg pair</div><div class="line">ns &lt;- sapply(s, length)[c(1,3,5,7)]</div><div class="line">(w &lt;- ns/sum(ns))</div><div class="line">sum(w * (means[c(2,4,6,8)] - means[c(1,3,5,7)]))</div><div class="line">coefs[2]</div><div class="line">sum(w * (means[c(2,4,6,8)] - means[c(1,3,5,7)]))</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&gt; (w &lt;- ns/sum(ns))</div><div class="line">   L1pull    L2pull    L3pull    L4pull </div><div class="line"><span class="number">0.2411348</span> <span class="number">0.1063830</span> <span class="number">0.3687943</span> <span class="number">0.2836879</span> </div><div class="line">&gt; sum(w * (means[c(<span class="number">2</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">8</span>)] - means[c(<span class="number">1</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">7</span>)]))</div><div class="line">[<span class="number">1</span>] -<span class="number">0.7790071</span></div><div class="line">&gt; coefs[<span class="number">2</span>]</div><div class="line">  typepush </div><div class="line">-<span class="number">0.7790071</span> </div><div class="line">&gt; sum(w * (means[c(<span class="number">2</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">8</span>)] - means[c(<span class="number">1</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">7</span>)]))</div><div class="line">[<span class="number">1</span>] -<span class="number">0.7790071</span></div></pre></td></tr></table></figure>
<h2 id="比较系数contrasting-coefficients">比较系数(Contrasting coefficients)</h2>
<p>有的时候，我们可能对模型中单个系数表示的比较结果感兴趣，例如push与pull的差值，也就是上面的<code>coefs[2]</code>。但是，有的时候，由单一的系数无法得到想要的比较结果，但是联合使用几个系数可以进行比较，这就是比较系数(contrast)。为了引入<code>contrast</code>的概念，我们先来看一下<code>coefs</code>这个变量，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt; coefs</div><div class="line">(Intercept)    typepush       legL2       legL3       legL4 </div><div class="line">  <span class="number">1.0539153</span>  -<span class="number">0.7790071</span>   <span class="number">0.1719216</span>   <span class="number">0.1604921</span>   <span class="number">0.2813382</span></div></pre></td></tr></table></figure>
<p>这个结果包含截矩的估计值，push与pull的估计效应，L2与L1效应的估计值，L3与L1效应估计值，L4与L1效应的估计值。假设我们想要比较两组数的效应大小，并且其中一组不是L1怎么办？这个解决过程就叫比较(<code>contrast</code>)。</p>
<p>比较(contrast)是对估计效应(estimated coefficient)的联合过计算，即<span class="math inline">\(\mathbf{c^\top} \hat{\boldsymbol{\beta}}\)</span>，其中<span class="math inline">\(\mathbf{c}\)</span>是一个列向量，其行数与线性模型系数的数目相同。如果<span class="math inline">\(\mathbf{c}\)</span>中含有1个或多个0，那就表示相应的<span class="math inline">\(\hat{\beta}\)</span>中的估计系数就不参与相应的比较系数(contrast)计算。</p>
<p>如果我们想比较L2和L3，它就相当于在线性模型中比较这两个系数，因为它们都是与L1进行比较的，如下所示：</p>
<p><span class="math display">\[
(\mbox{L3} - \mbox{L1}) - (\mbox{L2} - \mbox{L1}) = \mbox{L3} - \mbox{L2 }
\]</span> 对这两种进行比较的一个简单途径就是使用<code>constrast</code>包中的<code>contrast()</code>函数。我们只需要指定要比较的两组名称即可，现在我们来比较一下pull或push类型，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(contrast) <span class="comment">#Available from CRAN</span></div><div class="line">L3vsL2 &lt;- contrast(fitTL,list(leg=<span class="string">"L3"</span>,type=<span class="string">"pull"</span>),list(leg=<span class="string">"L2"</span>,type=<span class="string">"pull"</span>))</div><div class="line">L3vsL2</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt; L3vsL2</div><div class="line">lm model parameter contrast</div><div class="line"></div><div class="line">    Contrast       S.E.      Lower      Upper     t  df Pr(&gt;|t|)</div><div class="line"> -<span class="number">0.01142949</span> <span class="number">0.04319685</span> -<span class="number">0.0964653</span> <span class="number">0.07360632</span> -<span class="number">0.26</span> <span class="number">277</span>   <span class="number">0.7915</span></div></pre></td></tr></table></figure>
<p>第1列是<code>Contrast</code>，它表示的是L3与L2的估计值。</p>
<p>我们可以证明，系数的线性组合的最小二乘估计是这些估计的相同线性组合。因此，效应大小估计值(effect size estimate)就是两者之间的差值。使用<code>contrast()</code>函数进行比较的比较向量，被储备成为一个称为<code>X</code>变量中，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">coefs[<span class="number">4</span>] - coefs[<span class="number">3</span>]</div><div class="line">(cT &lt;- L3vsL2$X)</div><div class="line">cT %*% coefs</div></pre></td></tr></table></figure>
<p>计算结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&gt; coefs[<span class="number">4</span>] - coefs[<span class="number">3</span>]</div><div class="line">      legL3 </div><div class="line">-<span class="number">0.01142949</span> </div><div class="line">&gt; (cT &lt;- L3vsL2$X)</div><div class="line">  (Intercept) typepush legL2 legL3 legL4</div><div class="line"><span class="number">1</span>           <span class="number">0</span>        <span class="number">0</span>    -<span class="number">1</span>     <span class="number">1</span>     <span class="number">0</span></div><div class="line">attr(,<span class="string">"assign"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span></div><div class="line">attr(,<span class="string">"contrasts"</span>)</div><div class="line">attr(,<span class="string">"contrasts"</span>)$type</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div><div class="line"></div><div class="line">attr(,<span class="string">"contrasts"</span>)$leg</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div><div class="line"></div><div class="line">&gt; cT %*% coefs</div><div class="line">         [,<span class="number">1</span>]</div><div class="line"><span class="number">1</span> -<span class="number">0.01142949</span></div></pre></td></tr></table></figure>
<p>计算结果里面还有t检验与标准误，我们以前提到过，t检验是一个估计值，它的除数就标准误。比较估计值的标准误是由比较向量<span class="math inline">\(\mathbf{c}\)</span>乘以估计的协方差矩阵<span class="math inline">\(\hat{\Sigma}\)</span>的任意一边得到的，我们对var<span class="math inline">\(\hat{\beta}\)</span>的估计值如下所示： <span class="math display">\[
\sqrt{\mathbf{c^\top} \hat{\boldsymbol{\Sigma}} \mathbf{c}}
\]</span></p>
<p>系数的协方差为： <span class="math display">\[
\boldsymbol{\Sigma} = \sigma^2 (\mathbf{X}^\top \mathbf{X})^{-1}
\]</span> 我们使用样本估计值<span class="math inline">\(\hat{\sigma}^2\)</span>来估计<span class="math inline">\({\sigma}^2\)</span>，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Sigma.hat &lt;- sum(fitTL$residuals^<span class="number">2</span>)/(nrow(X) - ncol(X)) * solve(t(X) %*% X)</div><div class="line">signif(Sigma.hat, <span class="number">2</span>)</div><div class="line">sqrt(cT %*% Sigma.hat %*% t(cT))</div><div class="line">L3vsL2$SE</div></pre></td></tr></table></figure>
<p>计算结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&gt; Sigma.hat &lt;- sum(fitTL$residuals^<span class="number">2</span>)/(nrow(X) - ncol(X)) * solve(t(X) %*% X)</div><div class="line">&gt; signif(Sigma.hat, <span class="number">2</span>)</div><div class="line">            (Intercept) typepush    legL2    legL3    legL4</div><div class="line">(Intercept)     <span class="number">0.00079</span> -<span class="number">3.1e-04</span> -<span class="number">0.00064</span> -<span class="number">0.00064</span> -<span class="number">0.00064</span></div><div class="line">typepush       -<span class="number">0.00031</span>  <span class="number">6.2e-04</span>  <span class="number">0.00000</span>  <span class="number">0.00000</span>  <span class="number">0.00000</span></div><div class="line">legL2          -<span class="number">0.00064</span> -<span class="number">6.4e-20</span>  <span class="number">0.00210</span>  <span class="number">0.00064</span>  <span class="number">0.00064</span></div><div class="line">legL3          -<span class="number">0.00064</span> -<span class="number">6.4e-20</span>  <span class="number">0.00064</span>  <span class="number">0.00110</span>  <span class="number">0.00064</span></div><div class="line">legL4          -<span class="number">0.00064</span> -<span class="number">1.2e-19</span>  <span class="number">0.00064</span>  <span class="number">0.00064</span>  <span class="number">0.00120</span></div><div class="line">&gt; sqrt(cT %*% Sigma.hat %*% t(cT))</div><div class="line">           <span class="number">1</span></div><div class="line"><span class="number">1</span> <span class="number">0.04319685</span></div><div class="line">&gt; L3vsL2$SE</div><div class="line">[<span class="number">1</span>] <span class="number">0.04319685</span></div></pre></td></tr></table></figure>
<p>如果我们选择参数<code>type=&quot;push&quot;</code>，那么我们就会获得与L3和L2比较的一样的结果。其原因就是，在差值的两侧都添加了<code>typepush</code>效应（这一句不太理解）我们可以取消它，如下所示： <figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">L3vsL2.equiv &lt;- contrast(fitTL,list(leg=<span class="string">"L3"</span>,type=<span class="string">"push"</span>),list(leg=<span class="string">"L2"</span>,type=<span class="string">"push"</span>))</div><div class="line">L3vsL2.equiv$X</div></pre></td></tr></table></figure></p>
<p>运行结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&gt; L3vsL2.equiv &lt;- contrast(fitTL,list(leg=<span class="string">"L3"</span>,type=<span class="string">"push"</span>),list(leg=<span class="string">"L2"</span>,type=<span class="string">"push"</span>))</div><div class="line">&gt; L3vsL2.equiv$X</div><div class="line">  (Intercept) typepush legL2 legL3 legL4</div><div class="line"><span class="number">1</span>           <span class="number">0</span>        <span class="number">0</span>    -<span class="number">1</span>     <span class="number">1</span>     <span class="number">0</span></div><div class="line">attr(,<span class="string">"assign"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span></div><div class="line">attr(,<span class="string">"contrasts"</span>)</div><div class="line">attr(,<span class="string">"contrasts"</span>)$type</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div><div class="line"></div><div class="line">attr(,<span class="string">"contrasts"</span>)$leg</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div></pre></td></tr></table></figure>
<p>##交互项(<code>interaction terms</code>)</p>
<p>在前面的线性模型案例中，我们假设pull与push的效应对于所有的腿(leg)都是相同的（也就是说橘黄色的箭头是一样的），但是从我们最终计算的结果来看，并不能很好的捕获数据的趋势，换句话讲，就是简单与每组的平均值并不完全一致。例如L1组，push与pull估计系数太大，而L3组，push与pull又太小。</p>
<p>此时，我们引入交互项(interaction terms)，这个引入的系数可以解决不同组中push与pull差值过大的问题。由于我们在模型中已经有了push与pull项，因此我们只需要再添加三个项就能够找到leg-piar特异性push和pull的差异。在下面我们会向模型的设计矩阵中添加交互项(interaction terms)，其方法是将代表现有项的设计矩阵列相乘。</p>
<p>我们可以在<code>type</code>和<code>leg</code>之间构建一个交互项，即<code>type:leg</code>，其中的冒号<code>:</code>表示两个变量存在交互作用，另外一种相同的做法就是<code>~type*leg</code>，这两种写法都是主要研究<code>type</code>与<code>leg</code>之间的交互作用，而不研究其他变量之间的交互作用，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">url &lt;- <span class="string">"https://raw.githubusercontent.com/genomicsclass/dagdata/master/inst/extd\</span></div><div class="line"><span class="string">ata/spider_wolff_gorb_2013.csv"</span></div><div class="line">filename &lt;- <span class="string">"spider_wolff_gorb_2013.csv"</span></div><div class="line"><span class="keyword">library</span>(downloader)</div><div class="line"><span class="keyword">if</span> (!file.exists(filename)) download(url, filename)</div><div class="line">spider &lt;- read.csv(filename, skip=<span class="number">1</span>)</div><div class="line">X &lt;- model.matrix(~ type + leg + type:leg, data=spider)</div><div class="line">colnames(X)</div><div class="line">X &lt;- model.matrix(~type*leg, data=spider)</div><div class="line">colnames(X)</div><div class="line">head(X)</div><div class="line"><span class="keyword">library</span>(rafalib)</div><div class="line">imagemat(X, main=<span class="string">"Model matrix for linear model with interactions"</span>)</div></pre></td></tr></table></figure>
<p>计算结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&gt; X &lt;- model.matrix(~ type + leg + type:leg, data=spider)</div><div class="line">&gt; colnames(X)</div><div class="line">[<span class="number">1</span>] <span class="string">"(Intercept)"</span>    <span class="string">"typepush"</span>       <span class="string">"legL2"</span>          <span class="string">"legL3"</span>         </div><div class="line">[<span class="number">5</span>] <span class="string">"legL4"</span>          <span class="string">"typepush:legL2"</span> <span class="string">"typepush:legL3"</span> <span class="string">"typepush:legL4"</span></div><div class="line">&gt; X &lt;- model.matrix(~type*leg, data=spider)</div><div class="line">&gt; colnames(X)</div><div class="line">[<span class="number">1</span>] <span class="string">"(Intercept)"</span>    <span class="string">"typepush"</span>       <span class="string">"legL2"</span>          <span class="string">"legL3"</span>         </div><div class="line">[<span class="number">5</span>] <span class="string">"legL4"</span>          <span class="string">"typepush:legL2"</span> <span class="string">"typepush:legL3"</span> <span class="string">"typepush:legL4"</span></div><div class="line">&gt; head(X)</div><div class="line">  (Intercept) typepush legL2 legL3 legL4 typepush:legL2 typepush:legL3</div><div class="line"><span class="number">1</span>           <span class="number">1</span>        <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>              <span class="number">0</span>              <span class="number">0</span></div><div class="line"><span class="number">2</span>           <span class="number">1</span>        <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>              <span class="number">0</span>              <span class="number">0</span></div><div class="line"><span class="number">3</span>           <span class="number">1</span>        <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>              <span class="number">0</span>              <span class="number">0</span></div><div class="line"><span class="number">4</span>           <span class="number">1</span>        <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>              <span class="number">0</span>              <span class="number">0</span></div><div class="line"><span class="number">5</span>           <span class="number">1</span>        <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>              <span class="number">0</span>              <span class="number">0</span></div><div class="line"><span class="number">6</span>           <span class="number">1</span>        <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>              <span class="number">0</span>              <span class="number">0</span></div><div class="line">  typepush:legL4</div><div class="line"><span class="number">1</span>              <span class="number">0</span></div><div class="line"><span class="number">2</span>              <span class="number">0</span></div><div class="line"><span class="number">3</span>              <span class="number">0</span></div><div class="line"><span class="number">4</span>              <span class="number">0</span></div><div class="line"><span class="number">5</span>              <span class="number">0</span></div><div class="line"><span class="number">6</span>              <span class="number">0</span></div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190823225213.jpeg">

</div>
<p>其中，第6到8列表示的是：<code>typepush:legL2</code>，<code>typepush:legL3</code>与<code>typepush:legL4</code>，也就是说，它们是由第2列的<code>typepush</code>和第3到5列的<code>legL2</code>，<code>legL3</code>和<code>legL4</code>产生的。我们看最后1列，即<code>typepush:legL4</code>列，这是另外的一个系数，即<span class="math inline">\(\beta_{push,L4}\)</span>，此系数表示push与L4共同作用的样本。这就可能对L4-push这一组样本的均值的差异进行解释，例如当我们通过估计的截距、估计的typepush系数，估计的L4系数LegL4来对数据进行预测时产生偏差（例如数据点不在估计的直线上），当我们考虑了交互作用后，其结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">fitX &lt;- lm(friction ~ type + leg + type:leg, data=spider)</div><div class="line">summary(fitX)</div><div class="line">coefs &lt;- coef(fitX)</div><div class="line">coefs</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">&gt; fitX &lt;- lm(friction ~ type + leg + type:leg, data=spider)</div><div class="line">&gt; summary(fitX)</div><div class="line"></div><div class="line">Call:</div><div class="line">lm(formula = friction ~ type + leg + type:leg, data = spider)</div><div class="line"></div><div class="line">Residuals:</div><div class="line">     Min       1Q   Median       3Q      Max </div><div class="line">-<span class="number">0.46385</span> -<span class="number">0.10735</span> -<span class="number">0.01111</span>  <span class="number">0.07848</span>  <span class="number">0.76853</span> </div><div class="line"></div><div class="line">Coefficients:</div><div class="line">               Estimate Std. Error t value Pr(&gt;|t|)    </div><div class="line">(Intercept)     <span class="number">0.92147</span>    <span class="number">0.03266</span>  <span class="number">28.215</span>  &lt; <span class="number">2e-16</span> ***</div><div class="line">typepush       -<span class="number">0.51412</span>    <span class="number">0.04619</span> -<span class="number">11.131</span>  &lt; <span class="number">2e-16</span> ***</div><div class="line">legL2           <span class="number">0.22386</span>    <span class="number">0.05903</span>   <span class="number">3.792</span> <span class="number">0.000184</span> ***</div><div class="line">legL3           <span class="number">0.35238</span>    <span class="number">0.04200</span>   <span class="number">8.390</span> <span class="number">2.62e-15</span> ***</div><div class="line">legL4           <span class="number">0.47928</span>    <span class="number">0.04442</span>  <span class="number">10.789</span>  &lt; <span class="number">2e-16</span> ***</div><div class="line">typepush:legL2 -<span class="number">0.10388</span>    <span class="number">0.08348</span>  -<span class="number">1.244</span> <span class="number">0.214409</span>    </div><div class="line">typepush:legL3 -<span class="number">0.38377</span>    <span class="number">0.05940</span>  -<span class="number">6.461</span> <span class="number">4.73e-10</span> ***</div><div class="line">typepush:legL4 -<span class="number">0.39588</span>    <span class="number">0.06282</span>  -<span class="number">6.302</span> <span class="number">1.17e-09</span> ***</div><div class="line">---</div><div class="line">Signif. codes:  <span class="number">0</span> ‘***’ <span class="number">0.001</span> ‘**’ <span class="number">0.01</span> ‘*’ <span class="number">0.05</span> ‘.’ <span class="number">0.1</span> ‘ ’ <span class="number">1</span></div><div class="line"></div><div class="line">Residual standard error: <span class="number">0.1904</span> on <span class="number">274</span> degrees of freedom</div><div class="line">Multiple R-squared:  <span class="number">0.8279</span>,	Adjusted R-squared:  <span class="number">0.8235</span> </div><div class="line"><span class="literal">F</span>-statistic: <span class="number">188.3</span> on <span class="number">7</span> and <span class="number">274</span> DF,  p-value: &lt; <span class="number">2.2e-16</span></div><div class="line">&gt; coefs</div><div class="line">   (Intercept)       typepush          legL2          legL3          legL4 </div><div class="line">     <span class="number">0.9214706</span>     -<span class="number">0.5141176</span>      <span class="number">0.2238627</span>      <span class="number">0.3523756</span>      <span class="number">0.4792794</span> </div><div class="line">typepush:legL2 typepush:legL3 typepush:legL4 </div><div class="line">    -<span class="number">0.1038824</span>     -<span class="number">0.3837670</span>     -<span class="number">0.3958824</span></div></pre></td></tr></table></figure>
<h3 id="计算估计系数">计算估计系数</h3>
<p>现在我们先画一下上面的计算结果，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(RColorBrewer)</div><div class="line">spider$group &lt;- factor(paste0(spider$leg, spider$type))</div><div class="line">stripchart(split(spider$friction, spider$group), </div><div class="line">           vertical=<span class="literal">TRUE</span>, pch=<span class="number">1</span>, method=<span class="string">"jitter"</span>, las=<span class="number">2</span>, xlim=c(<span class="number">0</span>,<span class="number">11</span>), ylim=c(<span class="number">0</span>,<span class="number">2</span>))</div><div class="line">cols &lt;- brewer.pal(<span class="number">8</span>,<span class="string">"Dark2"</span>)</div><div class="line">abline(h=<span class="number">0</span>)</div><div class="line">arrows(<span class="number">1</span>+a,<span class="number">0</span>,<span class="number">1</span>+a,coefs[<span class="number">1</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">1</span>],length=lgth)</div><div class="line">abline(h=coefs[<span class="number">1</span>],col=cols[<span class="number">1</span>])</div><div class="line">arrows(<span class="number">2</span>+a,coefs[<span class="number">1</span>],<span class="number">2</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">2</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">2</span>],length=lgth)</div><div class="line">arrows(<span class="number">3</span>+a,coefs[<span class="number">1</span>],<span class="number">3</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">3</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">3</span>],length=lgth)</div><div class="line">arrows(<span class="number">5</span>+a,coefs[<span class="number">1</span>],<span class="number">5</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">4</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">4</span>],length=lgth)</div><div class="line">arrows(<span class="number">7</span>+a,coefs[<span class="number">1</span>],<span class="number">7</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">5</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">5</span>],length=lgth)</div><div class="line"><span class="comment">#now the interactions:</span></div><div class="line">segments(<span class="number">3</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">3</span>],<span class="number">4</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">3</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">3</span>])</div><div class="line">arrows(<span class="number">4</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">3</span>],<span class="number">4</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">3</span>]+coefs[<span class="number">2</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">2</span>],length=lgth)</div><div class="line">arrows(<span class="number">4</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">2</span>]+coefs[<span class="number">3</span>],<span class="number">4</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">2</span>]+coefs[<span class="number">3</span>]+coefs[<span class="number">6</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">6</span>],length=lgth)</div><div class="line">segments(<span class="number">5</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">4</span>],<span class="number">6</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">4</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">4</span>])</div><div class="line">arrows(<span class="number">6</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">4</span>],<span class="number">6</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">4</span>]+coefs[<span class="number">2</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">2</span>],length=lgth)</div><div class="line">arrows(<span class="number">6</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">4</span>]+coefs[<span class="number">2</span>],<span class="number">6</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">4</span>]+coefs[<span class="number">2</span>]+coefs[<span class="number">7</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">7</span>],length=lgth)</div><div class="line">segments(<span class="number">7</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">5</span>],<span class="number">8</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">5</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">5</span>])</div><div class="line">arrows(<span class="number">8</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">5</span>],<span class="number">8</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">5</span>]+coefs[<span class="number">2</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">2</span>],length=lgth)</div><div class="line">arrows(<span class="number">8</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">5</span>]+coefs[<span class="number">2</span>],<span class="number">8</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">5</span>]+coefs[<span class="number">2</span>]+coefs[<span class="number">8</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">8</span>],length=lgth)</div><div class="line">legend(<span class="string">"right"</span>,names(coefs),fill=cols,cex=<span class="number">.75</span>,bg=<span class="string">"white"</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190823232236.jpeg">

</div>
<p>估计的交互作用系数就能反映出在对push和pull进行比较时，leg-pair-specific导致的差值不同。上图的橘黄色简单表示的是与L1相比，push和pull的差值估计。如果估计的交互系数过大，那么push与pull差值的均值就与参考组相比（也就是L1组中push和pull差值的均值），非常不同。</p>
<p>### 比较(contrast)</p>
<p>在一些简单案例中，我们会使用<code>contrast</code>包来进行比较，混合计算估计系数。例如我们知道L2样本的push与pull效应。我们可以从上面箭图中看出来（也就是黄色箭头加上橘黄色简单），我们也可以在<code>contrast()</code>函数中指定要比较哪两组，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(contrast) <span class="comment">##Available from CRAN</span></div><div class="line">L2push.vs.pull &lt;- contrast(fitX,</div><div class="line">list(leg=<span class="string">"L2"</span>, type = <span class="string">"push"</span>),</div><div class="line">list(leg=<span class="string">"L2"</span>, type = <span class="string">"pull"</span>))</div><div class="line">L2push.vs.pull</div><div class="line">coefs[<span class="number">2</span>] + coefs[<span class="number">6</span>] <span class="comment">##we know this is also orange + yellow arrow</span></div></pre></td></tr></table></figure>
<p>计算结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&gt; L2push.vs.pull</div><div class="line">lm model parameter contrast</div><div class="line"></div><div class="line"> Contrast      S.E.      Lower      Upper     t  df Pr(&gt;|t|)</div><div class="line">   -<span class="number">0.618</span> <span class="number">0.0695372</span> -<span class="number">0.7548951</span> -<span class="number">0.4811049</span> -<span class="number">8.89</span> <span class="number">274</span>        <span class="number">0</span></div><div class="line">&gt; coefs[<span class="number">2</span>] + coefs[<span class="number">6</span>] <span class="comment">##we know this is also orange + yellow arrow</span></div><div class="line">typepush </div><div class="line">  -<span class="number">0.618</span></div></pre></td></tr></table></figure>
<h2 id="差值的差异differences-of-differences">差值的差异(Differences of differences)</h2>
<p>push与pull在L2中的差异和push与pull在L1中的差异是不同的，为什么会不同的，我们可以使用模型中的<code>typepush:legL2</code>估计系数，也就是上图中的黄色箭头。这个系数的p值是否等于0，可以从上面的<code>summary(fitX)</code>函数来查看。同样的，我们也可以看出来L3与L1中差值(push和pull的差值)的差异和L4与L1的差值。假设我们想知道push与pull在L3中的差异与L2中的差值是否相同。在上面的图形中，我们可以看到，除了L1之外的其他腿的push和pull效应就是typepush箭头加上该组的交互作用项。</p>
<p>如果我们想比较两个非参考组，那么数学公式如下所示： <span class="math display">\[
(\mbox{typepush} + \mbox{typepush:legL3}) - (\mbox{typepush} + \mbox{typepush:legL2})
\]</span> 可以简写为： <span class="math display">\[
= \mbox{typepush:legL3} - \mbox{typepush:legL2}
\]</span> 在这里我们无法使用<code>contrast()</code>函数直接比较，但是我们可以使用<code>glht()</code>函数进行比较（这个函数的全称是<code>general liner hypothesis test</code>)，这个函数在<code>multcomp</code>包中。为了使用<code>glht()</code>这个函数，我们需要构建一个矩阵，这个矩阵只有一行，其中<code>-1</code>表示<code>typepush:legL2</code>系数，其中<code>+1</code>表示<code>typepush:legL3</code>系数。我们将这个矩阵加入到<code>linfct()</code>函数中（这个函数是linear function的缩写），当成<code>linfct()</code>的参数，计算后，我们会获得一个有关估计交互系数比较的表，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(multcomp) <span class="comment">##Available from CRAN</span></div><div class="line">C &lt;- matrix(c(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,-<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>), <span class="number">1</span>)</div><div class="line">C</div><div class="line">L3vsL2interaction &lt;- glht(fitX, linfct=C)</div><div class="line">summary(L3vsL2interaction)</div></pre></td></tr></table></figure>
<p>计算结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&gt; C</div><div class="line">     [,<span class="number">1</span>] [,<span class="number">2</span>] [,<span class="number">3</span>] [,<span class="number">4</span>] [,<span class="number">5</span>] [,<span class="number">6</span>] [,<span class="number">7</span>] [,<span class="number">8</span>]</div><div class="line">[<span class="number">1</span>,]    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>   -<span class="number">1</span>    <span class="number">1</span>    <span class="number">0</span></div><div class="line">&gt; L3vsL2interaction &lt;- glht(fitX, linfct=C)</div><div class="line">&gt; summary(L3vsL2interaction)</div><div class="line"></div><div class="line">	 Simultaneous Tests <span class="keyword">for</span> General Linear Hypotheses</div><div class="line"></div><div class="line">Fit: lm(formula = friction ~ type + leg + type:leg, data = spider)</div><div class="line"></div><div class="line">Linear Hypotheses:</div><div class="line">       Estimate Std. Error t value Pr(&gt;|t|)    </div><div class="line"><span class="number">1</span> == <span class="number">0</span> -<span class="number">0.27988</span>    <span class="number">0.07893</span>  -<span class="number">3.546</span>  <span class="number">0.00046</span> ***</div><div class="line">---</div><div class="line">Signif. codes:  <span class="number">0</span> ‘***’ <span class="number">0.001</span> ‘**’ <span class="number">0.01</span> ‘*’ <span class="number">0.05</span> ‘.’ <span class="number">0.1</span> ‘ ’ <span class="number">1</span></div><div class="line">(Adjusted p values reported -- single-step method)</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-tags" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rvdsd.top/2019/08/12/DAL/DALS012_Linear_Models02MatrixMath/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="RVDSD">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RVDSD的个人笔记本">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/12/DAL/DALS012_Linear_Models02MatrixMath/" itemprop="url">DALS012-Linear Models线性模型02矩阵知识</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-12T12:00:00+08:00">
                2019-08-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Data-Analysis-for-the-life-sciences/" itemprop="url" rel="index">
                    <span itemprop="name">Data Analysis for the life sciences</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3,904
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  17
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言">前言</h2>
<p>这一部分是《Data Analysis for the life sciences》的第5章线性模型的第2小节。这一部分的主要内容涉及矩阵的数学计算原理。</p>
<p>先来看一下前面的一个案例。</p>
<h2 id="小鼠饲料案例">小鼠饲料案例</h2>
<p>在前面的内容中，我们使用了t检验来研究高脂饲料(hf)饲喂的小鼠与普通饲料(chow)饲喂的小鼠体重的差异，现在我们使用线性模型来研究一下这两种小鼠的体重是否有差异，最终我们会发现，这两种统计方法在本质上是一样的，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">dir &lt;- system.file(package = <span class="string">"dagdata"</span>)</div><div class="line">list.files(dir)</div><div class="line">dir</div><div class="line">filename &lt;- file.path(dir,<span class="string">"extdata/femaleMiceWeights.csv"</span>)</div><div class="line">dat &lt;- read.csv(filename)</div><div class="line"><span class="comment"># input raw data</span></div><div class="line">head(dat)</div><div class="line">str(dat)</div><div class="line">stripchart(dat$Bodyweight ~ dat$Diet, vertical=<span class="literal">TRUE</span>, method=<span class="string">"jitter"</span>,</div><div class="line">main=<span class="string">"Bodyweight over Diet"</span>)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&gt; head(dat)</div><div class="line">  Diet Bodyweight</div><div class="line"><span class="number">1</span> chow      <span class="number">21.51</span></div><div class="line"><span class="number">2</span> chow      <span class="number">28.14</span></div><div class="line"><span class="number">3</span> chow      <span class="number">24.04</span></div><div class="line"><span class="number">4</span> chow      <span class="number">23.45</span></div><div class="line"><span class="number">5</span> chow      <span class="number">23.68</span></div><div class="line"><span class="number">6</span> chow      <span class="number">19.79</span></div><div class="line">&gt; str(dat)</div><div class="line"><span class="string">'data.frame'</span>:	<span class="number">24</span> obs. of  <span class="number">2</span> variables:</div><div class="line"> $ Diet      : Factor w/ <span class="number">2</span> levels <span class="string">"chow"</span>,<span class="string">"hf"</span>: <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="keyword">...</span></div><div class="line"> $ Bodyweight: num  <span class="number">21.5</span> <span class="number">28.1</span> <span class="number">24</span> <span class="number">23.4</span> <span class="number">23.7</span> <span class="keyword">...</span></div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190817104902.jpeg">

</div>
<p>从这张图上我们大致可以看出来，hf组的小鼠体重比chow组的小鼠体重高一些。现在我们使用设计矩阵<span class="math inline">\(\mathbf{X}\)</span>（公式为<code>~Diet</code>）来计算一下这个结果，在设计矩阵中，第2列是分组信息，也就是饲料的类型，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">levels(dat$Diet)</div><div class="line">X &lt;- model.matrix(~ Diet, data=dat)</div><div class="line">X</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">&gt; X</div><div class="line">   (Intercept) Diethf</div><div class="line"><span class="number">1</span>            <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">2</span>            <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">3</span>            <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">4</span>            <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">5</span>            <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">6</span>            <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">7</span>            <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">8</span>            <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">9</span>            <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">10</span>           <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">11</span>           <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">12</span>           <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">13</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">14</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">15</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">16</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">17</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">18</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">19</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">20</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">21</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">22</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">23</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">24</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line">attr(,<span class="string">"assign"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0</span> <span class="number">1</span></div><div class="line">attr(,<span class="string">"contrasts"</span>)</div><div class="line">attr(,<span class="string">"contrasts"</span>)$Diet</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div></pre></td></tr></table></figure>
<h2 id="lm函数背后的数学原理"><code>lm()</code>函数背后的数学原理</h2>
<p>现在我们先不用<code>lm()</code>来进行计算，先用设计矩阵%<span class="math inline">\(来计算一下\)</span>$，这个值能够使线性模型的平方和最小，公式如下所示： <span class="math display">\[
\hat{\boldsymbol{\beta}} = (\mathbf{X}^\top \mathbf{X})^{-1} \mathbf{X}^\top \mathbf{Y}
\]</span> 在R中，可以使用矩阵相乘的符号<code>%*%</code>，以及<code>solve()</code>函数来求解上述方程，如下所示： <figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Y &lt;- dat$Bodyweight</div><div class="line">X &lt;- model.matrix(~ Diet, data=dat)</div><div class="line">solve(t(X) %*% X) %*% t(X) %*% Y</div></pre></td></tr></table></figure></p>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&gt; Y &lt;- dat$Bodyweight</div><div class="line">&gt; X &lt;- model.matrix(~ Diet, data=dat)</div><div class="line">&gt; solve(t(X) %*% X) %*% t(X) %*% Y</div><div class="line">                 [,<span class="number">1</span>]</div><div class="line">(Intercept) <span class="number">23.813333</span></div><div class="line">Diethf       <span class="number">3.020833</span></div></pre></td></tr></table></figure>
<p>这些系数是对照组的平均值（23.813333），以及两组的差值（3.020833），计算一下，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">s &lt;- split(dat$Bodyweight, dat$Diet)</div><div class="line">mean(s[[<span class="string">"chow"</span>]])</div><div class="line">mean(s[[<span class="string">"hf"</span>]]) - mean(s[[<span class="string">"chow"</span>]])</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt; s &lt;- split(dat$Bodyweight, dat$Diet)</div><div class="line">&gt; mean(s[[<span class="string">"chow"</span>]])</div><div class="line">[<span class="number">1</span>] <span class="number">23.81333</span></div><div class="line">&gt; mean(s[[<span class="string">"hf"</span>]]) - mean(s[[<span class="string">"chow"</span>]])</div><div class="line">[<span class="number">1</span>] <span class="number">3.020833</span></div></pre></td></tr></table></figure>
<p>现在我们使用<code>lm()</code>函数两周来计算一下，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">fit &lt;- lm(Bodyweight ~ Diet, data=dat)</div><div class="line">summary(fit)</div><div class="line">(coefs &lt;- coef(fit))</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&gt; summary(fit)</div><div class="line"></div><div class="line">Call:</div><div class="line">lm(formula = Bodyweight ~ Diet, data = dat)</div><div class="line"></div><div class="line">Residuals:</div><div class="line">    Min      1Q  Median      3Q     Max </div><div class="line">-<span class="number">6.1042</span> -<span class="number">2.4358</span> -<span class="number">0.4138</span>  <span class="number">2.8335</span>  <span class="number">7.1858</span> </div><div class="line"></div><div class="line">Coefficients:</div><div class="line">            Estimate Std. Error t value Pr(&gt;|t|)    </div><div class="line">(Intercept)   <span class="number">23.813</span>      <span class="number">1.039</span>  <span class="number">22.912</span>   &lt;<span class="number">2e-16</span> ***</div><div class="line">Diethf         <span class="number">3.021</span>      <span class="number">1.470</span>   <span class="number">2.055</span>   <span class="number">0.0519</span> .  </div><div class="line">---</div><div class="line">Signif. codes:  <span class="number">0</span> ‘***’ <span class="number">0.001</span> ‘**’ <span class="number">0.01</span> ‘*’ <span class="number">0.05</span> ‘.’ <span class="number">0.1</span> ‘ ’ <span class="number">1</span></div><div class="line"></div><div class="line">Residual standard error: <span class="number">3.6</span> on <span class="number">22</span> degrees of freedom</div><div class="line">Multiple R-squared:  <span class="number">0.1611</span>,	Adjusted R-squared:  <span class="number">0.1229</span> </div><div class="line"><span class="literal">F</span>-statistic: <span class="number">4.224</span> on <span class="number">1</span> and <span class="number">22</span> DF,  p-value: <span class="number">0.05192</span></div><div class="line">&gt; (coefs &lt;- coef(fit))</div><div class="line">(Intercept)      Diethf </div><div class="line">  <span class="number">23.813333</span>    <span class="number">3.020833</span></div></pre></td></tr></table></figure>
<h2 id="线性回归系数">线性回归系数</h2>
<p>下图说明了前面我们计算出来的2个系数，即对照组小鼠的平均体重，以及hf组的小鼠体重与对照组的差异，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">stripchart(dat$Bodyweight ~ dat$Diet, vertical=<span class="literal">TRUE</span>, method=<span class="string">"jitter"</span>,</div><div class="line">           main=<span class="string">"Bodyweight over Diet"</span>, ylim=c(<span class="number">0</span>,<span class="number">40</span>), xlim=c(<span class="number">0</span>,<span class="number">3</span>))</div><div class="line">a &lt;- -<span class="number">0.25</span></div><div class="line">lgth &lt;- <span class="number">.1</span></div><div class="line"><span class="keyword">library</span>(RColorBrewer)</div><div class="line">cols &lt;- brewer.pal(<span class="number">3</span>,<span class="string">"Dark2"</span>)</div><div class="line">abline(h=<span class="number">0</span>)</div><div class="line">arrows(<span class="number">1</span>+a,<span class="number">0</span>,<span class="number">1</span>+a,coefs[<span class="number">1</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">1</span>],length=lgth)</div><div class="line">abline(h=coefs[<span class="number">1</span>],col=cols[<span class="number">1</span>])</div><div class="line">arrows(<span class="number">2</span>+a,coefs[<span class="number">1</span>],<span class="number">2</span>+a,coefs[<span class="number">1</span>]+coefs[<span class="number">2</span>],lwd=<span class="number">3</span>,col=cols[<span class="number">2</span>],length=lgth)</div><div class="line">abline(h=coefs[<span class="number">1</span>]+coefs[<span class="number">2</span>],col=cols[<span class="number">2</span>])</div><div class="line">legend(<span class="string">"right"</span>,names(coefs),fill=cols,cex=<span class="number">.75</span>,bg=<span class="string">"white"</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190817114032.jpeg">

</div>
<p>在这里使用前面的小鼠案例主要是为了说明了回归与t检验在本质上是一样的，这个简单的线性回归模型给出了与特定类型t检验相同的结果（t统计量与p值）。这是两组之间的t检验，前提是两组的总体标准差相同。当我们假设误差<span class="math inline">\(\boldsymbol{\varepsilon}\)</span>都是均匀分布时，这些误差被编码到线性模型中。虽然在这种情况下的线性模相当于t检验，但我们可以对线性模型进行拓展，将其扩展到复杂的形式。在下面的内容中，我们将会说明线性模型能够得到几乎相同的结果：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt; summary(fit)$coefficients</div><div class="line">             Estimate Std. Error   t value     Pr(&gt;|t|)</div><div class="line">(Intercept) <span class="number">23.813333</span>   <span class="number">1.039353</span> <span class="number">22.911684</span> <span class="number">7.642256e-17</span></div><div class="line">Diethf       <span class="number">3.020833</span>   <span class="number">1.469867</span>  <span class="number">2.055174</span> <span class="number">5.192480e-02</span></div></pre></td></tr></table></figure>
<p>t检验的结果与之相同：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ttest &lt;- t.test(s[[<span class="string">"hf"</span>]], s[[<span class="string">"chow"</span>]], var.equal=<span class="literal">TRUE</span>)</div><div class="line">summary(fit)$coefficients[<span class="number">2</span>,<span class="number">3</span>]</div><div class="line">ttest$statistic</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt; summary(fit)$coefficients[<span class="number">2</span>,<span class="number">3</span>]</div><div class="line">[<span class="number">1</span>] <span class="number">2.055174</span></div><div class="line">&gt; ttest$statistic</div><div class="line">       t </div><div class="line"><span class="number">2.055174</span></div></pre></td></tr></table></figure>
<h2 id="练习">练习</h2>
<p>P189</p>
<h2 id="标准误">标准误</h2>
<p>使用矩阵代数来计算最小二乘估计时，所得到的估计值是取机变量。我们还能计算这些值的标准误。线性代数也能满足这些任务，先看一些案例。</p>
<h2 id="自由落体">自由落体</h2>
<p>在学习统计学的过程中，了解随机源于何处是有必要的。在自由落体这个案例中，当我们对落下来的球进行测量时，就会出现检测误差，这就是自由落体运行中随机的来源。假设我们做了好几次实验，每次实验我们都会得到一组测量误差。这就意味着，我们得到的数据基本是随机变化的，这反过来，也意味着，我们计算得到的估计值也是随机变化的。在这个案例中，每次我们进行实验时，引力常数的估计值也都在发生变化。引力常数是一个确定的值，但是我们对它的估计不是。为了说明这一步，我们可以使用Monte Carlo模拟一下。具体来说，我们将会重复地生成数据，并对每次的二次项(quadratic term)进行估计，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">set.seed(<span class="number">1</span>)</div><div class="line">B &lt;- <span class="number">10000</span></div><div class="line">h0 &lt;- <span class="number">56.67</span></div><div class="line">v0 &lt;- <span class="number">0</span></div><div class="line">g &lt;- <span class="number">9.8</span> <span class="comment">##meters per second</span></div><div class="line">n &lt;- <span class="number">25</span></div><div class="line">tt &lt;- seq(<span class="number">0</span>,<span class="number">3.4</span>,len=n) <span class="comment">##time in secs, t is a base function</span></div><div class="line">X &lt;-cbind(<span class="number">1</span>,tt,tt^<span class="number">2</span>)</div><div class="line"><span class="comment">##create X'X^-1 X'</span></div><div class="line">A &lt;- solve(crossprod(X)) %*% t(X)</div><div class="line">betahat&lt;-replicate(B,&#123;</div><div class="line">y &lt;- h0 + v0*tt - <span class="number">0.5</span>*g*tt^<span class="number">2</span> + rnorm(n,sd=<span class="number">1</span>)</div><div class="line">betahats &lt;- A%*%y</div><div class="line"><span class="keyword">return</span>(betahats[<span class="number">3</span>])</div><div class="line">&#125;)</div><div class="line">head(betahat)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; head(betahat)</div><div class="line">[<span class="number">1</span>] -<span class="number">5.038646</span> -<span class="number">4.894362</span> -<span class="number">5.143756</span> -<span class="number">5.220960</span> -<span class="number">5.063322</span> -<span class="number">4.777521</span></div></pre></td></tr></table></figure>
<p>从上面结果我们可以发现，每次的估计值都不一样，这是因为估计值<span class="math inline">\(\hat{\beta}\)</span>是一个随机变量，它其实是服从正态分布的，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(rafalib)</div><div class="line">mypar(<span class="number">1</span>,<span class="number">2</span>)</div><div class="line">hist(betahat)</div><div class="line">qqnorm(betahat)</div><div class="line">qqline(betahat)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190817124445.jpeg">

</div>
<p>上图显示的是，通过Monte Carlo模拟生成的自由落体运行数据对回归系数的估计值的分布。左侧是直方图，右侧是qq图。</p>
<p>由于<span class="math inline">\(\hat{\beta}\)</span>是我们生成的那些服从正态分布的数据的线性组合，因此从QQ图上我们也可以看出，<span class="math inline">\(\hat{\beta}\)</span>也服从正态分布。此外，这个分布的均值的真实参数0.5g，可以通过Monte Carlo模拟来所证实，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">round(mean(betahat),<span class="number">1</span>)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; round(mean(betahat),<span class="number">1</span>)</div><div class="line">[<span class="number">1</span>] -<span class="number">4.9</span></div></pre></td></tr></table></figure>
<p>但是，当我们对估计值进行计算时，无法得到精确的数值，这是因为我们估计值的标准误大约是：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; sd(betahat)</div><div class="line">[<span class="number">1</span>] <span class="number">0.2129976</span></div></pre></td></tr></table></figure>
<p>在接下来的案例中，我们将会演示一下，不通过Monte Carlo模拟来计算标准误的方法，因为在实际的分析中，我们无法精确地知道误差是如何产生的。</p>
<h2 id="父子身高">父子身高</h2>
<p>在父母身高的案例中，我们也遇到了随机问题，因为我们是对父子身高的总体进行随机抽样。为了说明这个问题，现在假设我们已经有了这个总体：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(UsingR)</div><div class="line">x &lt;- father.son$fheight</div><div class="line">y &lt;- father.son$sheight</div><div class="line">n &lt;- length(y)</div></pre></td></tr></table></figure>
<p>现在我们使用Monte Carlo模拟来生成一个含有50个数据的样本，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">N &lt;- <span class="number">50</span></div><div class="line">B &lt;-<span class="number">1000</span></div><div class="line">betahat &lt;- replicate(B,&#123;</div><div class="line">index &lt;- sample(n,N)</div><div class="line">sampledat &lt;- father.son[index,]</div><div class="line">x &lt;- sampledat$fheight</div><div class="line">y &lt;- sampledat$sheight</div><div class="line">lm(y~x)$coef</div><div class="line">&#125;)</div><div class="line">betahat &lt;- t(betahat) <span class="comment">#have estimates in two columns</span></div></pre></td></tr></table></figure>
<p>现在绘制一个QQ图，我们看到，我们的估计值大致是服从标准正态分布的，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">mypar(<span class="number">1</span>,<span class="number">2</span>)</div><div class="line">qqnorm(betahat[,<span class="number">1</span>])</div><div class="line">qqline(betahat[,<span class="number">1</span>])</div><div class="line">qqnorm(betahat[,<span class="number">2</span>])</div><div class="line">qqline(betahat[,<span class="number">2</span>])</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190817130758.jpeg">

</div>
<p>现在看一下估计值之间的相关性，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; cor(betahat[,<span class="number">1</span>],betahat[,<span class="number">2</span>])</div><div class="line">[<span class="number">1</span>] -<span class="number">0.9992293</span></div></pre></td></tr></table></figure>
<p>当我们计算我们估计值的线性组合时，我们需要知道这个信息能够正确地计算出这些线性组合的标准误差。在接下来的部分中，我们会提到方差-协方差(variance-covariance)矩阵。两个随机变量的协方差定义如下：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mean( (betahat[,<span class="number">1</span>]-mean(betahat[,<span class="number">1</span>] ))* (betahat[,<span class="number">2</span>]-mean(betahat[,<span class="number">2</span>])))</div></pre></td></tr></table></figure>
<p>结果为：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; mean( (betahat[,<span class="number">1</span>]-mean(betahat[,<span class="number">1</span>] ))* (betahat[,<span class="number">2</span>]-mean(betahat[,<span class="number">2</span>])))</div><div class="line">[<span class="number">1</span>] -<span class="number">1.035291</span></div></pre></td></tr></table></figure>
<p>协方差是相关系数乘以每个随机变量的标准差，如下所示：</p>
<p><span class="math display">\[
\mbox{Corr}(X,Y) = \frac{\mbox{Cov}(X,Y)}{\sigma_X \sigma_Y}
\]</span></p>
<p>除此之外，这个量在实际分析中没有一个现实意义上解释。但是，它对于数学推导的过程来说，有着重要意义。在接下来的部分中，我们会描述用于计算线性模型估计的标准差的矩阵代数计算方法。</p>
<h2 id="方差-协方差矩阵">方差-协方差矩阵</h2>
<p>我们先来定义一什么是方差-协方差矩阵(variance-covariance matrix)<span class="math inline">\(\Sigma\)</span>。地于一个元素是随机变量的向量<span class="math inline">\(\mathbf{Y}\)</span>来说，我们定义<span class="math inline">\(\Sigma\)</span>是含有<span class="math inline">\(i,j\)</span>维的矩阵，如下所示： <span class="math display">\[
\Sigma_{i,j} \equiv \mbox{Cov}(Y_i, Y_j)
\]</span></p>
<p>如果<span class="math inline">\(i=j\)</span>，那么协方差就等于方差，如果变量都是独立的，则协方差都为0。在我们现在所学到的各种向量里，<span class="math inline">\(\mathbf{Y}\)</span>向量的每个观测值<span class="math inline">\(Y_{i}\)</span>是从总体中抽样得到的，我们可以假设它的每个元素都是独立的，并且<span class="math inline">\(Y_{i}\)</span>有着相同的方差<span class="math inline">\(\sigma^2\)</span>，因此方差-协方差矩阵只有两类元素，如下所示： <span class="math display">\[
\mbox{Cov}(Y_i, Y_i) = \mbox{var}(Y_i) = \sigma^2
\]</span> <span class="math display">\[
\mbox{Cov}(Y_i, Y_j) = 0, \mbox{ for } i \neq j
\]</span></p>
<p>这就是暗示了<span class="math inline">\(\boldsymbol{\Sigma} = \sigma^2 \mathbf{I}\)</span> ，其中<span class="math inline">\(\mathbf{I}\)</span>是单位矩阵(Identity matrix)。</p>
<h2 id="线性组合的方差">线性组合的方差</h2>
<p>线性代数提供的一个有用结果就是<span class="math inline">\(\mathbf{Y}\)</span>的<span class="math inline">\(\mathbf{AY}\)</span>线性结合的方差-协方差矩阵，它的计算如下所示： <span class="math display">\[
\mbox{var}(\mathbf{AY}) = \mathbf{A}\mbox{var}(\mathbf{Y}) \mathbf{A}^\top
\]</span> 例如，如果<span class="math inline">\(Y_{1}\)</span>和<span class="math inline">\(Y_{2}\)</span>是独立的，并且其方差为<span class="math inline">\(\sigma^2\)</span>，那么：</p>
<p><span class="math display">\[
\mbox{var}\{Y_1+Y_2\} = 
\mbox{var}\left\{ \begin{pmatrix}1&amp;1\end{pmatrix}\begin{pmatrix} Y_1\\Y_2\\ \end{pmatrix}\right\}=\begin{pmatrix}1&amp;1\end{pmatrix} \sigma^2 \mathbf{I}\begin{pmatrix} 1\\1\\ \end{pmatrix}=2\sigma^2
\]</span></p>
<p>我们会使用上述的结果来获取LSE的标准误。</p>
<h2 id="les标准误">LES标准误</h2>
<p><span class="math inline">\(\hat{\beta}\)</span>是一个线性组合，即 <span class="math inline">\(\mathbf{Y}\)</span>: <span class="math inline">\(\mathbf{AY}\)</span> with <span class="math inline">\(\mathbf{A}=\mathbf{(X^\top X)^{-1}X}^\top\)</span>的线性组合，因此我们可以使用上面的公式来计算一个我们估计值的方差：</p>
<p>$$ () = (  ) =</p>
<p>\ (Y) ()^= \</p>
<p> ^2  ()^= \</p>
<p>^2   = \ ^2 $$</p>
<p>其中，这个矩阵的平方根的对角线含有我们估计值的标准误。</p>
<h2 id="估计sigma2">估计<span class="math inline">\(\sigma^2\)</span></h2>
<p>为了从上述公式中获得一个精确的估计值，我们需要估计<span class="math inline">\(\sigma^2\)</span>。在前面我们通过抽样估计了标准误。但是<span class="math inline">\(Y\)</span>的抽样标准误不是<span class="math inline">\(\sigma\)</span>，因为<span class="math inline">\(Y\)</span>还包含了变异，这些变量是由模型<span class="math inline">\(\mathbf{X\beta}\)</span>的确定部分引入的。此时我们采用的方法是利用残差。</p>
<p>我们可以按下面的公式构建残差： <span class="math display">\[
\mathbf{r}\equiv\boldsymbol{\hat{\varepsilon}} = \mathbf{Y}-\mathbf{X}\boldsymbol{\hat{\beta}}
\]</span> 其中，<span class="math inline">\(r\)</span>和<span class="math inline">\(\hat{\epsilon}\)</span>都可以用来表示残差(residuals)。然后我们使用上述的公式来估计残差，这种方式与单变量情况下类似： <span class="math display">\[
s^2 \equiv \hat{\sigma}^2 = \frac{1}{N-p}\mathbf{r}^\top\mathbf{r} = \frac{1}{N-p}\sum_{i=1}^N r_i^2
\]</span></p>
<p>其中，<span class="math inline">\(N\)</span>是样本数目，<span class="math inline">\(p\)</span>是<span class="math inline">\(\mathbf{X}\)</span>的列数，或者是参数的数目（包括截矩<span class="math inline">\(\beta_{0}\)</span>）。公式中还要除以<span class="math inline">\(N-p\)</span>，这是因为根据数学理论（不用深究，这个跟自由度能关），除以<span class="math inline">\(N-p\)</span>，表示无偏估计。下面在R中计算一下，观察一下我们是否能够获得与Monte Carlo模拟一样的数值：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">n &lt;- nrow(father.son)</div><div class="line">N &lt;- <span class="number">50</span></div><div class="line">index &lt;- sample(n,N)</div><div class="line">sampledat &lt;- father.son[index,]</div><div class="line">x &lt;- sampledat$fheight</div><div class="line">y &lt;- sampledat$sheight</div><div class="line">X &lt;- model.matrix(~x)</div><div class="line">N &lt;- nrow(X)</div><div class="line">p &lt;- ncol(X)</div><div class="line">XtXinv &lt;- solve(crossprod(X))</div><div class="line">resid &lt;- y - X %*% XtXinv %*% crossprod(X,y)</div><div class="line">s &lt;- sqrt( sum(resid^<span class="number">2</span>)/(N-p))</div><div class="line">ses &lt;- sqrt(diag(XtXinv))*s</div><div class="line">summary(lm(y~x))$coef[,<span class="number">2</span>]</div><div class="line">ses</div><div class="line">apply(betahat,<span class="number">2</span>,sd)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&gt; summary(lm(y~x))$coef[,<span class="number">2</span>]</div><div class="line">(Intercept)           x </div><div class="line">  <span class="number">8.3899781</span>   <span class="number">0.1240767</span> </div><div class="line">&gt; ses</div><div class="line">(Intercept)           x </div><div class="line">  <span class="number">8.3899781</span>   <span class="number">0.1240767</span> </div><div class="line">&gt; apply(betahat,<span class="number">2</span>,sd)</div><div class="line">(Intercept)           x </div><div class="line">  <span class="number">8.3817556</span>   <span class="number">0.1237362</span></div></pre></td></tr></table></figure>
<p>从上面我们可以看出来，我们的计算结果与Monte Carlo模拟的结果几乎一样。</p>
<h2 id="估计值的线性组合">估计值的线性组合</h2>
<p>多数情况下，我们会计算估计值的一个线性组合，例如<span class="math inline">\(\hat{\beta_{2}}-\hat{\beta_{1}}\)</span>。这就是<span class="math inline">\(\hat{\beta}\)</span>的一个线性组合，如下所示： <span class="math display">\[
\hat{\beta}_2 - \hat{\beta}_1 = 
\begin{pmatrix}0&amp;-1&amp;1&amp;0&amp;\dots&amp;0\end{pmatrix} \begin{pmatrix}
\hat{\beta}_0\\
\hat{\beta}_1 \\ 
\hat{\beta}_2 \\ 
\vdots\\
\hat{\beta}_p
\end{pmatrix}
\]</span> 通过上述的公式，我们就知道中如何计算<span class="math inline">\(\hat{\beta}\)</span>的方差-协方差矩阵。</p>
<h2 id="clt与t分布">CLT与t分布</h2>
<p>我们已经了解了如何过计算估计值的标准误。但是，我们在第1章中了解到，在计算置信区间时，我们需要知道随机变量的分布。我们努力计算标准误的原因是因为，CLT适用于线性模型。如果<span class="math inline">\(N\)</span>足够大，那么LSE就会服从正态分布，其中这个正态分布的均值为<span class="math inline">\(\beta\)</span>，标准误就是前面计算的标准误。对于小样本来说，如果<span class="math inline">\(\varepsilon\)</span>服从正态分布，那么<span class="math inline">\(\hat{\beta}-\hat{\beta}\)</span>服从t分布。在这里，我们不需要知道空上计算过程，但是这个结果很有，因为这是我们在线性模型中计算p值，置信区间的基础。</p>
<h2 id="代码与数学">代码与数学</h2>
<p>构建线性模型的标准做法要么是假设<span class="math inline">\(\mathbf{X}\)</span>是固定的，要么我们给它们设置条件。因此<span class="math inline">\(\mathbf{X\beta}\)</span>没有像<span class="math inline">\(\mathbf{X}\)</span>那样固定的方差。这就浊为什么我们要写 <span class="math inline">\(\mbox{var}(Y_i) = \mbox{var}(\varepsilon_i)=\sigma^2\)</span>。在实际计算中，这有可能造成误解，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">x = father.son$fheight</div><div class="line">beta = c(<span class="number">34</span>,<span class="number">0.5</span>)</div><div class="line">var(beta[<span class="number">1</span>]+beta[<span class="number">2</span>]*x)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; var(beta[<span class="number">1</span>]+beta[<span class="number">2</span>]*x)</div><div class="line">[<span class="number">1</span>] <span class="number">1.883576</span></div></pre></td></tr></table></figure>
<p>这个值并不等于0，也不接近于0。这就是为什么我们要谨慎区分代码与数学的一个案例。<code>var()</code>函数仅仅是用于计算我们输入数值的方差，而数学对方差的定义则是要考虑到这些数字是否是随机变量。在上述的R代码中，<code>x</code>并没有固定：我们只是让它发生变化，但是，当我们写下<span class="math inline">\(\mbox{var}(Y_i) = \sigma^2\)</span>时，我们是把数学上的<code>x</code>强制固定下来。同样，如果我们使用R来计算自由落体运行案例中<span class="math inline">\(Y\)</span>的方差，我们也会获得一个与<span class="math inline">\(\sigma^2=1\)</span>（已知方差）明显不同的数值，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">n &lt;- length(tt)</div><div class="line">y &lt;- h0 + v0*tt - <span class="number">0.5</span>*g*tt^<span class="number">2</span> + rnorm(n,sd=<span class="number">1</span>)</div><div class="line">var(y)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt; n &lt;- length(tt)</div><div class="line">&gt; y &lt;- h0 + v0*tt - <span class="number">0.5</span>*g*tt^<span class="number">2</span> + rnorm(n,sd=<span class="number">1</span>)</div><div class="line">&gt; var(y)</div><div class="line">[<span class="number">1</span>] <span class="number">329.5136</span></div></pre></td></tr></table></figure>
<h2 id="练习-1">练习</h2>
<p>P199</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-tags" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rvdsd.top/2019/08/11/DAL/DALS011_Linear_Models01MatrixDescription/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="RVDSD">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RVDSD的个人笔记本">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/11/DAL/DALS011_Linear_Models01MatrixDescription/" itemprop="url">DALS011-Linear Models线性模型01MatrixDescription</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-11T12:00:00+08:00">
                2019-08-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Data-Analysis-for-the-life-sciences/" itemprop="url" rel="index">
                    <span itemprop="name">Data Analysis for the life sciences</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3,766
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  16
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言">前言</h2>
<p>这一部分是《Data Analysis for the life sciences》的第5章线性模型的第1小节。这一部分的主要内容涉及矩阵的表示方法。</p>
<h2 id="背景知识">背景知识</h2>
<p>数据分析中的很多模型都可以用矩阵代数来表示。我们指的这些模型都是线性模型(linear models)。线性(Linear)并不是说它们是直线，而是说是线性组合。使用矩阵代数来描述线性模型非常方便，因为我们可以更好地构建这些模型，并使用数学工具来方便计算。在这一部分中，我们将详细地描述我们如何使用矩阵代数来构建并拟合线性模型。</p>
<p>在本书中，我们关注的线性模型是基于二分法的线性模型：例如治疗组与对照组。在前面提到的小鼠饲料的案例中就是这种线性模型的一个典型案例。在这一部分中，我们会描述一些比较复杂的案例，不过还会继续关注二分法变量的线性模型。</p>
<p>当我们学习线性模型时，需要记住，我们使用的变量仍然是随机变量。这就意味着，我们使用线性模型获得的估计值也是随机变量。虽然数学上这理解起来比较复杂，但是我们前面学到的一些概念在这里仍然适用。现在可以先做一些练习，在线性模型的练习中复习一些随机变量的概念。</p>
<h2 id="练习">练习</h2>
<p>P172</p>
<h2 id="设计矩阵the-design-matrix">设计矩阵(The Design Matrix)</h2>
<p>R中的<code>formual()</code>和<code>model.matrix()</code>可以用于生成各种线性模型的设计矩阵(design matrices)（也被称为模型矩阵，即model matrices)。例如，在小鼠的饲料实验中，我们可以这样构建模型，如下所示： <span class="math display">\[
Y_{i}=\beta_{0}+\beta_{1} x_{i}+\varepsilon, i=1, \ldots, N
\]</span> 其中，<span class="math inline">\(Y_{i}\)</span>表示体重，而<span class="math inline">\(x_{i}\)</span>等于1的时候，表示小鼠<span class="math inline">\(i\)</span>吃的是高脂饲料(hf)。我们可以使用实验单位(Experimental unit)来表示N个不同的实验动物，这里的实验单位是小鼠。我们称这类变量为指示变量(indicator variables)，因此这类变量仅用于标明实验单位，表示某种干预的有无。现在用矩阵代数来描述就是以下形式： <span class="math display">\[
\mathbf{Y}=\left(\begin{array}{c}{Y_{1}} \\ {Y_{2}} \\ {\vdots} \\ {Y_{N}}\end{array}\right), \mathbf{X}=\left(\begin{array}{cc}{1} &amp; {x_{1}} \\ {1} &amp; {x_{2}} \\ {\vdots} &amp; {} \\ {1} &amp; {x_{N}}\end{array}\right), \beta=\left(\begin{array}{c}{\beta_{0}} \\ {\beta_{1}}\end{array}\right) \text { and } \varepsilon=\left(\begin{array}{c}{\varepsilon_{1}} \\ {\varepsilon_{2}} \\ {\vdots} \\ {\varepsilon_{N}}\end{array}\right)
\]</span> 或为： <span class="math display">\[
\left(\begin{array}{c}{Y_{1}} \\ {Y_{2}} \\ {\vdots} \\ {Y_{N}}\end{array}\right)=\left(\begin{array}{cc}{1} &amp; {x_{1}} \\ {1} &amp; {x_{2}} \\ {\vdots} &amp; {} \\ {1} &amp; {x_{N}}\end{array}\right)\left(\begin{array}{c}{\beta_{0}} \\ {\beta_{1}}\end{array}\right)+\left(\begin{array}{c}{\varepsilon_{1}} \\ {\varepsilon_{2}} \\ {\vdots} \\ {\varepsilon_{N}}\end{array}\right)
\]</span> 简化形式为： <span class="math display">\[
\mathrm{Y}=\mathrm{X} \boldsymbol{\beta}+\varepsilon
\]</span> 其中<span class="math inline">\(\mathbf{X}\)</span>是设计矩阵，一旦我们定义了设计矩阵，那么我们就能计算出最小二乘估计。这个过程称为拟合模型(fitting the model)。在R中，我们可以直接在<code>lm()</code>函数中输入一个公式(formula)直接进行拟合。在后面的一个脚本中，我们会使用<code>model.matrix()</code>函数，这个函数是在<code>lm()</code>函数内部使用的。这种使用方式哦可以方便地让我们将R的formula与矩阵<span class="math inline">\(\mathbf{X}\)</span>连接起来，有助于我们对<code>lm()</code>的结果进行解释。</p>
<h2 id="设计方案">设计方案</h2>
<p>设计矩阵的选择是线性模型中的关键步骤，因为它编码了哪些系数将适合用于建模，以及样本之间的相互关系。一个常见的误解就是，选择实验设计要遵循简单明了的原则，即要在描述中直接标明样本。事实并非如此。关于每个样本（无论是对照组还是处理组，实验批次等）的基础信息里并不意味着这是一个“正确”的设计矩阵。设计矩阵还应该对<span class="math inline">\(X\)</span>中的变量是如何解释<span class="math inline">\(Y\)</span>的值这些信息进行编码，这是研究者们必须要考虑的。</p>
<p>在这一部分的案例中，我们使用线性模型来比较不同组之间的差异。因此，最终进行计算的设计矩阵应该至少包含两列，即截矩(intercept)列，截矩列是第1列，另外就是第2列，第2列指定样本。在这种情况下，线性模型中的两个系数(coefficient)分别为：第1个系数是截矩(interccept)，它代表了第1组的总体均数，第2个系数是差值，这个差值表示的是第2组与第1组总体的差值。当我们进行统计学分析时，往往第2个系数是我们最感兴趣的，因为我们想知道这两组数据是否有差异。</p>
<p>我们可以在R中通过2行代码来编制实验设计。我们先是使用波浪线<code>~</code>来构建一个公式。这种形式的公式意味着，我们想使用波浪线右侧的变量的观测值来构建统计模型。然后我们再放进一个变量的名称，就能知道样本来源于哪些组。</p>
<p>看一个案例。 现在我们有两组数据，分别是对照组和高脂饲料组(hf)小鼠的体重数据。现在我们用1来表示对照组小鼠，2来表示hf组。我们首先要告诉R，这些值不能被当成数值，而是应该当成因子。然后使用公式<code>~group</code>来构建模型，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">group &lt;- factor( c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>) )</div><div class="line">model.matrix(~ group)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&gt; group &lt;- factor( c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>) )</div><div class="line">&gt; model.matrix(~ group)</div><div class="line">  (Intercept) group2</div><div class="line"><span class="number">1</span>           <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">2</span>           <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">3</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">4</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line">attr(,<span class="string">"assign"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0</span> <span class="number">1</span></div><div class="line">attr(,<span class="string">"contrasts"</span>)</div><div class="line">attr(,<span class="string">"contrasts"</span>)$group</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div></pre></td></tr></table></figure>
<p>这里面有很多信息，<code>attr</code>后面的信息不用管。</p>
<p>其实上面的计算过程也可以使用<code>model.matrix()</code>来构建，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">group &lt;- factor( c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>) )</div><div class="line">model.matrix(formula(~ group))</div></pre></td></tr></table></figure>
<p>如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&gt; group &lt;- factor( c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>) )</div><div class="line">&gt; model.matrix(formula(~ group))</div><div class="line">  (Intercept) group2</div><div class="line"><span class="number">1</span>           <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">2</span>           <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">3</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">4</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line">attr(,<span class="string">"assign"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0</span> <span class="number">1</span></div><div class="line">attr(,<span class="string">"contrasts"</span>)</div><div class="line">attr(,<span class="string">"contrasts"</span>)$group</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div></pre></td></tr></table></figure>
<p>如果我们不对组别(<code>group</code>)进行因子转换，那么就会出现下面的情况：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">group &lt;- c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>)</div><div class="line">model.matrix(~ group)</div></pre></td></tr></table></figure>
<p>即：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&gt; model.matrix(~ group)</div><div class="line">  (Intercept) group</div><div class="line"><span class="number">1</span>           <span class="number">1</span>     <span class="number">1</span></div><div class="line"><span class="number">2</span>           <span class="number">1</span>     <span class="number">1</span></div><div class="line"><span class="number">3</span>           <span class="number">1</span>     <span class="number">2</span></div><div class="line"><span class="number">4</span>           <span class="number">1</span>     <span class="number">2</span></div><div class="line">attr(,<span class="string">"assign"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0</span> <span class="number">1</span></div></pre></td></tr></table></figure>
<p>这种形式不是设计矩阵。因为没有经过factor转换的数值就是单纯的数值，而非指示变量(indicator variable)，因子类型变量的数值与具体的数字无关，字符串也能生成这些变量，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">group &lt;- factor(c(<span class="string">"control"</span>,<span class="string">"control"</span>,<span class="string">"highfat"</span>,<span class="string">"highfat"</span>))</div><div class="line">model.matrix(~ group)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&gt; group &lt;- factor(c(<span class="string">"control"</span>,<span class="string">"control"</span>,<span class="string">"highfat"</span>,<span class="string">"highfat"</span>))</div><div class="line">&gt; model.matrix(~ group)</div><div class="line">  (Intercept) grouphighfat</div><div class="line"><span class="number">1</span>           <span class="number">1</span>            <span class="number">0</span></div><div class="line"><span class="number">2</span>           <span class="number">1</span>            <span class="number">0</span></div><div class="line"><span class="number">3</span>           <span class="number">1</span>            <span class="number">1</span></div><div class="line"><span class="number">4</span>           <span class="number">1</span>            <span class="number">1</span></div><div class="line">attr(,<span class="string">"assign"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0</span> <span class="number">1</span></div><div class="line">attr(,<span class="string">"contrasts"</span>)</div><div class="line">attr(,<span class="string">"contrasts"</span>)$group</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div></pre></td></tr></table></figure>
<h2 id="多组设计">多组设计</h2>
<p>现在我们设计了3组数据，如下所示： <figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">group &lt;- factor(c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>))</div><div class="line">model.matrix(~ group)</div></pre></td></tr></table></figure></p>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&gt; group &lt;- factor(c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>))</div><div class="line">&gt; model.matrix(~ group)</div><div class="line">  (Intercept) group2 group3</div><div class="line"><span class="number">1</span>           <span class="number">1</span>      <span class="number">0</span>      <span class="number">0</span></div><div class="line"><span class="number">2</span>           <span class="number">1</span>      <span class="number">0</span>      <span class="number">0</span></div><div class="line"><span class="number">3</span>           <span class="number">1</span>      <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">4</span>           <span class="number">1</span>      <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">5</span>           <span class="number">1</span>      <span class="number">0</span>      <span class="number">1</span></div><div class="line"><span class="number">6</span>           <span class="number">1</span>      <span class="number">0</span>      <span class="number">1</span></div><div class="line">attr(,<span class="string">"assign"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0</span> <span class="number">1</span> <span class="number">1</span></div><div class="line">attr(,<span class="string">"contrasts"</span>)</div><div class="line">attr(,<span class="string">"contrasts"</span>)$group</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div></pre></td></tr></table></figure>
<p>现在我们的设计矩阵中有了第3列，这个第3列属于第3组。另外一种方法就是通过在公式中指定<code>+0</code>来添加第3组，如下所示： <figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">group &lt;- factor(c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>))</div><div class="line">model.matrix(~ group + <span class="number">0</span>)</div></pre></td></tr></table></figure></p>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&gt; group &lt;- factor(c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>))</div><div class="line">&gt; model.matrix(~ group + <span class="number">0</span>)</div><div class="line">  group1 group2 group3</div><div class="line"><span class="number">1</span>      <span class="number">1</span>      <span class="number">0</span>      <span class="number">0</span></div><div class="line"><span class="number">2</span>      <span class="number">1</span>      <span class="number">0</span>      <span class="number">0</span></div><div class="line"><span class="number">3</span>      <span class="number">0</span>      <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">4</span>      <span class="number">0</span>      <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">5</span>      <span class="number">0</span>      <span class="number">0</span>      <span class="number">1</span></div><div class="line"><span class="number">6</span>      <span class="number">0</span>      <span class="number">0</span>      <span class="number">1</span></div><div class="line">attr(,<span class="string">"assign"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">1</span> <span class="number">1</span> <span class="number">1</span></div><div class="line">attr(,<span class="string">"contrasts"</span>)</div><div class="line">attr(,<span class="string">"contrasts"</span>)$group</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div></pre></td></tr></table></figure>
<p>注：在这一处我不太理解，原文是<code>This group now fits a separate coefficient for each group.</code>翻译为汉语则是<code>这一组现在适用于每组的单独系数</code>，等后文中有介绍的时候再补上，以下是其它的参考书（数学建模：基于R.薛毅 著）对这一内容的理解：</p>
<p><code>lm()</code>中的参数<code>formula</code>是模型公式：</p>
<ol style="list-style-type: decimal">
<li><code>y ~ 1+x1 + x2</code>这种形式，表示常数项，<span class="math inline">\(X_{1}\)</span>，<span class="math inline">\(X_{2}\)</span>的系数；</li>
<li><code>y ~ x1 + x2</code>这种形式，去掉了1，其意义与原来加1的一样。</li>
<li><code>y ~ 0 + x1 + x2</code>这种形式，添加了0，表示拟合成就齐次线性模型（或者是改为<code>y ~ -1 + x1 + x2</code>）。</li>
</ol>
<h2 id="多变量设计">多变量设计</h2>
<p>前面我们构建的线性模型只有1个变量，即饲料。而在生命科学中，在一次实验中，往往会涉及多个变量，例如我们也许会研究饲料与性别这两个因素对体重的影响，在这种情况下，我们也许就会设计4组，如下所示： <figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">diet &lt;- factor(c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>))</div><div class="line">sex &lt;- factor(c(<span class="string">"f"</span>,<span class="string">"f"</span>,<span class="string">"m"</span>,<span class="string">"m"</span>,<span class="string">"f"</span>,<span class="string">"f"</span>,<span class="string">"m"</span>,<span class="string">"m"</span>))</div><div class="line">table(diet,sex)</div></pre></td></tr></table></figure></p>
<p>组别如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt; table(diet,sex)</div><div class="line">    sex</div><div class="line">diet f m</div><div class="line">   <span class="number">1</span> <span class="number">2</span> <span class="number">2</span></div><div class="line">   <span class="number">2</span> <span class="number">2</span> <span class="number">2</span></div></pre></td></tr></table></figure>
<p>假如我们认为饲料对体重的影响和性别对体重的影响（这只是假设）是相同的，那么我们就可以构建一个线性模型，如下所示： <span class="math display">\[
Y_{i}=\beta_{0}+\beta_{1} x_{i, 1}+\beta_{2} x_{i, 2}+\varepsilon_{i}
\]</span> 现在我们在R中对这个模型进行拟合，此时我们需要添加另外一个变量来构建一个设计矩阵，如下所示： <figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">diet &lt;- factor(c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>))</div><div class="line">sex &lt;- factor(c(<span class="string">"f"</span>,<span class="string">"f"</span>,<span class="string">"m"</span>,<span class="string">"m"</span>,<span class="string">"f"</span>,<span class="string">"f"</span>,<span class="string">"m"</span>,<span class="string">"m"</span>))</div><div class="line">model.matrix(~ diet + sex)</div></pre></td></tr></table></figure></p>
<p>如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&gt; diet &lt;- factor(c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>))</div><div class="line">&gt; sex &lt;- factor(c(<span class="string">"f"</span>,<span class="string">"f"</span>,<span class="string">"m"</span>,<span class="string">"m"</span>,<span class="string">"f"</span>,<span class="string">"f"</span>,<span class="string">"m"</span>,<span class="string">"m"</span>))</div><div class="line">&gt; model.matrix(~ diet + sex)</div><div class="line">  (Intercept) diet2 sexm</div><div class="line"><span class="number">1</span>           <span class="number">1</span>     <span class="number">0</span>    <span class="number">0</span></div><div class="line"><span class="number">2</span>           <span class="number">1</span>     <span class="number">0</span>    <span class="number">0</span></div><div class="line"><span class="number">3</span>           <span class="number">1</span>     <span class="number">0</span>    <span class="number">1</span></div><div class="line"><span class="number">4</span>           <span class="number">1</span>     <span class="number">0</span>    <span class="number">1</span></div><div class="line"><span class="number">5</span>           <span class="number">1</span>     <span class="number">1</span>    <span class="number">0</span></div><div class="line"><span class="number">6</span>           <span class="number">1</span>     <span class="number">1</span>    <span class="number">0</span></div><div class="line"><span class="number">7</span>           <span class="number">1</span>     <span class="number">1</span>    <span class="number">1</span></div><div class="line"><span class="number">8</span>           <span class="number">1</span>     <span class="number">1</span>    <span class="number">1</span></div><div class="line">attr(,<span class="string">"assign"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0</span> <span class="number">1</span> <span class="number">2</span></div><div class="line">attr(,<span class="string">"contrasts"</span>)</div><div class="line">attr(,<span class="string">"contrasts"</span>)$diet</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div><div class="line"></div><div class="line">attr(,<span class="string">"contrasts"</span>)$sex</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div></pre></td></tr></table></figure>
<p>这个设计矩阵包含一个截矩(intercept)，一个饲料变量(diet)，一个性别变量(sex)。我们可以说这个线性模型解释了组间差异与条件变量的差异。但是，如上所述，这个模型成立的前提是，我们假设了饮食和性别的差异会对小鼠的体重产生相同的影响。我们称这些情况为累加效应(additive effect)。对于每一个变量，我们添加一个效应时，不用考虑其它的变量是什么。针对这种情况，还有一种线性模型，这种线性模型里还会考虑两个变量之间的潜在交互作用。</p>
<p>如果我们要考虑交互作用的话，模型的构建如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">model.matrix(~ diet + sex + diet:sex)</div><div class="line"><span class="comment"># OR</span></div><div class="line"><span class="comment"># model.matrix(~ diet*sex)</span></div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&gt; </div><div class="line">&gt; model.matrix(~ diet + sex + diet:sex)</div><div class="line">  (Intercept) diet2 sexm diet2:sexm</div><div class="line"><span class="number">1</span>           <span class="number">1</span>     <span class="number">0</span>    <span class="number">0</span>          <span class="number">0</span></div><div class="line"><span class="number">2</span>           <span class="number">1</span>     <span class="number">0</span>    <span class="number">0</span>          <span class="number">0</span></div><div class="line"><span class="number">3</span>           <span class="number">1</span>     <span class="number">0</span>    <span class="number">1</span>          <span class="number">0</span></div><div class="line"><span class="number">4</span>           <span class="number">1</span>     <span class="number">0</span>    <span class="number">1</span>          <span class="number">0</span></div><div class="line"><span class="number">5</span>           <span class="number">1</span>     <span class="number">1</span>    <span class="number">0</span>          <span class="number">0</span></div><div class="line"><span class="number">6</span>           <span class="number">1</span>     <span class="number">1</span>    <span class="number">0</span>          <span class="number">0</span></div><div class="line"><span class="number">7</span>           <span class="number">1</span>     <span class="number">1</span>    <span class="number">1</span>          <span class="number">1</span></div><div class="line"><span class="number">8</span>           <span class="number">1</span>     <span class="number">1</span>    <span class="number">1</span>          <span class="number">1</span></div><div class="line">attr(,<span class="string">"assign"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span></div><div class="line">attr(,<span class="string">"contrasts"</span>)</div><div class="line">attr(,<span class="string">"contrasts"</span>)$diet</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div><div class="line"></div><div class="line">attr(,<span class="string">"contrasts"</span>)$sex</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div></pre></td></tr></table></figure>
<h2 id="指定比较水平relevel">指定比较水平relevel()</h2>
<p>在构建设计矩阵时，我们所选水平的参考水平用于比较。默认情况下，我们都是按照第1个水平因素进行比较，但是我们可以使用<code>relevel()</code>函数来指定哪个水平因素作用为对照，例如我们选择第2组作为参考水平，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">group &lt;- factor(c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>))</div><div class="line">group &lt;- relevel(group, <span class="string">"2"</span>)</div><div class="line">model.matrix(~ group)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&gt; model.matrix(~ group)</div><div class="line">  (Intercept) group1</div><div class="line"><span class="number">1</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">2</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">3</span>           <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">4</span>           <span class="number">1</span>      <span class="number">0</span></div><div class="line">attr(,<span class="string">"assign"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0</span> <span class="number">1</span></div><div class="line">attr(,<span class="string">"contrasts"</span>)</div><div class="line">attr(,<span class="string">"contrasts"</span>)$group</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div></pre></td></tr></table></figure>
<p>这里涉及了<code>relevel</code>函数，此函数信息如下所示：</p>
<h3 id="relevel函数">relevel()函数</h3>
<p>全称reorder levels of factor，函数的功能是：对一个因子的水平重新排序，以通过指定<code>ref</code>来指定第1个水平作为参考水平（例如在回归中使用二元解释变量，可以指定哪个水平作为参考水平），其余的往后移。在<code>contr.treatment</code>对照中非常有用，<code>contr.treatment</code>通常会将第1个水平当作参考水平。 用法： <code>relevel(x,ref,...)</code>，其中x是一个未排序的因子，ref：指定的参考水平，通常是一个字符串。</p>
<p>或者是在<code>factor()</code>中直接明确地指出，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">group &lt;- factor(c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>))</div><div class="line">group &lt;- factor(group, levels=c(<span class="string">"1"</span>,<span class="string">"2"</span>))</div><div class="line">model.matrix(~ group)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&gt; group &lt;- factor(c(<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>))</div><div class="line">&gt; group &lt;- factor(group, levels=c(<span class="string">"1"</span>,<span class="string">"2"</span>))</div><div class="line">&gt; model.matrix(~ group)</div><div class="line">  (Intercept) group2</div><div class="line"><span class="number">1</span>           <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">2</span>           <span class="number">1</span>      <span class="number">0</span></div><div class="line"><span class="number">3</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line"><span class="number">4</span>           <span class="number">1</span>      <span class="number">1</span></div><div class="line">attr(,<span class="string">"assign"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0</span> <span class="number">1</span></div><div class="line">attr(,<span class="string">"contrasts"</span>)</div><div class="line">attr(,<span class="string">"contrasts"</span>)$group</div><div class="line">[<span class="number">1</span>] <span class="string">"contr.treatment"</span></div></pre></td></tr></table></figure>
<h2 id="model.matrix的计算"><code>model.matrix</code>的计算</h2>
<p><code>model.matrix()</code>函数会捕获R全局环境中的变量，除非这些数据已经作为数据框的形式提供给到<code>model.matrix()</code>函数，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">group &lt;- <span class="number">1</span>:<span class="number">4</span></div><div class="line">model.matrix(~ group, data=data.frame(group=<span class="number">5</span>:<span class="number">8</span>))</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&gt; group &lt;- <span class="number">1</span>:<span class="number">4</span></div><div class="line">&gt; model.matrix(~ group, data=data.frame(group=<span class="number">5</span>:<span class="number">8</span>))</div><div class="line">  (Intercept) group</div><div class="line"><span class="number">1</span>           <span class="number">1</span>     <span class="number">5</span></div><div class="line"><span class="number">2</span>           <span class="number">1</span>     <span class="number">6</span></div><div class="line"><span class="number">3</span>           <span class="number">1</span>     <span class="number">7</span></div><div class="line"><span class="number">4</span>           <span class="number">1</span>     <span class="number">8</span></div><div class="line">attr(,<span class="string">"assign"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0</span> <span class="number">1</span></div></pre></td></tr></table></figure>
<h2 id="连续型变量">连续型变量</h2>
<p>前面内容中的变量都是指示数据（有的统计学书中指的是分类变量，哑变量），而在一些实验设计中，我们研究的是数值型变量（连续型变量），不需要将它们转换到第1列。例如在自由落体实验中，时间是一个连续型变量，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">tt &lt;- seq(<span class="number">0</span>,<span class="number">3.4</span>,len=<span class="number">4</span>)</div><div class="line">model.matrix(~ tt + I(tt^<span class="number">2</span>))</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&gt; tt &lt;- seq(<span class="number">0</span>,<span class="number">3.4</span>,len=<span class="number">4</span>)</div><div class="line">&gt; model.matrix(~ tt + I(tt^<span class="number">2</span>))</div><div class="line">  (Intercept)       tt   I(tt^<span class="number">2</span>)</div><div class="line"><span class="number">1</span>           <span class="number">1</span> <span class="number">0.000000</span>  <span class="number">0.000000</span></div><div class="line"><span class="number">2</span>           <span class="number">1</span> <span class="number">1.133333</span>  <span class="number">1.284444</span></div><div class="line"><span class="number">3</span>           <span class="number">1</span> <span class="number">2.266667</span>  <span class="number">5.137778</span></div><div class="line"><span class="number">4</span>           <span class="number">1</span> <span class="number">3.400000</span> <span class="number">11.560000</span></div><div class="line">attr(,<span class="string">"assign"</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0</span> <span class="number">1</span> <span class="number">2</span></div></pre></td></tr></table></figure>
<p>在这个模型里，我们用到了<code>I()</code>函数，<code>I()</code>的功能是，对一个变量进行数学变换，在上面的公式里，<code>I(tt^2)</code>的意思是就是，通过<code>I()</code>，将<code>tt^2</code>这个变量当作是一个变量，如果不加<code>I()</code>，则是单纯地计算<code>tt^2</code>的值。查看<code>I()</code>的文档就可以发现，这个函数的全称是<code>Inhibit Interpretation/Conversion of Objects</code>。</p>
<p>在生命科学中，我们还有可能会涉及这样一种情况，例如我们想研究一个药物的量效关系，例如研究这个药物在0mg，10mg和20mg时的效果。 将连续型数据强制作为变量很难进行分析。这就是为什么指示变量只是假设2组的均值不同，而连续型变量会假设预测测变量和结果之间存在着某种特定的关系。</p>
<p>在自由落体实验中，我们有重力加速度这个理论的支持。而在父子身高案例中，由于这些数据是二元正态分布变量，如果我们加上一些条件的话，父子之间的身高存在着线性关系。但是，我们发现，如果不对年龄等这类变量进行“调整(adjust)”的话，并将它们包含在线性模型中，其统计结果就值得商榷。我们不支持将这样的变量加到线性模型中，除非已经有支持这种数据的模型出现。</p>
<h2 id="练习-1">练习</h2>
<p>P183</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-tags" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rvdsd.top/2019/08/10/DAL/DALS010_Matrix_Algebra02_Matrix_Notation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="RVDSD">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RVDSD的个人笔记本">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/10/DAL/DALS010_Matrix_Algebra02_Matrix_Notation/" itemprop="url">DALS010-Matrix Algebra(矩阵代数)02-Matrix Notation</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-10T12:00:00+08:00">
                2019-08-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Data-Analysis-for-the-life-sciences/" itemprop="url" rel="index">
                    <span itemprop="name">Data Analysis for the life sciences</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  4,386
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  21
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言">前言</h2>
<p>这一部分是《Data Analysis for the life sciences》的第4章：矩阵代数的第2小节，这一部分的主要内容涉及矩阵的表示方法。</p>
<h2 id="线性模型语言">线性模型语言</h2>
<p>线性代数的符号化实际上简化了线性模型的数学描述和操作，以及R中的代码。这一部分的练习主要是通过使用矩阵符号来表示线性模型，并使用它来解最小二乘方程。</p>
<h2 id="解方程组">解方程组</h2>
<p>数学家创建线性代数是为了解以下这样的线性方程组： <span class="math display">\[
\begin{array}{r}{a+b+c=6} \\ {3 a-2 b+c=2} \\ {2 a+b-c=1}\end{array}
\]</span> 它提供了非常有用的机制来解决这些常见问题。我们将会学习如何使用矩阵代数来表示以及求解这些方程组，如下所示： <span class="math display">\[
\left(\begin{array}{ccc}{1} &amp; {1} &amp; {1} \\ {3} &amp; {-2} &amp; {1} \\ {2} &amp; {1} &amp; {-1}\end{array}\right)\left(\begin{array}{l}{a} \\ {b} \\ {c}\end{array}\right)=\left(\begin{array}{l}{6} \\ {2} \\ {1}\end{array}\right) \Rightarrow\left(\begin{array}{l}{a} \\ {b} \\ {c}\end{array}\right)=\left(\begin{array}{ccc}{1} &amp; {1} &amp; {1} \\ {3} &amp; {-2} &amp; {1} \\ {2} &amp; {1} &amp; {-1}\end{array}\right)^{-1}\left(\begin{array}{l}{6} \\ {2} \\ {1}\end{array}\right)
\]</span> 这一部分就是要解释上面的这些符号是什么意思，以及在统计学中如何用这些符号来计算线性方程。</p>
<h2 id="向量矩阵与标量">向量，矩阵与标量</h2>
<p>线性代数中的基本元素包括向量(vector)，矩阵(matrix)和标题(scalar)。</p>
<h3 id="向量">向量</h3>
<p>在自由落体运行，父子身高以及小鼠体重实验中，与这些数据有关的随机变量我们通常用<span class="math inline">\(Y_{1}, \ldots, Y_{n}\)</span>来表示，我们可以将它们视为一个向量(Vector)，其实R中就是这么干的，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(UsingR)</div><div class="line">y=father.son$fheight</div><div class="line">head(y)</div></pre></td></tr></table></figure>
<p>如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; head(y)</div><div class="line">[<span class="number">1</span>] <span class="number">65.04851</span> <span class="number">63.25094</span> <span class="number">64.95532</span> <span class="number">65.75250</span> <span class="number">61.13723</span> <span class="number">63.02254</span></div></pre></td></tr></table></figure>
<h3 id="矩阵">矩阵</h3>
<p>在数学中，我们可以只用一个符号来表示向量，我们通常用一个加粗的黑体字母，即<span class="math inline">\(\mathbf{Y}\)</span>来表示向量，从而将它与<span class="math inline">\(Y\)</span>区分开来，如下所示： <span class="math display">\[
\mathbf{Y}=\left(\begin{array}{c}{Y_{1}} \\ {Y_{2}} \\ {\vdots} \\ {Y_{N}}\end{array}\right)
\]</span> 因此，我们知道，一个数据向量的默认就是<span class="math inline">\(N \times 1\)</span>维，而不是<span class="math inline">\(1 \times N\)</span>维。这里不使用加粗字母是因为，在文中通常会告诉我们这是一个矩阵，而不是一个向量。类似的，我们可以使用数学符合来表示协方差(covariates)或预测因子(predictors)，如果我们有两个预测因子，那么就可以按以下形式表示： <span class="math display">\[
\mathrm{X}_{1}=\left(\begin{array}{c}{x_{1,1}} \\ {\vdots} \\ {x_{N, 1}}\end{array}\right) \text { and } \mathrm{X}_{2}=\left(\begin{array}{c}{x_{1,2}} \\ {\vdots} \\ {x_{N, 2}}\end{array}\right)
\]</span> 在自由落体案例中，<span class="math inline">\(x_{1,1}=t_{i}\)</span>，<span class="math inline">\(x_{i, 1}=t_{i}^{2}\)</span>，其中，<span class="math inline">\(t_{i}\)</span>表示的是第i次的观测值，这里再强调一次，向量可以被视为<span class="math inline">\(N \times 1\)</span>矩阵。因此上面的两个预测因子可以转换为矩阵，如下所示： <span class="math display">\[
\mathbf{X}=\left[\mathbf{X}_{1} \mathbf{X}_{2}\right]=\left(\begin{array}{cc}{x_{1,1}} &amp; {x_{1,2}} \\ {\vdots} \\ {x_{N, 1}} &amp; {x_{N, 2}}\end{array}\right)
\]</span> 此时，这个矩阵就是<span class="math inline">\(N \times 2\)</span>维，在R中，我们可以创建这个矩阵，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">n &lt;- <span class="number">25</span></div><div class="line">tt &lt;- seq(<span class="number">0</span>,<span class="number">3.4</span>,len=n) <span class="comment">##time in secs, t is a base function</span></div><div class="line">X &lt;- cbind(X1=tt,X2=tt^<span class="number">2</span>)</div><div class="line">head(X)</div><div class="line">dim(X)</div></pre></td></tr></table></figure>
<p>如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&gt; head(X)</div><div class="line">            X1         X2</div><div class="line">[<span class="number">1</span>,] <span class="number">0.0000000</span> <span class="number">0.00000000</span></div><div class="line">[<span class="number">2</span>,] <span class="number">0.1416667</span> <span class="number">0.02006944</span></div><div class="line">[<span class="number">3</span>,] <span class="number">0.2833333</span> <span class="number">0.08027778</span></div><div class="line">[<span class="number">4</span>,] <span class="number">0.4250000</span> <span class="number">0.18062500</span></div><div class="line">[<span class="number">5</span>,] <span class="number">0.5666667</span> <span class="number">0.32111111</span></div><div class="line">[<span class="number">6</span>,] <span class="number">0.7083333</span> <span class="number">0.50173611</span></div><div class="line">&gt; dim(X)</div><div class="line">[<span class="number">1</span>] <span class="number">25</span>  <span class="number">2</span></div></pre></td></tr></table></figure>
<p>我们也可以使用这些符号来表示任意<span class="math inline">\(N \times p\)</span>维的矩阵，如下所示： <span class="math display">\[
\mathbf{X}=\left(\begin{array}{ccc}{x_{1,1}} &amp; {\dots} &amp; {x_{1, p}} \\ {x_{2,1}} &amp; {\dots} &amp; {x_{2, p}} \\ {} &amp; {\vdots} \\ {x_{N, 1}} &amp; {\dots} &amp; {x_{N, p}}\end{array}\right)
\]</span> 在R中，可以使用<code>matrix()</code>函数来创建矩阵，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">N &lt;- <span class="number">100</span>; p &lt;- <span class="number">5</span></div><div class="line">X &lt;- matrix(<span class="number">1</span>:(N*p),N,p)</div><div class="line">head(X)</div><div class="line">dim(X)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&gt; head(X)</div><div class="line">     [,<span class="number">1</span>] [,<span class="number">2</span>] [,<span class="number">3</span>] [,<span class="number">4</span>] [,<span class="number">5</span>]</div><div class="line">[<span class="number">1</span>,]    <span class="number">1</span>  <span class="number">101</span>  <span class="number">201</span>  <span class="number">301</span>  <span class="number">401</span></div><div class="line">[<span class="number">2</span>,]    <span class="number">2</span>  <span class="number">102</span>  <span class="number">202</span>  <span class="number">302</span>  <span class="number">402</span></div><div class="line">[<span class="number">3</span>,]    <span class="number">3</span>  <span class="number">103</span>  <span class="number">203</span>  <span class="number">303</span>  <span class="number">403</span></div><div class="line">[<span class="number">4</span>,]    <span class="number">4</span>  <span class="number">104</span>  <span class="number">204</span>  <span class="number">304</span>  <span class="number">404</span></div><div class="line">[<span class="number">5</span>,]    <span class="number">5</span>  <span class="number">105</span>  <span class="number">205</span>  <span class="number">305</span>  <span class="number">405</span></div><div class="line">[<span class="number">6</span>,]    <span class="number">6</span>  <span class="number">106</span>  <span class="number">206</span>  <span class="number">306</span>  <span class="number">406</span></div><div class="line">&gt; dim(X)</div><div class="line">[<span class="number">1</span>] <span class="number">100</span>   <span class="number">5</span></div></pre></td></tr></table></figure>
<p>默认情况下，在R中，矩阵是按照列的顺序进行填充的，如果加上参数<code>byrow=TRUE</code>，则矩阵会按照行进行填充，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">N &lt;- <span class="number">100</span>; p &lt;- <span class="number">5</span></div><div class="line">X &lt;- matrix(<span class="number">1</span>:(N*p),N,p,byrow=<span class="literal">TRUE</span>)</div><div class="line">head(X)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&gt; head(X)</div><div class="line">     [,<span class="number">1</span>] [,<span class="number">2</span>] [,<span class="number">3</span>] [,<span class="number">4</span>] [,<span class="number">5</span>]</div><div class="line">[<span class="number">1</span>,]    <span class="number">1</span>    <span class="number">2</span>    <span class="number">3</span>    <span class="number">4</span>    <span class="number">5</span></div><div class="line">[<span class="number">2</span>,]    <span class="number">6</span>    <span class="number">7</span>    <span class="number">8</span>    <span class="number">9</span>   <span class="number">10</span></div><div class="line">[<span class="number">3</span>,]   <span class="number">11</span>   <span class="number">12</span>   <span class="number">13</span>   <span class="number">14</span>   <span class="number">15</span></div><div class="line">[<span class="number">4</span>,]   <span class="number">16</span>   <span class="number">17</span>   <span class="number">18</span>   <span class="number">19</span>   <span class="number">20</span></div><div class="line">[<span class="number">5</span>,]   <span class="number">21</span>   <span class="number">22</span>   <span class="number">23</span>   <span class="number">24</span>   <span class="number">25</span></div><div class="line">[<span class="number">6</span>,]   <span class="number">26</span>   <span class="number">27</span>   <span class="number">28</span>   <span class="number">29</span>   <span class="number">30</span></div></pre></td></tr></table></figure>
<h3 id="标量">标量</h3>
<p>标量仅仅是一个数字，通常使用小写字母来表示标量，并且不加粗。</p>
<h2 id="练习">练习</h2>
<p>P157</p>
<h2 id="数学运算">数学运算</h2>
<p>前面我们提到了一个方程组，如下所示： <span class="math display">\[
\begin{aligned} a+b+c &amp;=6 \\ 3 a-2 b+c &amp;=2 \\ 2 a+b-c &amp;=1 \end{aligned}
\]</span> 如果用矩阵代数来表示，就是下面的形式： <span class="math display">\[
\left(\begin{array}{ccc}{1} &amp; {1} &amp; {1} \\ {3} &amp; {-2} &amp; {1} \\ {2} &amp; {1} &amp; {-1}\end{array}\right)\left(\begin{array}{l}{a} \\ {b} \\ {c}\end{array}\right)=\left(\begin{array}{l}{6} \\ {2} \\ {1}\end{array}\right) \Rightarrow\left(\begin{array}{l}{a} \\ {b} \\ {c}\end{array}\right)=\left(\begin{array}{ccc}{1} &amp; {1} &amp; {1} \\ {3} &amp; {-2} &amp; {1} \\ {2} &amp; {1} &amp; {-1}\end{array}\right)^{-1}\left(\begin{array}{l}{6} \\ {2} \\ {1}\end{array}\right)
\]</span></p>
<h2 id="矩阵与标量相乘">矩阵与标量相乘</h2>
<p>这是矩阵运算中最简单的操作，一个矩阵<span class="math inline">\(\mathbf{X}\)</span>与一个标量<span class="math inline">\(a\)</span>相乘，矩阵的每一个元素都与这个标量相乘，如下所示： <span class="math display">\[
\mathbf{X}=\left(\begin{array}{ccc}{x_{1,1}} &amp; {\dots} &amp; {x_{1, p}} \\ {x_{2,1}} &amp; {\dots} &amp; {x_{2, p}} \\ {} &amp; {\vdots} &amp; {} \\ {x_{N, 1}} &amp; {\dots} &amp; {x_{N, p}}\end{array}\right) \Rightarrow a \mathbf{X}=\left(\begin{array}{ccc}{a x_{1,1}} &amp; {\dots} &amp; {a x_{1, p}} \\ {a x_{2,1}} &amp; {\dots} &amp; {a x_{2, p}} \\ {} &amp; {\vdots} \\ {a_{N, 1}} &amp; {\dots} &amp; {a x_{N, p}}\end{array}\right)
\]</span> R中的运算会自动遵循这个规则，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">X &lt;- matrix(<span class="number">1</span>:<span class="number">12</span>,<span class="number">4</span>,<span class="number">3</span>)</div><div class="line">print(X)</div><div class="line">a &lt;- <span class="number">2</span></div><div class="line">print(a*X)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&gt; X &lt;- matrix(<span class="number">1</span>:<span class="number">12</span>,<span class="number">4</span>,<span class="number">3</span>)</div><div class="line">&gt; print(X)</div><div class="line">     [,<span class="number">1</span>] [,<span class="number">2</span>] [,<span class="number">3</span>]</div><div class="line">[<span class="number">1</span>,]    <span class="number">1</span>    <span class="number">5</span>    <span class="number">9</span></div><div class="line">[<span class="number">2</span>,]    <span class="number">2</span>    <span class="number">6</span>   <span class="number">10</span></div><div class="line">[<span class="number">3</span>,]    <span class="number">3</span>    <span class="number">7</span>   <span class="number">11</span></div><div class="line">[<span class="number">4</span>,]    <span class="number">4</span>    <span class="number">8</span>   <span class="number">12</span></div><div class="line">&gt; a &lt;- <span class="number">2</span></div><div class="line">&gt; print(a*X)</div><div class="line">     [,<span class="number">1</span>] [,<span class="number">2</span>] [,<span class="number">3</span>]</div><div class="line">[<span class="number">1</span>,]    <span class="number">2</span>   <span class="number">10</span>   <span class="number">18</span></div><div class="line">[<span class="number">2</span>,]    <span class="number">4</span>   <span class="number">12</span>   <span class="number">20</span></div><div class="line">[<span class="number">3</span>,]    <span class="number">6</span>   <span class="number">14</span>   <span class="number">22</span></div><div class="line">[<span class="number">4</span>,]    <span class="number">8</span>   <span class="number">16</span>   <span class="number">24</span></div></pre></td></tr></table></figure>
<h2 id="转置transpose">转置(Transpose)</h2>
<p>矩阵的转置就是将矩阵的行与列颠倒，通常使用<span class="math inline">\(T\)</span>这个符号表示矩阵的转置运算，如下所示： <span class="math display">\[
\mathbf{X}=\left(\begin{array}{ccc}{x_{1,1}} &amp; {\ldots} &amp; {x_{1, p}} \\ {x_{2,1}} &amp; {\ldots} &amp; {x_{2, p}} \\ {} &amp; {\vdots} &amp; {} \\ {x_{N, 1}} &amp; {\ldots} &amp; {x_{N, p}}\end{array}\right) \Rightarrow \mathbf{X}^{\top}=\left(\begin{array}{ccc}{x_{1,1}} &amp; {\ldots} &amp; {x_{p, 1}} \\ {x_{1,2}} &amp; {\ldots} &amp; {x_{p, 2}} \\ {} &amp; {\vdots} &amp; {} \\ {x_{1, N}} &amp; {\ldots} &amp; {x_{p, N}}\end{array}\right)
\]</span> 在R中，直接使用<code>t()</code>函数就行，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">X &lt;- matrix(<span class="number">1</span>:<span class="number">12</span>,<span class="number">4</span>,<span class="number">3</span>)</div><div class="line">X</div><div class="line">t(X)</div></pre></td></tr></table></figure>
<p>如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&gt; X &lt;- matrix(<span class="number">1</span>:<span class="number">12</span>,<span class="number">4</span>,<span class="number">3</span>)</div><div class="line">&gt; X</div><div class="line">     [,<span class="number">1</span>] [,<span class="number">2</span>] [,<span class="number">3</span>]</div><div class="line">[<span class="number">1</span>,]    <span class="number">1</span>    <span class="number">5</span>    <span class="number">9</span></div><div class="line">[<span class="number">2</span>,]    <span class="number">2</span>    <span class="number">6</span>   <span class="number">10</span></div><div class="line">[<span class="number">3</span>,]    <span class="number">3</span>    <span class="number">7</span>   <span class="number">11</span></div><div class="line">[<span class="number">4</span>,]    <span class="number">4</span>    <span class="number">8</span>   <span class="number">12</span></div><div class="line">&gt; t(X)</div><div class="line">     [,<span class="number">1</span>] [,<span class="number">2</span>] [,<span class="number">3</span>] [,<span class="number">4</span>]</div><div class="line">[<span class="number">1</span>,]    <span class="number">1</span>    <span class="number">2</span>    <span class="number">3</span>    <span class="number">4</span></div><div class="line">[<span class="number">2</span>,]    <span class="number">5</span>    <span class="number">6</span>    <span class="number">7</span>    <span class="number">8</span></div><div class="line">[<span class="number">3</span>,]    <span class="number">9</span>   <span class="number">10</span>   <span class="number">11</span>   <span class="number">12</span></div></pre></td></tr></table></figure>
<h2 id="矩阵的相乘">矩阵的相乘</h2>
<p>还以开始三元一次方程组为例说明一下，如下所示： <span class="math display">\[
\begin{array}{r}{a+b+c=6} \\ {3 a-2 b+c=2} \\ {2 a+b-c=1}\end{array}
\]</span></p>
<p>两个矩阵相乘的运算法则是，第1个矩阵的行乘以第2个矩阵的列（第1个矩阵的列数与第2个矩阵的行数相同）。由于第2个矩阵只有1列，因此相乘的结果如下所示： <span class="math display">\[
\left(\begin{array}{ccc}{1} &amp; {1} &amp; {1} \\ {3} &amp; {-2} &amp; {1} \\ {2} &amp; {1} &amp; {-1}\end{array}\right)\left(\begin{array}{l}{a} \\ {b} \\ {c}\end{array}\right)=\left(\begin{array}{c}{a+b+c} \\ {3 a-2 b+c} \\ {2 a+b-c}\end{array}\right)
\]</span> 下面我们在R中计算一下，我们来看一下<code>abc=c(3,2,1)</code>是否是上述方程组的一个解，计算结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">X &lt;- matrix(c(<span class="number">1</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>,-<span class="number">2</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,-<span class="number">1</span>),<span class="number">3</span>,<span class="number">3</span>)</div><div class="line">abc &lt;- c(<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>) <span class="comment">#use as an example</span></div><div class="line">rbind( sum(X[<span class="number">1</span>,]*abc), sum(X[<span class="number">2</span>,]*abc), sum(X[<span class="number">3</span>,]%*%abc))</div></pre></td></tr></table></figure>
<p>计算结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt; rbind( sum(X[<span class="number">1</span>,]*abc), sum(X[<span class="number">2</span>,]*abc), sum(X[<span class="number">3</span>,]%*%abc))</div><div class="line">     [,<span class="number">1</span>]</div><div class="line">[<span class="number">1</span>,]    <span class="number">6</span></div><div class="line">[<span class="number">2</span>,]    <span class="number">6</span></div><div class="line">[<span class="number">3</span>,]    <span class="number">7</span></div></pre></td></tr></table></figure>
<p>使用<code>%*%</code>可以进行矩阵相乘，这种方法很简单，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">X%*%abc</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt; X%*%abc</div><div class="line">     [,<span class="number">1</span>]</div><div class="line">[<span class="number">1</span>,]    <span class="number">6</span></div><div class="line">[<span class="number">2</span>,]    <span class="number">6</span></div><div class="line">[<span class="number">3</span>,]    <span class="number">7</span></div></pre></td></tr></table></figure>
<p>从上面结果我们可以知道，<code>c(3,2,1)</code>不是方程组的解。为了求解方程组，我们需要逆转(inverse)左边的矩阵（后面要学习的内容）。在这里，我们定义矩阵<span class="math inline">\(A\)</span>与<span class="math inline">\(X\)</span>相乘的一般规则，如下所示： <span class="math display">\[
\mathbf{A X}=\left(\begin{array}{cccc}{a_{1,1}} &amp; {a_{1,2}} &amp; {\dots} &amp; {a_{1, N}} \\ {a_{2,1}} &amp; {a_{2,2}} &amp; {\dots} &amp; {a_{2, N}} \\ {} &amp; {} &amp; {\vdots} \\ {a_{M, 1}} &amp; {a_{M, 2}} &amp; {\dots} &amp; {a_{M, N}}\end{array}\right)\left(\begin{array}{ccc}{x_{1,1}} &amp; {\dots} &amp; {x_{1, p}} \\ {x_{2,1}} &amp; {\dots} &amp; {x_{2, p}} \\ {} &amp; {\vdots} \\ {x_{N, 1}} &amp; {\dots} &amp; {x_{N, p}}\end{array}\right)\\=\left(\begin{array}{ccc}{\sum_{i=1}^{N} a_{1, i} x_{i, 1}} &amp; {\ldots} &amp; {\sum_{i=1}^{N} a_{1, i} x_{i, p}} \\ {} &amp; {\vdots} &amp; {} \\ {\sum_{i=1}^{N} a_{M, i} x_{i, 1}} &amp; {\ldots} &amp; {\sum_{i=1}^{N} a_{M, i} x_{i, p}}\end{array}\right)
\]</span> 只有当矩阵<span class="math inline">\(A\)</span>的列数与矩阵<span class="math inline">\(X\)</span>的行数相等时，才能得到两个矩阵相乘的结果。</p>
<h2 id="单位矩阵the-identity-matrix">单位矩阵(The identity matrix)</h2>
<p>在矩阵代数中，单位矩阵的意义与1类似，一个矩阵乘以单位矩阵，还是其本身，单位矩阵的定义如下所示： <span class="math display">\[
\mathbf{I}=\left(\begin{array}{cccccc}{1} &amp; {0} &amp; {0} &amp; {\ldots} &amp; {0} &amp; {0} \\ {0} &amp; {1} &amp; {0} &amp; {\ldots} &amp; {0} &amp; {0} \\ {0} &amp; {0} &amp; {1} &amp; {\ldots} &amp; {0} &amp; {0} \\ {\vdots} &amp; {\vdots} &amp; {\vdots} &amp; {\ddots} &amp; {\vdots} &amp; {\vdots} \\ {0} &amp; {0} &amp; {0} &amp; {\ldots} &amp; {1} &amp; {0} \\ {0} &amp; {0} &amp; {0} &amp; {\ldots} &amp; {0} &amp; {1}\end{array}\right)
\]</span> 单位矩阵的行与列数目相等，从左上解到右下解的元素都为1，其余都为0。现在我们看一下一个矩阵与单位矩阵的相乘结果，如下所示： <span class="math display">\[
\mathbf{X I}=\left(\begin{array}{ccc}{x_{1,1}} &amp; {\dots} &amp; {x_{1, p}} \\ {} &amp; {\vdots} &amp; {} \\ {x_{N, 1}} &amp; {\dots} &amp; {x_{N, p}}\end{array}\right)\left(\begin{array}{cccccc}{1} &amp; {0} &amp; {0} &amp; {\dots} &amp; {0} &amp; {0} \\ {0} &amp; {1} &amp; {0} &amp; {\dots} &amp; {0} &amp; {0} \\ {0} &amp; {0} &amp; {1} &amp; {\dots} &amp; {0} &amp; {0} \\ {} &amp; {} &amp; {} &amp; {\vdots} &amp; {} \\ {0} &amp; {0} &amp; {0} &amp; {\dots} &amp; {1} &amp; {0} \\ {0} &amp; {0} &amp; {0} &amp; {\dots} &amp; {0} &amp; {1}\end{array}\right)=\left(\begin{array}{ccc}{x_{1,1}} &amp; {\dots} &amp; {x_{1, p}} \\ {} &amp; {\vdots} &amp; {} \\ {x_{N, 1}} &amp; {\dots} &amp; {x_{N, p}}\end{array}\right)
\]</span> R中可以通过<code>diag()</code>函数来生成单位矩阵，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">n &lt;- <span class="number">5</span> <span class="comment">#pick dimensions</span></div><div class="line">diag(n)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&gt; n &lt;- <span class="number">5</span> <span class="comment">#pick dimensions</span></div><div class="line">&gt; diag(n)</div><div class="line">     [,<span class="number">1</span>] [,<span class="number">2</span>] [,<span class="number">3</span>] [,<span class="number">4</span>] [,<span class="number">5</span>]</div><div class="line">[<span class="number">1</span>,]    <span class="number">1</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span></div><div class="line">[<span class="number">2</span>,]    <span class="number">0</span>    <span class="number">1</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span></div><div class="line">[<span class="number">3</span>,]    <span class="number">0</span>    <span class="number">0</span>    <span class="number">1</span>    <span class="number">0</span>    <span class="number">0</span></div><div class="line">[<span class="number">4</span>,]    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">1</span>    <span class="number">0</span></div><div class="line">[<span class="number">5</span>,]    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">1</span></div></pre></td></tr></table></figure>
<h2 id="矩阵的逆转inverse">矩阵的逆转(inverse)</h2>
<p>矩阵<span class="math inline">\(X\)</span>的逆转可以表示为<span class="math inline">\(X^{-1}\)</span>，逆转后的矩阵与原矩阵相乘，会得到单位矩阵，即<span class="math inline">\(X^{-1} X=I\)</span>，但是，并非所有的矩阵都可以逆转（逆转后的矩阵称为逆矩阵）。</p>
<p>当我们计算一个线性模型时，就要用到逆矩阵。在R中可以使用<code>solve()</code>函数来进行运算，<code>solve()</code>函数就是计算一个矩阵的逆矩阵，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">X &lt;- matrix(c(<span class="number">1</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>,-<span class="number">2</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,-<span class="number">1</span>),<span class="number">3</span>,<span class="number">3</span>)</div><div class="line">y &lt;- matrix(c(<span class="number">6</span>,<span class="number">2</span>,<span class="number">1</span>),<span class="number">3</span>,<span class="number">1</span>)</div><div class="line">solve(X)</div><div class="line">solve(X)%*%y <span class="comment">#equivalent to solve(X,y)</span></div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&gt; solve(X)</div><div class="line">           [,<span class="number">1</span>]        [,<span class="number">2</span>]       [,<span class="number">3</span>]</div><div class="line">[<span class="number">1</span>,] <span class="number">0.07692308</span>  <span class="number">0.15384615</span>  <span class="number">0.2307692</span></div><div class="line">[<span class="number">2</span>,] <span class="number">0.38461538</span> -<span class="number">0.23076923</span>  <span class="number">0.1538462</span></div><div class="line">[<span class="number">3</span>,] <span class="number">0.53846154</span>  <span class="number">0.07692308</span> -<span class="number">0.3846154</span></div><div class="line">&gt; solve(X)%*%y <span class="comment">#equivalent to solve(X,y)</span></div><div class="line">     [,<span class="number">1</span>]</div><div class="line">[<span class="number">1</span>,]    <span class="number">1</span></div><div class="line">[<span class="number">2</span>,]    <span class="number">2</span></div><div class="line">[<span class="number">3</span>,]    <span class="number">3</span></div></pre></td></tr></table></figure>
<h2 id="练习-1">练习</h2>
<p>P163</p>
<h2 id="矩阵案例">矩阵案例</h2>
<p>前面内容是关于矩阵的简单案例，以及它们在数据分析过程中的重要作用。我们最终要达到的目标是：如何使用矩阵代数符号来描述线性模型以及求解最小二乘问题。</p>
<h3 id="均值">均值</h3>
<p>为了计算样本的均值和方差，例如我们使用<span class="math inline">\(\overline{Y}=\frac{1}{N} Y_{i}\)</span>来计算均值，使用<span class="math inline">\(\operatorname{var}(Y)=\frac{1}{N} \sum_{i=1}^{N}\left(Y_{i}-\overline{Y}\right)^{2}\)</span>来计算方差。我们也可以使用矩阵乘法来计睡这些结果。</p>
<p>第一步：定义一个<span class="math inline">\(N\times1\)</span>矩阵，它只有1列，如下所示： <span class="math display">\[
A=\left(\begin{array}{l}{1} \\ {1} \\ {\vdots} \\ {1}\end{array}\right)
\]</span> 我们可以使用下面的公式来计算均值： <span class="math display">\[
\frac{1}{N} \mathbf{A}^{\top} Y=\frac{1}{N}\left(\begin{array}{llll}{1} &amp; {1} &amp; {\ldots} &amp; {1}\end{array}\right)\left(\begin{array}{l}{Y_{1}} \\ {Y_{2}} \\ {\vdots} \\ {Y_{N}}\end{array}\right)=\frac{1}{N} \sum_{i=1}^{N} Y_{i}=\overline{Y}
\]</span> 从上面的公式我们可以看到，里面乘了一个标量，即<span class="math inline">\(1/N\)</span>，在R中，可以使用<code>%*%</code>来实现，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(UsingR)</div><div class="line">y &lt;- father.son$sheight</div><div class="line">print(mean(y))</div><div class="line">N &lt;- length(y)</div><div class="line">Y&lt;- matrix(y,N,<span class="number">1</span>)</div><div class="line">A &lt;- matrix(<span class="number">1</span>,N,<span class="number">1</span>)</div><div class="line">barY=t(A)%*%Y / N</div><div class="line">print(barY)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&gt; <span class="keyword">library</span>(UsingR)</div><div class="line">&gt; y &lt;- father.son$sheight</div><div class="line">&gt; print(mean(y))</div><div class="line">[<span class="number">1</span>] <span class="number">68.68407</span></div><div class="line">&gt; N &lt;- length(y)</div><div class="line">&gt; Y&lt;- matrix(y,N,<span class="number">1</span>)</div><div class="line">&gt; A &lt;- matrix(<span class="number">1</span>,N,<span class="number">1</span>)</div><div class="line">&gt; barY=t(A)%*%Y / N</div><div class="line">&gt; print(barY)</div><div class="line">         [,<span class="number">1</span>]</div><div class="line">[<span class="number">1</span>,] <span class="number">68.68407</span></div></pre></td></tr></table></figure>
<h3 id="方差">方差</h3>
<p>在统计学中，常常会用到矩阵转置后的相乘，而在R中，可以直接进行运算，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">barY=crossprod(A,Y) / N</div><div class="line">print(barY)</div><div class="line">barY2 &lt;- t(A)%*%Y/N</div><div class="line">print(barY2)</div></pre></td></tr></table></figure>
<p>计算结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&gt; print(barY)</div><div class="line">         [,<span class="number">1</span>]</div><div class="line">[<span class="number">1</span>,] <span class="number">68.68407</span></div><div class="line">&gt; barY2 &lt;- t(A)%*%Y/N</div><div class="line">&gt; print(barY2)</div><div class="line">         [,<span class="number">1</span>]</div><div class="line">[<span class="number">1</span>,] <span class="number">68.68407</span></div></pre></td></tr></table></figure>
<p>在计算方差时，公式如下所示： <span class="math display">\[
\mathbf{r} \equiv\left(\begin{array}{c}{Y_{1}-\overline{Y}} \\ {\vdots} \\ {Y_{N}-\overline{Y}}\end{array}\right), \frac{1}{N} \mathbf{r}^{\top} \mathbf{r}=\frac{1}{N} \sum_{i=1}^{N}\left(Y_{i}-\overline{Y}\right)^{2}
\]</span> 在R中，如果<code>crossprod()</code>函数只有一个矩阵参数，那么计算的就是<span class="math inline">\(r^{\top} r\)</span>，可以简单地写为以下形式：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">r &lt;- y - barY</div><div class="line">crossprod(r)/N</div><div class="line">t(r)%*%r/N</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&gt; crossprod(r)/N</div><div class="line">         [,<span class="number">1</span>]</div><div class="line">[<span class="number">1</span>,] <span class="number">7.915196</span></div><div class="line">&gt; t(r)%*%r/N</div><div class="line">         [,<span class="number">1</span>]</div><div class="line">[<span class="number">1</span>,] <span class="number">7.915196</span></div></pre></td></tr></table></figure>
<p>上述计算过程也等于以下形式：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(rafalib)</div><div class="line">popvar(y)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; popvar(y)</div><div class="line">[<span class="number">1</span>] <span class="number">7.915196</span></div></pre></td></tr></table></figure>
<h2 id="线性模型">线性模型</h2>
<p>现在我们应用一下线性模型，还以Galton的案例为例说明一下，我们先定义以下矩阵： <span class="math display">\[
\mathbf{Y}=\left(\begin{array}{c}{Y_{1}} \\ {Y_{2}} \\ {\vdots} \\ {Y_{N}}\end{array}\right), \mathbf{X}=\left(\begin{array}{cc}{1} &amp; {x_{1}} \\ {1} &amp; {x_{2}} \\ {\vdots} &amp; {} \\ {1} &amp; {x_{N}}\end{array}\right), \beta=\left(\begin{array}{c}{\beta_{0}} \\ {\beta_{1}}\end{array}\right) \text { and } \varepsilon=\left(\begin{array}{c}{\varepsilon_{1}} \\ {\varepsilon_{2}} \\ {\vdots} \\ {\varepsilon_{N}}\end{array}\right)
\]</span> 然后写出线性模型，如下所示： <span class="math display">\[
Y_{i}=\beta_{0}+\beta_{1} x_{i}+\varepsilon, i=1, \ldots, N
\]</span> 它等于以下形式： <span class="math display">\[
\left(\begin{array}{c}{Y_{1}} \\ {Y_{2}} \\ {\vdots} \\ {Y_{N}}\end{array}\right)=\left(\begin{array}{cc}{1} &amp; {x_{1}} \\ {1} &amp; {x_{2}} \\ {\vdots} &amp; {} \\ {1} &amp; {x_{N}}\end{array}\right)\left(\begin{array}{c}{\beta_{0}} \\ {\beta_{1}}\end{array}\right)+\left(\begin{array}{c}{\varepsilon_{1}} \\ {\varepsilon_{2}} \\ {\vdots} \\ {\varepsilon_{N}}\end{array}\right)
\]</span> 简化一下，就是下面的形式： <span class="math display">\[
\mathrm{Y}=\mathrm{X} \beta+\varepsilon
\]</span> 那么最小二乘方程就变得比较简单，如下所示： <span class="math display">\[
(\mathrm{Y}-\mathrm{X} \boldsymbol{\beta})^{\top}(\mathrm{Y}-\mathrm{X} \boldsymbol{\beta})
\]</span> 现在我们计算的目标就是，找到<span class="math inline">\(\beta\)</span>的值，使得上述方程的值最小，我们可以使用微积分的手段来进行计算。</p>
<h2 id="线性模型的微积分计算">线性模型的微积分计算</h2>
<p>在使用矩阵符号来计算偏微分方程(partial derivative equation)时，需要遵循几个规则。通过当微分方程为0时，计算出<span class="math inline">\(\beta\)</span>，这个就是我们要求的解。在这里，我们上述的微分方程是以下形式： <span class="math display">\[
\begin{array}{c}{2 \mathbf{X}^{\top}(\mathbf{Y}-\mathbf{X} \hat{\boldsymbol{\beta}})=0} \\ {\mathbf{X}^{\top} \mathbf{X} \hat{\boldsymbol{\beta}}=\mathbf{X}^{\top} \mathbf{Y}} \\ {\hat{\boldsymbol{\beta}}=\left(\mathbf{X}^{\top} \mathbf{X}\right)^{-1} \mathbf{X}^{\top} \mathbf{Y}}\end{array}
\]</span> 对于求出的解，也就是<span class="math inline">\(\beta\)</span>，通常在上面加一个帽子结构，即<span class="math inline">\(\hat{\beta}\)</span>，这个表示是对真实的<span class="math inline">\(\beta\)</span>值的估计。这里我们需要记住的是，最小二乘类似于一个幂运算，这个公式类似于<span class="math inline">\(f(x)^{2}\)</span>的导数2<span class="math inline">\(f(x) f^{\prime}(x)\)</span>。</p>
<h2 id="在r中计算lse">在R中计算LSE</h2>
<p>代码如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(UsingR)</div><div class="line">x=father.son$fheight</div><div class="line">y=father.son$sheight</div><div class="line">X &lt;- cbind(<span class="number">1</span>,x)</div><div class="line">betahat &lt;- solve( t(X) %*% X ) %*% t(X) %*% y</div><div class="line"><span class="comment">###or</span></div><div class="line">betahat &lt;- solve( crossprod(X) ) %*% crossprod( X, y )</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt; betahat</div><div class="line">       [,<span class="number">1</span>]</div><div class="line">  <span class="number">33.886604</span></div><div class="line">x  <span class="number">0.514093</span></div></pre></td></tr></table></figure>
<p>通过计算估计的<span class="math inline">\(\hat{\beta_{0}}+\hat{\beta_{1}}x\)</span>就能计算出相应的<span class="math inline">\(x\)</span>的值，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">newx &lt;- seq(min(x),max(x),len=<span class="number">100</span>)</div><div class="line">X &lt;- cbind(<span class="number">1</span>,newx)</div><div class="line">fitted &lt;- X%*%betahat</div><div class="line">plot(x,y,xlab=<span class="string">"Father's height"</span>,ylab=<span class="string">"Son's height"</span>)</div><div class="line">lines(newx,fitted,col=<span class="number">2</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190816192553.jpeg">

</div>
<p>其中，<span class="math inline">\(\hat{\boldsymbol{\beta}}=\left(\mathbf{X}^{\top} \mathbf{X}\right)^{-1} \mathbf{X}^{\top} \mathbf{Y}\)</span>是数据分析中最常用的公式之一，它的一大优势就是可以应用于多种情况，例如在自由落体运算中：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">set.seed(<span class="number">1</span>)</div><div class="line">g &lt;- <span class="number">9.8</span> <span class="comment">#meters per second</span></div><div class="line">n &lt;- <span class="number">25</span></div><div class="line">tt &lt;- seq(<span class="number">0</span>,<span class="number">3.4</span>,len=n) <span class="comment">#time in secs, t is a base function</span></div><div class="line">d &lt;- <span class="number">56.67</span> - <span class="number">0.5</span>*g*tt^<span class="number">2</span> + rnorm(n,sd=<span class="number">1</span>)</div></pre></td></tr></table></figure>
<p>我们几乎用了与前面相同的代码，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">X &lt;- cbind(<span class="number">1</span>,tt,tt^<span class="number">2</span>)</div><div class="line">y &lt;- d</div><div class="line">betahat &lt;- solve(crossprod(X))%*%crossprod(X,y)</div><div class="line">newtt &lt;- seq(min(tt),max(tt),len=<span class="number">100</span>)</div><div class="line">X &lt;- cbind(<span class="number">1</span>,newtt,newtt^<span class="number">2</span>)</div><div class="line">fitted &lt;- X%*%betahat</div><div class="line">plot(tt,y,xlab=<span class="string">"Time"</span>,ylab=<span class="string">"Height"</span>)</div><div class="line">lines(newtt,fitted,col=<span class="number">2</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190816192833.jpeg">

</div>
<p>最终的估计值为：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt; betahat</div><div class="line">         [,<span class="number">1</span>]</div><div class="line">   <span class="number">56.5317368</span></div><div class="line">tt  <span class="number">0.5013565</span></div><div class="line">   -<span class="number">5.0386455</span></div></pre></td></tr></table></figure>
<h2 id="lm函数"><code>lm()</code>函数</h2>
<p>现在我们使用<code>lm()</code>函数来计算一下自由落体运动，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">X &lt;- cbind(tt,tt^<span class="number">2</span>)</div><div class="line">fit=lm(y~X)</div><div class="line">summary(fit)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&gt; summary(fit)</div><div class="line"></div><div class="line">Call:</div><div class="line">lm(formula = y ~ X)</div><div class="line"></div><div class="line">Residuals:</div><div class="line">    Min      1Q  Median      3Q     Max </div><div class="line">-<span class="number">2.5295</span> -<span class="number">0.4882</span>  <span class="number">0.2537</span>  <span class="number">0.6560</span>  <span class="number">1.5455</span> </div><div class="line"></div><div class="line">Coefficients:</div><div class="line">            Estimate Std. Error t value Pr(&gt;|t|)    </div><div class="line">(Intercept)  <span class="number">56.5317</span>     <span class="number">0.5451</span> <span class="number">103.701</span>   &lt;<span class="number">2e-16</span> ***</div><div class="line">Xtt           <span class="number">0.5014</span>     <span class="number">0.7426</span>   <span class="number">0.675</span>    <span class="number">0.507</span>    </div><div class="line">X            -<span class="number">5.0386</span>     <span class="number">0.2110</span> -<span class="number">23.884</span>   &lt;<span class="number">2e-16</span> ***</div><div class="line">---</div><div class="line">Signif. codes:  <span class="number">0</span> ‘***’ <span class="number">0.001</span> ‘**’ <span class="number">0.01</span> ‘*’ <span class="number">0.05</span> ‘.’ <span class="number">0.1</span> ‘ ’ <span class="number">1</span></div><div class="line"></div><div class="line">Residual standard error: <span class="number">0.9822</span> on <span class="number">22</span> degrees of freedom</div><div class="line">Multiple R-squared:  <span class="number">0.9973</span>,	Adjusted R-squared:  <span class="number">0.997</span> </div><div class="line"><span class="literal">F</span>-statistic:  <span class="number">4025</span> on <span class="number">2</span> and <span class="number">22</span> DF,  p-value: &lt; <span class="number">2.2e-16</span></div></pre></td></tr></table></figure>
<p>这个结果与前面的计算结果一致。</p>
<h2 id="总结">总结</h2>
<p>在这一部分中，我们学习了如何使用线性代数来描述线性模型。随后我们研究了几个案例，其中的一些是与实验设计有有。我们还演示了最小二乘估计。但是，我们需要记住，由于y是一个随机变量，这些估计也是随机的。在后面的章节中，我们将学习如何计算这些随机变量，以及随机变量的标准误以及统计推断。</p>
<h2 id="练习-2">练习</h2>
<p>P171</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-tags" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rvdsd.top/2019/08/09/DAL/DALS009_Matrix_Algebra01_Motivating_Examples/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="RVDSD">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RVDSD的个人笔记本">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/09/DAL/DALS009_Matrix_Algebra01_Motivating_Examples/" itemprop="url">DALS009-Matrix Algebra(矩阵代数)01-简单线性回归</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-09T12:00:00+08:00">
                2019-08-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Data-Analysis-for-the-life-sciences/" itemprop="url" rel="index">
                    <span itemprop="name">Data Analysis for the life sciences</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2,982
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  12
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言">前言</h2>
<p>这篇笔记是《Data Analysis for the Life Sciences》的第4章：矩阵代数的第1部分。这一部分的主要内容涉及线性方程的简单理解。</p>
<h2 id="简单案例">简单案例</h2>
<p>在这一部分中，我们将会提到3个例子，第1个来源于物理学(physics)，一个来源于遗传学(genetics)，一具是来源于小鼠实验(mouse experiment)。这3个例子明显不同，但是在分析数据中却都用了相同的统计学方法：拟合线性模型(fitting linear models)。在学习线性模型时，通常使用矩阵代数(Matrix Algebra)来进行讲解和描述。</p>
<h2 id="第1案例-自由落体">第1案例-自由落体</h2>
<p>先来看第1个案例，这个案例是与物理学有关。</p>
<p>试想，你是16世纪的伽里略(Galileo)，你想要描述一个自由落体物体的速度(velocity)。此时，一个助手爬上比萨斜塔，并在上面松开手，落下一个球，同时其他的助手记录一下球在不同时间点的位置。此时，我们就来模拟一下这个过程，在模拟的这个过程里，由于我们已经知道了自由落体运动的公式，因此我们会向这个模拟数据里添加一些检测误差，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">set.seed(<span class="number">1</span>)</div><div class="line">g &lt;- <span class="number">9.8</span> <span class="comment">##meters per second</span></div><div class="line">n &lt;- <span class="number">25</span></div><div class="line">tt &lt;- seq(<span class="number">0</span>,<span class="number">3.4</span>,len=n) <span class="comment">##time in secs, note: we use tt because t is a base function</span></div><div class="line">d &lt;- <span class="number">56.67</span> - <span class="number">0.5</span>*g*tt^<span class="number">2</span> + rnorm(n,sd=<span class="number">1</span>) <span class="comment">##meters</span></div></pre></td></tr></table></figure>
<p>现在绘制出助手们记录的不同时间点的球的位置，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mypar()</div><div class="line">plot(tt,d,ylab=<span class="string">"Distance in meters"</span>,xlab=<span class="string">"Time in seconds"</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190816133037.jpeg">

</div>
<p>假如助手不知道准确的自由落体运行，但是通过观察这个图形，他大致可以推导出这个位置-时间关系应该遵循抛物线，因此可以对上述的数据进行建模，如下所示：</p>
<p><span class="math display">\[
Y_i = \beta_0 + \beta_1 x_i + \beta_2 x_i^2 + \varepsilon_i, i=1,\dots,n
\]</span></p>
<p>其中， <span class="math inline">\(Y_i\)</span> 代表了球的位置， <span class="math inline">\(x_i\)</span> 代表了时间， <span class="math inline">\(\varepsilon_i\)</span> 表示测量误差。这是一个线性模型，因为这个方程是一个已知量（也就是一系列的<span class="math inline">\(x\)</span>，即预测因子(predictors)或协变量(covariates)）和一个未知量（即一系列的<span class="math inline">\(\beta\)</span>）的线性组合。</p>
<h2 id="第2案例-父子身高">第2案例-父子身高</h2>
<p>再来看第2个案例， 这个案例与遗传学有关。</p>
<p>试想，你是19世纪的Francis Galton，你收集了很多对父子的身高，你怀疑身高与遗传因素有关，你的数据如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(UsingR)</div><div class="line">x=father.son$fheight</div><div class="line">y=father.son$sheight</div><div class="line">plot(x,y,xlab=<span class="string">"Father's height"</span>,ylab=<span class="string">"Son's height"</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190816134929.png">

</div>
<p>从这个张图上我们大概能觉得，父亲身高在一定程度上影响了儿子的身高，此时我们就可以构建一个模型来描述这种情况，如下所示： <span class="math display">\[
Y_{i}=\beta_{0}+\beta_{1} x_{i}+\varepsilon, i=1, \ldots, N
\]</span></p>
<p>这也是一个线性模型，其中<span class="math inline">\(x_i\)</span> 表示了第<span class="math inline">\(i\)</span>对父亲的身高，<span class="math inline">\(Y_i\)</span>表示了第<span class="math inline">\(i\)</span>对儿子的身高。而 <span class="math inline">\(\varepsilon_i\)</span>表示其余变量。在这个案例中，我们认为父亲的身高是预测因素，并且是固定的（不是随机的），因此我们使用小写字母来表示父亲的身高。仅仅用测量误差是无法完全解释 <span class="math inline">\(\varepsilon_i\)</span>代表的变异程度，因为这个模型中并没有包含其它的变量，例如母亲的身高，遗传的随机因素以及环境因素也有可能影响儿子的身高。</p>
<h2 id="第3案例-多个总体的抽样">第3案例-多个总体的抽样</h2>
<p>第3个案例有是关小鼠实验的。还以这本书刚开始的案例说明一下，我们有两类小鼠的体重，这两类小鼠分别使用正常饲料(chow)和高脂饲料(high fat, hf)进行饲喂。现在我们从这两个种群的小鼠中各随机抽取12个样本。我们的研究重点在于，饲料的不同是否会影响小鼠的体重，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># library(devtools)</span></div><div class="line"><span class="comment"># install_github("genomicsclass/dagdata")</span></div><div class="line">dir &lt;- system.file(package = <span class="string">"dagdata"</span>)</div><div class="line">list.files(dir)</div><div class="line">dir</div><div class="line">filename &lt;- file.path(dir,<span class="string">"extdata/femaleMiceWeights.csv"</span>)</div><div class="line">dat &lt;- read.csv(filename)</div><div class="line"><span class="comment"># input raw data</span></div><div class="line">head(dat)</div><div class="line">str(dat)</div></pre></td></tr></table></figure>
<p>数据如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&gt; list.files(dir)</div><div class="line">[<span class="number">1</span>] <span class="string">"data"</span>        <span class="string">"DESCRIPTION"</span> <span class="string">"extdata"</span>     <span class="string">"help"</span>        <span class="string">"html"</span>       </div><div class="line">[<span class="number">6</span>] <span class="string">"Meta"</span>        <span class="string">"NAMESPACE"</span>   <span class="string">"script"</span>     </div><div class="line">&gt; dir</div><div class="line">[<span class="number">1</span>] <span class="string">"C:/Users/20161111/Documents/R/win-library/3.5/dagdata"</span></div><div class="line">&gt; filename &lt;- file.path(dir,<span class="string">"extdata/femaleMiceWeights.csv"</span>)</div><div class="line">&gt; dat &lt;- read.csv(filename)</div><div class="line">&gt; <span class="comment"># input raw data</span></div><div class="line">&gt; head(dat)</div><div class="line">  Diet Bodyweight</div><div class="line"><span class="number">1</span> chow      <span class="number">21.51</span></div><div class="line"><span class="number">2</span> chow      <span class="number">28.14</span></div><div class="line"><span class="number">3</span> chow      <span class="number">24.04</span></div><div class="line"><span class="number">4</span> chow      <span class="number">23.45</span></div><div class="line"><span class="number">5</span> chow      <span class="number">23.68</span></div><div class="line"><span class="number">6</span> chow      <span class="number">19.79</span></div><div class="line">&gt; str(dat)</div><div class="line"><span class="string">'data.frame'</span>:	<span class="number">24</span> obs. of  <span class="number">2</span> variables:</div><div class="line"> $ Diet      : Factor w/ <span class="number">2</span> levels <span class="string">"chow"</span>,<span class="string">"hf"</span>: <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="keyword">...</span></div><div class="line"> $ Bodyweight: num  <span class="number">21.5</span> <span class="number">28.1</span> <span class="number">24</span> <span class="number">23.4</span> <span class="number">23.7</span> <span class="keyword">...</span></div></pre></td></tr></table></figure>
<p>查看一下小鼠的体重抽样结果，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">stripchart(Bodyweight~Diet,data=dat,vertical=<span class="literal">TRUE</span>,method=<span class="string">"jitter"</span>,pch=<span class="number">1</span>,main=<span class="string">"Mi\</span></div><div class="line"><span class="string">ce weights"</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190816143047.png">

</div>
<p>假如我们想要判断一下这饮食是否对小鼠的平均体重有所影响。我们可以使用t检验和置信区间来进行统计。同时我们也可以使用一个线性模型来进行精确的检验，如下所示： <span class="math display">\[
Y_{i}=\beta_{0}+\beta_{1} x_{i}+\varepsilon_{i}
\]</span> 其中<span class="math inline">\(\beta_0\)</span>表示了正常饲料饲喂的小鼠平均体重，而<span class="math inline">\(\beta_1\)</span>则表示了高脂饲料(hf)饲喂的小鼠平均体重与正常饲料饲喂小鼠体重的差值，其中 <span class="math inline">\(x_i = 1\)</span> 表示第<span class="math inline">\(i\)</span>只小鼠吃的hf饲料，<span class="math inline">\(x_i = 0\)</span> 表示小鼠吃的是正常饲料，而<span class="math inline">\(\varepsilon_i\)</span>则是说明，源于相同总体的小鼠个体差异。</p>
<p>## 线性模型的一般形式</p>
<p>通过前面的3个案例我们知道了线性模型，包含了上述统计模型的线性模型的一般形式可以写为如下公式： <span class="math display">\[
Y_{i}=\beta_{0}+\beta_{1} x_{i, 1}+\beta_{2} x_{i, 2}+\cdots+\beta_{2} x_{i, p}+\varepsilon_{i}, i=1, \ldots, n
\]</span> 即： <span class="math display">\[
Y_{i}=\beta_{0}+\sum_{j=1}^{p} \beta_{j} x_{i, j}+\varepsilon_{i}, i=1, \ldots, n
\]</span> 在这个公式里，我们使用了一个预测量<span class="math inline">\(p\)</span>，矩阵代数提供了一种精练的语言和数学框架来计算以及推导那些满足上述框架的任何线性模型。</p>
<h2 id="估计参数estimating-parameters">估计参数(Estimating parameters)</h2>
<p>当我们用上述的模型来估计未知量<span class="math inline">\(\beta\)</span>时非常有用。例如，在第1个案例中，我们通过线性模型来计算其中的未知的参数。在第2个案例中，通过估计其中的未知参数，我们可以更好地理解遗传因素(inheritance)在父子身高方面的影响。在第3个案例中，我们想研究饲料是否对小鼠的体重有影响，也就是说我们要计算出<span class="math inline">\(\beta_{1} \neq 0\)</span>。</p>
<p>在科学研究中，标准的做法就是找出能拟合这些数据的线性模型中的那些数值（也就是上面的<span class="math inline">\(\beta_{j}\)</span>），找到的这个线性方向与这些点的距离最小。这个过程通常是通过最小二乘(Least Squares, LS)的思想来实现的，下面的这个公式被称为最小平方(Least squares)方程： <span class="math display">\[
\sum_{i=1}^{n}\left\{Y_{i}-\left(\beta_{0}+\sum_{j=1}^{p} \beta_{j} x_{i, j}\right)\right\}^{2}
\]</span></p>
<p>一旦我们找到了这些值，我们就称这些值为最小二乘估计(Least Squares Estimates, LSE)，并将其命名为<span class="math inline">\(\hat{\beta}\)</span>。当我们在估计值处计算出了最小二乘方程后，上面的那个公式就称为残差平方和(Residual Sum of Squares, RSS)。由于RSS所有的量都是取决于Y，因此这个值是随机变量。</p>
<h2 id="自由落体案例回顾">自由落体案例回顾</h2>
<p>在高中物理课本中我们就知道，自由落体运行的方程为： <span class="math display">\[
d=h_{0}+v_{0} t-0.5 \times 9.8 t^{2}
\]</span> 其中，<span class="math inline">\(h_{0}\)</span>和<span class="math inline">\(v_{0}\)</span>分别是起始的高度与速度。在我们模拟的自由落体运行方程中，<span class="math inline">\(v_{0}=0\)</span>，<span class="math inline">\(h_{0}=56.67\)</span>，R代码如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">g &lt;- <span class="number">9.8</span> <span class="comment">##meters per second</span></div><div class="line">n &lt;- <span class="number">25</span></div><div class="line">tt &lt;- seq(<span class="number">0</span>,<span class="number">3.4</span>,len=n) <span class="comment">##time in secs, t is a base function</span></div><div class="line">f &lt;- <span class="number">56.67</span> - <span class="number">0.5</span>*g*tt^<span class="number">2</span></div><div class="line">y &lt;- f + rnorm(n,sd=<span class="number">1</span>)</div><div class="line"></div><div class="line">png(file=<span class="string">"../Figs/falling.png"</span>, width=<span class="number">1200</span>, height=<span class="number">1200</span>, res=<span class="number">300</span>,</div><div class="line">    pointsize=<span class="number">10</span>)</div><div class="line">plot(tt,y,ylab=<span class="string">"Distance in meters"</span>,xlab=<span class="string">"Time in seconds"</span>)</div><div class="line">lines(tt,f,col=<span class="number">2</span>)</div><div class="line">dev.off()</div></pre></td></tr></table></figure>
<p>我们模拟的自由落体运行图形如下所示：</p>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190816152214.png">

</div>
<p>但是，当我们假设自己是伽利略时，这个方程还没有被推导出来，因此我们并不知道其中相应的参数，这些数据只是表现得像一条抛物线，因此我们可以对这些数据进行建模，如下所示： <span class="math display">\[
Y_{i}=\beta_{0}+\beta_{1} x_{i}+\beta_{2} x_{i}^{2}+\varepsilon, i=1, \ldots, n
\]</span> 此时，我们如何找到LSE？</p>
<h2 id="lm函数">lm()函数</h2>
<p>R中的<code>lm()</code>函数可以很好地计算线性方程，现在我们先来简单计算一下这个方程，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">g &lt;- <span class="number">9.8</span> <span class="comment">##meters per second</span></div><div class="line">tt &lt;- seq(<span class="number">0</span>,<span class="number">3.4</span>,len=n) <span class="comment">##time in secs, t is a base function</span></div><div class="line">y &lt;- f + rnorm(n,sd=<span class="number">1</span>)</div><div class="line">tt2 &lt;-tt^<span class="number">2</span></div><div class="line">fit &lt;- lm(y~tt+tt2)</div><div class="line">summary(fit)$coef</div></pre></td></tr></table></figure>
<p>计算结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt; summary(fit)$coef</div><div class="line">              Estimate Std. Error     t value     Pr(&gt;|t|)</div><div class="line">(Intercept) <span class="number">57.1399311</span>  <span class="number">0.5484054</span> <span class="number">104.1928697</span> <span class="number">3.897090e-31</span></div><div class="line">tt          -<span class="number">0.1997275</span>  <span class="number">0.7470438</span>  -<span class="number">0.2673572</span> <span class="number">7.916846e-01</span></div><div class="line">tt2         -<span class="number">4.9193723</span>  <span class="number">0.2122243</span> -<span class="number">23.1800643</span> <span class="number">5.973048e-17</span></div></pre></td></tr></table></figure>
<p>这样就计算出了LSE，以及标准误，p值。</p>
<h2 id="最小二乘估计the-least-squares-estimate-lse">最小二乘估计(The Least squares estimate, LSE)</h2>
<p>现在我们写一个函数，这个函数的功能在于计算任任<span class="math inline">\(\beta\)</span>的RSS，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">rss &lt;- <span class="keyword">function</span>(Beta0,Beta1,Beta2)&#123;</div><div class="line">    r &lt;- y - (Beta0+Beta1*tt+Beta2*tt^<span class="number">2</span>)</div><div class="line">    <span class="keyword">return</span>(sum(r^<span class="number">2</span>))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所以对于任何三维向量，我们得到一个RSS。下图是当我们保持另外两个<span class="math inline">\(\beta\)</span>固定时，关于<span class="math inline">\(\beta_{2}\)</span>的函数的RSS的曲线，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">rss &lt;- <span class="keyword">function</span>(Beta0,Beta1,Beta2)&#123;</div><div class="line">    r &lt;- y - (Beta0+Beta1*tt+Beta2*tt^<span class="number">2</span>)</div><div class="line">    <span class="keyword">return</span>(sum(r^<span class="number">2</span>))</div><div class="line">&#125;</div><div class="line"></div><div class="line">Beta2s&lt;- seq(-<span class="number">10</span>,<span class="number">0</span>,len=<span class="number">100</span>)</div><div class="line">plot(Beta2s,sapply(Beta2s,rss,Beta0=<span class="number">55</span>,Beta1=<span class="number">0</span>),</div><div class="line">     ylab=<span class="string">"RSS"</span>,xlab=<span class="string">"Beta2"</span>,type=<span class="string">"l"</span>)</div><div class="line"><span class="comment">##Let's add another curve fixing another pair:</span></div><div class="line">Beta2s&lt;- seq(-<span class="number">10</span>,<span class="number">0</span>,len=<span class="number">100</span>)</div><div class="line">lines(Beta2s,sapply(Beta2s,rss,Beta0=<span class="number">65</span>,Beta1=<span class="number">0</span>),col=<span class="number">2</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190816155010.png">

</div>
<p>反复计算在这里行不通，相反，我们会使用微积分(calculus)的方法来进行计算，通过取偏导数(partial derivatives)，将它们设为0，然后求解。当然，如果我们有很多参数，这些方程会变得相当复杂。线性代数为这个问题提供了精练且通用的方法。</p>
<h2 id="galton拓展">Galton拓展</h2>
<p>Galton在研究父子身高问题时，他通过探索性数据分析有了一个新颖的发现，如下所示：</p>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190816155451.png">

</div>
<p>Galton发现，如果他将父子的身高数据制成表格，然后将那些x和y值的和都相同的点连接起来，就构成了一个椭圆。通过计算还会进一步发现，这些数据服从二元正态分布（具体的高尔顿图可以参考《于忠义, YUZhong-yi. 高尔顿发现相关与回归的历史回顾与反思[J]. 统计与信息论坛, 2009, 24(9):17-25.》）如下所示： <span class="math display">\[
\operatorname{Pr}(X&lt;a, Y&lt;b)=\\ \int_{-\infty}^{a} \int_{-\infty}^{b} \frac{1}{2 \pi \sigma_{x} \sigma_{y} \sqrt{1-\rho^{2}}} \exp \left\{\frac{1}{2\left(1-\rho^{2}\right)}\left[\left(\frac{x-\mu_{x}}{\sigma_{x}}\right)^{2}-2 \rho\left(\frac{x-\mu_{x}}{\sigma_{x}}\right)\left(\frac{y-\mu_{y}}{\sigma_{y}}\right)+\left(\frac{y-\mu_{y}}{\sigma_{y}}\right)^{2}\right]\right\}
\]</span> 从上面的公式我们知道，当我们保持<span class="math inline">\(X\)</span>不变时（也就是设定好<span class="math inline">\(x\)</span>），<span class="math inline">\(Y\)</span>的分布是服从正态分布的，即服从均值为<span class="math inline">\(\mu_{x}+\sigma_{y} \rho\left(\frac{x-\mu_{x}}{\sigma_{x}}\right)\)</span>，标准差为<span class="math inline">\(\sigma_{y} \sqrt{1-\rho^{2}}\)</span>的正态分布。<span class="math inline">\(\rho\)</span>是<span class="math inline">\(X\)</span>和<span class="math inline">\(Y\)</span>的相关系数，这就说明，如果我们设定<span class="math inline">\(X=x\)</span>，<span class="math inline">\(Y\)</span>实际上是一个线性模型。在我们的这个简单线性模型中，<span class="math inline">\(\beta_{0}\)</span>和<span class="math inline">\(\beta_{1}\)</span>参数表示为<span class="math inline">\(\mu_{x}, \mu_{y}, \sigma_{x}, \sigma_{y}\)</span>和<span class="math inline">\(\rho\)</span>。</p>
<h2 id="练习">练习</h2>
<p>P152</p>
<h2 id="参考资料">参考资料</h2>
<ol style="list-style-type: decimal">
<li>Rafael A Irizarry and Michael I Love.Data Analysis for the Life Sciences.This book is for sale at http://leanpub.com/dataanalysisforthelifesciences</li>
<li>于忠义, YUZhong-yi. 高尔顿发现相关与回归的历史回顾与反思[J]. 统计与信息论坛, 2009, 24(9):17-25.</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-tags" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rvdsd.top/2019/08/08/DAL/DALS008_Exploratory_Data_Analysis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="RVDSD">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RVDSD的个人笔记本">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/08/DAL/DALS008_Exploratory_Data_Analysis/" itemprop="url">DALS008-数据探索(Exploratory Data Analysis)01-图表</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-08T12:00:00+08:00">
                2019-08-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Data-Analysis-for-the-life-sciences/" itemprop="url" rel="index">
                    <span itemprop="name">Data Analysis for the life sciences</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  9,250
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  38
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言">前言</h2>
<p>这篇笔记是《Data Analysis for the Life Sciences》的第3章：探索性数据分析，主要内容涉及常见图表的解读，数据的描述，秩和检验。</p>
<blockquote>
<p>图片的最大价值就在于能够强迫我们发现一些我们预料不到的东西——John W.Tukey</p>
</blockquote>
<p>生命科学的研究，由于检测存在的误差，会导致一些异常值的出现。如果不没有发现这些问题，那么就会导致错误的分析结果以及假的发现。例如，有时候实验失败，或者是说在分析流程中，对涉及到的所有实验数据都进行检验，也无法发现它们，例如使用R中的<code>t.test()</code>函数。但是，这些分析流程仍然会给我们一些启示。此外，仅仅通过实验报告中的结果，也很难或者是几乎无法发现一些错误。</p>
<p>图表就是一种发现这些问题的强大工具，这一章节的内容就是探索性数据分析(Exploratory Data Analysis,EDA)。现存很多数据分析方法都是通过EDA来得到启示的。此外，EDA还能发现一些有意思的物理物现象，如果使用其它常规的统计学方法，这些现象有可能就会错失。在这本书中，我们会使用探索性数据来选择合适的统计学方法。</p>
<h2 id="qq图">QQ图</h2>
<p>qq图的全称为quantile quantile Plots，它经常用于验证一批数据是否服从正态分布。我们通过一些具体的案例来说明一下什么是分位数。</p>
<p>在一批数据中，第p个百分位数被定义为这个数大于p%的数，具体的定义可以参考以前的笔记<a href="https://www.jianshu.com/p/dd372640b146" target="_blank" rel="external">《StatQuest学习笔记06——分位数及其应用》</a>，再比如中间的50%百分位数就是中位数。</p>
<p>我们可以计算出一批身高的百分位数，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(UsingR) <span class="comment">##available from CRAN</span></div><div class="line"><span class="keyword">library</span>(rafalib)</div><div class="line">x &lt;- father.son$fheight</div><div class="line">head(x)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; head(x)</div><div class="line">[<span class="number">1</span>] <span class="number">65.04851</span> <span class="number">63.25094</span> <span class="number">64.95532</span> <span class="number">65.75250</span> <span class="number">61.13723</span> <span class="number">63.02254</span></div></pre></td></tr></table></figure>
<p>现在我们计算一批服合正态分布的数据：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">ps &lt;- (seq(<span class="number">0</span>,<span class="number">99</span>) + <span class="number">0.5</span> )/<span class="number">100</span></div><div class="line"><span class="comment"># Calculate standard quantile</span></div><div class="line">qs &lt;- quantile(x, ps)</div><div class="line"><span class="comment"># produces sample quantiles corresponding to the given probabilitie</span></div><div class="line"><span class="comment"># For example</span></div><div class="line"><span class="comment"># ps2 &lt;- c(0.005,0.515,0.995)</span></div><div class="line"><span class="comment"># quantile(x,ps2)</span></div><div class="line"><span class="comment"># &gt; quantile(x,ps2)</span></div><div class="line"><span class="comment"># 0.5%    51.5%    99.5% </span></div><div class="line"><span class="comment"># 60.29272 67.84169 74.58332 </span></div><div class="line">normalqs &lt;- qnorm(ps, mean(x), popsd(x))</div><div class="line">plot(normalqs,qs,xlab=<span class="string">"Normal percentiles"</span>,ylab=<span class="string">"Height percentiles"</span>)</div><div class="line">abline(<span class="number">0</span>,<span class="number">1</span>) <span class="comment">##identity line</span></div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190810131549.jpeg">

</div>
<p>上图显示的是，(<code>mean(x)</code>)为均值，总体方差为（<code>pposd(x)</code>）的正态分布数据集的qq图，这里的x指的是前文提到的father.son中fheight的身高，也就是父亲的身高，这里的qq图是理论上的qq图，代码中的<code>qnorm()</code>函数用于计算正态分布中的第p个分位一数的Z-score，具体的可以参考这篇笔记<a href="https://www.jianshu.com/p/a24eb1b94177" target="_blank" rel="external">《R语言中dnorm, pnorm, qnorm与rnorm以及随机数》</a>，现在看一下实际的qq图，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">qqnorm(x)</div><div class="line">qqline(x)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190810134743.jpeg">

</div>
<p><code>qqnorm()</code>函数绘制的图形都是按照标准正态分布来进行绘制，因此，上图中的直接斜率为<code>popas(x)</code>，截矩为<code>mean(x)</code>。</p>
<p>在前面的案例中，多数点与直线的匹配程度都非常好，实际上，我们可以使用Monte Carlo来模拟一下已知数据是否符合正态分布，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">n &lt;-1000</div><div class="line">x &lt;- rnorm(n)</div><div class="line">qqnorm(x)</div><div class="line">qqline(x)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190810135337.jpeg">

</div>
<p>现在我们来模拟一下不符合正态分布的数据在qq图中是什么样子的，我们从不同自由度的t分布的数据中来抽取一些数据来画图，服从t分布的数据有这么一个特点：自由度越低，t分布的尾部就越平坦，自由度越高，尾部越高，整体越接近正态分布。在qq图中，我们可以看到，在qq图的左侧，这些数据点低于直线，而在右侧，这些点高于直线，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">dfs &lt;- c(<span class="number">3</span>,<span class="number">6</span>,<span class="number">12</span>,<span class="number">30</span>)</div><div class="line">mypar(<span class="number">2</span>,<span class="number">2</span>)</div><div class="line"><span class="keyword">for</span>(df <span class="keyword">in</span> dfs)&#123;</div><div class="line">x &lt;- rt(<span class="number">1000</span>,df)</div><div class="line">qqnorm(x,xlab=<span class="string">"t quantiles"</span>,main=paste0(<span class="string">"d.f="</span>,df),ylim=c(-<span class="number">6</span>,<span class="number">6</span>))</div><div class="line">qqline(x)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190810140047.jpeg">

</div>
<h2 id="箱线图boxplot">箱线图(boxplot)</h2>
<p>我们获取的数据并非总是符合正态分布的，例如收入(income)就不符合正态分布，对于那些不符合正态分布的数据来说，谈论均值与标准差就没有多大意义，因为我们无法从均值与标准差中推测出相应的总体信息，只有数据符合正态时，谈论均值与标准差才有意义，现在我们来看一下2000年美国CEO的收入，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(rafalib)</div><div class="line"><span class="keyword">library</span>(UsingR)</div><div class="line">mypar(<span class="number">1</span>,<span class="number">2</span>)</div><div class="line">hist(exec.pay)</div><div class="line">qqnorm(exec.pay)</div><div class="line">qqline(exec.pay)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190812153606.jpeg">

</div>
<p>除了使用QQ外，另外一种估计数据的实用手段就是计算一组数据的25%，50%与75%分位数。箱线图就能展示这3个计算值，以及这些数据的范围，即中位数±1.5（75%百分位数-25%百分位数）。超过这个范围的数据点有时候称为异常值(outliers)。</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">boxplot(exec.pay, ylab=<span class="string">"10,000s of dollars"</span>,ylim=c(<span class="number">0</span>,<span class="number">400</span>))</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190812154457.png">

</div>
<h2 id="散点图与相关scatterplots-and-correlation">散点图与相关(Scatterplots And Correlation)</h2>
<p>前面提到的方法都是单变量(univariate variables)。而在生物学研究中，我们往往关注两个变量或多个变量之间的关系。一个典型的案例就是Francis Galton通过计算父亲与儿子身高的关系来理解遗传学。如果我们想要计算一下这些数据，我们就能利用这两组数据（也就是父亲的身高这一组数据与儿子的身高这一组数据）的均值与标准差来描述这些数据，因为身高这种数据是符合正态分布的。但是，我们通常这种常规方法无法找出这两组数据的关系，先来看一下散点图，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(UsingR)</div><div class="line">data(<span class="string">"father.son"</span>)</div><div class="line">x &lt;- father.son$fheight</div><div class="line">y &lt;- father.son$sheight</div><div class="line">plot(x,y, xlab=<span class="string">"Father's height in inches"</span>,ylab=<span class="string">"Son's height in inches"</span>,main=paste(<span class="string">"Correlation="</span>, signif(cor(x,y),<span class="number">2</span>)))</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190812155537.png">

</div>
<p>这个散点图展示出了一个趋势：父亲越高，儿子就越高。这个趋势可以使用相关系数(correlation coefficient)来表示，这个案例中的相关系数是0.5。也就是说我们可以使用父亲的身高来预测儿子的身高。</p>
<h2 id="分层stratification">分层(Stratification)</h2>
<p>现在我们假设一种场景，比如我们随机地选取一个儿子来猜测他的身高，其中儿子这一组数据的平均身高是68.7英寸（），这个身高所占的比例是最大的（可以看直方图），因此我们可以根据这个预测一个儿子的身高。但是，如果我们被告知，这个选中的儿子的父亲身高是72英寸，那么我们还会猜测这个儿子身高是68.7英寸么？</p>
<p>父亲的身高是高于平均值的，尤其是当这个父亲的身高还高于父亲这一组数据均值的1.75个标准差时。我们有可能会预测，这个父亲的儿子身高是否也高于1.75个标准差？结果发现，这个结果是高估了。为了验证这个结果，我们来看一下，那些身高约为72英寸的父亲的儿子的身高，我们可以对父亲这一组数据进行分层(stratifying)。</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">groups &lt;- split(y, round(x))</div><div class="line">boxplot(groups)</div><div class="line">print(mean(y[ round(x) == <span class="number">72</span>]))</div><div class="line"><span class="comment"># [1] 70.67719</span></div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190812161555.png">

</div>
<p>对数据进行分层后，再绘制箱线图，我们就可以看到每组数据的分布。身高约为72英寸父亲的平均身高是70.7英寸。我们还能看到，分层后的数据的中位数大概是一条直接（箱线图中间的线是中位数值，而非均值）。中位数构成的这条直线比较类似于回归线(regression line)，而回归线的斜率与相关有关。</p>
<h2 id="二元正态分布bi-variate-normal-distribution">二元正态分布(Bi-variate Normal Distribution)</h2>
<p>一对随机变量，例如(X,Y)，当它们值的比例可以按照以下公式来表示时，例如a和b，就可以认为它们接近二元正态分布：</p>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190812164350.png">

</div>
<p>上面的这个公式看起来很复杂，但是背后的原理非常简单。另外一种比较简单的理解就是：先固定一个值x，然后观察当X=x时，所有的点(X,Y)。通常来说，在统计学中我们把这一过程称为设定条件(conditioning)。我们可以根据X来设定Y。如果一对随机变量接近双变量正态分布，那么X=x时，Y的分布也就服从一个正态分布，而x的值可以是任意的，现在我们来看一下身高数据，看一下上述的思路是否符合，身高数据一共分为4层，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">groups &lt;- split(y, round(x))</div><div class="line">mypar(<span class="number">2</span>,<span class="number">2</span>)</div><div class="line"><span class="keyword">for</span> (i <span class="keyword">in</span> c(<span class="number">5</span>,<span class="number">8</span>,<span class="number">11</span>,<span class="number">14</span>))&#123;</div><div class="line">  qqnorm(groups[[i]], main = paste0(<span class="string">"X="</span>, names(groups)[i],<span class="string">" strate"</span>),</div><div class="line">         ylim=range(y), xlim=c(-<span class="number">2.5</span>, <span class="number">2.5</span>))</div><div class="line">  qqline(groups[[i]])</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190812180851.png">

</div>
<p>当两个变量服从双变量正态分布时，从数学统计学的公式就可以知道，对于给定的x值，相对应的Y（与X=x配对）平均值为： <span class="math display">\[
\mu_{Y}+\rho \frac{X-\mu_{X}}{\sigma_{X}} \sigma_{Y}
\]</span> 从上面公式我们可以知道，这个直线的斜率为<span class="math inline">\(\rho \frac{\sigma_{Y}}{\sigma_{X}}\)</span>，这个直线就是回归直线(regression line)。如果SD一样，那么这个回归线的斜率就是<span class="math inline">\(\rho\)</span>。因此，如果我们对X和Y进行标准化后，那么相关(correlation)就是这个回归直线的斜率。</p>
<p>这个公式的另外一种表示就是我们可以构建一个预测值<span class="math inline">\(\hat{Y}\)</span>：即对于距离x均值1个SD的x值，我们可以预测相应Y的值，是远离y均值的<span class="math inline">\(\rho\)</span>个SD的值，如下所示： <span class="math display">\[
\frac{\hat{Y}-\mu_{Y}}{\sigma_{Y}}=\rho \frac{x-\mu_{X}}{\sigma_{X}}
\]</span> 如果两个变量，即X和Y存在着很好的相关性，那么我们可以预测出相同的SD数目。如果相关性为0，那么我们就无法根据x的值来预测y的值。现在我们在计算一下每层的均值，进而确定回归直线：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">x=( x-mean(x) )/sd(x)</div><div class="line">y=( y-mean(y) )/sd(y)</div><div class="line">means=tapply(y, round(x*<span class="number">4</span>)/<span class="number">4</span>, mean)</div><div class="line">fatherheights=as.numeric(names(means))</div><div class="line">mypar(<span class="number">1</span>,<span class="number">1</span>)</div><div class="line">plot(fatherheights, means, ylab=<span class="string">"average of strata of son heights"</span>, ylim=range(fatherheights))</div><div class="line">abline(<span class="number">0</span>, cor(x,y))</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190812201906.png">

</div>
<h2 id="方差解释variance-explained">方差解释(Variance explained)</h2>
<p>前面提到的条件分布(conditional distribution)的标准差如下所示： <span class="math display">\[
\sqrt{1-\rho^{2}} \sigma_{Y}
\]</span> 这个公式与X能够解释Y的多少方差类似，这个解释程度是<span class="math inline">\(\rho^{2} \times 100 \%\)</span>。而上述的那个公式中：Y的方差是<span class="math inline">\(\rho^{2}\)</span>，如果给定X的值，那么Y自身能够解释Y值波动的程度就是$ (1-^{2}) _{Y}^{2} $。这个里我们只需要记住，方差解释(variance explained)这种表述只有在两组数据接近双变量正态分布(bivariate normal distribution)的情况下才有意义（注：对于书中的这段话我没太明白，按照自己的理解来记的笔记）。</p>
<h2 id="绘图原则">绘图原则</h2>
<p>优秀数据图主要是为了能够准确清楚地展示你的数据，Karl Broman（注：此人是华盛顿大学生物统计与医学信息学系教授，主要研究统计遗传学）提出了几点绘图中要避开以下操作：</p>
<ul>
<li>展示信息太少(Display as little information as possible)；</li>
<li>阅读体验不好（乱堆图表）(Obscure what you do show (with chart junk))；</li>
<li>使用伪3D图形，瞎用颜色(Use pseudo-3D and color gratuitously)；</li>
<li>随意使用饼图（尤其是各种颜色与3D饼图）(Make a pie chart (preferably in color and 3D))；</li>
<li>没有图例(Use a poorly chosen scale)；</li>
<li>没有展示有效数字(Ignore significant figures)。</li>
</ul>
<h2 id="常见各种图形">常见各种图形</h2>
<p>这一部分涉及常见的各种图形，例如饼图，柱状图等。</p>
<h3 id="饼图pie-charts">饼图(pie charts)</h3>
<p>现在我们来看一个数据，这个数据是2013年的调查的各个浏览器的使用率，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">browsers &lt;- c(Opera=<span class="number">1</span>,Safari=<span class="number">9</span>,Firefox=<span class="number">20</span>,IE=<span class="number">26</span>,Chrome=<span class="number">44</span>)</div><div class="line">pie(browsers,main=<span class="string">"Browser Usage (August 2013)"</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190813090542.png">

</div>
<p>但是饼图有很大局限，在R中，我们查看一下<code>pie()</code>函数的说明，如下所示： &gt; “Pie charts are a very bad way of displaying information. The eye is good at judging &gt; linear measures and bad at judging relative areas. A bar chart or dot chart is a preferable &gt; way of displaying this type of data.”</p>
<p>上述就提到了，饼图展示的信息有限。人眼善于判断线性度量，不善于判断面积度量。因此，使用条形图来展示相关的信息比饼图更好。</p>
<p>从饼图中我们只能看出每个浏览器的占有率，但是，除非这些占有率接近25%，50%或75%，否则也不太容易看出来，此时如果直接展示数字反而好一些。为了更好地展示数据，现在使用柱状图(barplot)来看一下这些数据，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">barplot(browsers, main=<span class="string">"Browser Usage (August 2013)"</span>, ylim=c(<span class="number">0</span>,<span class="number">55</span>))</div><div class="line">abline(h=<span class="number">1</span>:<span class="number">5</span> * <span class="number">10</span>)</div><div class="line">barplot(browsers, add=<span class="literal">TRUE</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190813091355.png">

</div>
<p>从柱状图上的柱子，以及平行于x轴的几条水平线我们就很容易看到每个浏览器的市场占有率。不过在画柱状图的时候，要避免画成3D的，因为3D图很直观地看到其顶部对应的数字，如下所示：</p>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190813092149.png">

</div>
<p>更差的是画环形图(donut plot)，如下所示：</p>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190813092246.png">

</div>
<h3 id="柱状图barplot">柱状图(barplot)</h3>
<p>这里注明一下，barplot有的翻译为柱状图，有的翻译为条形图，我觉得是一样的，这两种图形的x轴（或y轴）上都是分类变量，而不是连续变量。需要与柱状图进行区分的则是直方图(histogram)，直方图的x轴上是连续变量。</p>
<p>虽然柱状图在展示百分比方面很有用，但是柱状图经常被错误地用于比较两组数据，在这类应用中，常常用均值作为柱子的高度，使用误差棒来表示标准误，如下所示：</p>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190813093556.png">

</div>
<p>这种图展示的信息很少，例如没有说明数据的分布情况。其实针对这种情况，使用箱线图(boxplot)更合适，如果数据点比较少，可以直接在箱线图上添加上数据点。如果数据点很多，只用画箱线图，不加数据点注行。如果在箱线图函数<code>boxplot()</code>中添加上<code>range=0</code>参数的话，也可以不绘制离群点(outlier)，现在我们绘制箱线图，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">x &lt;- rnorm(<span class="number">8</span>,<span class="number">30</span>,<span class="number">5</span>)</div><div class="line">y &lt;- rnorm(<span class="number">8</span>,<span class="number">38</span>,<span class="number">5</span>)</div><div class="line"></div><div class="line"><span class="keyword">library</span>(rafalib)</div><div class="line">mypar()</div><div class="line">dat &lt;- list(Treatment=x,Control=y)</div><div class="line">boxplot(dat,xlab=<span class="string">"Group"</span>,ylab=<span class="string">"Response"</span>,cex=<span class="number">0</span>)</div><div class="line">stripchart(dat,vertical=<span class="literal">TRUE</span>,method=<span class="string">"jitter"</span>,pch=<span class="number">16</span>,add=<span class="literal">TRUE</span>,col=<span class="number">1</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190813094533.jpeg">

</div>
<p>从上面的箱线图我们可以看到以下信息： - 数据的中心； - 数据的分布，范围； - 所有的数据点。</p>
<p>而在柱状图中，我们仅能看到均值与SE，况且SE还与样本的数目(sample size)有关，无法发现数据的分布规律。当我们的数据有离群点或者是有很大拖尾时(very large tails)时，柱状图的一些局限就会更加明显，在下面的图形中我们会觉得这两组数据的差异非常大：</p>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190813095001.png">

</div>
<p>但是，如果我们仔细研究一下这两组数据，就会发现，这两组数据的差异主要是由第二数据的两个离群值导致的，为了解决这个问题，现在我们分别绘制一下常规的箱线图以及经过log转换后的箱线图，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(rafalib)</div><div class="line">mypar(<span class="number">1</span>,<span class="number">2</span>)</div><div class="line"></div><div class="line">x &lt;- <span class="number">10</span>^rnorm(<span class="number">10</span>,<span class="number">0.2</span>)</div><div class="line">y &lt;- <span class="number">10</span>^rnorm(<span class="number">10</span>,<span class="number">1.2</span>)</div><div class="line"></div><div class="line">dat &lt;- list(Treatment=x,Control=y)</div><div class="line">boxplot(dat,xlab=<span class="string">"Group"</span>,ylab=<span class="string">"Response"</span>,cex=<span class="number">0</span>)</div><div class="line">stripchart(dat,vertical=<span class="literal">TRUE</span>,method=<span class="string">"jitter"</span>,pch=<span class="number">16</span>,add=<span class="literal">TRUE</span>,col=<span class="number">1</span>)</div><div class="line">boxplot(dat,xlab=<span class="string">"Group"</span>,ylab=<span class="string">"Response"</span>,log=<span class="string">"y"</span>,cex=<span class="number">0</span>)</div><div class="line">stripchart(dat,vertical=<span class="literal">TRUE</span>,method=<span class="string">"jitter"</span>,pch=<span class="number">16</span>,add=<span class="literal">TRUE</span>,col=<span class="number">1</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190813095508.png">

</div>
<h3 id="散点图scatter-plot">散点图(scatter plot)</h3>
<p>许多统计分析研究的目标就是找到两个变量的关系。在这些统计结果中通常会报告简单的相关性(correlation)，有时候还会画出相应的图形。但是，仅仅展示出一个回归直线(regression line)还不够，因为直线无法显示出背后的数据，此时最好还要加上数据点，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">x &lt;- rnorm(<span class="number">100</span>,<span class="number">100</span>,<span class="number">10</span>)</div><div class="line">y &lt;- <span class="number">100</span>+<span class="number">10</span>*sqrt(<span class="number">2</span>*(x-min(x)))+rnorm(<span class="number">100</span>,<span class="number">0</span>,<span class="number">10</span>)</div><div class="line">mypar(<span class="number">1</span>,<span class="number">2</span>)</div><div class="line">plot(x,y,lwd=<span class="number">2</span>,type=<span class="string">"n"</span>)</div><div class="line">fit &lt;- lm(y~x)</div><div class="line">abline(fit$coef,lwd=<span class="number">2</span>)</div><div class="line">b &lt;- round(fit$coef,<span class="number">4</span>)</div><div class="line">text(<span class="number">78</span>, <span class="number">200</span>, paste(<span class="string">"y ="</span>, b[<span class="number">1</span>], <span class="string">"+"</span>, b[<span class="number">2</span>], <span class="string">"x"</span>), adj=c(<span class="number">0</span>,<span class="number">0.5</span>))</div><div class="line">rho &lt;- round(cor(x,y),<span class="number">4</span>)</div><div class="line">text(<span class="number">78</span>, <span class="number">187</span>,expression(paste(rho,<span class="string">" = 0.8567"</span>)),adj=c(<span class="number">0</span>,<span class="number">0.5</span>))</div><div class="line">plot(x,y,lwd=<span class="number">2</span>)</div><div class="line">fit &lt;- lm(y~x)</div><div class="line">abline(fit$coef,lwd=<span class="number">2</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190813100648.jpeg">

</div>
<h3 id="高度的相关性并不意味着相同high-correlation-does-not-imply-replication">高度的相关性并不意味着相同(High correlation does not imply replication)</h3>
<p>当出现一个新的技术，或者是在实验室中引入一项新技术时，我们通常会用这些技术来检测相同的样本(replicated sample)，进而绘制出散点图来看一下它们的相关性。高度的相关性(high correlation)用于评估这项新技术是否有重现性(reproducible)。</p>
<p>但是，相关性有时候也会误导人(misleading)，下面的散点图展示的是一项高通量技术对相同样本的检测结果。这项技术同时输出12626个检测值。在下图的左侧中，我们可以看到原始数据显示出很高的相关性。但是这组数据拖尾严重(very fat tails)，其中有95%的数据是在绿线以下，另外，下图的右侧是经过log转换后的图：</p>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190813105226.png">

</div>
<p>虽然上面两张图都显示出了高度的相关性（都接近1）。这是否就意味着这些数据能够重复？为了研究第二次检测的结果能否重现第一次的检测，我们需要研究这两组数据的差值。为此，我们可以绘制差值与均值的图型，如下所示：</p>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190813112113.png">

</div>
<p>上面的这种分析方法叫Bland-Altman绘图法，也叫MA图。MA的意思是minus与average，因为在这种图中上，y轴表示了两个样本数据经过log转换后，取的差值，x轴表示的是两个样本的数据经过log转换后，两个数据的平均值。在这张图形中，我们使用的是log2转换，从y轴上可以看到，两次测量后的差值多数情况下是1。这意味着当测量应该相同时，我们将平均观察到2倍的差异。我们现在可以将这种可变性(variability)与检测的差值(differences)进行比较，从而决定这项技术是否达到了我们想要的精度。</p>
<h3 id="配对数据的柱状图">配对数据的柱状图</h3>
<p>数据分析的一项常规任务就是比较两组数据。当数据集比较小，并且是配对数据（例如治疗前与治疗后），可以使用两种颜色的柱状图来展示结果，如下所示：</p>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190813165133.png">

</div>
<p>除此之外，还有更好的展示数据的方式，这些展示方式能够看到治疗效果。第一种就是简单地绘制散点图，从散点图中我们可以发现，多数点都在直线上方。另外一种就是绘制箱线图。 先看散点图，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">set.seed(<span class="number">12201970</span>)</div><div class="line">before &lt;- runif(<span class="number">6</span>, <span class="number">5</span>, <span class="number">8</span>)</div><div class="line">after &lt;- rnorm(<span class="number">6</span>, before*<span class="number">1.05</span>, <span class="number">2</span>)</div><div class="line">li &lt;- range(c(before, after))</div><div class="line">ymx &lt;- max(abs(after-before))</div><div class="line">mypar(<span class="number">1</span>,<span class="number">2</span>)</div><div class="line">plot(before, after, xlab=<span class="string">"Before"</span>, ylab=<span class="string">"After"</span>,</div><div class="line">     ylim=li, xlim=li)</div><div class="line">abline(<span class="number">0</span>,<span class="number">1</span>, lty=<span class="number">2</span>, col=<span class="number">1</span>)</div><div class="line">plot(before, after-before, xlab=<span class="string">"Before"</span>, ylim=c(-ymx, ymx),</div><div class="line">     ylab=<span class="string">"Change (After - Before)"</span>, lwd=<span class="number">2</span>)</div><div class="line">abline(h=<span class="number">0</span>, lty=<span class="number">2</span>, col=<span class="number">1</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190813165425.png">

</div>
<p>从上图可以看出来，右侧的图比较像MA图，其实就是相当于把左侧的散点图旋转了一下。</p>
<p>散点图中的直线并不直观，而箱线图则能很好地显示变化的效果，但是会丧失配对信息，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">z &lt;- rep(c(<span class="number">0</span>,<span class="number">1</span>), rep(<span class="number">6</span>,<span class="number">2</span>))</div><div class="line">mypar(<span class="number">1</span>,<span class="number">2</span>)</div><div class="line">plot(z, c(before, after),</div><div class="line">xaxt=<span class="string">"n"</span>, ylab=<span class="string">"Response"</span>,</div><div class="line">xlab=<span class="string">""</span>, xlim=c(-<span class="number">0.5</span>, <span class="number">1.5</span>))</div><div class="line">axis(side=<span class="number">1</span>, at=c(<span class="number">0</span>,<span class="number">1</span>), c(<span class="string">"Before"</span>,<span class="string">"After"</span>))</div><div class="line">segments(rep(<span class="number">0</span>,<span class="number">6</span>), before, rep(<span class="number">1</span>,<span class="number">6</span>), after, col=<span class="number">1</span>)</div><div class="line">boxplot(before,after,names=c(<span class="string">"Before"</span>,<span class="string">"After"</span>),ylab=<span class="string">"Response"</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190813170145.png">

</div>
<h3 id="折线图line-chart">折线图(line chart)</h3>
<p>先看一个反面典型：</p>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190813172337.png">

</div>
<p>这个折线图是一个伪3D图，它表示的信息不清楚，也许是为了区分这三条曲线，但是，从这3条曲线上的点很难找到对应的数值，这种图不推荐使用。</p>
<p>现在来看一个比较正常的图表，代码如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">log_dose &lt;- <span class="number">1</span>:<span class="number">10</span></div><div class="line">Drug_A &lt;- c(<span class="number">0.8</span>, <span class="number">0.75</span>, <span class="number">0.76</span>, <span class="number">0.71</span>, <span class="number">0.73</span>, <span class="number">0.7</span>,<span class="number">0.67</span>,<span class="number">0.66</span>,<span class="number">0.68</span>,<span class="number">0.65</span>)</div><div class="line">Drug_B &lt;- c(<span class="number">0.75</span>,<span class="number">0.73</span>,<span class="number">0.7</span>,<span class="number">0.65</span>,<span class="number">0.62</span>,<span class="number">0.5</span>,<span class="number">0.3</span>,<span class="number">0.28</span>,<span class="number">0.27</span>,<span class="number">0.29</span>)</div><div class="line">Drug_C &lt;- c(<span class="number">0.92</span>,<span class="number">0.9</span>,<span class="number">0.87</span>,<span class="number">0.75</span>,<span class="number">0.74</span>,<span class="number">0.73</span>,<span class="number">0.64</span>,<span class="number">0.6</span>,<span class="number">0.58</span>,<span class="number">0.52</span>)</div><div class="line">x &lt;- data.frame(log_dose,Drug_A,Drug_B,Drug_C)</div><div class="line">plot(x[,<span class="number">1</span>],x[,<span class="number">2</span>],xlab=<span class="string">"log Dose"</span>,ylab=<span class="string">"Proportion survived"</span>,ylim=c(<span class="number">0</span>,<span class="number">1</span>),</div><div class="line">     type=<span class="string">"l"</span>,lwd=<span class="number">2</span>,col=<span class="number">1</span>)</div><div class="line">lines(x[,<span class="number">1</span>],x[,<span class="number">3</span>],lwd=<span class="number">2</span>,col=<span class="number">2</span>)</div><div class="line">lines(x[,<span class="number">1</span>],x[,<span class="number">4</span>],lwd=<span class="number">2</span>,col=<span class="number">3</span>)</div><div class="line">legend(<span class="number">1</span>,<span class="number">0.3</span>,c(<span class="string">"Drug A"</span>,<span class="string">"Drug B"</span>,<span class="string">"Drug C"</span>),lwd=<span class="number">2</span>, col=<span class="number">1</span>:<span class="number">3</span>,horiz=<span class="literal">T</span>,bty = <span class="string">"n"</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190813174434.jpeg">

</div>
<h3 id="添加重要信息">添加重要信息</h3>
<p>在下面的案例中，我们会模拟生成一批数据来研究两组之间的关系：对照组与治疗组。每组分别有3次实验，现在我们使用普通的柱状图来描述一下这两种干预结果，如下所示：</p>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190813182210.png">

</div>
<p>这类图形并没有很好地展示不同药物剂量的治疗效果，也就是没有展示出量效关系这种重要信息，现在我们使用折线图来展示一下这些信息，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">x &lt;- <span class="number">1</span>:<span class="number">8</span></div><div class="line">y1 &lt;- <span class="number">0.9</span> - x/<span class="number">80</span> + rnorm(length(x), <span class="number">0</span>, <span class="number">0.02</span>)</div><div class="line">y2 &lt;- <span class="number">0.9</span> - x/<span class="number">40</span> + rnorm(length(x), <span class="number">0</span>, <span class="number">0.02</span>)</div><div class="line">y3 &lt;- <span class="number">0.85</span> - x/<span class="number">30</span> + rnorm(length(x), <span class="number">0</span>, <span class="number">0.02</span>)</div><div class="line">y &lt;- cbind(y1, y2, y3)</div><div class="line"></div><div class="line">z1 &lt;- <span class="number">0.95</span> - x/<span class="number">40</span> + rnorm(length(x), <span class="number">0</span>, <span class="number">0.02</span>)</div><div class="line">z2 &lt;- ilogit(-<span class="number">0.4</span>*(x-<span class="number">4.5</span>) + rnorm(length(x), <span class="number">0</span>, <span class="number">0.04</span>))</div><div class="line">z3 &lt;- ilogit(-<span class="number">0.5</span>*(x-<span class="number">4.5</span>) + rnorm(length(x), <span class="number">0</span>, <span class="number">0.04</span>))</div><div class="line">z1[<span class="number">6</span>:<span class="number">8</span>] &lt;- z1[<span class="number">6</span>:<span class="number">8</span>] - <span class="number">0.18</span>*<span class="number">3</span></div><div class="line">z &lt;- cbind(z1, z2, z3)</div><div class="line">ym &lt;- apply(y, <span class="number">1</span>, mean)</div><div class="line">zm &lt;- apply(z, <span class="number">1</span>, mean)</div><div class="line"></div><div class="line">dev.off()</div><div class="line">png(file=<span class="string">"../fig9b.png"</span>, width=<span class="number">1200</span>, height=<span class="number">1000</span>, res=<span class="number">288</span>,pointsize=<span class="number">12</span>)</div><div class="line">bgcolor &lt;- rgb(<span class="number">0</span>, <span class="number">0</span>, <span class="number">98</span>, maxColorValue=<span class="number">255</span>)</div><div class="line">par(las=<span class="number">1</span>,fg=<span class="string">"white"</span>,col=<span class="string">"white"</span>,col.axis=<span class="string">"white"</span>,col.lab=<span class="string">"white"</span>,</div><div class="line">    bg=bgcolor,mar=c(<span class="number">0.1</span>,<span class="number">0.1</span>,<span class="number">0.1</span>,<span class="number">0.1</span>))</div><div class="line">plot(x, y1, ylim=c(<span class="number">0</span>,<span class="number">1</span>), type=<span class="string">"n"</span>, xlab=<span class="string">"Dose"</span>, ylab=<span class="string">"Response"</span>)</div><div class="line"><span class="keyword">for</span>(i <span class="keyword">in</span> <span class="number">1</span>:<span class="number">3</span>) lines(x, y[,i], col=<span class="number">1</span>, lwd=<span class="number">1</span>, lty=<span class="number">2</span>)</div><div class="line"><span class="keyword">for</span>(i <span class="keyword">in</span> <span class="number">1</span>:<span class="number">3</span>) lines(x, z[,i], col=<span class="number">2</span>, lwd=<span class="number">1</span>, lty=<span class="number">2</span>)</div><div class="line">lines(x, ym, col=<span class="number">1</span>, lwd=<span class="number">2</span>)</div><div class="line">lines(x, zm, col=<span class="number">2</span>, lwd=<span class="number">2</span>)</div><div class="line">legend(<span class="string">"bottomleft"</span>, lwd=<span class="number">2</span>, col=c(<span class="number">1</span>, <span class="number">2</span>), c(<span class="string">"Control"</span>, <span class="string">"Treated"</span>))</div><div class="line">dev.off()</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190813182044.png">

</div>
<h2 id="有效数字">有效数字</h2>
<p>R的统计结果的小数点数位很多，有的时候直接粘贴比较麻烦，此时就可以减少一些小数位，先来看一批数据，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">heights &lt;- cbind(rnorm(<span class="number">8</span>,<span class="number">73</span>,<span class="number">3</span>),rnorm(<span class="number">8</span>,<span class="number">73</span>,<span class="number">3</span>),rnorm(<span class="number">8</span>,<span class="number">80</span>,<span class="number">3</span>),</div><div class="line">                 rnorm(<span class="number">8</span>,<span class="number">78</span>,<span class="number">3</span>),rnorm(<span class="number">8</span>,<span class="number">78</span>,<span class="number">3</span>))</div><div class="line">colnames(heights)&lt;-c(<span class="string">"SG"</span>,<span class="string">"PG"</span>,<span class="string">"C"</span>,<span class="string">"PF"</span>,<span class="string">"SF"</span>)</div><div class="line">rownames(heights)&lt;- paste(<span class="string">"team"</span>,<span class="number">1</span>:<span class="number">8</span>)</div><div class="line">heights</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&gt; heights</div><div class="line">             SG       PG        C       PF       SF</div><div class="line">team <span class="number">1</span> <span class="number">70.28569</span> <span class="number">73.53063</span> <span class="number">77.97624</span> <span class="number">75.53098</span> <span class="number">79.91438</span></div><div class="line">team <span class="number">2</span> <span class="number">69.13691</span> <span class="number">72.98393</span> <span class="number">79.53870</span> <span class="number">77.05309</span> <span class="number">73.23242</span></div><div class="line">team <span class="number">3</span> <span class="number">69.66017</span> <span class="number">70.11667</span> <span class="number">80.43766</span> <span class="number">80.39365</span> <span class="number">76.69519</span></div><div class="line">team <span class="number">4</span> <span class="number">73.95542</span> <span class="number">72.61165</span> <span class="number">77.36032</span> <span class="number">79.48383</span> <span class="number">75.00610</span></div><div class="line">team <span class="number">5</span> <span class="number">73.36905</span> <span class="number">77.19182</span> <span class="number">78.59511</span> <span class="number">78.28309</span> <span class="number">81.98515</span></div><div class="line">team <span class="number">6</span> <span class="number">74.03342</span> <span class="number">67.47227</span> <span class="number">79.25801</span> <span class="number">70.24398</span> <span class="number">77.07891</span></div><div class="line">team <span class="number">7</span> <span class="number">74.14659</span> <span class="number">76.21967</span> <span class="number">81.25641</span> <span class="number">74.01896</span> <span class="number">80.90877</span></div><div class="line">team <span class="number">8</span> <span class="number">70.57122</span> <span class="number">68.65044</span> <span class="number">84.30345</span> <span class="number">76.18054</span> <span class="number">77.83099</span></div></pre></td></tr></table></figure>
<p>上述的这些数字精确到小点第5位，很多时候在写实验结果时根本没必要，此时使用<code>round()</code>函数，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&gt; round(heights,<span class="number">1</span>)</div><div class="line">         SG   PG    C   PF   SF</div><div class="line">team <span class="number">1</span> <span class="number">70.3</span> <span class="number">73.5</span> <span class="number">78.0</span> <span class="number">75.5</span> <span class="number">79.9</span></div><div class="line">team <span class="number">2</span> <span class="number">69.1</span> <span class="number">73.0</span> <span class="number">79.5</span> <span class="number">77.1</span> <span class="number">73.2</span></div><div class="line">team <span class="number">3</span> <span class="number">69.7</span> <span class="number">70.1</span> <span class="number">80.4</span> <span class="number">80.4</span> <span class="number">76.7</span></div><div class="line">team <span class="number">4</span> <span class="number">74.0</span> <span class="number">72.6</span> <span class="number">77.4</span> <span class="number">79.5</span> <span class="number">75.0</span></div><div class="line">team <span class="number">5</span> <span class="number">73.4</span> <span class="number">77.2</span> <span class="number">78.6</span> <span class="number">78.3</span> <span class="number">82.0</span></div><div class="line">team <span class="number">6</span> <span class="number">74.0</span> <span class="number">67.5</span> <span class="number">79.3</span> <span class="number">70.2</span> <span class="number">77.1</span></div><div class="line">team <span class="number">7</span> <span class="number">74.1</span> <span class="number">76.2</span> <span class="number">81.3</span> <span class="number">74.0</span> <span class="number">80.9</span></div><div class="line">team <span class="number">8</span> <span class="number">70.6</span> <span class="number">68.7</span> <span class="number">84.3</span> <span class="number">76.2</span> <span class="number">77.8</span></div></pre></td></tr></table></figure>
<h2 id="相关的误解misunderstanding-correlation">相关的误解(Misunderstanding Correlation)</h2>
<p>相关性(correlation)广泛用于表示数据的重现性(reproducibility)，例如在基因组学(genomics)常会用到。但在数学角度来看，相关性与重现性关系不大，这里简单描述三个关于相关性的问题。</p>
<p>关于相关性最大的误用就是计算那些不服从双变量正态分布数据的相关性。前面提到，如果两组数据服从双变量正态分布，那么使用均值、标准差以及相关性来描述这些数据是合适的。但是，还有很多数据不是双变量正态分布。例如基因表达的数据就不服从双变量正态分布，这种数据的右侧有着扁平的尾巴(with a very fat right tail)。</p>
<p>研究两个重复检测数据重现性(reproducibility)的标准做法是先计算一下这两组数据的距离，如下所示： <span class="math display">\[
\sqrt{\sum_{i=1}^{n} d_{i}^{2}} \text { with } d_{i}=x_{i}-y_{i}
\]</span> 当两次检测的数值重复性很好的时候，这个度量(metric)是降低的，当这个值是0的时候（其实就相当于两次检测的结果完全一样），结果最完美（这只是理想情况）。使用这种度量的另外一个好处就是，如果我们将它除以N，那么得到的数值就是就是作为<span class="math inline">\(d_{1},\dots,d_{N}\)</span>的标准差（此时我们假设d是大于0的）（原文是if we assume the d average out to 0，我的理解是，我们假设d的平均值为0，或者是d的平均值大于0）。如果将d视为残差(residuals)，那么这个统计量（已经除以N了）就相当于RMSE（全称为Root Mean Squared Error，译为均方根误差），我们称为<code>距离度量(distance metric)</code>。此外，这个统计量的单位与检测值的单位是一样的，因此能很好地解释结果。</p>
<p>使用相关性(correlation)是另外一个局限是，相关性计算无法检测到由于平均值改变而导致的不可重复性（原文是：Another limitation of the correlation is that it does not detect cases that are not reproducible due to average changes.），而距离度量则能检测到这些差异，因此前面的公式可以写为下面的形式： <span class="math display">\[
\frac{1}{n} \sum_{i=1}^{n}\left(x_{i}-y_{i}\right)^{2}=\frac{1}{n} \sum_{i=1}^{n}\left[\left(x_{i}-\mu_{x}\right)-\left(y_{i}-\mu_{y}\right)+\left(\mu_{x}-\mu_{y}\right)\right]^{2}
\]</span> 其中<span class="math inline">\(\mu_{x}\)</span>和<span class="math inline">\(\mu_{y}\)</span>表示的是两次检测的均值，因此上面的公式还可以写为如下形式： <span class="math display">\[
\frac{1}{n} \sum_{i=1}^{n}\left(x_{i}-y_{i}\right)^{2}=\frac{1}{n} \sum_{i=1}^{n}\left(x_{i}-\mu_{x}\right)^{2}+\frac{1}{n} \sum_{i=1}^{n}\left(y_{i}-\mu_{y}\right)^{2}+\left(\mu_{x}-\mu_{y}\right)^{2}+\frac{1}{n} \sum_{i=1}^{n}\left(x_{i}-\mu_{x}\right)\left(y_{i}-\mu_{y}\right)
\]</span> 如果我们假设前后两次检测的结果的方差都是1，那么上面的公式就可以简化为如下形式： <span class="math display">\[
\frac{1}{n} \sum_{i=1}^{n}\left(x_{i}-y_{i}\right)^{2}=2+\left(\mu_{x}-\mu_{y}\right)^{2}-2 \rho
\]</span> 其中<span class="math inline">\(\rho\)</span>表示相关性，因此我们可以直接看到距离度量(distance metric)与相关性(correlation)的关系，但是，距离度量与相关性的一个重要差异就是距离度量含有<span class="math inline">\(\left(\mu_{x}-\mu_{y}\right)^{2}\)</span>，因此，它可以检测到那些由于大量均值变化而导致的无法重复。</p>
<p>相关性不能当成重复性(reproducibility)指标的另外一个因素就是，相关性没有单位(units)。我们使用一个公式就能看到这种局限，假如我们有两个变量，分别为<code>x</code>和<code>y</code>，其中<code>y=x+d</code>。如果<code>d</code>的方差越大，那么<code>x+d</code>就越无法重现<code>x</code>，也就是说，如果<code>d</code>这个数值波动越大，表示的就是第二次检测与第一次检测的数值偏差越大，进而可以得出结果：两次检测数据之间的重复性越差。而<code>距离度量(distrance metric)</code>仅取决于<code>d</code>的方差，也就是说它只取决于前后两次检测的偏差程度，它表示的是就是重复性的好坏，而相关性还依赖于<code>x</code>的方差，如果<code>d</code>与<code>x</code>是独立的，那么相关性的公式就如下所示： <span class="math display">\[
\operatorname{cor}(x, y)=\frac{1}{\sqrt{1+\operatorname{var}(d) / \operatorname{var}(x)}}
\]</span> 从上面的公式我们就可以看出来，相关性取决于<code>d</code>的方差与<code>x</code>的方差，这就说明了，即使相关性接近于1，也无法说明重复性很好。具体来说就是，无论<code>d</code>的方差怎么样，我们通过增加<code>x</code>的方差，就可以使相关系数随意地接近于1。</p>
<h2 id="练习">练习</h2>
<p>P131</p>
<h2 id="异常值的总结">异常值的总结</h2>
<p>正态分布在分析生命科学相关数据中有着重要作用，但是，由于相关检测仪器的复杂性，也会偶尔观察到一些异常值。例如某些扫描仪的缺陷会出现几个异常值的点，或者说是PCR过程中会产生一些偏倚。</p>
<p>因此我们往往会遇到一些情况，即在一群数据中，除了某个异常值外，其余的数据符合正态分布，如下所示： <figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">set.seed(<span class="number">1</span>)</div><div class="line">x &lt;- c(rnorm(<span class="number">100</span>,<span class="number">0</span>,<span class="number">1</span>))</div><div class="line">x[<span class="number">23</span>] &lt;- <span class="number">100</span></div><div class="line">boxplot(x)</div></pre></td></tr></table></figure></p>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190815184258.png">

</div>
<p>例如在上面的图形中，有一个点的数值是100，在统计学中，我们将这种点称为异常值(outliers)。一小部分的异常值会严重误导我们的数据分析，例如，这组数据中的均值与方差差就会远远偏离实际值，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; cat(<span class="string">"The average is"</span>,mean(x),<span class="string">"and the SD is"</span>,sd(x))</div><div class="line">The average is <span class="number">1.108142</span> and the SD is <span class="number">10.02938</span></div></pre></td></tr></table></figure>
<p>我们生成的数据是标准正态分布，也就是均值为1，标准差为0，而加了一个异常值后，均值就变成了1.108142，标准差就变成了10.02938。</p>
<h3 id="中位数">中位数</h3>
<p>中位数的定义就是，将一组数据按从小到大的顺序排列，这个数字位于中间，有50%的数字大于它，有50%的数字小于它，对于含有异常值的一组数据来说，中位数比较稳健(robust)，现在我们来看一下我们前面数据的中位数（理论上应该比较接近于0），如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">median(x)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; median(x)</div><div class="line">[<span class="number">1</span>] <span class="number">0.1684483</span></div></pre></td></tr></table></figure>
<h3 id="中位数绝对偏差the-median-absolute-deviationmad">中位数绝对偏差(The median absolute deviation,MAD)</h3>
<p>中位数绝对偏差，即The median absolute deviation，缩写为MAD，它是对标准差的稳健性描述。它的计算方法为：</p>
<p>第一步：计算每个数据点与中位数的差值；</p>
<p>第二步：取第一步中的绝对值；</p>
<p>第三步：取第二步中绝对值的中位数，再乘以1.4826。</p>
<p>其中，1.4826是一个比例因子(scaling factor )，MAD是一个无偏估计，现在我们使用MAD来估计前面的那组数据（就是服从标准正态分布的那组数据），那么它的值就非常接近于1了，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; mad(x)</div><div class="line">[<span class="number">1</span>] <span class="number">0.8857141</span></div></pre></td></tr></table></figure>
<h3 id="spearman相关系数">Spearman相关系数</h3>
<p>前面我们提到，相关性对异常值比较敏感，这里我们构建了两组独立的数据，基中它们都含有以前面类似的异常值，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">set.seed(<span class="number">1</span>)</div><div class="line">x=c(rnorm(<span class="number">100</span>,<span class="number">0</span>,<span class="number">1</span>)) <span class="comment">##real distribution</span></div><div class="line">x[<span class="number">23</span>] &lt;- <span class="number">100</span> <span class="comment">##mistake made in 23th measurement</span></div><div class="line">y=c(rnorm(<span class="number">100</span>,<span class="number">0</span>,<span class="number">1</span>)) <span class="comment">##real distribution</span></div><div class="line">y[<span class="number">23</span>] &lt;- <span class="number">84</span> <span class="comment">##similar mistake made in 23th measurement</span></div><div class="line"><span class="keyword">library</span>(rafalib)</div><div class="line">mypar()</div><div class="line">plot(x,y,main=paste0(<span class="string">"correlation="</span>,round(cor(x,y),<span class="number">3</span>)),pch=<span class="number">21</span>,bg=<span class="number">1</span>,xlim=c(-<span class="number">3</span>,<span class="number">100</span>),ylim=c(-<span class="number">3</span>,<span class="number">100</span>))</div><div class="line">abline(<span class="number">0</span>,<span class="number">1</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190815190642.jpeg">

</div>
<p>Spearman相关系数遵循中位数与MAD的基本思想，也就是使用了分位数(quantiles)的原理。这个原理很简单：我们将每个数据集转换为秩(rank)，然后计算它们的相关性，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">mypar(<span class="number">1</span>,<span class="number">2</span>)</div><div class="line">plot(x,y,main=paste0(<span class="string">"correlation="</span>,round(cor(x,y),<span class="number">3</span>)),pch=<span class="number">21</span>,bg=<span class="number">1</span>,xlim=c(-<span class="number">3</span>,<span class="number">100</span>),ylim=c(-<span class="number">3</span>,<span class="number">100</span>))</div><div class="line">plot(rank(x),rank(y),main=paste0(<span class="string">"correlation="</span>,round(cor(x,y,method=<span class="string">"spearman"</span>),<span class="number">3</span>)),pch=<span class="number">21</span>,bg=<span class="number">1</span>,xlim=c(-<span class="number">3</span>,<span class="number">100</span>),ylim=c(-<span class="number">3</span>,<span class="number">100</span>))</div><div class="line">abline(<span class="number">0</span>,<span class="number">1</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190815190916.jpeg">

</div>
<p>从上面的结果我们可以知道，这些统计量对异常值很稳健，但为什么我们会使用那些不稳健的相关性计算方法呢？通常来说，如果我们知道异常值，那么我们最好使用中位数和MAD来替代均值与标准差来描述一组数据。但是，与非稳健性的相关性计算方法相比，这些稳健的统计方法的功效比较低。</p>
<h3 id="对数比的对称性symmetry-of-log-ratio">对数比的对称性(Symmetry of log ratio)</h3>
<p>比值(ratio)通常并不对称，现在我们来模拟一组比值来看一下，这组比值表示的是两个样本中100个基因的比值，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">x &lt;- <span class="number">2</span>^(rnorm(<span class="number">100</span>))</div><div class="line">y &lt;- <span class="number">2</span>^(rnorm(<span class="number">100</span>))</div><div class="line">ratios &lt;- x / y</div></pre></td></tr></table></figure>
<p>在生命科学中，我们经常使用比值或表达倍数(fold changes, FC)。假设现在们就在研究某个因素干预前后基因的变化的比值。因此在这些数据中，有些比值大于1，就表示经过干预后，基因表达上升。如果干预没有效果，那么这些比值小于1和大于1的数目是差不多的，通过直方图我们就可以看到干预后的基因变化量，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">mypar(<span class="number">1</span>,<span class="number">2</span>)</div><div class="line">hist(ratios)</div><div class="line">logratios &lt;- log2(ratios)</div><div class="line">hist(logratios)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190815192005.jpeg">

</div>
<p>从上面的这两张图我们可以看到，这些数据并不关于1对称。例如，1/32比32/1更接近于1，其实这两个数字表示的比值意义其实是相反的，一个是降低了32倍，一个是升高了32倍，但是它们不对称。如果我们经过了log转换，这两个数值就会关于0对称，转换的过程如下所示： <span class="math display">\[
\log (x / y)=\log (x)-\log (y)=-(\log (y)-\log (x))=\log (y / x)
\]</span> 现在我们看一下这些数据点，如下所示：</p>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190815192411.png">

</div>
<p>在生命科学中，经常使用log转换，这是因为100倍的变化可能是100/1或1/100，但是1/100比100/1更接近于1。</p>
<h2 id="wilcoxon秩和检测wilcoxon-rank-sum-test">Wilcoxon秩和检测(Wilcoxon Rank Sum Test)</h2>
<p>从前面内容我们可以知道，样本的均值(mean)和SD对异常值(outlier)敏感。t检验的计算原理就是均值与SD。因此在有异常值存在的情况下，Wilcoxon秩和检验（其本质与Mann-Whitney检验）就成了一种替代选择。</p>
<p>在下面的代码中，我们进行了t检验（其零假设为真）。当使用这些原始数据进行计算时，t检验与Wilcoxon检验的p值都大于0.05，但是，当我们在每个样本中故意错误地更改了一个观测值后，并将其输入计算过程，此时，t检验就会计算出一个小p值，而Wilcoxon检验则不会这样，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">set.seed(<span class="number">779</span>) </div><div class="line"><span class="comment">##779 picked for illustration purposes</span></div><div class="line">N=<span class="number">25</span></div><div class="line">x&lt;- rnorm(N,<span class="number">0</span>,<span class="number">1</span>)</div><div class="line">y&lt;- rnorm(N,<span class="number">0</span>,<span class="number">1</span>)</div><div class="line">cat(<span class="string">"t-test pval:"</span>,t.test(x,y)$p.value,<span class="string">"\n"</span>)</div><div class="line">cat(<span class="string">"Wilcox test pval:"</span>,wilcox.test(x,y)$p.value,<span class="string">"\n"</span>)</div><div class="line">x[<span class="number">1</span>] &lt;- <span class="number">5</span></div><div class="line">x[<span class="number">2</span>] &lt;- <span class="number">7</span></div><div class="line">cat(<span class="string">"t-test pval:"</span>,t.test(x,y)$p.value,<span class="string">"\n"</span>)</div><div class="line"></div><div class="line">cat(<span class="string">"Wilcox test pval:"</span>,wilcox.test(x,y)$p.value,<span class="string">"\n"</span>)</div></pre></td></tr></table></figure>
<p>计算结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&gt; cat(<span class="string">"t-test pval:"</span>,t.test(x,y)$p.value,<span class="string">"\n"</span>)</div><div class="line">t-test pval: <span class="number">0.1589672</span> </div><div class="line">&gt; cat(<span class="string">"Wilcox test pval:"</span>,wilcox.test(x,y)$p.value,<span class="string">"\n"</span>)</div><div class="line">Wilcox test pval: <span class="number">0.3066718</span> </div><div class="line">&gt; x[<span class="number">1</span>] &lt;- <span class="number">5</span></div><div class="line">&gt; x[<span class="number">2</span>] &lt;- <span class="number">7</span></div><div class="line">&gt; cat(<span class="string">"t-test pval:"</span>,t.test(x,y)$p.value,<span class="string">"\n"</span>)</div><div class="line">t-test pval: <span class="number">0.04439948</span> </div><div class="line">&gt; </div><div class="line">&gt; cat(<span class="string">"Wilcox test pval:"</span>,wilcox.test(x,y)$p.value,<span class="string">"\n"</span>)</div><div class="line">Wilcox test pval: <span class="number">0.1310212</span></div></pre></td></tr></table></figure>
<h3 id="wilcoxon检验的基本思想">Wilcoxon检验的基本思想</h3>
<p>Wilcoxon检验的基本思想如下所示：</p>
<ol style="list-style-type: decimal">
<li>汇总所有数据；</li>
<li>将数据的值转换为秩(rank)，也就是排序；</li>
<li>然后将这些秩再按原来的组别分开；</li>
<li>计算出每组秩的总和，进行检验。</li>
</ol>
<p>检验的过程如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(rafalib)</div><div class="line">mypar(<span class="number">1</span>,<span class="number">2</span>)</div><div class="line">stripchart(list(x,y),vertical=<span class="literal">TRUE</span>,ylim=c(-<span class="number">7</span>,<span class="number">7</span>),ylab=<span class="string">"Observations"</span>,pch=<span class="number">21</span>,bg=<span class="number">1</span>)</div><div class="line">abline(h=<span class="number">0</span>)</div><div class="line">xrank&lt;-rank(c(x,y))[seq(along=x)]</div><div class="line">yrank&lt;-rank(c(x,y))[-seq(along=y)]</div><div class="line">stripchart(list(xrank,yrank),vertical=<span class="literal">TRUE</span>,ylab=<span class="string">"Ranks"</span>,pch=<span class="number">21</span>,bg=<span class="number">1</span>,cex=<span class="number">1.25</span>)</div><div class="line">ws &lt;- sapply(x,<span class="keyword">function</span>(z) rank(c(z,y))[<span class="number">1</span>]-<span class="number">1</span>)</div><div class="line">text( rep(<span class="number">1.05</span>,length(ws)), xrank, ws, cex=<span class="number">0.8</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190816082005.jpeg">

</div>
<p>上图是含有异常值的两个图表，左侧是原始图形，它含有的异常值，右则是将数值点转换为秩后的图形，可以发现右侧的数据分布就比较正常了，没有异常值。</p>
<p>秩和检验中的W值是对第一组相对于第二组的秩。通过排列组合(combinatorics)，我们可以精确地计算出W的p值。我们也可以使用CLT来计算，因为W是近拉于正态分布的，下面我们构建了z-score来进行计算，如下所示；</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">W &lt;-sum(ws)</div><div class="line">W</div><div class="line">n1&lt;-length(x);n2&lt;-length(y)</div><div class="line">Z &lt;- (mean(ws)-n2/<span class="number">2</span>)/ sqrt(n2*(n1+n2+<span class="number">1</span>)/<span class="number">12</span>/n1)</div><div class="line">print(Z)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&gt; W &lt;-sum(ws)</div><div class="line">&gt; W</div><div class="line">[<span class="number">1</span>] <span class="number">391</span></div><div class="line">&gt; n1&lt;-length(x);n2&lt;-length(y)</div><div class="line">&gt; Z &lt;- (mean(ws)-n2/<span class="number">2</span>)/ sqrt(n2*(n1+n2+<span class="number">1</span>)/<span class="number">12</span>/n1)</div><div class="line">&gt; print(Z)</div><div class="line">[<span class="number">1</span>] <span class="number">1.523124</span></div></pre></td></tr></table></figure>
<p>在这个计算过程中，我们得到了Z值，这个Z值对应的p值大于0.05。</p>
<h2 id="练习-1">练习</h2>
<p>P140</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-tags" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rvdsd.top/2019/08/07/DAL/DALS007_Inference06_AssociationTests/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="RVDSD">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RVDSD的个人笔记本">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/07/DAL/DALS007_Inference06_AssociationTests/" itemprop="url">DALS007-统计推断(Inference)06-关联检验(Association Tests)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-07T12:00:00+08:00">
                2019-08-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Data-Analysis-for-the-life-sciences/" itemprop="url" rel="index">
                    <span itemprop="name">Data Analysis for the life sciences</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2,706
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  11
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言">前言</h2>
<p>这篇笔记是《Data Analysis for the Life Sciences》的第2章：统计推断(Inference)的第6部分。这一部分的主要内容涉及卡方检验。</p>
<h2 id="关联检验">关联检验</h2>
<p>前面所提到的案例都是普通的统计学案例，这些普通案例指的是，它们的数据是二元的(binary)，分类的(categorical)或有序的(ordinal)。现在我们考虑一种特殊的案例，例如基因型数据，现在我们有两组基因型数据，一组基因是AA/Aa，另外一组是aa（某个特定疾病的对照）。现在我们的问题是，这个基因型(genotype)是否与疾病相关。这个案例与我们前面提到的案例就有点像了，我们有两个总体，即AA/Aa与aa，我们使用1或0来表示它们对应的疾病状态，其中0是不患病，1是患病的。此时我们不能使用t检验，因为这种数据明显不符合正态分布，无法使用t检验。如果样本足够大的话，可以使用CLT，否则，可以使用关联检验(association test)。</p>
<h2 id="女士品茶">女士品茶</h2>
<p>关于假设检验最有名的一个案例就是Fisher提出的。这个案例大概是这个样子的，一名女士声称，如果牛奶与红茶加入的先后顺序不同，得到的奶茶口味也不同，并且她自己能品尝出来。Fisher就给了4杯奶茶，这4杯奶茶加入的花与牛奶顺序是不同的，是随机的。后来这个女士品尝对了3个，此时，我们能认为这个女士确实有这种能力么，她品尝出的这3杯奶茶是否是出于偶然因素？假设检验就能回答这个问题，并且能够对这种偶然因素进行定量。</p>
<p>现在我们提出我们的基础问题：假如这个女士品尝出的这3杯奶茶是她自己瞎猜（瞎猜说明她没有品尝出奶茶这种能力），并且猜对了，那么她瞎猜对3杯，或者是比3杯更难发生的事件（例如猜对4杯）的概率是多少？现在我们做一个零假设，假设她能猜对4杯，这个事件的概率是多少？</p>
<p>现在我们就把这个事件再简化一下，我们做一个零假设，我们可以把女士品尝这个特殊案例看作是从一个含有4个绿球（正确答案）和4个红球（错误答案）的瓮中挑出4个小球的试验。</p>
<p>零假设就是：这个女士品尝出正确奶茶的结果纯粹是她自己瞎猜的，也就是说，每个小球有着相同的机会被挑中。现在计算一下每个事件的概率，那么挑中3个绿球的概率就是： <span class="math display">\[
\left(\begin{array}{l}{4} \\ {3}\end{array}\right)\left(\begin{array}{l}{4} \\ {1}\end{array}\right) /\left(\begin{array}{l}{8} \\ {4}\end{array}\right)=16 / 70
\]</span> 挑中4个绿球的概率是： <span class="math display">\[
\left(\begin{array}{l}{4} \\ {4}\end{array}\right)\left(\begin{array}{l}{4} \\ {0}\end{array}\right) /\left(\begin{array}{l}{8} \\ {4}\end{array}\right)=1 / 70
\]</span> 现在我们把这两个数值相应，就是约等于0.24，这个数字表示，这个女士能够品尝对3杯奶茶，甚至比3杯奶茶这个事件更加极端的概率（例如4杯奶茶），这就是p值。这个p值产生的过程就是Fisher精确检验(<code>Fisher's exact test</code>)，这类数据服从超几何分布(<code>hypergeometric distribution</code>)。</p>
<h2 id="二联表">二联表</h2>
<p>前面提到的数据我们可以使用二联表来创建，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">tab &lt;- matrix(c(<span class="number">3</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">3</span>),<span class="number">2</span>,<span class="number">2</span>)</div><div class="line">rownames(tab)&lt;-c(<span class="string">"Poured Before"</span>,<span class="string">"Poured After"</span>)</div><div class="line">colnames(tab)&lt;-c(<span class="string">"Guessed before"</span>,<span class="string">"Guessed after"</span>)</div><div class="line">tab</div></pre></td></tr></table></figure>
<p>数据如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt; tab</div><div class="line">              Guessed before Guessed after</div><div class="line">Poured Before              <span class="number">3</span>             <span class="number">1</span></div><div class="line">Poured After               <span class="number">1</span>             <span class="number">3</span></div></pre></td></tr></table></figure>
<p>使用<code>fisher.test()</code>这个函数就能计算出p值，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fisher.test(tab,alternative=<span class="string">"greater"</span>)</div></pre></td></tr></table></figure>
<p>计算结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&gt; fisher.test(tab,alternative=<span class="string">"greater"</span>)</div><div class="line"></div><div class="line">	Fisher<span class="string">'s Exact Test for Count Data</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">data:  tab</span></div><div class="line"><span class="string">p-value = 0.2429</span></div><div class="line"><span class="string">alternative hypothesis: true odds ratio is greater than 1</span></div><div class="line"><span class="string">95 percent confidence interval:</span></div><div class="line"><span class="string"> 0.3135693       Inf</span></div><div class="line"><span class="string">sample estimates:</span></div><div class="line"><span class="string">odds ratio </span></div><div class="line"><span class="string">  6.408309</span></div></pre></td></tr></table></figure>
<h2 id="卡方检验">卡方检验</h2>
<p>GWAS全称是Genome-wide association studies，即全基因组关联分析。这种分析的统计结果常用曼哈顿图(Manhattan)图来表示。曼哈顿图的y轴是p值的负的log值（底为10），这个p值则是通过计算数百万个SNP的关联检验得到的。x轴通常是染色体的位置（例如chromosome 1 to 22, X,Y等）。这引起p值的计算类似于前面提到的女士品茶的计算过程。但是，在女士品茶那个案例中，绿球与红球的数目是固定的，针对每种事件的发生次数也是固定的，换句话讲，在列联表中，行与列的中的数字之和是固定的。这种限定条件就对二联表中所有的可能性进行了约束，并且还可以使用超几何分布来计算p值。但是，实际情况并非如此，这时，可以使用另外一种方法，即卡方检验(Chi-squared test)。</p>
<p>假如我们有250个人，他们中有一些人患有某种疾病，剩下的则不患。在这些人中，纯合子(aa)有50人，这些纯合子中又有20%的人患病，即有10名患有该病，而非纯合子(AA/Aa)的人中则有10%患有该病。如果我们再挑250个人，那么又是什么情况呢？</p>
<p>现在我们先根据既有的数据来过计算一下，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">disease=factor(c(rep(<span class="number">0</span>,<span class="number">180</span>),rep(<span class="number">1</span>,<span class="number">20</span>),rep(<span class="number">0</span>,<span class="number">40</span>),rep(<span class="number">1</span>,<span class="number">10</span>)),</div><div class="line">labels=c(<span class="string">"control"</span>,<span class="string">"cases"</span>))</div><div class="line">genotype=factor(c(rep(<span class="string">"AA/Aa"</span>,<span class="number">200</span>),rep(<span class="string">"aa"</span>,<span class="number">50</span>)),</div><div class="line">levels=c(<span class="string">"AA/Aa"</span>,<span class="string">"aa"</span>))</div><div class="line">dat &lt;- data.frame(disease, genotype)</div><div class="line">dat &lt;- dat[sample(nrow(dat)),] <span class="comment">#shuffle them up</span></div><div class="line">head(dat)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&gt; head(dat)</div><div class="line">    disease genotype</div><div class="line"><span class="number">130</span> control    AA/Aa</div><div class="line"><span class="number">191</span>   cases    AA/Aa</div><div class="line"><span class="number">187</span>   cases    AA/Aa</div><div class="line"><span class="number">233</span> control       aa</div><div class="line"><span class="number">144</span> control    AA/Aa</div><div class="line"><span class="number">91</span>  control    AA/Aa</div></pre></td></tr></table></figure>
<p>使用<code>table()</code>函数可以创建一个列联表，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">table(genotype)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt; table(genotype)</div><div class="line">genotype</div><div class="line">AA/Aa    aa </div><div class="line">  <span class="number">200</span>    <span class="number">50</span></div></pre></td></tr></table></figure>
<p>查看一下疾病的列联表，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">table(disease)</div></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt; table(disease)</div><div class="line">disease</div><div class="line">control   cases </div><div class="line">    <span class="number">220</span>      <span class="number">30</span></div></pre></td></tr></table></figure>
<p>现在把基因型与疾病关联起来，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">tab &lt;- table(genotype,disease)</div><div class="line">tab</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt; tab</div><div class="line">        disease</div><div class="line">genotype control cases</div><div class="line">   AA/Aa     <span class="number">180</span>    <span class="number">20</span></div><div class="line">   aa         <span class="number">40</span>    <span class="number">10</span></div></pre></td></tr></table></figure>
<p>从上面结果可以看出来，我们使用了2个因素，即基因型，疾病，函数<code>table()</code>返回了<code>2X2</code>列联表。</p>
<p>对于上述的这种数据，我们通常会使用比数比(OR, odds ratio)来表示。现在我们计算一下<code>aa</code>的比数(odd)，即<code>10/40</code>，也就是说在50个纯合子(aa)中，有10名患病，40名不患病，这个数值是患病与不患病的比值。那么AA/Aa这种基因型患病的比数为20/180，这两个比值再进行比，就是比数比(odd ratio)，即：<code>(10/40)/(20/180)</code>，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(tab[<span class="number">2</span>,<span class="number">2</span>]/tab[<span class="number">2</span>,<span class="number">1</span>]) / (tab[<span class="number">1</span>,<span class="number">2</span>]/tab[<span class="number">1</span>,<span class="number">1</span>])</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; (tab[<span class="number">2</span>,<span class="number">2</span>]/tab[<span class="number">2</span>,<span class="number">1</span>]) / (tab[<span class="number">1</span>,<span class="number">2</span>]/tab[<span class="number">1</span>,<span class="number">1</span>])</div><div class="line">[<span class="number">1</span>] <span class="number">2.25</span></div></pre></td></tr></table></figure>
<p>我们并不使用OR来直接计算p值。相反，我们会先假设基因型与疾病没有关联，然后计算出表格中每个单元格的期望数值。在零假设下，含有200个人的AA/Aa和含有50个人的aa都被计算出相应的患病数，把他们都当成一个总体，那么患病率是：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">p=mean(disease==<span class="string">"cases"</span>)</div><div class="line">p</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; p</div><div class="line">[<span class="number">1</span>] <span class="number">0.12</span></div></pre></td></tr></table></figure>
<p>那么这个表格的期望值是（期望值是使用每组的人数乘以发病率）：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">expected &lt;- rbind(c(<span class="number">1</span>-p,p)*sum(genotype==<span class="string">"AA/Aa"</span>),</div><div class="line">c(<span class="number">1</span>-p,p)*sum(genotype==<span class="string">"aa"</span>))</div><div class="line">dimnames(expected)&lt;-dimnames(tab)</div><div class="line">expected</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt; expected</div><div class="line">        disease</div><div class="line">genotype control cases</div><div class="line">   AA/Aa     <span class="number">176</span>    <span class="number">24</span></div><div class="line">   aa         <span class="number">44</span>     <span class="number">6</span></div></pre></td></tr></table></figure>
<p>卡方检验的p值计算结果如下：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">chisq.test(tab)$p.value</div></pre></td></tr></table></figure>
<p>结果为：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; chisq.test(tab)$p.value</div><div class="line">[<span class="number">1</span>] <span class="number">0.08857435</span></div></pre></td></tr></table></figure>
<h2 id="大样本小p值">大样本，小p值</h2>
<p>前面提到，在报道一项发现时，仅报道p值是不合适。许多遗传学关联研究似乎过于强调p值，在这些研究中，研究者们使用了大量的样本，因此他们报道的p值非常低。但是，如果我们仔细看一下他们的结果就会发现，比数比(odd ratio)则表现得很一般：很少有大于1的。在这种情况下，基因型为AA/Aa或aa的差异也许并不改变个体的疾病风险，虽然这有着实际意义(practically significant)，但是，一个人不可能根据这些基因型与疾病的关系而对自己的行为进行改变。</p>
<p>比数比(odds ration)与p值之间并非是一对一的关系。为了说明这一点，我们在保证所有比例相同的前提下来重新计算一下p值。现在我们把样本数目扩大10倍，这就会明显地降低p值，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">tab &lt;- tab*<span class="number">10</span></div><div class="line">chisq.test(tab)$p.value</div></pre></td></tr></table></figure>
<p>计算结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt; tab &lt;- tab*<span class="number">10</span></div><div class="line">&gt; chisq.test(tab)$p.value</div><div class="line">[<span class="number">1</span>] <span class="number">1.219624e-09</span></div></pre></td></tr></table></figure>
<h2 id="比数比的置信区间confidence-intervals-for-the-odd-ratio">比数比的置信区间(Confidence Intervals For The Odd Ratio)</h2>
<p>在数学上计算OR的置信区间并不简单明了。在计算其它统计量时，我们可以推导出那些统计量的近似，但是OR的计算与之不同，OR不仅是一个比值，而是一个比值的比值。因此，没有简单的方法（例如CLT）来计算OR。</p>
<p>一种方法是使用广义线性模型(generalized linear models )的理论，这种理论可以对比数比的log值(log odds ratio)进行估计。经过log转换的比数比就可以被证明是接近正态分布的，如下所示（具体的理论可以参考文献）：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">fit &lt;- glm(disease~genotype,family=<span class="string">"binomial"</span>,data=dat)</div><div class="line">coeftab&lt;- summary(fit)$coef</div><div class="line">coeftab</div></pre></td></tr></table></figure>
<p>计算结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&gt; fit &lt;- glm(disease~genotype,family=<span class="string">"binomial"</span>,data=dat)</div><div class="line">&gt; coeftab&lt;- summary(fit)$coef</div><div class="line">&gt; coeftab</div><div class="line">              Estimate Std. Error   z value     Pr(&gt;|z|)</div><div class="line">(Intercept) -<span class="number">2.1972246</span>  <span class="number">0.2356828</span> -<span class="number">9.322803</span> <span class="number">1.133070e-20</span></div><div class="line">genotypeaa   <span class="number">0.8109302</span>  <span class="number">0.4249074</span>  <span class="number">1.908487</span> <span class="number">5.632834e-02</span></div></pre></td></tr></table></figure>
<p>数据的表格中的第2行就是估计值与log(odds ratio)的值。数学理论告诉我们，这个估计值是接近于正态分布的。因此我们可以构建一个置信区间，然后再化为正常值，就能计算出OR的置信区间，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ci &lt;- coeftab[<span class="number">2</span>,<span class="number">1</span>] + c(-<span class="number">2</span>,<span class="number">2</span>)*coeftab[<span class="number">2</span>,<span class="number">2</span>]</div><div class="line">exp(ci)</div></pre></td></tr></table></figure>
<p>计算结果为：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt; ci &lt;- coeftab[<span class="number">2</span>,<span class="number">1</span>] + c(-<span class="number">2</span>,<span class="number">2</span>)*coeftab[<span class="number">2</span>,<span class="number">2</span>]</div><div class="line">&gt; exp(ci)</div><div class="line">[<span class="number">1</span>] <span class="number">0.9618616</span> <span class="number">5.2632310</span></div></pre></td></tr></table></figure>
<p>这个置信区间包括1，这与p值大于于0.05的结果是一致的。需要注意的是，这里的p值是基于另一种不同方法计算的，它以前面使用卡方检验得到的p值计算过程不一样。</p>
<h2 id="练习">练习</h2>
<p>P91</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-tags" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rvdsd.top/2019/08/06/DAL/DALS006_Inference05_PermutationTest/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="RVDSD">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RVDSD的个人笔记本">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/06/DAL/DALS006_Inference05_PermutationTest/" itemprop="url">DALS006-统计推断(Inference)05-置换检验(Permutation Test)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-06T12:00:00+08:00">
                2019-08-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Data-Analysis-for-the-life-sciences/" itemprop="url" rel="index">
                    <span itemprop="name">Data Analysis for the life sciences</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2,577
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  10
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言">前言</h2>
<p>这篇笔记是《Data Analysis for the Life Sciences》的第2章：统计推断(Inference)的第5部分。这一部分的主要内容涉及置换检验。</p>
<p>置换检验英文是Permutation test，这是Fisher于20世纪30年代提出的一种基于大量计算（computationally intensive），利用样本数据的全（或随机）排列，进行统计推断的方法，因其对总体分布自由，应用较为广泛，特别适用于总体分布未知的小样本资料，以及某些难以用常规方法分析资料的假设检验问题。在具体使用上它和Bootstrap Methods类似，通过对样本进行顺序上的置换，重新计算统计检验量，构造经验分布，然后在此基础上求出P-value，进行推断，生信中常用的GSEA分析本质上就是置换检验。</p>
<p>置换检验的根本原理就是<strong>重新采样增加小样本的整体样本量，然后看其的概率分布来预测假设是否成立</strong>。</p>
<h2 id="置换检验permutation-test">置换检验(Permutation Test)</h2>
<p>现在考虑一种情况，在这种情况下，标准的数理统计近拟(standard mathematical statistical approximation)都不适用。但是，我们已经计算出了一个总结性的统计，例如均值的差值，但是，我们的这些数据不符合一些即定分布，也没有办法得到总体，也就是说无法进行一些数据模拟，例如Monte Carlo模拟，面对这种情况，我们可以采用置换检验(Permutation test)。</p>
<h2 id="置换检验过程">置换检验过程</h2>
<p>在前面部分中，我们介绍了参数模拟，这种方法有助于我们计算出观察到的差值是否有统计学的意义。而置换检验则会使用另外一种计算方法，它也是利用了两组的差值。在这种方法中，我们会随机置换干预组与对照组的分组标签。当我们置换了干预组与对照组的分级标签后，得到的新数据我们会假设它们服从零分布，现在我们通过置换这两组数据来计算一下零分布（这里假设置换1000次）。</p>
<p>第一步，是先计算出两组（这里是treatment组与control组） 的均值差值，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(dplyr)</div><div class="line">dir &lt;- system.file(package = <span class="string">"dagdata"</span>)</div><div class="line">filename &lt;- file.path(dir,<span class="string">"extdata/femaleMiceWeights.csv"</span>)</div><div class="line">dat &lt;- read.csv(filename)</div><div class="line">control &lt;- filter(dat, Diet == <span class="string">"chow"</span>) %&gt;% dplyr::select(Bodyweight) %&gt;% unlist</div><div class="line">treatment &lt;- filter(dat, Diet == <span class="string">"hf"</span>) %&gt;% dplyr::select(Bodyweight) %&gt;% unlist</div><div class="line">obsdiff &lt;- mean(treatment) - mean(control)</div></pre></td></tr></table></figure>
<p>第二步，对样本重新进行分组，也就是将上述的两组的所有数据（每组都是12个样本，一共是24个数据）重新进行分组，每组12个数值，每组重新分组时，都计算出均数差，24个数据随机等分为2组，一共是2704156个均数差（使用<code>choose(24,12)</code>就能计算出来，不过我们这里只不进行全部置换，我们只置换1000次，现在我们通过置换这两组数据来计算一下零分布（置换1000次），如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">N &lt;- <span class="number">12</span></div><div class="line">avgdiff &lt;- replicate(<span class="number">1000</span>, &#123;</div><div class="line">  all &lt;- sample(c(control, treatment))</div><div class="line">  newcontrols &lt;- all[<span class="number">1</span>:N]</div><div class="line">  newtreatments &lt;- all[(N+<span class="number">1</span>):(<span class="number">2</span>*N)]</div><div class="line">  <span class="keyword">return</span>(mean(newtreatments)-mean(newcontrols))</div><div class="line">&#125;)</div><div class="line">hist(avgdiff)</div><div class="line">abline(v=obsdiff,col=<span class="string">"red"</span>,lwd=<span class="number">2</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190728170314.jpeg">

</div>
<p>第三步：计算出上面那1000个均数差中大于<code>obsdiff</code>的个数。</p>
<p>现在我们考虑一下，有多少个零均值(null means，结合上下文，这里的零均值应该是在零假设成立的前面下的均值）大于观察值呢？这个比值就是零假设成立下的p值。我们向分子与分母都加1，用于校正一下p值（书中列出的参考文献，这里不解释它的数学原理），如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># the proportion of permutations with larger difference</span></div><div class="line">(sum(abs(avgdiff) &gt; abs(obsdiff))+<span class="number">1</span>)/(length(avgdiff)+<span class="number">1</span>)</div></pre></td></tr></table></figure>
<p>计算结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt; <span class="comment"># the proportion of permutations with larger difference</span></div><div class="line">&gt; (sum(abs(avgdiff) &gt; abs(obsdiff))+<span class="number">1</span>)/(length(avgdiff)+<span class="number">1</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0.04795205</span></div></pre></td></tr></table></figure>
<p>第四步：就是根据第三步中的计算结果（上面的计算结果是0.04795205）来下结论。</p>
<p>如果p&gt;0.05，说明在两样本来自同一总体的假设下，当前样本的出现是很平常的，不能拒绝H0假设，认为两样本的差异无统计学意义；如果p&lt;0.05，则认为两样本的差异有统计学意义，不过考虑到这里的p值基本上就是在0.05附近，因此下结论也应该慎重。</p>
<p>现在我们使用小样本数据来重复一下这个实验，我们通过抽样的方式来创建一个小样本数据，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">N &lt;- <span class="number">5</span></div><div class="line">control &lt;- sample(control, N)</div><div class="line">treatment &lt;- sample(treatment, N)</div><div class="line">obsdiff &lt;- mean(treatment) - mean(control)</div><div class="line"></div><div class="line">avgdiff &lt;- replicate(<span class="number">1000</span>,&#123;</div><div class="line">  all &lt;- sample(c(control, treatment))</div><div class="line">  newcontrols &lt;- all[<span class="number">1</span>:N]</div><div class="line">  newtreatments &lt;- all[(N+<span class="number">1</span>):(<span class="number">2</span>*N)]</div><div class="line">  <span class="keyword">return</span>(mean(newtreatments) - mean(newcontrols))</div><div class="line">&#125;)</div><div class="line">hist(avgdiff)</div><div class="line">abline(v=obsdiff, col=<span class="string">"red"</span>,lwd=<span class="number">2</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190728173556.jpeg">

</div>
<p>上面的直方图显示的是使用置换检验计算出来的小样本数据的均值之差，红线表示的是观察值的差异。</p>
<p>现在我们发现，使用这种方法得到的观察差值并不显著，这里需要记住，没有理论能保证，置换的结果接近于实际的零分布。例如，如果不同的总体之间确实存在着差异，一些置换检验的结果可能就计算不出差异，也有一些能计算出差异。这说明，在置换检验中，零分布比实际的零分布有着一个更扁平的尾部。这也就说明了，为什么置换检验会得到一个比较保守的p值。出于这种原因，当我们的样本数目比较少时通常不做置换检验。</p>
<p>另外我们还要注意，置换检验也有是假设的：假设样本是独立的，是可以进行交换的(“exchangeable”)。如果你的数据中含有隐藏的结构，置换检验生成的估计的零分布分则会低估该分布的尾部面积，这有可能破坏原始数据中的现在结构（注：这里我的理解就是，假设A样本和B样本数据没有差异，那么它们无论怎么置换后，得到的数据应该是差不多的，也就是说得到的p值会比较大）。</p>
<h2 id="练习">练习</h2>
<p>书中还列出一个练习题，现在我们来做一下。</p>
<p>第一步，下载原始数据，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">url &lt;- <span class="string">"https://raw.githubusercontent.com/genomicsclass/dagdata/master/inst/extdata/babies.txt"</span></div><div class="line">filename &lt;- basename(url)</div><div class="line"><span class="keyword">library</span>(downloader)</div><div class="line"><span class="keyword">library</span>(dplyr)</div><div class="line">download(url, destfile=filename)</div><div class="line">babies &lt;- read.table(<span class="string">"babies.txt"</span>, header=<span class="literal">TRUE</span>)</div><div class="line">bwt.nonsmoke &lt;- filter(babies, smoke==<span class="number">0</span>) %&gt;% dplyr::select(bwt) %&gt;% unlist</div><div class="line">bwt.smoke &lt;- filter(babies, smoke==<span class="number">1</span>) %&gt;% dplyr::select(bwt) %&gt;% unlist</div></pre></td></tr></table></figure>
<p>第二步，现在我们生成一个数据集，先来观察一下它们的差值，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">N=<span class="number">10</span></div><div class="line">set.seed(<span class="number">1</span>)</div><div class="line">nonsmokers &lt;- sample(bwt.nonsmoke , N)</div><div class="line">smokers &lt;- sample(bwt.smoke , N)</div><div class="line">obs &lt;- mean(smokers) - mean(nonsmokers)</div><div class="line">obs</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; obs</div><div class="line">[<span class="number">1</span>] -<span class="number">16.9</span></div></pre></td></tr></table></figure>
<p>现在我们的问题就是：在我们构建的这个数据里（这个数据含有1个nonsmokers样本，1个smokers样本），这个观察到的差值<code>-16.9</code>是否有统计学上的意义？</p>
<p>这里我们使用前面提到的置换检测来计算一下上面构建好的p值。我们会重新杂揉(原文是reshuffle，没找到相应的中文翻译，这里我译为“杂揉”，也就是把这两组数据混合起来)，然后重新计算它们的均值。现在我们称使用下面的代码来计算一下，经过置换后的，其中的一个均值的差值，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">dat &lt;- c(smokers,nonsmokers)</div><div class="line">shuffle &lt;- sample(dat)</div><div class="line">smokersstar &lt;- shuffle[<span class="number">1</span>:N]</div><div class="line">nonsmokersstar &lt;- shuffle[(N+<span class="number">1</span>):(<span class="number">2</span>*N)]</div><div class="line">mean(smokersstar)-mean(nonsmokersstar)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; mean(smokersstar)-mean(nonsmokersstar)</div><div class="line">[<span class="number">1</span>] -<span class="number">8.5</span></div></pre></td></tr></table></figure>
<p>上面的这个值就是我们即将构建的零分布中的一个观测值。</p>
<p>现在我们开始计算p值，将随机数种子设为1，即<code>set.seed(1)</code>，用于置换1000次，生成一个零分布。现在我们从这个零分布中观察到的前面的那个差值的p值是多少呢？</p>
<p>计算过程的完整代码如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">N=<span class="number">10</span></div><div class="line">set.seed(<span class="number">1</span>)</div><div class="line">nonsmokers &lt;- sample(bwt.nonsmoke , N)</div><div class="line">smokers &lt;- sample(bwt.smoke , N)</div><div class="line">obs &lt;- mean(smokers) - mean(nonsmokers)</div><div class="line"></div><div class="line">avgdiff &lt;- replicate(<span class="number">1000</span>,&#123;</div><div class="line">  shuffle &lt;- sample(dat)</div><div class="line">  sample_smokers &lt;- shuffle[<span class="number">1</span>:N]</div><div class="line">  sample_nonsmokers &lt;- shuffle[(N+<span class="number">1</span>):(<span class="number">2</span>*N)]</div><div class="line">  <span class="keyword">return</span>(mean(sample_smokers) - mean(sample_nonsmokers))</div><div class="line">&#125;)</div><div class="line"></div><div class="line">hist(avgdiff)</div><div class="line">abline(v=obs, col=<span class="string">"red"</span>,lwd=<span class="number">2</span>)</div><div class="line">(sum(abs(avgdiff) &gt; abs(obs))+<span class="number">1</span>)/(length(avgdiff)+<span class="number">1</span>)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; (sum(abs(avgdiff) &gt; abs(obs))+<span class="number">1</span>)/(length(avgdiff)+<span class="number">1</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0.05394605</span></div></pre></td></tr></table></figure>
<p>从上面我们可以看到，p值是大于0.05的。我们来看一下直方图的结果：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">hist(avgdiff)</div><div class="line">abline(v=obs, col=<span class="string">"red"</span>,lwd=<span class="number">2</span>)</div></pre></td></tr></table></figure>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190923183550.jpeg">

</div>
<p>现在我们分别使用t检验和Wilcoxon检验分别计算如下，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">t.test(smokers,nonsmokers)</div><div class="line">wilcox.test(smokers,nonsmokersstar)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&gt; t.test(smokers,nonsmokers)</div><div class="line"></div><div class="line">	Welch Two Sample t-test</div><div class="line"></div><div class="line">data:  smokers and nonsmokers</div><div class="line">t = -<span class="number">2.067</span>, df = <span class="number">13.159</span>, p-value = <span class="number">0.059</span></div><div class="line">alternative hypothesis: true difference <span class="keyword">in</span> means is not equal to <span class="number">0</span></div><div class="line"><span class="number">95</span> percent confidence interval:</div><div class="line"> -<span class="number">34.5419234</span>   <span class="number">0.7419234</span></div><div class="line">sample estimates:</div><div class="line">mean of x mean of y </div><div class="line">    <span class="number">109.9</span>     <span class="number">126.8</span> </div><div class="line"></div><div class="line">&gt; wilcox.test(smokers,nonsmokersstar)</div><div class="line"></div><div class="line">	Wilcoxon rank sum test with continuity correction</div><div class="line"></div><div class="line">data:  smokers and nonsmokersstar</div><div class="line">W = <span class="number">34</span>, p-value = <span class="number">0.2399</span></div><div class="line">alternative hypothesis: true location shift is not equal to <span class="number">0</span></div></pre></td></tr></table></figure>
<p>从上面的结果来看，置换检验算出的p值为0.053，t检验计算出的p值为0.059，这两个计算结果还是比较接近的。最后我们使用了Wilcoxon检验，p值是大于0.05的，毕竟Wilcoxon检验的功效较小。</p>
<p>练习中的第2题提到，我们不使用均值之差，而是使用中位数之差，即<code>obsdiff &lt;- median(smokers) - median(nonsmokers)</code>，看一下p值，计算过程如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">N=<span class="number">10</span></div><div class="line">set.seed(<span class="number">1</span>)</div><div class="line">nonsmokers &lt;- sample(bwt.nonsmoke , N)</div><div class="line">smokers &lt;- sample(bwt.smoke , N)</div><div class="line">(obs &lt;- median(smokers) - median(nonsmokers))</div><div class="line">dat &lt;- c(nonsmokers,smokers)</div><div class="line">  </div><div class="line">avgdiff &lt;- replicate(<span class="number">1000</span>, &#123;</div><div class="line">  shuffle &lt;- sample(dat)</div><div class="line">  smokersstar &lt;- shuffle[<span class="number">1</span>:N]</div><div class="line">  nonsmokersstar &lt;- shuffle[(N+<span class="number">1</span>):(<span class="number">2</span>*N)]</div><div class="line">  obs = median(smokersstar)-median(nonsmokersstar)</div><div class="line">  <span class="keyword">return</span>(obs)</div><div class="line">&#125;)</div><div class="line">hist(avgdiff)</div><div class="line">abline(v=obs, col=<span class="string">"red"</span>,lwd=<span class="number">2</span>)</div><div class="line">(sum(abs(avgdiff) &gt; abs(obs))+<span class="number">1</span>)/(length(avgdiff)+<span class="number">1</span>)</div></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; (sum(abs(avgdiff) &gt; abs(obs))+<span class="number">1</span>)/(length(avgdiff)+<span class="number">1</span>)</div><div class="line">[<span class="number">1</span>] <span class="number">0.02197802</span></div></pre></td></tr></table></figure>
<p>从结果来看，通过来看中位数差值，p值是小于0.05的。来看一下直方图的结果：</p>
<div class="figure">
<img src="https://pic-1256416512.cos.ap-chengdu.myqcloud.com/img/20190923183619.jpeg">

</div>
<p>出现这种结果我的理解就是因为，随机了取样的数目太少，是10个，如果变成20个，有可能p值就大于0.05了（当把N变为20，那么p值就在于0.05，并且中位数的直方图也更像正态分布的钟形曲线）。</p>
<h2 id="参考资料">参考资料</h2>
<ol style="list-style-type: decimal">
<li><a href="https://blog.csdn.net/u011467621/article/details/47971917" target="_blank" rel="external">Permutation Test 置换检验(转）</a></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/25/">25</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">RVDSD</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">246</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">117</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">RVDSD</span>

  
</div>



<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_pv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>


<div class="BbeiAn-info">
	<a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41018102000118" style="color:#909090;text-decoration:none;padding-left:0px;no-repeat left center" rel="nofollow">豫公网安备 41018102000118</a>	  <!--这里将图标作为了背景，以使得能和后面的文字在同一行-->
</div>

  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.3</div>




<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共980.9k字</span>
</div>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="custom_mathjax_source">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
  


  

  

</body>
</html>
